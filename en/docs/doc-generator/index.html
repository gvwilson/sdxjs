<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: Documentation Generator</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.taylorfrancis.com/books/mono/10.1201/9781003317807/software-design-example-greg-wilson" /><img src="../sdxjs-cover.png" alt="Book cover" width="80%" /></a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../doc-generator/">
      <strong>Documentation Generator</strong>
    </a>
  </li>
  
  <li>
    <a href="../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><em><a href="../sdxjs-examples.zip" alt="source code archive">download examples</a></em></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 16: Documentation Generator</h1>


          
            

            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#accumulator" markdown="1">accumulator</a>, <a class="gl-ref" href="../glossary/#block_comment" markdown="1">block comment</a>, <a class="gl-ref" href="../glossary/#deprecation" markdown="1">deprecation</a>, <a class="gl-ref" href="../glossary/#doc_comment" markdown="1">doc comment</a>, <a class="gl-ref" href="../glossary/#line_comment" markdown="1">line comment</a>, <a class="gl-ref" href="../glossary/#slug" markdown="1">slug</a>
</p>


            <div class="page-toc"></div>
            <p>Many programmers believe they&rsquo;re more likely to write documentation and keep it up to date
if it is close to the code.
Tools that extract specially-formatted comments from code and turn them into documentation
have been around since at least the 1980s;
many are used for JavaScript,
including <span class="ix-entry" ix-key="JSDoc" markdown="1"><a href="https://jsdoc.app/">JSDoc</a></span> and <span class="ix-entry" ix-key="ESDoc" markdown="1"><a href="https://esdoc.org/">ESDoc</a></span>.
This chapter will use what we learned in <a class="x-ref" href="../code-generator/">Chapter 15</a> about parsing source code
to build a simple documentation generator of our own.</p>
<h2 id="doc-generator-extract">Section 16.1: How can we extract documentation comments?</h2>
<p>We will use <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span> once again to parse our source files.
This time we will use the parser&rsquo;s <code>onComment</code> option,
giving it an array to fill in.
For the moment we won&rsquo;t bother to assign the <span class="ix-entry" ix-key="abstract syntax tree" markdown="1">AST</span> produced by parsing to a variable
because we are just interested in the comments:</p>
<div class="code-sample lang-js" title="extract-comments.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="two-kinds-of-comment.js">
<div class="highlight"><pre><span></span><code><span class="c1">// double-slash comment</span><span class="w"></span>
<span class="cm">/* slash-star comment */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="two-kinds-of-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    &quot;type&quot;: &quot;Line&quot;,
    &quot;value&quot;: &quot; double-slash comment&quot;,
    &quot;start&quot;: 0,
    &quot;end&quot;: 23,
    &quot;loc&quot;: {
      &quot;start&quot;: {
        &quot;line&quot;: 1,
        &quot;column&quot;: 0
      },
      &quot;end&quot;: {
        &quot;line&quot;: 1,
        &quot;column&quot;: 23
      }
    }
  },
  {
    &quot;type&quot;: &quot;Block&quot;,
    &quot;value&quot;: &quot; slash-star comment &quot;,
    &quot;start&quot;: 24,
    &quot;end&quot;: 48,
    &quot;loc&quot;: {
      &quot;start&quot;: {
        &quot;line&quot;: 2,
        &quot;column&quot;: 0
      },
      &quot;end&quot;: {
        &quot;line&quot;: 2,
        &quot;column&quot;: 24
      }
    }
  }
]
</code></pre></div>
</div>
<p>There is more information here than we need,
so let&rsquo;s slim down the JSON that we extract:</p>
<div class="code-sample lang-js" title="extract-comments-subset.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="two-kinds-of-comment-subset.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js two-kinds-of-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="two-kinds-of-comment-subset.out">
<div class="highlight"><pre><span></span><code>[
  {
    &quot;type&quot;: &quot;Line&quot;,
    &quot;value&quot;: &quot; double-slash comment&quot;,
    &quot;start&quot;: 1,
    &quot;end&quot;: 1
  },
  {
    &quot;type&quot;: &quot;Block&quot;,
    &quot;value&quot;: &quot; slash-star comment &quot;,
    &quot;start&quot;: 2,
    &quot;end&quot;: 2
  }
]
</code></pre></div>
</div>
<figure id="doc-generator-comments" class="figure-here">
  <img src="./comments.svg" alt="Line and block comments"/>
  <figcaption markdown="1">Figure 16.1: How line comments and block comments are distinguished and represented.</figcaption>
</figure>

<p>Acorn distinguishes two kinds of comments (<a class="fig-ref" href="../doc-generator/#doc-generator-comments">Figure 16.1</a>).
<span class="ix-entry" ix-key="line comment;comment!line" markdown="1"><a class="gl-ref" href="../glossary/#line_comment" markdown="1">Line comments</a></span> cannot span multiple lines;
if one line comment occurs immediately after another,
Acorn reports two comments:</p>
<div class="code-sample lang-js" title="multi-line-double-slash-comment.js">
<div class="highlight"><pre><span></span><code><span class="c1">//</span><span class="w"></span>
<span class="c1">// multi-line double-slash comment</span><span class="w"></span>
<span class="c1">//</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="multi-line-double-slash-comment.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js multi-line-double-slash-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="multi-line-double-slash-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    &quot;type&quot;: &quot;Line&quot;,
    &quot;value&quot;: &quot;&quot;,
    &quot;start&quot;: 1,
    &quot;end&quot;: 1
  },
  {
    &quot;type&quot;: &quot;Line&quot;,
    &quot;value&quot;: &quot; multi-line double-slash comment&quot;,
    &quot;start&quot;: 2,
    &quot;end&quot;: 2
  },
  {
    &quot;type&quot;: &quot;Line&quot;,
    &quot;value&quot;: &quot;&quot;,
    &quot;start&quot;: 3,
    &quot;end&quot;: 3
  }
]
</code></pre></div>
</div>
<p><span class="ix-entry" ix-key="block comment;comment!block" markdown="1"><a class="gl-ref" href="../glossary/#block_comment" markdown="1">Block comments</a></span>,
on the other hand,
can span any number of lines.
We don&rsquo;t need to prefix each line with <code>*</code> but most people do for readability:</p>
<div class="code-sample lang-js" title="multi-line-slash-star-comment.js">
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * multi-line slash-star comment</span>
<span class="cm"> */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="multi-line-slash-star-comment.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js multi-line-slash-star-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="multi-line-slash-star-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    &quot;type&quot;: &quot;Block&quot;,
    &quot;value&quot;: &quot;\n * multi-line slash-star comment\n &quot;,
    &quot;start&quot;: 1,
    &quot;end&quot;: 3
  }
]
</code></pre></div>
</div>
<p>By convention,
we use block comments that start with <code>/**</code> for documentation.
The first two characters are recognized by the parser as &ldquo;start of comment&rdquo;,
so the first character in the extracted text is <code>*</code>:</p>
<div class="code-sample lang-js" title="doc-comment.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * doc comment</span>
<span class="cm"> */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="doc-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    &quot;type&quot;: &quot;Block&quot;,
    &quot;value&quot;: &quot;*\n * doc comment\n &quot;,
    &quot;start&quot;: 1,
    &quot;end&quot;: 3
  }
]
</code></pre></div>
</div>
<h2 id="doc-generator-input">Section 16.2: What input will we try to handle?</h2>
<p>We will use <span class="ix-entry" ix-key="Markdown" markdown="1"><a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a></span> for formatting our documentation.
The <span class="ix-entry" ix-key="doc comment;comment!doc" markdown="1"><a class="gl-ref" href="../glossary/#doc_comment" markdown="1">doc comments</a></span> for function definitions look like this:</p>
<div class="code-sample lang-js" title="example-plain.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * # Demonstrate documentation generator.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">util</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./util-plain&#39;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `main`: Main driver.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Parse arguments.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Process input stream.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `parseArgs`: Parse command line.</span>
<span class="cm"> * - `args` (`string[]`): arguments to parse.</span>
<span class="cm"> * - `defaults` (`Object`): default values.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: program configuration object.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">parseArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">defaults</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `process`: Transform data.</span>
<span class="cm"> * - `input` (`stream`): where to read.</span>
<span class="cm"> * - `output` (`stream`): where to write.</span>
<span class="cm"> * - `op` (`class`): what to do.</span>
<span class="cm"> *    Use @BaseProcessor unless told otherwise.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">output</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">BaseProcessor</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while the ones for class definitions look like this:</p>
<div class="code-sample lang-js" title="util-plain.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * # Utilities to demonstrate doc generator.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `BaseProcessor`: General outline.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">BaseProcessor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * ### `constructor`: Build processor.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * ### `run`: Pass input to output.</span>
<span class="cm">   * - `input` (`stream`): where to read.</span>
<span class="cm">   * - `output` (`stream`): where to write.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">BaseProcessor</span><span class="w"></span>
</code></pre></div>
</div>
<p>The doc comments are unpleasant at the moment:
they repeat the function and method names from the code,
we have to create titles ourselves,
and we have to remember the back-quotes for formatting code.
We will fix some of these problems once we have a basic tool up and running.</p>
<p>The next step in doing that is to translate Markdown into HTML.
There are many <span class="ix-entry" ix-key="Markdown!parser" markdown="1">Markdown parsers</span> in JavaScript;
after experimenting with a few,
we decided to use <a href="https://markdown-it.github.io/"><code>markdown-it</code></a>
along with the <a href="https://www.npmjs.com/package/markdown-it-anchor"><code>markdown-it-anchor</code></a> extension
that creates HTML anchors for headings.
The main program gets all the doc comments from all of the input files,
converts the Markdown to HTML,
and displays that:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">STYLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;width: 40rem; padding-left: 0.5rem; border: solid;&#39;</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;html&gt;&lt;body style=&quot;</span><span class="si">${</span><span class="nx">STYLE</span><span class="si">}</span><span class="sb">&quot;&gt;`</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">FOOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAllComments</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="p">({</span><span class="w"> </span><span class="nx">html</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">MarkdownAnchor</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">slugify</span><span class="o">:</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">allComments</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">HEAD</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">FOOT</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To get all the comments,
we extract comments from all the files,
remove the leading <code>*</code> characters (which aren&rsquo;t part of the documentation),
and then join the results after stripping off extraneous blanks:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">getAllComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">allFilenames</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">allFilenames</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extractComments</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comments</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">removePrefix</span><span class="p">(</span><span class="nx">comment</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comments</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">stripped</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`# </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">\n\n</span><span class="si">${</span><span class="nx">combined</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Extracting the comments from a single file is done as before:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">extractComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Block&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">end</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">subset</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and removing the prefix <code>*</code> characters is a matter of splitting the text into lines,
removing the leading spaces and asterisks,
and putting the lines back together:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">removePrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">comment</span><span class="p">.</span><span class="nx">stripped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">value</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^ *\/?\* */</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;*/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">comment</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>One thing that isn&rsquo;t in this file (because we&rsquo;re going to use it in later versions)
is the function <code>slugify</code>.
A <span class="ix-entry" ix-key="slug (unique identifier)" markdown="1"><a class="gl-ref" href="../glossary/#slug" markdown="1">slug</a></span> is a short string that identifies a header or a web page;
the name comes from the era of newspapers,
where a slug was a short name used to identify an article while it was in production.
Our <code>slugify</code> function strips unnecessary characters out of a title,
adds hyphens,
and generally makes it something you might see in a URL:</p>
<div class="code-sample lang-js" title="slugify.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/.js$/</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^ \w]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">slugify</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let&rsquo;s run this generator and see what it produces
(<a class="fig-ref" href="../doc-generator/#doc-generator-process-plain">Figure 16.3</a> and <a class="fig-ref" href="../doc-generator/#doc-generator-mapping">Figure 16.2</a>):</p>
<div class="code-sample lang-sh" title="process-plain.sh">
<div class="highlight"><pre><span></span><code>node process-plain.js example-plain.js util-plain.js
</code></pre></div>
</div>
<div class="code-sample lang-html" title="process-plain.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;width: 40rem; padding-left: 0.5rem; border: solid;&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;exampleplain&quot;</span><span class="p">&gt;</span>example-plain.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;demonstrate&quot;</span><span class="p">&gt;</span>Demonstrate documentation generator.<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;main&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>main<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Main driver.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;parseargs&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>parseArgs<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Parse command line.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>args<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>string[]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): arguments to parse.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>defaults<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Object<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): default values.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Returns: program configuration object.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;process&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>process<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Transform data.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>op<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>class<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): what to do.
Use @BaseProcessor unless told otherwise.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;utilplain&quot;</span><span class="p">&gt;</span>util-plain.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;utilities&quot;</span><span class="p">&gt;</span>Utilities to demonstrate doc generator.<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;baseprocessor&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>BaseProcessor<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: General outline.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;constructor&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>constructor<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Build processor.<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;run&quot;</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>run<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Pass input to output.<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="doc-generator-mapping">
  <img src="./mapping.svg" alt="Mapping comments to documentation"/>
  <figcaption markdown="1">Figure 16.2: How comments in code map to documentation in HTML.</figcaption>
</figure>

<figure id="doc-generator-process-plain" class="latex-small">
  <img src="./process-plain.svg" alt="Output of documentation generator"/>
  <figcaption markdown="1">Figure 16.3: The page produced by the documentation generator.</figcaption>
</figure>

<p>It works,
but there is a double <code>h1</code> header for each file (the filename and the title comment),
the anchor IDs are hard to read,
there are no cross-references,
and so on.
Some of the visual issues can be resolved with <span class="ix-entry" ix-key="CSS" markdown="1">CSS</span>,
and we can change our input format to make processing easier
as long as it also makes authoring easier.
However,
anything that is written twice will eventually be wrong in one place or another,
so our first priority is to remove duplication.</p>
<h2 id="doc-generator-dup">Section 16.3: How can we avoid duplicating names?</h2>
<p>If a comment is the first thing in a file,
we want to use it as title text;
this will save us having to write an explicit level-1 title in a comment.
For each other comment,
we can extract the name of the function or method
from the node on the line immediately following the doc comment.
This allows us to write much tidier comments:</p>
<div class="code-sample lang-js" title="find-following-input.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Overall file header.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Double the input.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="kr">double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Triple the input.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">triple</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Define a class.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Method description.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nx">someMethod</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To extract and display information from nodes immediately following doc comments
we must find all the block comments,
record the last line of each,
and then search the AST to find nodes that are on lines
immediately following any of those trailing comment lines.
(We will assume for now that there are no blank lines between the comment
and the start of the class or function.)
The main program finds the comments as usual,
creates a set containing the line numbers we are looking for,
then searches for the nodes we want:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Block&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">comments</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">nodes</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">condense</span><span class="p">(</span><span class="nx">node</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The recursive search is straightforward as well&mdash;we delete line numbers from the target set
and add nodes to the <span class="ix-entry" ix-key="Accumulator pattern;design pattern!Accumulator" markdown="1"><a class="gl-ref" href="../glossary/#accumulator" markdown="1">accumulator</a></span> as we find matches:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">findFollowing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">targets</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">accum</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">targets</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
we use a function called <code>condense</code> to get the name we want out of the AST:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">condense</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;VariableDeclaration&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">declarations</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;FunctionDeclaration&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ClassDeclaration&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;MethodDefinition&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="sb">`Unknown node type </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We need this because we get a different structure with:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">than we get with:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>When we run this on our test case we get:</p>
<div class="code-sample lang-out" title="find-following.out">
<div class="highlight"><pre><span></span><code>[
  { type: &#39;VariableDeclaration&#39;, start: 8, name: &#39;double&#39; },
  { type: &#39;FunctionDeclaration&#39;, start: 13, name: &#39;triple&#39; },
  { type: &#39;ClassDeclaration&#39;, start: 20, name: &#39;Example&#39; },
  { type: &#39;MethodDefinition&#39;, start: 24, name: &#39;someMethod&#39; }
]
</code></pre></div>
</div>
<p>We can use this to create better output (<a class="fig-ref" href="../doc-generator/#doc-generator-fill-in-headers">Figure 16.4</a>):</p>
<div class="code-sample lang-js" title="fill-in-headers.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;markdown-it&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">MarkdownAnchor</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;markdown-it-anchor&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">getComments</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./get-comments.js&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">getDefinitions</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./get-definitions.js&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fillIn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./fill-in.js&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./slugify.js&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">STYLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;width: 40rem; padding-left: 0.5rem; border: solid;&#39;</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;html&gt;&lt;body style=&quot;</span><span class="si">${</span><span class="nx">STYLE</span><span class="si">}</span><span class="sb">&quot;&gt;`</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">FOOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filenames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getComments</span><span class="p">(</span><span class="nx">filenames</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allDefinitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getDefinitions</span><span class="p">(</span><span class="nx">filenames</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">allComments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">definitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allDefinitions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fillIn</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="p">,</span><span class="w"> </span><span class="nx">definitions</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">combined</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="p">({</span><span class="w"> </span><span class="nx">html</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">MarkdownAnchor</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">slugify</span><span class="o">:</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">combined</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">HEAD</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">FOOT</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="fill-in-headers.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;width: 40rem; padding-left: 0.5rem; border: solid;&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;fillinheadersinput&quot;</span><span class="p">&gt;</span>fill-in-headers-input.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Demonstrate documentation generator.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;main&quot;</span><span class="p">&gt;</span>main<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Main driver.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;parseargs&quot;</span><span class="p">&gt;</span>parseArgs<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Parse command-line arguments.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>args<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>string[]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): arguments to parse.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>defaults<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Object<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): default values.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Program configuration object.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;baseprocessor&quot;</span><span class="p">&gt;</span>BaseProcessor<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Default processing class.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;constructor&quot;</span><span class="p">&gt;</span>constructor<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Build base processor.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;run&quot;</span><span class="p">&gt;</span>run<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Pass input to output.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="doc-generator-fill-in-headers" class="latex-small">
  <img src="./fill-in-headers.svg" alt="Filling in headers"/>
  <figcaption markdown="1">Figure 16.4: Filling in headers when generating documentation.</figcaption>
</figure>

<h2 id="doc-generator-note">Section 16.4: Code is Data</h2>
<p>We haven&rsquo;t made this point explicitly in a while,
so we will repeat it here:
<span class="ix-entry" ix-key="code!as data" markdown="1">code is just another kind of data</span>,
and we can process it just like we would process any other data.
Parsing code to produce an AST is no different from parsing HTML to produce DOM;
in both cases we are simply transforming a textual representation that&rsquo;s easy for people to author
into a data structure that&rsquo;s easy for a program to manipulate.
Pulling things out of that data to create a report
is no different from pulling numbers out of a hospital database to report monthly vaccination rates.</p>
<p>Treating code as data enables us to do routine programming tasks with a single command,
which in turn gives us more time to think about the tasks that we can&rsquo;t (yet) automate.
Doing this is the foundation of a tool-based approach to software engineering;
as the mathematician <span class="ix-entry" ix-key="Whitehead, Alfred North" markdown="1">Alfred North Whitehead</span> once wrote,
&ldquo;Civilization advances by extending the number of important operations which we can perform without thinking about them.&rdquo;</p>
<h2 id="doc-generator-exercises">Section 16.5: Exercises</h2>
<h3 class="exercise">Building an index</h3>
<p>Modify the documentation generator to produce an alphabetical index of all classes and methods found.
Index entries should be hyperlinks to the documentation for the corresponding item.</p>
<h3 class="exercise">Documenting exceptions</h3>
<p>Extend the documentation generator to allow people to document the exceptions that a function throws.</p>
<h3 class="exercise">Deprecation warning</h3>
<p>Add a feature to the documentation generator
to allow authors to mark functions and methods as <a class="gl-ref" href="../glossary/#deprecation" markdown="1">deprecation</a>
(i.e., to indicate that while they still exist,
they should not be used because they are being phased out).</p>
<h3 class="exercise">Usage examples</h3>
<p>Enhance the documentation generator so that
if a horizontal rule <code>---</code> appears in a documentation comment,
the text following is typeset as usage example.
(A doc comment may contain several usage examples.)</p>
<h3 class="exercise">Unit testing</h3>
<p>Write unit tests for the documentation generator using Mocha.</p>
<h3 class="exercise">Summarizing functions</h3>
<p>Modify the documentation generator so that line comments inside a function that use <code>//*</code>
are formatted as a bullet list in the documentation for that function.</p>
<h3 class="exercise">Cross referencing</h3>
<p>Modify the documentation generator so that
the documentation for one class or function
can include Markdown links to other classes or functions.</p>
<h3 class="exercise">Data types</h3>
<p>Modify the documentation generator to allow authors to define new data types
in the same way as <a href="https://jsdoc.app/">JSDoc</a>.</p>
<h3 class="exercise">Inline parameter documentation</h3>
<p>Some documentation generators put the documentation for a parameter
on the same line as the parameter:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Transform data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">input</span><span class="p">,</span><span class="w">  </span><span class="cm">/*- {stream} where to read */</span><span class="w"></span>
<span class="w">  </span><span class="nx">output</span><span class="p">,</span><span class="w"> </span><span class="cm">/*- {stream} where to write */</span><span class="w"></span>
<span class="w">  </span><span class="nx">op</span><span class="w">      </span><span class="cm">/*- {Operation} what to do */</span><span class="w"></span>
<span class="p">){</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">Modify the documentation generator to handle this.</p>
<h3 class="exercise">Tests as documentation</h3>
<p>The <a href="https://docs.python.org/3/library/doctest.html">doctest</a> library for Python
allows programmers to embed unit tests as documentation in their programs.
Write a tool that:</p>
<ol>
<li>
<p>Finds functions that start with a block comment.</p>
</li>
<li>
<p>Extracts the code and output from those blocks comments
    and turns them into assertions.</p>
</li>
</ol>
<p class="continue">For example, given this input:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">findIncreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">values</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &gt; findIncreasing([])</span>
<span class="cm">   * []</span>
<span class="cm">   * &gt; findIncreasing([1])</span>
<span class="cm">   * [1]</span>
<span class="cm">   * &gt; findIncreasing([1, 2])</span>
<span class="cm">   * [1, 2]</span>
<span class="cm">   * &gt; findIncreasing([2, 1])</span>
<span class="cm">   * [2]</span>
<span class="cm">   */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">the tool would produce:</p>
<div class="highlight"><pre><span></span><code><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([]),</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">1</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
          
        </main>
      </div>
    </div>
  </body>
</html>
