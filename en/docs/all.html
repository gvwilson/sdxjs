<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Software Design by Example: a tool-based introduction with JavaScript</title>
</head>
<body>
    <section class="cover">
      <h1>Software Design by Example: a tool-based introduction with JavaScript</h1>
    </section>
    <section class="tocElement" id="tocElement">
      <h1 id="ToC">Table of Contents</h1>
    </section>
<section class="new-chapter"><h1 id="introduction">Chapter: Chapter 1: Introduction</h1>

<p>The best way to learn design is to study examples <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Schon1984">Schon1984</a>, <a class="bib-ref" href="../bibliography/#Petre2016">Petre2016</a>]</span>,
and some of the best examples of software design come from
the tools programmers use in their own work.
In these lessons we build small versions of things like file backup systems,
testing frameworks,
regular expression matchers,
and browser layout engines
both to demystify them
and to give some insights into how experienced programmers think.
We draw inspiration from <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Brown2011">Brown2011</a>, <a class="bib-ref" href="../bibliography/#Brown2012">Brown2012</a>, <a class="bib-ref" href="../bibliography/#Brown2016">Brown2016</a>]</span>,
<a href="https://maryrosecook.com/">Mary Rose Cook's</a> <a href="http://gitlet.maryrosecook.com/">Gitlet</a>,
and the books that introduced the Unix philosophy to an entire generation of programmers
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Kernighan1979">Kernighan1979</a>, <a class="bib-ref" href="../bibliography/#Kernighan1981">Kernighan1981</a>, <a class="bib-ref" href="../bibliography/#Kernighan1983">Kernighan1983</a>, <a class="bib-ref" href="../bibliography/#Kernighan1988">Kernighan1988</a>]</span>.</p>
<p>All of the written material in this project can be freely reused
under the terms of the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons - Attribution - NonCommercial license</a>,
while all of the software is made available under the terms of
the <a href="https://firstdonoharm.dev/">Hippocratic License</a>;
see <a class="x-ref" href="#license">Appendix A</a> for details.</p>
<p>All proceeds from this project will go to support the <a href="https://www.reddoorshelter.ca/">Red Door Family Shelter</a>.</p>
<h2 id="introduction-audience">Section 1.1: Who is our audience?</h2>
<p>Every lesson should be written with specific learners in mind.
These three <a href="https://teachtogether.tech/en/index.html#s:process-personas">personas</a> describe ours:</p>
<ul>
<li>
<p>Aïsha started writing VB macros for Excel in an accounting course and never looked back.
    After spending three years doing front-end JavaScript work
    she now wants to learn how to build back-end applications.
    This material will fill in some gaps in her programming knowledge
    and teach her some common design patterns.</p>
</li>
<li>
<p>Rupinder is studying computer science at college.
    He has learned a lot about the theory of algorithms,
    and while he uses Git and unit testing tools in his assignments,
    he doesn't feel he understands how they work.
    This material will give him a better understanding of those tools
    and of how to design new ones.</p>
</li>
<li>
<p>Yim builds mobile apps for a living
    but also teaches two college courses:
    one on full-stack web development using JavaScript and Node
    and another titled "Software Design".
    They are happy with the former,
    but frustrated that so many books about the latter subject talk about it in the abstract
    and use examples that their students can't relate to.
    This material will fill those gaps
    and give them starting points for a wide variety of course assignments.</p>
</li>
</ul>
<p>Like these three personas, readers should be able to:</p>
<ul>
<li>
<p>Write JavaScript programs using loops, arrays, functions, and classes.</p>
</li>
<li>
<p>Create static web pages using HTML and CSS.</p>
</li>
<li>
<p>Install Node on their computer
    and run programs with it from the command line.</p>
</li>
<li>
<p>Use <a href="https://git-scm.com/">Git</a> to save and share files.
    (It's OK not to know <a href="https://git-man-page-generator.lokaltog.net/">the more obscure commands</a>.)</p>
</li>
<li>
<p>Explain what a tree is and how to process one recursively.
    (This is the most complicated data structure and algorithm we <em>don't</em> explain.)</p>
</li>
</ul>
<p>This book can be read on its own or used as a classroom resource.
If you are looking for a project to do in a software design course,
adding a tool to those covered here would be fun as well as educational.
Please see <a class="x-ref" href="#conclusion">Chapter 21</a> for more details.</p>
<h2 id="introduction-contents">Section 1.2: What tools and ideas do we cover?</h2>
<p>Programmers have invented <a href="https://en.wikipedia.org/wiki/Programming_tool">a lot of tools</a> to make their lives easier.
This volume focuses on a few that individual developers use while writing software;
we hope future volumes
will explore those used in the applications that programmers build.</p>
<p><a class="x-ref" href="#glossary">Appendix E</a> defines the terms we introduce in these lessons,
which in turn define their scope:</p>
<ul>
<li>
<p>How to process a program like any other piece of text.</p>
</li>
<li>
<p>How to turn a program into a data structure that can be analyzed and modified.</p>
</li>
<li>
<p>What design patterns are and which ones are used most often.</p>
</li>
<li>
<p>How programs are executed and how we can control and inspect their execution.</p>
</li>
<li>
<p>How we can analyze programs' performance in order to make sensible design tradeoffs.</p>
</li>
<li>
<p>How to find and run code modules on the fly.</p>
</li>
</ul>
<div class="pagebreak"></div>
<h2 id="introduction-layout">Section 1.3: How are these lessons laid out?</h2>
<p>We display JavaScript source code like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">thing</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">collection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">thing</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">and Unix shell commands like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> filename <span class="k">in</span> *.dat
<span class="k">do</span>
    cut -d , -f <span class="m">10</span> <span class="nv">$filename</span>
<span class="k">done</span>
</code></pre></div>
<p class="continue">Data and output are shown in italics:</p>
<div class="highlight"><pre><span></span><code>Package,Releases
0,1
0-0,0
0-0-1,1
00print-lol,2
00smalinux,0
01changer,0
</code></pre></div>
<p>We occasionally wrap lines in source code in unnatural ways to make listings fit the printed page,
and sometimes use <code>...</code> to show where lines have been omitted.
Where we need to break lines of output for the same reason,
we end all but the last line with a single backslash <code>\</code>.
The full listings are all available in [our Git repository][stjs-repo]
and <a href="https://stjs.tech/">on our website</a>.</p>
<p>Finally,
we write functions as <code>functionName</code> rather than <code>functionName()</code>;
the latter is more common,
but people don't use <code>objectName{}</code> for objects or <code>arrayName[]</code> for arrays,
and the empty parentheses makes it hard to tell
whether we're talking about "the function itself" or "a call to the function with no parameters".</p>
<h2 id="introduction-history">Section 1.4: How did we get here?</h2>
<p>In the early 2000s,
the <span class="ix-entry" ix-key="University of Toronto" markdown="1">University of Toronto</span> asked <span class="ix-entry" ix-key="Wilson, Greg" markdown="1"><a href="https://third-bit.com/">Greg Wilson</a></span>
to teach an undergraduate course on software architecture.
After delivering the course three times he told the university they should cancel it:
between them,
the dozen textbooks he had purchased with the phrase "software architecture" in their titles
devoted a total of less than 30 pages to describing the designs of actual systems.</p>
<div class="pagebreak"></div>
<p>Frustrated by that,
he and <span class="ix-entry" ix-key="Oram, Andy" markdown="1"><a href="http://www.praxagora.com/">Andy Oram</a></span> persuaded some well-known programmers to contribute a chapter each
to a collection called <em>Beautiful Code</em> <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Oram2007">Oram2007</a>]</span>,
which went on to win the Jolt Award in 2007.
Entries in the book described everything from figuring out whether three points are on a line
to core components of Linux
and the software for the Mars Rover,
but the breadth that made them fun to read
also meant they weren't particularly useful for teaching.</p>
<p>To fix that,
Greg Wilson, <span class="ix-entry" ix-key="Brown, Amy" markdown="1"><a href="https://www.amyrhodabrown.com/">Amy Brown</a></span>,
<span class="ix-entry" ix-key="Armstrong, Tavish" markdown="1"><a href="http://tavisharmstrong.com/">Tavish Armstrong</a></span>,
and <span class="ix-entry" ix-key="DiBernardo, Mike" markdown="1"><a href="https://mikedebo.com/">Mike DiBernardo</a></span>
edited a four-book series between 2011 and 2016 called <em><a href="https://aosabook.org/">The Architecture of Open Source Applications</a></em>.
In the first two volumes,
the creators of fifty open source projects described their systems' designs;
the third book explored the performance of those systems,
while in the fourth volume contributors built scale models of common tools
as a way of demonstrating how those tools worked.
These books were closer to what an instructor would need for an undergraduate class on software design,
but still not quite right:
the intended audience would probably not be familiar with many of the problem domains,
and since each author used the programming language of their choice,
much of the code would be hard to understand.</p>
<p><em>Software Tools in JavaScript</em> is meant to address these shortcomings:
all of the code is written in one language,
and the examples are all tools that programmers use daily.
Most of the programs are less than 60 lines long and the longest is less than 200;
we believe each chapter can be covered in class in 1-2 hours,
while the exercises range in difficulty from a few minutes to a couple of days.</p>
<h2 id="introduction-use">Section 1.5: How can people use and contribute to this material?</h2>
<p>All of the written material on this site is made available under the Creative
Commons - Attribution - NonCommercial 4.0 International license (CC-BY-NC-4.0),
while the software is made available under the Hippocratic License.  The first
allows you to use and remix this material for non-commercial purposes, as-is or
in adapted form, provided you cite its original source; the second allows you to
use and remix the software on this site provided you do not violate
international agreements governing human rights. Please see <a class="x-ref" href="#license">Appendix A</a>
for details.</p>
<p>If you would like to improve what we have or add new material, please see the
Code of Conduct in <a class="x-ref" href="#conduct">Appendix B</a> and the contributor guidelines in
<a class="x-ref" href="#contributing">Appendix C</a>.  If you have questions or would like to use this material in
a course, please file an issue in our GitHub repository or send us email.</p>
<h2 id="introduction-help">Section 1.6: Who helped us?</h2>
<p>I am grateful to the creators of <a href="https://www.gnu.org/software/emacs/">Emacs</a>,
<a href="https://eslint.org/">ESLint</a>,
<a href="https://github.com/carpentries/glosario">Glosario</a>,
<a href="https://www.gnu.org/software/make/">GNU Make</a>,
<a href="https://www.latex-project.org/">LaTeX</a>,
<a href="https://nodejs.org/en/">Node</a>,
<a href="https://www.npmjs.com/">NPM</a>,
<a href="https://standardjs.com/">Standard JS</a>,
<a href="https://chrome.google.com/webstore/detail/svg-screenshot/nfakpcpmhhilkdpphcjgnokknpbpdllg">SVG Screenshot</a>,
<a href="https://wave.webaim.org/">WAVE</a>,
and all the other open source tools used in creating these lessons:
if we all give a little,
we all get a lot.
I would also like to thank Darren McElligott and Evan Schultz
for their reviews and feedback;
any errors, omissions, or misunderstandings that remain are entirely my fault.</p>
</section>
<section class="new-chapter"><h1 id="systems-programming">Chapter: Chapter 2: Systems Programming</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#anonymous_function" markdown="1">anonymous function</a>, <a class="gl-ref" href="../glossary/#asynchronous" markdown="1">asynchronous</a>, <a class="gl-ref" href="../glossary/#boolean" markdown="1">Boolean</a>, <a class="gl-ref" href="../glossary/#callback" markdown="1">callback function</a>, <a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a>, <a class="gl-ref" href="../glossary/#command_line_argument" markdown="1">command-line argument</a>, <a class="gl-ref" href="../glossary/#console" markdown="1">console</a>, <a class="gl-ref" href="../glossary/#current_working_directory" markdown="1">current working directory</a>, <a class="gl-ref" href="../glossary/#destructuring_assignment" markdown="1">destructuring assignment</a>, <a class="gl-ref" href="../glossary/#edge_case" markdown="1">edge case</a>, <a class="gl-ref" href="../glossary/#filename_extension" markdown="1">filename extension</a>, <a class="gl-ref" href="../glossary/#filesystem" markdown="1">filesystem</a>, <a class="gl-ref" href="../glossary/#filter" markdown="1">filter</a>, <a class="gl-ref" href="../glossary/#globbing" markdown="1">globbing</a>, <a class="gl-ref" href="../glossary/#idiomatic" markdown="1">idiomatic</a>, <a class="gl-ref" href="../glossary/#log_message" markdown="1">log message</a>, <a class="gl-ref" href="../glossary/#path" markdown="1">path (in filesystem)</a>, <a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a>, <a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a>, <a class="gl-ref" href="../glossary/#single_threaded" markdown="1">single-threaded</a>, <a class="gl-ref" href="../glossary/#string_interpolation" markdown="1">string interpolation</a>
</p>
<p>The biggest difference between JavaScript and most other programming languages
is that many operations in JavaScript are <span class="ix-entry" ix-key="asynchronous execution;execution!asynchronous" markdown="1"><a class="gl-ref" href="../glossary/#asynchronous" markdown="1">asynchronous</a></span>.
Its designers didn't want browsers to freeze while waiting for data to arrive or for users to click on things,
so operations that might be slow are implemented by describing now what to do later.
And since anything that touches the hard drive is slow from a processor's point of view,
<a href="https://nodejs.org/en/">Node</a> implements <span class="ix-entry" ix-key="filesystem operations" markdown="1"><a class="gl-ref" href="../glossary/#filesystem" markdown="1">filesystem</a></span> operations the same way.</p>
<blockquote>
<h3>How slow is slow?</h3>
<p><span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Gregg2020">Gregg2020</a>]</span> used the analogy in <a class="tbl-ref" href="../systems-programming/#systems-programming-times">Table 2.1</a>
to show how long it takes a computer to do different things
if we imagine that one CPU cycle is equivalent to one second.</p>
</blockquote>
<div class="table"><table id="systems-programming-times"><caption>Table 2.1: Computer operation times at human scale.</caption>
<thead>
<tr>
<th>Operation</th>
<th>Actual Time</th>
<th>Would Be…</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 CPU cycle</td>
<td>0.3 nsec</td>
<td>1 sec</td>
</tr>
<tr>
<td>Main memory access</td>
<td>120 nsec</td>
<td>6 min</td>
</tr>
<tr>
<td>Solid-state disk I/O</td>
<td>50-150 μsec</td>
<td>2-6 days</td>
</tr>
<tr>
<td>Rotational disk I/O</td>
<td>1-10 msec</td>
<td>1-12 months</td>
</tr>
<tr>
<td>Internet: San Francisco to New York</td>
<td>40 msec</td>
<td>4 years</td>
</tr>
<tr>
<td>Internet: San Francisco to Australia</td>
<td>183 msec</td>
<td>19 years</td>
</tr>
<tr>
<td>Physical system reboot</td>
<td>5 min</td>
<td>32,000 years</td>
</tr>
</tbody>
</table>
</div>
<p>Early JavaScript programs used <span class="ix-entry" ix-key="callback function" markdown="1"><a class="gl-ref" href="../glossary/#callback" markdown="1">callback functions</a></span> to describe asynchronous operations,
but as we're about to see,
callbacks can be hard to understand even in small programs.
In 2015,
the language's developers standardized a higher-level tool called promises
to make callbacks easier to manage,
and more recently they have added new keywords called <code>async</code> and <code>await</code> to make it easier still.
We need to understand all three layers in order to debug things when they go wrong,
so this chapter explores callbacks,
while <a class="x-ref" href="#async-programming">Chapter 3</a> shows how promises and <code>async</code>/<code>await</code> work.
This chapter also shows how to read and write files and directories with Node's standard libraries,
because we're going to be doing that a lot.</p>
<h2 id="systems-programming-ls">Section 2.1: How can we list a directory?</h2>
<p>To start,
let's try listing the contents of a directory the way we would in <span class="ix-entry" ix-key="Python" markdown="1"><a href="https://www.python.org/">Python</a></span>
or <span class="ix-entry" ix-key="Java" markdown="1"><a href="https://en.wikipedia.org/wiki/Java_(programming_language)">Java</a></span>:</p>
<div class="code-sample lang-js" title="list-dir-wrong.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We use <span class="ix-entry" ix-key="import module" markdown="1"><code>import <em>module</em> from 'source'</code></span> to load the library <code><em>source</em></code>
and assign its contents to <code><em>module</em></code>.
After that,
we can refer to things in the library using <code><em>module.component</em></code>
just as we refer to things in any other object.
We can use whatever name we want for the module,
which allows us to give short nicknames to libraries with long names;
we will take advantage of this in future chapters.</p>
<blockquote>
<h3><code>require</code> versus <code>import</code></h3>
<p>In 2015, a new version of JavaScript called ES6 introduced
the keyword <span class="ix-entry" ix-key="import vs. require;require vs. import" markdown="1"><code>import</code></span> for importing modules.
It improves on the older <code>require</code> function in several ways,
but Node still uses <code>require</code> by default.
To tell it to use <code>import</code>,
we have added <code>"type": "module"</code> at the top level of our Node <code>package.json</code> file.</p>
</blockquote>
<p>Our little program uses the <a href="https://nodejs.org/api/fs.html"><code>fs</code></a> library
which contains functions to create directories, read or delete files, etc.
(Its name is short for "filesystem".)
We tell the program what to list using <span class="ix-entry" ix-key="command-line argument" markdown="1"><a class="gl-ref" href="../glossary/#command_line_argument" markdown="1">command-line arguments</a></span>,
which Node automatically stores in an array called <span class="ix-entry" ix-key="process.argv" markdown="1"><code>process.argv</code></span>.
<code>process.argv[0]</code> is the name of the program used to run our code (in this case <code>node</code>),
while <code>process.argv[1]</code> is the name of our program (in this case <code>list-dir-wrong.js</code>);
the rest of <code>process.argv</code> holds whatever arguments we gave at the command line when we ran the program,
so <code>process.argv[2]</code> is the first argument after the name of our program (<a class="fig-ref" href="../systems-programming/#systems-programming-process-argv">Figure 2.1</a>):</p>
<figure id="systems-programming-process-argv">
<img alt="Command-line arguments in `process.argv`" src="./systems-programming/process-argv.svg"/>
<figcaption markdown="1">Figure 2.1: How Node stores command-line arguments in <code>process.argv</code>.</figcaption>
</figure>
<div class="pagebreak"></div>
<p>If we run this program with the name of a directory as its argument,
<code>fs.readdir</code> returns the names of the things in that directory as an array of strings.
The program uses <code>for (const name of results)</code> to loop over the contents of that array.
We could use <code>let</code> instead of <code>const</code>,
but it's good practice to declare things as <span class="ix-entry" ix-key="const declaration!advantages of" markdown="1"><code>const</code></span> wherever possible
so that anyone reading the program knows the variable isn't actually going to vary---doing
this reduces the <span class="ix-entry" ix-key="cognitive load" markdown="1"><a class="gl-ref" href="../glossary/#cognitive_load" markdown="1">cognitive load</a></span> on people reading the program.
Finally,
<span class="ix-entry" ix-key="console.log" markdown="1"><code>console.log</code></span> is JavaScript's equivalent of other languages' <code>print</code> command;
its strange name comes from the fact that
its original purpose was to create <a class="gl-ref" href="../glossary/#log_message" markdown="1">log messages</a> in the browser <a class="gl-ref" href="../glossary/#console" markdown="1">console</a>.</p>
<p>Unfortunately,
our program doesn't work:</p>
<div class="code-sample lang-sh" title="list-dir-wrong.sh">
<div class="highlight"><pre><span></span><code>node list-dir-wrong.js .
</code></pre></div>
</div>
<div class="code-sample lang-out" title="list-dir-wrong.out">
<div class="highlight"><pre><span></span><code>node:internal/process/esm_loader:74
    internalBinding('errors').triggerUncaughtException(
                              ^

TypeError [ERR_INVALID_CALLBACK]: Callback must be a function. Received \
undefined
    at makeCallback (node:fs:181:3)
    at Object.readdir (node:fs:1030:14)
    at /u/stjs/systems-programming/list-dir-wrong.js:4:20
    at ModuleJob.run (node:internal/modules/esm/module_job:154:23)
    at async Loader.import (node:internal/modules/esm/loader:177:24)
    at async Object.loadESM (node:internal/process/esm_loader:68:5) {
  code: 'ERR_INVALID_CALLBACK'
}
</code></pre></div>
</div>
<p class="continue">The error message comes from something we didn't write whose source we would struggle to read.
If we look for the name of our file (<code>list-dir-wrong.js</code>)
we see the error occurred on line 4;
everything above that is inside <code>fs.readdir</code>,
while everything below it is Node loading and running our program.</p>
<p>The problem is that <code>fs.readdir</code> doesn't return anything.
Instead,
its documentation says that it needs a callback function
that tells it what to do when data is available,
so we need to explore those in order to make our program work.</p>
<blockquote>
<h3>A theorem</h3>
<ol>
<li>Every program contains at least one bug.</li>
<li>Every program can be made one line shorter.</li>
<li>Therefore, every program can be reduced to a single statement which is wrong.</li>
</ol>
<p>--- variously attributed</p>
</blockquote>
<h2 id="systems-programming-callback">Section 2.2: What is a callback function?</h2>
<p>JavaScript uses a <span class="ix-entry" ix-key="single-threaded execution;execution!single-threaded" markdown="1"><a class="gl-ref" href="../glossary/#single_threaded" markdown="1">single-threaded</a></span> programming model:
as the introduction to this lesson said,
it splits operations like file I/O into "please do this" and "do this when data is available".
<code>fs.readdir</code> is the first part,
but we need to write a function that specifies the second part.</p>
<p>JavaScript saves a reference to this function
and calls with a specific set of parameters when our data is ready
(<a class="fig-ref" href="../systems-programming/#systems-programming-callbacks">Figure 2.2</a>).
Those parameters defined a standard <span class="ix-entry" ix-key="protocol!API as;API!as protocol" markdown="1"><a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a></span>
for connecting to libraries,
just like the USB standard allows us to plug hardware devices together.</p>
<figure id="systems-programming-callbacks">
<img alt="Running callbacks" src="./systems-programming/callbacks.svg"/>
<figcaption markdown="1">Figure 2.2: How JavaScript runs callback functions.</figcaption>
</figure>
<p>This corrected program gives <code>fs.readdir</code> a callback function called <code>listContents</code>:</p>
<div class="code-sample lang-js" title="list-dir-function-defined.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">listContents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'running callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">,</span><span class="w"> </span><span class="nx">listContents</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'last line of program'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue"><span class="ix-entry" ix-key="callback function!conventions for" markdown="1">Node callbacks</span>
always get an error (if there is any) as their first argument
and the result of a successful function call as their second.
The function can tell the difference by checking to see if the error argument is <code>null</code>.
If it is, the function lists the directory's contents with <code>console.log</code>,
otherwise, it uses <code>console.error</code> to display the error message.
Let's run the program with the <a class="gl-ref" href="../glossary/#current_working_directory" markdown="1">current working directory</a>
(written as '.')
as an argument:</p>
<div class="code-sample lang-sh" title="list-dir-function-defined.sh">
<div class="highlight"><pre><span></span><code>node list-dir-function-defined.js .
</code></pre></div>
</div>
<div class="code-sample lang-out" title="list-dir-function-defined.slice.out">
<div class="highlight"><pre><span></span><code>last line of program
running callback
Makefile
copy-file-filtered.js
copy-file-unfiltered.js
...
x-trace-anonymous
x-trace-anonymous.md
x-trace-callback
x-trace-callback.md
x-where-is-node.md
</code></pre></div>
</div>
<p>Nothing that follows will make sense if we don't understand
the order in which Node executes the statements in this program
(<a class="fig-ref" href="../systems-programming/#systems-programming-execution-order">Figure 2.3</a>):</p>
<ol>
<li>
<p>Execute the first line to load the <code>fs</code> library.</p>
</li>
<li>
<p>Define a function of two parameters and assign it to <code>listContents</code>.
    (Remember, a function is just another kind of data.)</p>
</li>
<li>
<p>Get the name of the directory from the command-line arguments.</p>
</li>
<li>
<p>Call <code>fs.readdir</code> to start a filesystem operation,
    telling it what directory we want to read and what function to call when data is available.</p>
</li>
<li>
<p>Print a message to show we're at the end of the file.</p>
</li>
<li>
<p>Wait until the filesystem operation finishes (this step is invisible).</p>
</li>
<li>
<p>Run the callback function, which prints the directory listing.</p>
</li>
</ol>
<figure id="systems-programming-execution-order">
<img alt="Callback execution order" src="./systems-programming/execution-order.svg"/>
<figcaption markdown="1">Figure 2.3: When JavaScript runs callback functions.</figcaption>
</figure>
<h2 id="systems-programming-anonymous">Section 2.3: What are anonymous functions?</h2>
<p>Most JavaScript programmers wouldn't define the function <code>listContents</code>
and then pass it as a callback.
Instead,
since the callback is only used in one place,
it is more <a class="gl-ref" href="../glossary/#idiomatic" markdown="1">idiomatic</a>
to define it where it is needed
as an <span class="ix-entry" ix-key="anonymous function;function!anonymous" markdown="1"><a class="gl-ref" href="../glossary/#anonymous_function" markdown="1">anonymous function</a></span>.
This makes it easier to see what's going to happen when the operation completes,
though it means the order of execution is quite different from the order of reading
(<a class="fig-ref" href="../systems-programming/#systems-programming-anonymous-functions">Figure 2.4</a>).
Using an anonymous function gives us the final version of our program:</p>
<div class="code-sample lang-js" title="list-dir-function-anonymous.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="systems-programming-anonymous-functions">
<img alt="Anonymous functions as callbacks" src="./systems-programming/anonymous-functions.svg"/>
<figcaption markdown="1">Figure 2.4: How and when JavaScript creates and runs anonymous callback functions.</figcaption>
</figure>
<blockquote>
<h3>Functions are data</h3>
<p>As we noted above,
a function is just <span class="ix-entry" ix-key="code!as data" markdown="1">another kind of data</span>.
Instead of being made up of numbers, characters, or pixels, it is made up of instructions,
but these are stored in memory like anything else.
Defining a function on the fly is no different from defining an array in-place using <code>[1, 3, 5]</code>,
and passing a function as an argument to another function is no different from passing an array.
We are going to rely on this insight over and over again in the coming lessons.</p>
</blockquote>
<h2 id="systems-programming-fileset">Section 2.4: How can we select a set of files?</h2>
<p>Suppose we want to copy some files instead of listing a directory's contents.
Depending on the situation
we might want to copy only those files given on the command line
or all files except some explicitly excluded.
What we <em>don't</em> want to have to do is list the files one by one;
instead,
we want to be able to write patterns like <code>*.js</code>.</p>
<p>To find files that match patterns like that,
we can use the <a href="https://www.npmjs.com/package/glob"><code>glob</code></a> module.
(To <span class="ix-entry" ix-key="globbing" markdown="1"><a class="gl-ref" href="../glossary/#globbing" markdown="1">glob</a></span> (short for "global") is an old Unix term for matching a set of files by name.)
The <code>glob</code> module provides a function that takes a pattern and a callback
and does something with every filename that matched the pattern:</p>
<div class="code-sample lang-js" title="glob-all-files.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="s1">'**/*.*'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="glob-all-files.slice.out">
<div class="highlight"><pre><span></span><code>copy-file-filtered.js
copy-file-unfiltered.js
copy-file-unfiltered.out
copy-file-unfiltered.sh
copy-file-unfiltered.txt
...
x-trace-anonymous.md
x-trace-anonymous/trace.js
x-trace-callback.md
x-trace-callback/trace.js
x-where-is-node.md
</code></pre></div>
</div>
<p>The leading <code>**</code> means "recurse into subdirectories",
while <code>*.*</code> means "any characters followed by '.' followed by any characters"
(<a class="fig-ref" href="../systems-programming/#systems-programming-globbing">Figure 2.5</a>).
Names that don't match <code>*.*</code> won't be included,
and by default,
neither are names that start with a '.' character.
This is another old Unix convention:
files and directories whose names have a leading '.'
usually contain configuration information for various programs,
so most commands will leave them alone unless told to do otherwise.</p>
<figure id="systems-programming-globbing">
<img alt="Matching filenames with `glob`" src="./systems-programming/globbing.svg"/>
<figcaption markdown="1">Figure 2.5: Using `glob` patterns to match filenames.</figcaption>
</figure>
<p>This program works,
but we probably don't want to copy Emacs backup files whose names end with <code>~</code>.
We can get rid of them by <span class="ix-entry" ix-key="globbing!filtering results" markdown="1"><a class="gl-ref" href="../glossary/#filter" markdown="1">filtering</a></span> the list that <code>glob</code> returns:</p>
<div class="code-sample lang-js" title="glob-get-then-filter-pedantic.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="s1">'**/*.*'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">f</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="nx">f</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'~'</span><span class="p">)</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="glob-get-then-filter-pedantic.slice.out">
<div class="highlight"><pre><span></span><code>copy-file-filtered.js
copy-file-unfiltered.js
copy-file-unfiltered.out
copy-file-unfiltered.sh
copy-file-unfiltered.txt
...
x-trace-anonymous.md
x-trace-anonymous/trace.js
x-trace-callback.md
x-trace-callback/trace.js
x-where-is-node.md
</code></pre></div>
</div>
<p><span class="ix-entry" ix-key="Array.filter" markdown="1"><code>Array.filter</code></span> creates a new array
containing all the items of the original array that pass a test
(<a class="fig-ref" href="../systems-programming/#systems-programming-array-filter">Figure 2.6</a>).
The test is specified as a callback function
that <code>Array.filter</code> calls once once for each item.
This function must return a <a class="gl-ref" href="../glossary/#boolean" markdown="1">Boolean</a>
that tells <code>Array.filter</code> whether to keep the item in the new array or not.
<code>Array.filter</code> does not modify the original array,
so we can filter our original list of filenames several times if we want to.</p>
<figure id="systems-programming-array-filter">
<img alt="Using `Array.filter`" src="./systems-programming/array-filter.svg"/>
<figcaption markdown="1">Figure 2.6: Selecting array elements using `Array.filter`.</figcaption>
</figure>
<p>We can make our globbing program more idiomatic by
removing the parentheses around the single parameter
and writing just the expression we want the function to return:</p>
<div class="code-sample lang-js" title="glob-get-then-filter-idiomatic.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="s1">'**/*.*'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">f</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'~'</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>However,
it turns out that <code>glob</code> will filter for us.
According to its documentation,
the function takes an <code>options</code> object full of key-value settings
that control its behavior.
This is another common pattern in Node libraries:
rather than accepting a large number of rarely-used parameters,
a function can take a single object full of settings.</p>
<p>If we use this,
our program becomes:</p>
<div class="code-sample lang-js" title="glob-filter-with-options.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="s1">'**/*.*'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Notice that we don't quote the key in the <code>options</code> object.
The keys in objects are almost always strings,
and if a string is simple enough that it won't confuse the parser,
we don't need to put quotes around it.
Here,
"simple enough" means "looks like it could be a variable name",
or equivalently "contains only letters, digits, and the underscore".</p>
<blockquote>
<h3>No one knows everything</h3>
<p>We combined <code>glob.glob</code> and <code>Array.filter</code> in our functions for more than a year
before someone pointed out the <code>ignore</code> option for <code>glob.glob</code>.
This shows:</p>
<ol>
<li>
<p>Life is short,
    so most of us find a way to solve the problem in front of us
    and re-use it rather than looking for something better.</p>
</li>
<li>
<p>Code reviews aren't just about finding bugs:
    they are also the most effective way to transfer knowledge between programmers.
    Even if someone is much more experienced than you,
    there's a good chance you might have stumbled over a better way to do something
    than the one they're using (see point #1 above).</p>
</li>
</ol>
</blockquote>
<p>To finish off our globbing program,
let's specify a source directory on the command line and include that in the pattern:</p>
<div class="code-sample lang-js" title="glob-with-source-directory.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This program uses <span class="ix-entry" ix-key="string interpolation" markdown="1"><a class="gl-ref" href="../glossary/#string_interpolation" markdown="1">string interpolation</a></span>
to insert the value of <code>srcDir</code> into a string.
The template string is written in back quotes,
and JavaScript converts every expression written as <code>${expression}</code> to text.
We could create the pattern by concatenating strings using
<code>srcDir + '/**/*.*'</code>,
but most programmers find interpolation easier to read.</p>
<h2 id="systems-programming-copy">Section 2.5: How can we copy a set of files?</h2>
<p>If we want to copy a set of files instead of just listing them
we need a way to create the <a class="gl-ref" href="../glossary/#path" markdown="1">paths</a> of the files we are going to create.
If our program takes a second argument that specifies the desired output directory,
we can construct the full output path by replacing the name of the source directory with that path:</p>
<div class="code-sample lang-js" title="glob-with-dest-directory.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">srcDir</span><span class="p">,</span><span class="w"> </span><span class="nx">dstDir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">srcName</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">srcName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">,</span><span class="w"> </span><span class="nx">dstDir</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">srcName</span><span class="p">,</span><span class="w"> </span><span class="nx">dstName</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This program uses <span class="ix-entry" ix-key="destructuring assignment;assignment!destructuring" markdown="1"><a class="gl-ref" href="../glossary/#destructuring_assignment" markdown="1">destructuring assignment</a></span>
to create two variables at once
by unpacking the elements of an array
(<a class="fig-ref" href="../systems-programming/#systems-programming-destructuring-assignment">Figure 2.7</a>).
It only works if the array contains the enough elements,
i.e.,
if both a source and destination are given on the command line;
we'll add a check for that in the exercises.</p>
<figure id="systems-programming-destructuring-assignment">
<img alt="Matching values with destructuring assignment" src="./systems-programming/destructuring-assignment.svg"/>
<figcaption markdown="1">Figure 2.7: Assigning many values at once by destructuring.</figcaption>
</figure>
<p>A more serious problem is that
this program only works if the destination directory already exists:
<code>fs</code> and equivalent libraries in other languages usually won't create directories for us automatically.
The need to do this comes up so often that there is a function called <code>ensureDir</code> to do it:</p>
<div class="code-sample lang-js" title="glob-ensure-output-directory.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcRoot</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">srcName</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">srcName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dstName</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">fs</span><span class="p">.</span><span class="nx">ensureDir</span><span class="p">(</span><span class="nx">dstDir</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>Notice that we import from <code>fs-extra</code> instead of <code>fs</code>;
the <a href="https://www.npmjs.com/package/fs-extra"><code>fs-extra</code></a> module provides some useful utilities on top of <code>fs</code>.
We also use <a href="https://nodejs.org/api/path.html"><code>path</code></a> to manipulate pathnames
rather than concatenating or interpolating strings
because there are a lot of tricky <a class="gl-ref" href="../glossary/#edge_case" markdown="1">edge cases</a> in pathnames
that the authors of that module have figured out for us.</p>
<blockquote>
<h3>Using distinct names</h3>
<p>We are now calling our command-line arguments <code>srcRoot</code> and <code>dstRoot</code>
rather than <code>srcDir</code> and <code>dstDir</code>.
We originally used <code>dstDir</code> as both
the name of the top-level destination directory (from the command line)
and the name of the particular output directory to create.
This was legal,
since every function creates
a new <span class="ix-entry" ix-key="scope!of variable definitions;variable definition!scope" markdown="1"><a class="gl-ref" href="../glossary/#scope" markdown="1">scope</a></span>,
but hard for people to understand.</p>
</blockquote>
<p>Our file copying program currently creates empty destination directories
but doesn't actually copy any files.
Let's use <code>fs.copy</code> to do that:</p>
<div class="code-sample lang-js" title="copy-file-unfiltered.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcRoot</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">srcName</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">srcName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dstName</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">fs</span><span class="p">.</span><span class="nx">ensureDir</span><span class="p">(</span><span class="nx">dstDir</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">fs</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">srcName</span><span class="p">,</span><span class="w"> </span><span class="nx">dstName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>The program now has three levels of callback
(<a class="fig-ref" href="../systems-programming/#systems-programming-triple-callback">Figure 2.8</a>):</p>
<ol>
<li>
<p>When <code>glob</code> has data, do things and then call <code>ensureDir</code>.</p>
</li>
<li>
<p>When <code>ensureDir</code> completes, copy a file.</p>
</li>
<li>
<p>When <code>copy</code> finishes, check the error status.</p>
</li>
</ol>
<figure id="systems-programming-triple-callback">
<img alt="Three levels of callback" src="./systems-programming/triple-callback.svg"/>
<figcaption markdown="1">Figure 2.8: Three levels of callback in the running example.</figcaption>
</figure>
<p>Our program looks like it should work,
but if we try to copy everything in the directory containing these lessons
we get an error message:</p>
<div class="code-sample lang-sh" title="copy-file-unfiltered.sh">
<div class="highlight"><pre><span></span><code>rm -rf /tmp/out
mkdir /tmp/out
node copy-file-unfiltered.js ../node_modules /tmp/out <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> head -n <span class="m">6</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="copy-file-unfiltered.out">
<div class="highlight"><pre><span></span><code>[Error: ENOENT: no such file or directory, chmod \
'/tmp/out/@nodelib/fs.stat/README.md'] {
  errno: -2,
  code: 'ENOENT',
  syscall: 'chmod',
  path: '/tmp/out/@nodelib/fs.stat/README.md'
}
</code></pre></div>
</div>
<p>The problem is that <code>node_modules/fs.stat</code> and <code>node_modules/fs.walk</code> match our globbing expression,
but are directories rather than files.
To prevent our program from trying to use <code>fs.copy</code> on directories,
we must use <code>fs.stat</code> to get the properties of the thing whose name <code>glob</code> has given us
and then check if it's a file.
The name "stat" is short for "status",
and since the status of something in the filesystem can be very complex,
<span class="ix-entry" ix-key="fs.stat" markdown="1"><code>fs.stat</code></span> returns <a href="https://nodejs.org/api/fs.html#fs_class_fs_stats">an object with methods that can answer common questions</a>.</p>
<p>Here's the final version of our file copying program:</p>
<div class="code-sample lang-js" title="copy-file-filtered.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>

<span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcRoot</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ignore</span><span class="o">:</span><span class="w"> </span><span class="s1">'*~'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">srcName</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">srcName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">srcName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">srcRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">dstRoot</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dstName</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="nx">fs</span><span class="p">.</span><span class="nx">ensureDir</span><span class="p">(</span><span class="nx">dstDir</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="nx">fs</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">srcName</span><span class="p">,</span><span class="w"> </span><span class="nx">dstName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">              </span><span class="p">})</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">It works,
but four levels of asynchronous callbacks is hard for humans to understand.
<a class="x-ref" href="#async-programming">Chapter 3</a> will introduce a pair of tools
that make code like this easier to read.</p>
<div class="break-before"></div>
<h2 id="systems-programming-exercises">Section 2.6: Exercises</h2>
<h3 class="exercise">Where is Node?</h3>
<p>Write a program called <code>wherenode.js</code> that prints the full path to the version of Node is is run with.</p>
<h3 class="exercise">Tracing callbacks</h3>
<p>In what order does the program below print messages?</p>
<div class="code-sample lang-js" title="trace.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'RED'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">green</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'GREEN'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">func</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'BLUE'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">left</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">blue</span><span class="p">(</span><span class="nx">green</span><span class="p">,</span><span class="w"> </span><span class="nx">red</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<h3 class="exercise">Tracing anonymous callbacks</h3>
<p>In what order does the program below print messages?</p>
<div class="code-sample lang-js" title="trace.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'BLUE'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">left</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">blue</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'GREEN'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">callback</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'RED'</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<h3 class="exercise">Checking arguments</h3>
<p>Modify the file copying program to check that it has been given the right number of command-line arguments
and to print a sensible error message (including a usage statement) if it hasn't.</p>
<h3 class="exercise">Significant entries</h3>
<p><code>count-lines-histogram.js</code> displays many zeroes and gives no visual sense of how large entries are.
Modify it so that:</p>
<ol>
<li>
<p>When it is run with the <code>--nonzero</code> flag only non-zero values are shown.</p>
</li>
<li>
<p>When it is run with the <code>--graphical</code> flag the numeric values are replaced with rows of asterisks.</p>
</li>
<li>
<p>If both flags are given the program prints an error message instead of running.</p>
</li>
</ol>
<h3 class="exercise">Glob patterns</h3>
<p>What filenames does each of the following glob patterns match?</p>
<ul>
<li><code>results-[0123456789].csv</code></li>
<li><code>results.(tsv|csv)</code></li>
<li><code>results.dat?</code></li>
<li><code>./results.data</code></li>
</ul>
<h3 class="exercise">Filtering arrays</h3>
<p>Fill in the blank in the code below so that it runs correctly.
Note: you can compare strings in JavaScript using <code>&lt;</code>, <code>&gt;=</code>, and other operators,
so that (for example) <code>person.personal &gt; 'P'</code> is <code>true</code>
if someone's personal name starts with a letter that comes after 'P' in the alphabet.</p>
<div class="code-sample lang-js" title="filter.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">people</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Jean'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Jennings'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Marlyn'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Wescoff'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Ruth'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lichterman'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Betty'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Snyder'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Frances'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Bilas'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Kay'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'McNulty'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">people</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">____</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">____</span><span class="p">)</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-txt" title="filter.txt">
<div class="highlight"><pre><span></span><code>[
  { personal: 'Jean', family: 'Jennings' },
  { personal: 'Ruth', family: 'Lichterman' },
  { personal: 'Frances', family: 'Bilas' }
]
</code></pre></div>
</div>
<h3 class="exercise">String interpolation</h3>
<p>Fill in the code below so that it prints the message shown.</p>
<div class="code-sample lang-js" title="interpolate.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">people</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Christine'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Darden'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Mary'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Jackson'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Katherine'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Johnson'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">personal</span><span class="o">:</span><span class="w"> </span><span class="s1">'Dorothy'</span><span class="p">,</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s1">'Vaughan'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">person</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">people</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`$____, $____`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-txt" title="interpolate.txt">
<div class="highlight"><pre><span></span><code>Darden, Christine
Jackson, Mary
Johnson, Katherine
Vaughan, Dorothy
</code></pre></div>
</div>
<h3 class="exercise">Destructuring assignment</h3>
<p>What is assigned to each named variable in each statement below?</p>
<ol>
<li><code>const first = [10, 20, 30]</code></li>
<li><code>const [first, second] = [10, 20, 30]</code></li>
<li><code>const [first, second, third] = [10, 20, 30]</code></li>
<li><code>const [first, second, third, fourth] = [10, 20, 30]</code></li>
<li><code>const {left, right} = {left: 10, right: 30}</code></li>
<li><code>const {left, middle, right} = {left: 10, middle: 20, right: 30}</code></li>
</ol>
<h3 class="exercise">Counting lines</h3>
<p>Write a program called <code>lc</code> that counts and reports the number of lines in one or more files and the total number of lines,
so that <code>lc a.txt b.txt</code> displays something like:</p>
<div class="highlight"><pre><span></span><code>a.txt 475
b.txt 31
total 506
</code></pre></div>
<h3 class="exercise">Renaming files</h3>
<p>Write a program called <code>rename</code> that takes three or more command-line arguments:</p>
<ol>
<li>A <a class="gl-ref" href="../glossary/#filename_extension" markdown="1">filename extension</a> to match.</li>
<li>An extension to replace it with.</li>
<li>The names of one or more existing files.</li>
</ol>
<p>When it runs,
<code>rename</code> renames any files with the first extension to create files with the second extension,
but will <em>not</em> overwrite an existing file.
For example,
suppose a directory contains <code>a.txt</code>, <code>b.txt</code>, and <code>b.bck</code>.
The command:</p>
<div class="highlight"><pre><span></span><code>rename .txt .bck a.txt b.txt
</code></pre></div>
<p class="continue">will rename <code>a.txt</code> to <code>a.bck</code>,
but will <em>not</em> rename <code>b.txt</code> because <code>b.bck</code> already exists.</p>
</section>
<section class="new-chapter"><h1 id="async-programming">Chapter: Chapter 3: Asynchronous Programming</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a>, <a class="gl-ref" href="../glossary/#character_encoding" markdown="1">character encoding</a>, <a class="gl-ref" href="../glossary/#class" markdown="1">class</a>, <a class="gl-ref" href="../glossary/#constructor" markdown="1">constructor</a>, <a class="gl-ref" href="../glossary/#event_loop" markdown="1">event loop</a>, <a class="gl-ref" href="../glossary/#exception" markdown="1">exception</a>, <a class="gl-ref" href="../glossary/#fluent_interface" markdown="1">fluent interface</a>, <a class="gl-ref" href="../glossary/#method" markdown="1">method</a>, <a class="gl-ref" href="../glossary/#method_chaining" markdown="1">method chaining</a>, <a class="gl-ref" href="../glossary/#non_blocking_execution" markdown="1">non-blocking execution</a>, <a class="gl-ref" href="../glossary/#promise" markdown="1">promise</a>, <a class="gl-ref" href="../glossary/#promisification" markdown="1">promisification</a>, <a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a>, <a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a>
</p>
<p>Callbacks work,
but they are hard to read and debug,
which means they only "work" in a limited sense.
JavaScript's developers added <span class="ix-entry" ix-key="promise!as alternative to callback" markdown="1"><a class="gl-ref" href="../glossary/#promise" markdown="1">promises</a></span> to the language in 2015
to make callbacks easier to write and understand,
and more recently they added the keywords <code>async</code> and <code>await</code> as well
to make asynchronous programming easier still.
To show how these work,
we will create a <a class="gl-ref" href="../glossary/#class" markdown="1">class</a> of our own called <code>Pledge</code>
that provides the same core features as promises.
Our explanation was inspired by <span class="ix-entry" ix-key="Huffine, Trey" markdown="1"><a href="https://medium.com/@treyhuffine">Trey Huffine's</a></span> <a href="https://levelup.gitconnected.com/understand-javascript-promises-by-building-a-promise-from-scratch-84c0fd855720">tutorial</a>,
and we encourage you to read that as well.</p>
<h2 id="async-programming-manage">Section 3.1: How can we manage asynchronous execution?</h2>
<p>JavaScript is built around an <span class="ix-entry" ix-key="event loop;execution!event loop" markdown="1"><a class="gl-ref" href="../glossary/#event_loop" markdown="1">event loop</a></span>.
Every task is represented by an entry in a queue;
the event loop repeatedly takes a task from the front of the queue,
runs it,
and adds any new tasks that it creates to the back of the queue to run later.
Only one task runs at a time;
each has its own <a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a>,
but objects can be shared between tasks
(<a class="fig-ref" href="../async-programming/#async-programming-event-loop">Figure 3.1</a>).</p>
<figure id="async-programming-event-loop">
<img alt="The event loop" src="./async-programming/event-loop.svg"/>
<figcaption markdown="1">Figure 3.1: Using an event loop to manage concurrent tasks.</figcaption>
</figure>
<p>Most tasks execute all the code available in the order it is written.
For example,
this one-line program uses <span class="ix-entry" ix-key="Array.forEach" markdown="1"><code>Array.forEach</code></span>
to print each element of an array in turn:</p>
<div class="code-sample lang-js" title="not-callbacks-alone.js">
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="not-callbacks-alone.out">
<div class="highlight"><pre><span></span><code>1000
1500
500
</code></pre></div>
</div>
<p>However,
a handful of special built-in functions make <a href="https://nodejs.org/en/">Node</a> switch tasks
or add new tasks to the run queue.
For example,
<span class="ix-entry" ix-key="setTimeout" markdown="1"><code>setTimeout</code></span> tells Node to run a callback function
after a certain number of milliseconds have passed.
Its first argument is a callback function that takes no arguments,
and its second is the delay.
When <code>setTimeout</code> is called,
Node sets the callback aside for the requested length of time,
then adds it to the run queue.
(This means the task runs <em>at least</em> the specified number of milliseconds later).</p>
<blockquote>
<h3>Why zero arguments?</h3>
<p><code>setTimeout</code>'s requirement that callback functions take no arguments
is another example of a <span class="ix-entry" ix-key="protocol!API as;API!as protocol" markdown="1"><a class="gl-ref" href="../glossary/#protocol" markdown="1">protocol</a></span>.
One way to think about it is that protocols allow old code to use new code:
whoever wrote <code>setTimeout</code> couldn't know what specific tasks we want to delay,
so they specified a way to wrap up any task at all.</p>
</blockquote>
<p>As the listing below shows,
the original task can generate many new tasks before it completes,
and those tasks can run in a different order than the order in which they were created
(<a class="fig-ref" href="../async-programming/#async-programming-set-timeout">Figure 3.2</a>).</p>
<div class="code-sample lang-js" title="callbacks-with-timeouts.js">
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`about to setTimeout for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`inside timer handler for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span><span class="w"> </span><span class="nx">t</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="callbacks-with-timeouts.out">
<div class="highlight"><pre><span></span><code>about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
inside timer handler for 500
inside timer handler for 1000
inside timer handler for 1500
</code></pre></div>
</div>
<figure id="async-programming-set-timeout">
<img alt="Setting a timeout" src="./async-programming/set-timeout.svg"/>
<figcaption markdown="1">Figure 3.2: Using `setTimeout` to delay operations.</figcaption>
</figure>
<p>If we give <code>setTimeout</code> a delay of zero milliseconds,
the new task can be run right away,
but any other tasks that are waiting have a chance to run as well:</p>
<div class="code-sample lang-js" title="callbacks-with-zero-timeouts.js">
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`about to setTimeout for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`inside timer handler for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="callbacks-with-zero-timeouts.out">
<div class="highlight"><pre><span></span><code>about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
inside timer handler for 1000
inside timer handler for 1500
inside timer handler for 500
</code></pre></div>
</div>
<p class="continue">We can use this trick to build a generic
<span class="ix-entry" ix-key="execution!non-blocking;non-blocking execution" markdown="1"><a class="gl-ref" href="../glossary/#non_blocking_execution" markdown="1">non-blocking function</a></span>
that takes a callback defining a task
and switches tasks if any others are available:</p>
<div class="code-sample lang-js" title="non-blocking.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">nonBlocking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`about to do nonBlocking for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">nonBlocking</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`inside timer handler for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="non-blocking.out">
<div class="highlight"><pre><span></span><code>about to do nonBlocking for 1000
about to do nonBlocking for 1500
about to do nonBlocking for 500
inside timer handler for 1000
inside timer handler for 1500
inside timer handler for 500
</code></pre></div>
</div>
<p>Node's built-in function <span class="ix-entry" ix-key="setImmediate" markdown="1"><code>setImmediate</code></span>
does exactly what our <code>nonBlocking</code> function does:
Node also has <code>process.nextTick</code>,
which doesn't do quite the same thing---we'll explore the differences in the exercises.</p>
<div class="code-sample lang-js" title="set-immediate.js">
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">1500</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`about to do setImmediate for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setImmediate</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`inside immediate handler for </span><span class="si">${</span><span class="nx">t</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="set-immediate.out">
<div class="highlight"><pre><span></span><code>about to do setImmediate for 1000
about to do setImmediate for 1500
about to do setImmediate for 500
inside immediate handler for 1000
inside immediate handler for 1500
inside immediate handler for 500
</code></pre></div>
</div>
<h2 id="async-programming-promises">Section 3.2: How do promises work?</h2>
<p>Before we start building our own <span class="ix-entry" ix-key="promise!behavior" markdown="1">promises</span>,
let's look at how we want them to work:</p>
<div class="code-sample lang-js" title="use-pledge-motivation.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pledge.js'</span><span class="w"></span>

<span class="ow">new</span><span class="w"> </span><span class="nx">Pledge</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top of a single then clause'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'about to call resolve callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'this is the result'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`in 'then' with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'first then value'</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="use-pledge-motivation.out">
<div class="highlight"><pre><span></span><code>top of a single then clause
about to call resolve callback
in 'then' with "this is the result"
</code></pre></div>
</div>
<p>This short program creates a new <code>Pledge</code>
with a callback that takes two other callbacks as arguments:
<span class="ix-entry" ix-key="promise!resolve;resolve promise" markdown="1"><code>resolve</code></span> (which will run when everything worked)
and <span class="ix-entry" ix-key="promise!reject;reject promise" markdown="1"><code>reject</code></span> (which will run when something went wrong).
The top-level callback does the first part of what we want to do,
i.e.,
whatever we want to run before we expect a delay;
for demonstration purposes, we will use <code>setTimeout</code> with zero delay to switch tasks.
Once this task resumes,
we call the <code>resolve</code> callback to trigger whatever is supposed to happen after the delay.</p>
<p>Now look at the line with <code>then</code>.
This is a <a class="gl-ref" href="../glossary/#method" markdown="1">method</a> of the <code>Pledge</code> object we just created,
and its job is to do whatever we want to do after the delay.
The argument to <code>then</code> is yet another callback function;
it will get the value passed to <code>resolve</code>,
which is how the first part of the action communicates with the second
(<a class="fig-ref" href="../async-programming/#async-programming-resolve">Figure 3.3</a>).</p>
<figure id="async-programming-resolve">
<img alt="How promises resolve" src="./async-programming/resolve.svg"/>
<figcaption markdown="1">Figure 3.3: Order of operations when a promise resolves.</figcaption>
</figure>
<p>In order to make this work,
<code>Pledge</code>'s <a class="gl-ref" href="../glossary/#constructor" markdown="1">constructor</a> must take a single function called <code>action</code>.
This function must take take two callbacks as arguments:
what to do if the action completes successfully
and what to do if it doesn't (i.e., how to handle errors).
<code>Pledge</code> will provide these callbacks to the action at the right times.</p>
<p><code>Pledge</code> also needs two methods:
<span class="ix-entry" ix-key="promise!then" markdown="1"><code>then</code></span> to enable more actions
and <span class="ix-entry" ix-key="promise!catch" markdown="1"><code>catch</code></span> to handle errors.
To simplify things just a little bit,
we will allow users to <span class="ix-entry" ix-key="method chaining" markdown="1"><a class="gl-ref" href="../glossary/#method_chaining" markdown="1">chain</a></span> as many <code>then</code>s as they want,
but only allow one <code>catch</code>.</p>
<h2 id="async-programming-fluent">Section 3.3: How can we chain operations together?</h2>
<p>A <span class="ix-entry" ix-key="fluent interface;programming style!fluent interface" markdown="1"><a class="gl-ref" href="../glossary/#fluent_interface" markdown="1">fluent interface</a></span>
is a style of object-oriented programming
in which the methods of an object return <code>this</code>
so that method calls can be chained together.
For example,
if our class is:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Fluent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{...}</span><span class="w"></span>

<span class="w">  </span><span class="nx">first</span><span class="w"> </span><span class="p">(</span><span class="nx">top</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="k">do</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">with</span><span class="w"> </span><span class="nx">top</span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">second</span><span class="w"> </span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="k">do</span><span class="w"> </span><span class="nx">something</span><span class="w"> </span><span class="kd">with</span><span class="w"> </span><span class="nx">left</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">right</span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">then we can write:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Fluent</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">f</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">).</span><span class="nx">second</span><span class="p">(</span><span class="s1">'and'</span><span class="p">,</span><span class="w"> </span><span class="s1">'goodbye'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">or even</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">Fluent</span><span class="p">()).</span><span class="nx">first</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">).</span><span class="nx">second</span><span class="p">(</span><span class="s1">'and'</span><span class="p">,</span><span class="w"> </span><span class="s1">'goodbye'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><code>Array</code>'s fluent interface lets us write expressions like
<code>Array.filter(...).map(...).map(...)</code>
that are usually more readable than assigning intermediate results to temporary variables.</p>
<p>If the original action given to our <code>Pledge</code> completes successfully,
the <code>Pledge</code> gives us a value by calling the <code>resolve</code> callback.
We pass this value to the first <code>then</code>,
pass the result of that <code>then</code> to the second one,
and so on.
If any of them fail and throw an <span class="ix-entry" ix-key="exception!in promise" markdown="1"><a class="gl-ref" href="../glossary/#exception" markdown="1">exception</a></span>,
we pass that exception to the error handler.
Putting it all together,
the whole class looks like this:</p>
<div class="code-sample lang-js" title="pledge.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">actionCallbacks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">errorCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="nx">action</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onResolve</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">onReject</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">then</span><span class="w"> </span><span class="p">(</span><span class="nx">thenHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">actionCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">thenHandler</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">errorHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">errorCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">onResolve</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">storedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">actionCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">storedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">action</span><span class="p">(</span><span class="nx">storedValue</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">actionCallbacks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">onReject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">onReject</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">errorCallback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Binding <code>this</code></h3>
<p><code>Pledge</code>'s constructor makes two calls to a special function called <span class="ix-entry" ix-key="bind method to object" markdown="1"><code>bind</code></span>.
When we create an object <code>obj</code> and call a method <code>meth</code>,
JavaScript sets the special variable <code>this</code> to <code>obj</code> inside <code>meth</code>.
If we use a method as a callback,
though,
<code>this</code> isn't automatically set to the correct object.
To convert the method to a plain old function with the right <code>this</code>,
we have to use <code>bind</code>.
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind">The documentation</a> has more details and examples.</p>
</blockquote>
<p>Let's create a <code>Pledge</code> and return a value:</p>
<div class="code-sample lang-js" title="use-pledge-return.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pledge.js'</span><span class="w"></span>

<span class="ow">new</span><span class="w"> </span><span class="nx">Pledge</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top of a single then clause'</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`then with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'first then value'</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="use-pledge-return.out">
<div class="highlight"><pre><span></span><code>top of a single then clause
</code></pre></div>
</div>
<p class="continue">Why didn't this work?</p>
<ol>
<li>
<p>We can't use <code>return</code> with pledges
    because the call stack of the task that created the pledge is gone
    by the time the pledge executes.
    Instead, we must call <code>resolve</code> or <code>reject</code>.</p>
</li>
<li>
<p>We haven't done anything that defers execution,
    i.e.,
    there is no call to <code>setTimeout</code>, <code>setImmediate</code>,
    or anything else that would switch tasks.
    Our original motivating example got this right.</p>
</li>
</ol>
<p>This example shows how we can chain actions together:</p>
<div class="code-sample lang-js" title="use-pledge-chained.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pledge.js'</span><span class="w"></span>

<span class="ow">new</span><span class="w"> </span><span class="nx">Pledge</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top of action callback with double then and a catch'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'about to call resolve callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'initial result'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'after resolve callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'end of action callback'</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`first then with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'first value'</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`second then with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'second value'</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="use-pledge-chained.out">
<div class="highlight"><pre><span></span><code>top of action callback with double then and a catch
end of action callback
about to call resolve callback
first then with "initial result"
second then with "first value"
after resolve callback
</code></pre></div>
</div>
<p class="continue">Notice that inside each <code>then</code> we <em>do</em> use <code>return</code>
because these clauses all run in a single task.
As we will see in the next section,
the full implementation of <code>Promise</code> allows us to run both normal code
and delayed tasks inside <code>then</code> handlers.</p>
<p>Finally,
in this example we explicitly signal a problem by calling <code>reject</code>
to make sure our error handling does what it's supposed to:</p>
<div class="code-sample lang-js" title="use-pledge-reject.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Pledge</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pledge.js'</span><span class="w"></span>

<span class="ow">new</span><span class="w"> </span><span class="nx">Pledge</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top of action callback with deliberate error'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'about to reject on purpose'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">reject</span><span class="p">(</span><span class="s1">'error on purpose'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`should not be here with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`in error handler with "</span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="use-pledge-reject.out">
<div class="highlight"><pre><span></span><code>top of action callback with deliberate error
about to reject on purpose
in error handler with "error on purpose"
</code></pre></div>
</div>
<h2 id="async-programming-real">Section 3.4: How are real promises different?</h2>
<p>Let's rewrite our chained pledge with built-in promises:</p>
<div class="code-sample lang-js" title="use-promise-chained.js">
<div class="highlight"><pre><span></span><code><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top of action callback with double then and a catch'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'about to call resolve callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'initial result'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'after resolve callback'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'end of action callback'</span><span class="p">)</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`first then with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'first value'</span><span class="w"></span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`second then with "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'second value'</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="use-promise-chained.out">
<div class="highlight"><pre><span></span><code>top of action callback with double then and a catch
end of action callback
about to call resolve callback
after resolve callback
first then with "initial result"
second then with "first value"
</code></pre></div>
</div>
<p>It looks almost the same,
but if we read the output carefully
we can see that the callbacks run <em>after</em> the main program finishes.
This is a signal that Node is delaying the execution of the code in the <code>then</code> handler.</p>
<p>A very common pattern is to return another promise from inside <code>then</code>
so that the next <code>then</code> is called on the returned promise,
not on the original promise
(<a class="fig-ref" href="../async-programming/#async-programming-chained">Figure 3.4</a>).
This is another way to implement a fluent interface:
if a method of one object returns a second object,
we can call a method of the second object immediately.</p>
<div class="code-sample lang-js" title="promise-example.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`constructing promise: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">resolve</span><span class="p">(</span><span class="sb">`resolving: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'before'</span><span class="p">)</span><span class="w"></span>
<span class="nx">delay</span><span class="p">(</span><span class="s1">'outer delay'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`first then: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">delay</span><span class="p">(</span><span class="s1">'inner delay'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`second then: </span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'after'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="promise-example.out">
<div class="highlight"><pre><span></span><code>before
constructing promise: outer delay
after
first then: resolving: outer delay
constructing promise: inner delay
second then: resolving: inner delay
</code></pre></div>
</div>
<figure id="async-programming-chained">
<img alt="Chained promises" src="./async-programming/chained.svg"/>
<figcaption markdown="1">Figure 3.4: Chaining promises to make asynchronous operations depend on each other.</figcaption>
</figure>
<p>We therefore have three rules for chaining promises:</p>
<ol>
<li>
<p>If our code can run synchronously, just put it in <code>then</code>.</p>
</li>
<li>
<p>If we want to use our own asynchronous function,
    it must create and return a promise.</p>
</li>
<li>
<p>Finally,
    if we want to use a library function that relies on callbacks,
    we have to convert it to use promises.
    Doing this is called <a class="gl-ref" href="../glossary/#promisification" markdown="1">promisification</a>
    (because programmers will rarely pass up an opportunity add a bit of jargon to the world),
    and most functions in the Node have already been promisified.</p>
</li>
</ol>
<h2 id="async-programming-tools">Section 3.5: How can we build tools with promises?</h2>
<p>Promises may seem more complex than callbacks right now,
but that's because we're looking at how they work rather than at how to use them.
To explore the latter subject,
let's use promises to build a program to count the number of lines in a set of files.
A few moments of search on <a href="https://www.npmjs.com/">NPM</a> turns up a promisified version of <code>fs-extra</code>
called <code>fs-extra-promise</code>,
so we will rely on it for file operations.</p>
<p>Our first step is to count the lines in a single file:</p>
<div class="code-sample lang-js" title="count-lines-single-file.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">encoding</span><span class="o">:</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="count-lines-single-file.sh">
<div class="highlight"><pre><span></span><code>node count-lines-single-file.js count-lines-single-file.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="count-lines-single-file.out">
<div class="highlight"><pre><span></span><code>count-lines-single-file.js: 12
</code></pre></div>
</div>
<blockquote>
<h3>Character encoding</h3>
<p>A <span class="ix-entry" ix-key="character encoding" markdown="1"><a class="gl-ref" href="../glossary/#character_encoding" markdown="1">character encoding</a></span> specifies how characters are stored as bytes.
The most widely used is <span class="ix-entry" ix-key="UTF-8;character encoding!UTF-8" markdown="1"><a class="gl-ref" href="../glossary/#utf_8" markdown="1">UTF-8</a></span>,
which stores characters common in Western European languages in a single byte
and uses multi-byte sequences for other symbols.
If we don't specify a character encoding,
<code>fs.readFileAsync</code> gives us an array of bytes rather than a string of characters.
We can tell we've made this mistake when we try to call a method of <code>String</code>
and Node tells us we can't.</p>
</blockquote>
<p>The next step is to count the lines in multiple files.
We can use <code>glob-promise</code> to delay handling the output of <code>glob</code>,
but we need some way to create a separate task to count the lines in each file
and to wait until those line counts are available before exiting our program.</p>
<p>The tool we want is <span class="ix-entry" ix-key="Promise.all" markdown="1"><code>Promise.all</code></span>,
which waits until all of the promises in an array have completed.
To make our program a little more readable,
we will put the creation of the promise for each file in a separate function:</p>
<div class="code-sample lang-js" title="count-lines-globbed-files.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lineCount</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">counts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">counts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">c</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">lineCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">encoding</span><span class="o">:</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">main</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="count-lines-globbed-files.sh">
<div class="highlight"><pre><span></span><code>node count-lines-globbed-files.js .
</code></pre></div>
</div>
<div class="code-sample lang-out" title="count-lines-globbed-files.slice.out">
<div class="highlight"><pre><span></span><code>10
1
12
4
1
...
3
2
5
2
14
</code></pre></div>
</div>
<p>However,
we want to display the names of the files whose lines we're counting along with the counts.
To do this our <code>then</code> must return two values.
We could put them in an array,
but it's better practice to construct a temporary object with named fields
(<a class="fig-ref" href="../async-programming/#async-programming-temporary-named-fields">Figure 3.5</a>).
This approach allows us to add or rearrange fields without breaking code
and also serves as a bit of documentation.
With this change
our line-counting program becomes:</p>
<div class="code-sample lang-js" title="count-lines-print-filenames.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lineCount</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">counts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">counts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">lines</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">lineCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">encoding</span><span class="o">:</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">({</span><span class="w"></span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">lines</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">main</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="async-programming-temporary-named-fields">
<img alt="Temporary objects with named fields" src="./async-programming/temporary-named-fields.svg"/>
<figcaption markdown="1">Figure 3.5: Creating temporary objects with named fields to carry values forward.</figcaption>
</figure>
<p>As in <a class="x-ref" href="#systems-programming">Chapter 2</a>,
this works until we run into a directory whose name name matches <code>*.*</code>,
which we do when counting the lines in the contents of <code>node_modules</code>.
The solution once again is to use <code>stat</code> to check if something is a file or not
before trying to read it.
And since <code>stat</code> returns an object that doesn't include the file's name,
we create another temporary object to pass information down the chain of <code>then</code>s.</p>
<div class="code-sample lang-js" title="count-lines-with-stat.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">statPair</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pair</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">pair</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">filename</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">files</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">lineCount</span><span class="p">(</span><span class="nx">f</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">counts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">counts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">lines</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">statPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">stats</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="p">}))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">lineCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">encoding</span><span class="o">:</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">({</span><span class="w"></span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">lines</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">main</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="count-lines-with-stat.sh">
<div class="highlight"><pre><span></span><code>node count-lines-with-stat.js .
</code></pre></div>
</div>
<div class="code-sample lang-out" title="count-lines-with-stat.slice.out">
<div class="highlight"><pre><span></span><code>10: ./assign-immediately.js
1: ./assign-immediately.out
12: ./await-fs.js
4: ./await-fs.out
1: ./await-fs.sh
...
3: ./x-multiple-catch/example.js
2: ./x-multiple-catch/example.txt
5: ./x-trace-load.md
2: ./x-trace-load/config.yml
14: ./x-trace-load/example.js
</code></pre></div>
</div>
<p class="continue">This code is complex, but much simpler than it would be if we were using callbacks.</p>
<blockquote>
<h3>Lining things up</h3>
<p>This code uses the expression <code>{filename, stats}</code>
to create an object whose keys are <code>filename</code> and <code>stats</code>,
and whose values are the values of the corresponding variables.
Doing this makes the code easier to read,
both because it's shorter
but also because it signals that the value associated with the key <code>filename</code>
is exactly the value of the variable with the same name.</p>
</blockquote>
<h2 id="async-programming-readable">Section 3.6: How can we make this more readable?</h2>
<p>Promises eliminate the deep nesting associated with callbacks of callbacks,
but they are still hard to follow.
The latest versions of JavaScript provide two new keywords <span class="ix-entry" ix-key="async keyword" markdown="1"><code>async</code></span> and <span class="ix-entry" ix-key="await keyword" markdown="1"><code>await</code></span>
to flatten code further.
<code>async</code> means "this function implicitly returns a promise",
while <code>await</code> means "wait for a promise to resolve".
This short program uses both keywords to print the first ten characters of a file:</p>
<div class="code-sample lang-js" title="await-fs.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">firstTenCharacters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`inside, raw text is </span><span class="si">${</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> characters long`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'about to call'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">firstTenCharacters</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`function result has type </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`outside, final result is "</span><span class="si">${</span><span class="nx">value</span><span class="si">}</span><span class="sb">"`</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="await-fs.out">
<div class="highlight"><pre><span></span><code>about to call
function result has type Promise
inside, raw text is 24 characters long
outside, final result is "Begin at t"
</code></pre></div>
</div>
<blockquote class="break-before">
<h3>Translating code</h3>
<p>When Node sees <code>await</code> and <code>async</code>
it silently <span class="ix-entry" ix-key="promise!automatic creation of" markdown="1">converts</span> the code to use promises with <code>then</code>, <code>resolve</code>, and <code>reject</code>;
we will see how this works in <a class="x-ref" href="#code-generator">Chapter 15</a>.
In order to provide a context for this transformation
we must put <code>await</code> inside a function that is declared to be <code>async</code>:
we can't simply write <code>await fs.statAsync(...)</code> at the top level of our program
outside a function.
This requirement is occasionally annoying,
but since we should be putting our code in functions anyway
it's hard to complain.</p>
</blockquote>
<p>To see how much cleaner our code is with <code>await</code> and <code>async</code>,
let's rewrite our line counting program to use them.
First,
we modify the two helper functions to look like they're waiting for results and returning them.
They actually wrap their results in promises and return those,
but Node now takes care of that for us:</p>
<div class="code-sample lang-js" title="count-lines-with-stat-async.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">statPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">lineCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">filename</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">lines</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Next,
we modify <code>main</code> to wait for things to complete.
We must still use <code>Promise.all</code> to handle the promises
that are counting lines for individual files,
but the result is less cluttered than our previous version.</p>
<div class="code-sample lang-js" title="count-lines-with-stat-async.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">srcDir</span><span class="si">}</span><span class="sb">/**/*.*`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pairs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">statPair</span><span class="p">(</span><span class="nx">filename</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pairs</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">pair</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">pair</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pair</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">lineCount</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">counts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">lines</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">srcDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">main</span><span class="p">(</span><span class="nx">srcDir</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<h2 id="async-programming-errors">Section 3.7: How can we handle errors with asynchronous code?</h2>
<p>We created several intermediate variables in the line-counting program to make the steps clearer.
Doing this also helps with error handling:
to see how,
we will build up an example in stages.</p>
<p>First,
if we return a promise that fails without using <code>await</code>,
then our main function will finish running before the error occurs,
and our <code>try</code>/<code>catch</code> doesn't help us
(<a class="fig-ref" href="../async-programming/#async-programming-handling-errors">Figure 3.6</a>):</p>
<div class="code-sample lang-js" title="return-immediately.js">
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">returnImmediately</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'deliberate'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'caught exception'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">returnImmediately</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="return-immediately.out">
<div class="highlight"><pre><span></span><code>/u/stjs/async-programming/return-immediately.js:3
</code></pre></div>
</div>
<figure id="async-programming-handling-errors">
<img alt="Handling asynchronous errors" src="./async-programming/handling-errors.svg"/>
<figcaption markdown="1">Figure 3.6: Wrong and right ways to handle errors in asynchronous code.</figcaption>
</figure>
<p>One solution to this problem is to be consistent and always return something.
Because the function is declared <code>async</code>,
the <code>Error</code> in the code below is automatically wrapped in a promise
so we can use <code>.then</code> and <code>.catch</code> to handle it as before:</p>
<div class="code-sample lang-js" title="assign-immediately.js">
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">returnImmediately</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'deliberate'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'caught exception'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">returnImmediately</span><span class="p">()</span><span class="w"></span>
<span class="nx">result</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`caller caught </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="assign-immediately.out">
<div class="highlight"><pre><span></span><code>caller caught Error: deliberate
</code></pre></div>
</div>
<p>If instead we <span class="ix-entry" ix-key="exception!with await" markdown="1"><code>return await</code></span>,
the function waits until the promise runs before returning.
The promise is turned into an exception because it failed,
and since we're inside the scope of our <code>try</code>/<code>catch</code> block,
everything works as we want:</p>
<div class="code-sample lang-js" title="return-await.js">
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">returnAwait</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'deliberate'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'caught exception'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">returnAwait</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="return-await.out">
<div class="highlight"><pre><span></span><code>caught exception
</code></pre></div>
</div>
<p class="continue">We prefer the second approach,
but whichever you choose,
please be consistent.</p>
<div class="break-before"></div>
<h2 id="async-programming-exercises">Section 3.8: Exercises</h2>
<h3 class="exercise">Immediate versus next tick</h3>
<p>What is the difference between <code>setImmediate</code> and <code>process.nextTick</code>?
When would you use each one?</p>
<h3 class="exercise">Tracing promise execution</h3>
<ol>
<li>
<p>What does this code print and why?</p>
<div class="highlight"><pre><span></span><code><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>What does this code print and why?</p>
<div class="highlight"><pre><span></span><code><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>What does this code print and why?</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</li>
</ol>
<p>Hint: try each snippet of code interactively in the Node interpreter and as a command-line script.</p>
<h3 class="exercise">Multiple catches</h3>
<p>Suppose we create a promise that deliberately fails and then add two error handlers:</p>
<div class="code-sample lang-js" title="example.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">oops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'failure'</span><span class="p">)))</span><span class="w"></span>
<span class="nx">oops</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span><span class="w"></span>
<span class="nx">oops</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">When the code is run it produces:</p>
<div class="code-sample lang-txt" title="example.txt">
<div class="highlight"><pre><span></span><code>failure
failure
</code></pre></div>
</div>
<ol>
<li>Trace the order of operations: what is created and executed when?</li>
<li>What happens if we run these same lines interactively?
    Why do we see something different than what we see when we run this file from the command line?</li>
</ol>
<h3 class="exercise">Then after catch</h3>
<p>Suppose we create a promise that deliberately fails
and attach both <code>then</code> and <code>catch</code> to it:</p>
<div class="code-sample lang-js" title="example.js">
<div class="highlight"><pre><span></span><code><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'failure'</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">When the code is run it produces:</p>
<div class="code-sample lang-txt" title="example.txt">
<div class="highlight"><pre><span></span><code>Error: failure
    at /u/stjs/promises/catch-then/example.js:1:41
    at new Promise (&lt;anonymous&gt;)
    at Object.&lt;anonymous&gt; (/u/stjs/promises/catch-then/example.js:1:1)
    at Module._compile (internal/modules/cjs/loader.js:1151:30)
    at Object.Module._extensions..js \
 (internal/modules/cjs/loader.js:1171:10)
    at Module.load (internal/modules/cjs/loader.js:1000:32)
    at Function.Module._load (internal/modules/cjs/loader.js:899:14)
    at Function.executeUserEntryPoint [as runMain] \
 (internal/modules/run_main.js:71:12)
    at internal/main/run_main_module.js:17:47
undefined
</code></pre></div>
</div>
<ol>
<li>Trace the order of execution.</li>
<li>Why is <code>undefined</code> printed at the end?</li>
</ol>
<h3 class="exercise">Head and tail</h3>
<p>The Unix <code>head</code> command shows the first few lines of one or more files,
while the <code>tail</code> command shows the last few.
Write programs <code>head.js</code> and <code>tail.js</code> that do the same things using promises and <code>async</code>/<code>await</code>,
so that:</p>
<div class="highlight"><pre><span></span><code>node head.js <span class="m">5</span> first.txt second.txt third.txt
</code></pre></div>
<p class="continue">prints the first 5 lines of each of the three files and:</p>
<div class="highlight"><pre><span></span><code>node tail.js <span class="m">5</span> first.txt second.txt third.txt
</code></pre></div>
<p class="continue">prints the last five lines of each file.</p>
<h3 class="exercise">Histogram of line counts</h3>
<p>Extend <code>count-lines-with-stat-async.js</code> to create a program <code>lh.js</code>
that prints two columns of output:
the number of lines in one or more files
and the number of files that are that long.
For example,
if we run:</p>
<div class="highlight"><pre><span></span><code>node lh.js promises/*.*
</code></pre></div>
<p class="continue">the output might be:</p>
<table>
<thead>
<tr>
<th>Length</th>
<th>Number of Files</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>7</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>6</td>
<td>7</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
</tr>
<tr>
<td>12</td>
<td>2</td>
</tr>
<tr>
<td>13</td>
<td>1</td>
</tr>
<tr>
<td>15</td>
<td>1</td>
</tr>
<tr>
<td>17</td>
<td>2</td>
</tr>
<tr>
<td>20</td>
<td>1</td>
</tr>
<tr>
<td>24</td>
<td>1</td>
</tr>
<tr>
<td>35</td>
<td>2</td>
</tr>
<tr>
<td>37</td>
<td>3</td>
</tr>
<tr>
<td>38</td>
<td>1</td>
</tr>
<tr>
<td>171</td>
<td>1</td>
</tr>
</tbody>
</table>
<h3 class="exercise">Select matching lines</h3>
<p>Using <code>async</code> and <code>await,
write a program called</code>match.js` that finds and prints lines containing a given string.
For example:</p>
<div class="highlight"><pre><span></span><code>node match.js Toronto first.txt second.txt third.txt
</code></pre></div>
<p class="continue">would print all of the lines from the three files that contain the word "Toronto".</p>
<h3 class="exercise">Find lines in all files</h3>
<p>Using <code>async</code> and <code>await</code>,
write a program called <code>in-all.js</code> that finds and prints lines found in all of its input files.
For example:</p>
<div class="highlight"><pre><span></span><code>node <span class="k">in</span>-all.js first.txt second.txt third.txt
</code></pre></div>
<p class="continue">will print those lines that occur in all three files.</p>
<h3 class="exercise">Find differences between two files</h3>
<p>Using <code>async</code> and <code>await</code>,
write a program called <code>file-diff.js</code>
that compares the lines in two files
and shows which ones are only in the first file,
which are only in the second,
and which are in both.
For example,
if <code>left.txt</code> contains:</p>
<div class="highlight"><pre><span></span><code>some
people
</code></pre></div>
<p class="continue">and <code>right.txt</code> contains:</p>
<div class="highlight"><pre><span></span><code>write
some
code
</code></pre></div>
<p class="continue">then:</p>
<div class="highlight"><pre><span></span><code>node file-diff.js left.txt right.txt
</code></pre></div>
<p class="continue">would print:</p>
<div class="highlight"><pre><span></span><code>2 code
1 people
* some
2 write
</code></pre></div>
<p class="continue">where <code>1</code>, <code>2</code>, and <code>*</code> show whether lines are in only the first or second file
or are in both.
Note that the order of the lines in the file doesn't matter.</p>
<p>Hint: you may want to use the <code>Set</code> class to store lines.</p>
<h3 class="exercise">Trace file loading</h3>
<p>Suppose we want are loading a YAML configuration file
using the promisified version of the <code>fs</code> library.
In what order do the print statements in this test program appear and why?</p>
<div class="code-sample lang-js" title="example.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'js-yaml'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">'config.yml'</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'inside test, raw text'</span><span class="p">,</span><span class="w"> </span><span class="nx">raw</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cooked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'inside test, cooked configuration'</span><span class="p">,</span><span class="w"> </span><span class="nx">cooked</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cooked</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">test</span><span class="p">()</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'outside test, result is'</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">something</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'outside test we have'</span><span class="p">,</span><span class="w"> </span><span class="nx">something</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<h3 class="exercise">Any and all</h3>
<ol>
<li>
<p>Add a method <code>Pledge.any</code> that takes an array of pledges
    and as soon as one of the pledges in the array resolves,
    returns a single promise that resolves with the value from that pledge.</p>
</li>
<li>
<p>Add another method <code>Pledge.all</code> that takes an array of pledges
    and returns a single promise that resolves to an array
    containing the final values of all of those pledges.</p>
</li>
</ol>
<p><a href="https://2ality.com/2019/08/promise-combinators.html">This article</a> may be helpful.</p>
</section>
<section class="new-chapter"><h1 id="unit-test">Chapter: Chapter 4: Unit Testing</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>, <a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result (of test)</a>, <a class="gl-ref" href="../glossary/#assertion" markdown="1">assertion</a>, <a class="gl-ref" href="../glossary/#caching" markdown="1">caching</a>, <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>, <a class="gl-ref" href="../glossary/#design_pattern" markdown="1">design pattern</a>, <a class="gl-ref" href="../glossary/#dynamic_loading" markdown="1">dynamic loading</a>, <a class="gl-ref" href="../glossary/#error_test" markdown="1">error (in a test)</a>, <a class="gl-ref" href="../glossary/#exception_handler" markdown="1">exception handler</a>, <a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result (of test)</a>, <a class="gl-ref" href="../glossary/#exploratory_programming" markdown="1">exploratory programming</a>, <a class="gl-ref" href="../glossary/#fail_test" markdown="1">fail (a test)</a>, <a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a>, <a class="gl-ref" href="../glossary/#global_variable" markdown="1">global variable</a>, <a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a>, <a class="gl-ref" href="../glossary/#lifecycle" markdown="1">lifecycle</a>, <a class="gl-ref" href="../glossary/#pass_test" markdown="1">pass (a test)</a>, <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>, <a class="gl-ref" href="../glossary/#side_effect" markdown="1">side effect</a>, <a class="gl-ref" href="../glossary/#singleton_pattern" markdown="1">Singleton pattern</a>, <a class="gl-ref" href="../glossary/#test_runner" markdown="1">test runner</a>, <a class="gl-ref" href="../glossary/#test_subject" markdown="1">test subject</a>, <a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throw (exception)</a>, <a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit test</a>
</p>
<p>We have written many small programs in the previous two chapters,
but haven't really tested any of them.
That's OK for <span class="ix-entry" ix-key="exploratory programming" markdown="1"><a class="gl-ref" href="../glossary/#exploratory_programming" markdown="1">exploratory programming</a></span>,
but if our software is going to be used instead of just read,
we should try to make sure it works.</p>
<p>A tool for writing and running <span class="ix-entry" ix-key="unit test!requirements for" markdown="1"><a class="gl-ref" href="../glossary/#unit_test" markdown="1">unit tests</a></span> is a good first step.
Such a tool should:</p>
<ul>
<li>find files containing tests;</li>
<li>find the tests in those files;</li>
<li>run the tests;</li>
<li>capture their results; and</li>
<li>report each test's result and a summary of those results.</li>
</ul>
<p>Our design is inspired by tools like <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> and <span class="ix-entry" ix-key="Jest" markdown="1"><a href="https://jestjs.io/">Jest</a></span>,
which were in turn inspired by tools built for other languages
from the 1980s onward <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Meszaros2007">Meszaros2007</a>, <a class="bib-ref" href="../bibliography/#Tudose2020">Tudose2020</a>]</span>.</p>
<h2 id="unit-test-structure">Section 4.1: How should we structure unit testing?</h2>
<p>As in other unit testing frameworks,
each test will be a function of zero arguments
so that the framework can run them all in the same way.
Each test will create a <span class="ix-entry" ix-key="fixture (in unit test);unit test!fixture" markdown="1"><a class="gl-ref" href="../glossary/#fixture" markdown="1">fixture</a></span> to be tested
and use <span class="ix-entry" ix-key="assertion!in unit test" markdown="1"><a class="gl-ref" href="../glossary/#assertion" markdown="1">assertions</a></span>
to compare the <span class="ix-entry" ix-key="actual result (in unit test);unit test!actual result" markdown="1"><a class="gl-ref" href="../glossary/#actual_result" markdown="1">actual result</a></span>
against the <span class="ix-entry" ix-key="expected result (in unit test);unit test!expected result" markdown="1"><a class="gl-ref" href="../glossary/#expected_result" markdown="1">expected result</a></span>.
The outcome can be exactly one of:</p>
<ul>
<li>
<p><span class="ix-entry" ix-key="pass (in unit test);unit test!pass" markdown="1"><a class="gl-ref" href="../glossary/#pass_test" markdown="1">Pass</a></span>:
    the <span class="ix-entry" ix-key="test subject (in unit test);unit test!test subject" markdown="1"><a class="gl-ref" href="../glossary/#test_subject" markdown="1">test subject</a></span> works as expected.</p>
</li>
<li>
<p><span class="ix-entry" ix-key="fail (in unit test);unit test!fail" markdown="1"><a class="gl-ref" href="../glossary/#fail_test" markdown="1">Fail</a></span>:
    something is wrong with the test subject.</p>
</li>
<li>
<p><span class="ix-entry" ix-key="error (in unit test);unit test!error" markdown="1"><a class="gl-ref" href="../glossary/#error_test" markdown="1">Error</a></span>:
    something wrong in the test itself,
    which means we don't know whether the test subject is working properly or not.</p>
</li>
</ul>
<p>To make this work,
we need some way to distinguish failing tests from broken ones.
Our solution relies on the fact that exceptions are objects
and that a program can use <span class="ix-entry" ix-key="introspection!in unit testing" markdown="1"><a class="gl-ref" href="../glossary/#introspection" markdown="1">introspection</a></span>
to determine the class of an object.
If a test <span class="ix-entry" ix-key="exception!throw" markdown="1"><a class="gl-ref" href="../glossary/#throw_exception" markdown="1">throws an exception</a></span> whose class is <code>assert.AssertionError</code>,
then we will assume the exception came from
one of the assertions we put in the test as a check
(<a class="fig-ref" href="../unit-test/#unit-test-mental-model">Figure 4.1</a>).
Any other kind of assertion indicates that the test itself contains an error.</p>
<figure id="unit-test-mental-model">
<img alt="Mental model of unit testing" src="./unit-test/mental-model.svg"/>
<figcaption markdown="1">Figure 4.1: Running tests that can pass, fail, or contain errors.</figcaption>
</figure>
<h2 id="unit-test-design">Section 4.2: How can we separate registration, execution, and reporting?</h2>
<p>To start,
let's use a handful of <a class="gl-ref" href="../glossary/#global_variable" markdown="1">global variables</a> to record tests and their results:</p>
<div class="code-sample lang-js" title="dry-run.js">
<div class="highlight"><pre><span></span><code><span class="c1">// State of tests.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">HopeTests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">HopePass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">HopeFail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">HopeError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
</code></pre></div>
</div>
<p>We don't run tests immediately
because we want to wrap each one in our own <span class="ix-entry" ix-key="exception!handler" markdown="1"><a class="gl-ref" href="../glossary/#exception_handler" markdown="1">exception handler</a></span>.
Instead,
the function <code>hopeThat</code> saves a descriptive message and a callback function that implements a test
in the <code>HopeTest</code> array.</p>
<div class="code-sample lang-js" title="dry-run.js">
<div class="highlight"><pre><span></span><code><span class="c1">// Record a single test for running later.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hopeThat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">HopeTests</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Independence</h3>
<p>Because we're appending tests to an array,
they will be run in the order in which they are registered,
but we shouldn't rely on that.
Every unit test should work independently of every other
so that an error or failure in an early test
doesn't affect the result of a later one.</p>
</blockquote>
<p>Finally,
the function <code>main</code> runs all registered tests:</p>
<div class="code-sample lang-js" title="dry-run.js">
<div class="highlight"><pre><span></span><code><span class="c1">// Run all of the tests that have been asked for and report summary.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">HopeTests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">test</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">test</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="nx">HopePass</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">assert</span><span class="p">.</span><span class="nx">AssertionError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">HopeFail</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">HopeError</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`pass </span><span class="si">${</span><span class="nx">HopePass</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`fail </span><span class="si">${</span><span class="nx">HopeFail</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`error </span><span class="si">${</span><span class="nx">HopeError</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">If a test completes without an exception, it passes.
If any of the <code>assert</code> calls inside the test raises an <code>AssertionError</code>,
the test fails,
and if it raises any other exception,
it's an error.
After all tests are run,
<code>main</code> reports the number of results of each kind.</p>
<p>Let's try it out:</p>
<div class="code-sample lang-js" title="dry-run.js">
<div class="highlight"><pre><span></span><code><span class="c1">// Something to test (doesn't handle zero properly).</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// These two should pass.</span><span class="w"></span>
<span class="nx">hopeThat</span><span class="p">(</span><span class="s1">'Sign of negative is -1'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">sign</span><span class="p">(</span><span class="o">-</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="nx">hopeThat</span><span class="p">(</span><span class="s1">'Sign of positive is 1'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">sign</span><span class="p">(</span><span class="mf">19</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"></span>

<span class="c1">// This one should fail.</span><span class="w"></span>
<span class="nx">hopeThat</span><span class="p">(</span><span class="s1">'Sign of zero is 0'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">sign</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"></span>

<span class="c1">// This one is an error.</span><span class="w"></span>
<span class="nx">hopeThat</span><span class="p">(</span><span class="s1">'Sign misspelled is error'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">sgn</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>

<span class="c1">// Call the main driver.</span><span class="w"></span>
<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="dry-run.out">
<div class="highlight"><pre><span></span><code>pass 2
fail 1
error 1
</code></pre></div>
</div>
<p>This simple "framework" does what it's supposed to, but:</p>
<ol>
<li>
<p>It doesn't tell us which tests have passed or failed.</p>
</li>
<li>
<p>Those global variables should be consolidated somehow
    so that it's clear they belong together.</p>
</li>
<li>
<p>It doesn't discover tests on its own.</p>
</li>
<li>
<p>We don't have a way to test things that are supposed to raise <code>AssertionError</code>.
    Putting assertions into code to check that it is behaving correctly
    is called <a class="gl-ref" href="../glossary/#defensive_programming" markdown="1">defensive programming</a>;
    it's a good practice,
    but we should make sure those assertions are failing when they're supposed to,
    just as we should test our smoke detectors every once in a while.</p>
</li>
</ol>
<h2 id="unit-test-registration">Section 4.3: How should we structure test registration?</h2>
<p>The next version of our testing tool solves the first two problems in the original
by putting the testing machinery in a class.
It uses the <span class="ix-entry" ix-key="Singleton pattern;design pattern!Singleton" markdown="1"><a class="gl-ref" href="../glossary/#singleton_pattern" markdown="1">Singleton</a></span> <a class="gl-ref" href="../glossary/#design_pattern" markdown="1">design pattern</a>
to ensure that only one object of that class is ever created <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Osmani2017">Osmani2017</a>]</span>.
Singletons are a way to manage global variables that belong together
like the ones we're using to record tests and their results.
As an extra benefit,
if we decide later that we need several copies of those variables,
we can just construct more instances of the class.</p>
<p>The file <code>hope.js</code> defines the class and exports one instance of it:</p>
<div class="code-sample lang-js" title="hope.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">terse</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cases</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">verbose</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}${</span><span class="nx">title</span><span class="si">}</span><span class="sb">:`</span><span class="w"></span>
<span class="w">      </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'\n'</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}</span><span class="sb">  </span><span class="si">${</span><span class="nx">r</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">cases</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'passes'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">passes</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'fails'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fails</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'errors'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">errors</span><span class="p">]]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>This strategy relies on two things:</p>
<ol>
<li>
<p><a href="https://nodejs.org/en/">Node</a> executes the code in a JavaScript module as it loads it,
    which means that it runs <code>new Hope()</code> and exports the newly-created object.</p>
</li>
<li>
<p>Node <span class="ix-entry" ix-key="cache!modules;require!caching modules" markdown="1"><a class="gl-ref" href="../glossary/#caching" markdown="1">caches</a></span> modules
    so that a given module is only loaded once
    no matter how many times it is imported.
    This ensures that <code>new Hope()</code> really is only called once.</p>
</li>
</ol>
<p>Once a program has imported <code>hope</code>,
it can call <code>Hope.test</code> to record a test for later execution
and <code>Hope.run</code> to execute all of the tests registered up until that point
(<a class="fig-ref" href="../unit-test/#unit-test-hope-structure">Figure 4.2</a>).</p>
<figure id="unit-test-hope-structure">
<img alt="Recording and running tests" src="./unit-test/hope-structure.svg"/>
<figcaption markdown="1">Figure 4.2: Creating a singleton, recording tests, and running them.</figcaption>
</figure>
<p>Finally,
our <code>Hope</code> class can report results as both a terse one-line summary and as a detailed listing.
It can also provide the titles and results of individual tests
so that if someone wants to format them in a different way (e.g., as HTML) they can do so:</p>
<div class="code-sample lang-js" title="hope.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">terse</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cases</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">verbose</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cases</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}${</span><span class="nx">title</span><span class="si">}</span><span class="sb">:`</span><span class="w"></span>
<span class="w">      </span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'\n'</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}</span><span class="sb">  </span><span class="si">${</span><span class="nx">r</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">cases</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'passes'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">passes</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'fails'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fails</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'errors'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">errors</span><span class="p">]]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Who's calling?</h3>
<p><code>Hope.test</code> uses the <span class="ix-entry" ix-key="caller module" markdown="1"><a href="https://www.npmjs.com/package/caller"><code>caller</code></a></span> module
to get the name of the function that is registering a test.
Reporting the test's name helps the user figure out where to start debugging;
getting it via introspection
rather than requiring the user to pass the function's name as a string
reduces typing
and guarantees that what we report is accurate.
Programmers will often copy, paste, and modify tests;
sooner or later (probably sooner) they will forget to modify
the copy-and-pasted function name being passed into <code>Hope.test</code>
and will then lose time trying to figure out why <code>test_this</code> is failing
when the failure is actually in <code>test_that</code>.</p>
</blockquote>
<h2 id="unit-test-cli">Section 4.4: How can we build a command-line interface for testing?</h2>
<p>Most programmers don't enjoy writing tests,
so if we want them to do it,
we have to make it as painless as possible.
A couple of <code>import</code> statements to get <code>assert</code> and <code>hope</code>
and then one function call per test
is about as simple as we can make the tests themselves:</p>
<div class="code-sample lang-js" title="test-add.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">hope</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./hope.js'</span><span class="w"></span>

<span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'Sum of 1 and 2'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">((</span><span class="mf">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">3</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p>But that just defines the tests---how will we find them so that we can run them?
One option is to require people to <code>import</code> each of the files containing tests
into another file:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// all-the-tests.js</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="s1">'./test-add.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="s1">'./test-sub.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="s1">'./test-mul.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="s1">'./test-div.js'</span><span class="w"></span>

<span class="nx">Hope</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>
<p class="continue">Here,
<code>all-the-tests.js</code> imports other files so that they will register tests
as a <span class="ix-entry" ix-key="side effect!for module registration" markdown="1"><a class="gl-ref" href="../glossary/#side_effect" markdown="1">side effect</a></span> via calls to <code>hope.test</code>
and then calls <code>Hope.run</code> to execute them.
It works,
but sooner or later (probably sooner) someone will forget to import one of the test files.</p>
<p>A better strategy is to load test files <span class="ix-entry" ix-key="dynamic loading" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_loading" markdown="1">dynamically</a></span>.
While <code>import</code> is usually written as a statement,
it can also be used as an <code>async</code> function
that takes a path as a parameter and loads the corresponding file.
As before,
loading files executes the code they contain,
which registers tests as a side effect:</p>
<div class="code-sample lang-js" title="pray.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">minimist</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'minimist'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">hope</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./hope.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parse</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">filenames</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">options</span><span class="p">.</span><span class="nx">filenames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">glob</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="si">}</span><span class="sb">/**/test-*.js`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">filenames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">hope</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">output</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'terse'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="nx">hope</span><span class="p">.</span><span class="nx">terse</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="nx">hope</span><span class="p">.</span><span class="nx">verbose</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="nx">main</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p>By default,
this program finds all files below the current working directory
whose names match the pattern <code>test-*.js</code>
and uses terse output.
Since we may want to look for files somewhere else,
or request verbose output,
the program needs to handle command-line arguments.</p>
<p>The <a href="https://www.npmjs.com/package/minimist"><code>minimist</code></a> module does this
in a way that is consistent with Unix conventions.
Given command-line arguments <em>after</em> the program's name
(i.e., from <code>process.argv[2]</code> onward),
it looks for patterns like <code>-x something</code>
and creates an object with flags as keys and values associated with them.</p>
<blockquote>
<h3>Filenames in <code>minimist</code></h3>
<p>If we use a command line like <code>pray.js -v something.js</code>,
then <code>something.js</code> becomes the value of <code>-v</code>.
To indicate that we want <code>something.js</code> added to the list of trailing filenames
associated with the special key <code>_</code> (a single underscore),
we have to write <code>pray.js -v -- something.js</code>.
The double dash is a common Unix convention for signalling the end of parameters.</p>
</blockquote>
<p>Our <span class="ix-entry" ix-key="test runner;unit test!test runner" markdown="1"><a class="gl-ref" href="../glossary/#test_runner" markdown="1">test runner</a></span> is now complete,
so we can try it out with some files containing tests that pass, fail, and contain errors:</p>
<div class="code-sample lang-sh" title="pray.sh">
<div class="highlight"><pre><span></span><code>node pray.js -v
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pray.out">
<div class="highlight"><pre><span></span><code>passes:
  /u/stjs/unit-test/test-add.js::Sum of 1 and 2
  /u/stjs/unit-test/test-sub.js::Difference of 1 and 2
fails:
  /u/stjs/unit-test/test-div.js::Quotient of 1 and 0
  /u/stjs/unit-test/test-mul.js::Product of 1 and 2
errors:
  /u/stjs/unit-test/test-missing.js::Sum of x and 0
</code></pre></div>
</div>
<blockquote>
<h3>Infinity is allowed</h3>
<p><code>test-div.js</code> contains the line:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'Quotient of 1 and 0'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">((</span><span class="mf">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>This test counts as a failure rather than an error
because thinks the result of dividing by zero is the special value <code>Infinity</code>
rather than an arithmetic error.</p>
</blockquote>
<p>Loading modules dynamically so that they can register something for us to call later
is a common pattern in many programming languages.
Control flow goes back and forth between the framework and the module being loaded
as this happens
so we must specify the <span class="ix-entry" ix-key="lifecycle!of unit test;unit test!lifecycle" markdown="1"><a class="gl-ref" href="../glossary/#lifecycle" markdown="1">lifecycle</a></span> of the loaded modules quite carefully.
<a class="fig-ref" href="../unit-test/#unit-test-lifecycle">Figure 4.3</a> illustrates what happens
when a pair of files <code>test-add.js</code> and <code>test-sub.js</code> are loaded by our framework:</p>
<ol>
<li><code>pray</code> loads <code>hope.js</code>.</li>
<li>Loading <code>hope.js</code> creates a single instance of the class <code>Hope</code>.</li>
<li><code>pray</code> uses <code>glob</code> to find files with tests.</li>
<li><code>pray</code> loads <code>test-add.js</code> using <code>import</code> as a function.</li>
<li>As <code>test-add.js</code> runs, it loads <code>hope.js</code>.
    Since <code>hope.js</code> is already loaded, this does not create a new instance of <code>Hope</code>.</li>
<li><code>test-add.js</code> uses <code>hope.test</code> to register a test (which does not run yet).</li>
<li><code>pray</code> then loads <code>test-sub.js</code>…</li>
<li>…which loads <code>Hope</code>…</li>
<li>…then registers a test.</li>
<li><code>pray</code> can now ask the unique instance of <code>Hope</code> to run all of the tests,
     then get a report from the <code>Hope</code> singleton and display it.</li>
</ol>
<figure id="unit-test-lifecycle">
<img alt="Unit testing lifecycle" src="./unit-test/lifecycle.svg"/>
<figcaption markdown="1">Figure 4.3: Lifecycle of dynamically-discovered unit tests.</figcaption>
</figure>
<div class="break-before"></div>
<h2 id="unit-test-exercises">Section 4.5: Exercises</h2>
<h3 class="exercise">Asynchronous globbing</h3>
<p>Modify <code>pray.js</code> to use the asynchronous version of <code>glob</code> rather than <code>glob.sync</code>.</p>
<h3 class="exercise">Timing tests</h3>
<p>Install the <a href="https://www.npmjs.com/package/microtime"><code>microtime</code></a> package and then modify the <code>dry-run.js</code> example
so that it records and reports the execution times for tests.</p>
<h3 class="exercise">Approximately equal</h3>
<ol>
<li>
<p>Write a function <code>assertApproxEqual</code> that does nothing if two values are within a certain tolerance of each other
    but throws an exception if they are not:</p>
<pre><code>// throws exception
assertApproxEqual(1.0, 2.0, 0.01, 'Values are too far apart')

// does not throw
assertApproxEqual(1.0, 2.0, 10.0, 'Large margin of error')
</code></pre>
</li>
<li>
<p>Modify the function so that a default tolerance is used if none is specified:</p>
<pre><code>// throws exception
assertApproxEqual(1.0, 2.0, 'Values are too far apart')

// does not throw
assertApproxEqual(1.0, 2.0, 'Large margin of error', 10.0)
</code></pre>
</li>
<li>
<p>Modify the function again so that it checks the <a class="gl-ref" href="../glossary/#relative_error" markdown="1">relative error</a>
    instead of the <a class="gl-ref" href="../glossary/#absolute_error" markdown="1">absolute error</a>.
    (The relative error is the absolute value of the difference between the actual and expected value,
    divided by the absolute value.)</p>
</li>
</ol>
<h3 class="exercise">Rectangle overlay</h3>
<p>A windowing application represents rectangles using objects with four values:
<code>x</code> and <code>y</code> are the coordinates of the lower-left corner,
while <code>w</code> and <code>h</code> are the width and height.
All values are non-negative:
the lower-left corner of the screen is at <code>(0, 0)</code>
and the screen's size is <code>WIDTH</code>x<code>HEIGHT</code>.</p>
<ol>
<li>
<p>Write tests to check that an object represents a valid rectangle.</p>
</li>
<li>
<p>The function <code>overlay(a, b)</code> takes two rectangles and returns either
    a new rectangle representing the region where they overlap or <code>null</code> if they do not overlap.
    Write tests to check that <code>overlay</code> is working correctly.</p>
</li>
<li>
<p>Do you tests assume that two rectangles that touch on an edge overlap or not?
    What about two rectangles that only touch at a single corner?</p>
</li>
</ol>
<h3 class="exercise">Selecting tests</h3>
<p>Modify <code>pray.js</code> so that if the user provides <code>-s pattern</code> or <code>--select pattern</code>
then the program only runs tests in files that contain the string <code>pattern</code> in their name.</p>
<h3 class="exercise">Tagging tests</h3>
<p>Modify <code>hope.js</code> so that users can optionally provide an array of strings to tag tests:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'Difference of 1 and 2'</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">((</span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="s1">'math'</span><span class="p">,</span><span class="w"> </span><span class="s1">'fast'</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
<p>Then modify <code>pray.js</code> so that if users specify either <code>-t tagName</code> or <code>--tag tagName</code>
only tests with that tag are run.</p>
<h3 class="exercise">Mock objects</h3>
<p>A mock object is a simplified replacement for part of a program
whose behavior is easier to control and predict than the thing it is replacing.
For example,
we may want to test that our program does the right thing if an error occurs while reading a file.
To do this,
we write a function that wraps <code>fs.readFileSync</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">mockReadFileSync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">encoding</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">and then modify it so that it throws an exception under our control.
For example,
if we define <code>MOCK_READ_FILE_CONTROL</code> like this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">MOCK_READ_FILE_CONTROL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p class="continue">then the third and fifth calls to <code>mockReadFileSync</code> throw an exception instead of reading data,
as do any calls after the fifth.
Write this function.</p>
<h3 class="exercise">Setup and teardown</h3>
<p>Testing frameworks often allow programmers to specify a <code>setup</code> function
that is to be run before each test
and a corresponding <code>teardown</code> function
that is to be run after each test.
(<code>setup</code> usually re-creates complicated test fixtures,
while <code>teardown</code> functions are sometimes needed to clean up after tests,
e.g., to close database connections or delete temporary files.)</p>
<p>Modify the testing framework in this chapter so that
if a file of tests contains something like this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">createFixtures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="k">do</span><span class="w"> </span><span class="nx">something</span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">hope</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="nx">createFixtures</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">then the function <code>createFixtures</code> will be called
exactly once before each test in that file.
Add a similar way to register a teardown function with <code>hope.teardown</code>.</p>
<h3 class="exercise break-before">Multiple tests</h3>
<p>Add a method <code>hope.multiTest</code> that allows users to specify
multiple test cases for a function at once.
For example, this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hope</span><span class="p">.</span><span class="nx">multiTest</span><span class="p">(</span><span class="s1">'check all of these`, functionToTest, [</span>
<span class="s1">  [['</span><span class="nx">arg1a</span><span class="s1">', '</span><span class="nx">arg1b</span><span class="s1">'], '</span><span class="nx">result1</span><span class="s1">'],</span>
<span class="s1">  [['</span><span class="nx">arg2a</span><span class="s1">', '</span><span class="nx">arg2b</span><span class="s1">'], '</span><span class="nx">result2</span><span class="s1">'],</span>
<span class="s1">  [['</span><span class="nx">arg3a</span><span class="s1">', '</span><span class="nx">arg3b</span><span class="s1">'], '</span><span class="nx">result3</span><span class="err">'</span><span class="p">]</span><span class="w"></span>
<span class="p">])</span><span class="w"></span>
</code></pre></div>
<p class="continue">should be equivalent to this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check all of these 0'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">functionToTest</span><span class="p">(</span><span class="s1">'arg1a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'arg1b'</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'result1'</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check all of these 1'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">functionToTest</span><span class="p">(</span><span class="s1">'arg2a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'arg2b'</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'result2'</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'check all of these 2'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">assert</span><span class="p">(</span><span class="nx">functionToTest</span><span class="p">(</span><span class="s1">'arg3a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'arg3b'</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'result3'</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3 class="exercise">Assertions for sets and maps</h3>
<ol>
<li>
<p>Write functions <code>assertSetEqual</code> and <code>assertMapEqual</code>
    that check whether two instances of <code>Set</code> or two instances of <code>Map</code> are equal.</p>
</li>
<li>
<p>Write a function <code>assertArraySame</code>
    that checks whether two arrays have the same elements,
    even if those elements are in different orders.</p>
</li>
</ol>
<h3 class="exercise">Testing promises</h3>
<p>Modify the unit testing framework to handle <code>async</code> functions,
so that:</p>
<div class="highlight"><pre><span></span><code><span class="nx">hope</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="s1">'delayed test'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{...})</span><span class="w"></span>
</code></pre></div>
<p class="continue">does the right thing.
(Note that you can use <code>typeof</code> to determine whether the object given to <code>hope.test</code>
is a function or a promise.)</p>
</section>
<section class="new-chapter"><h1 id="file-backup">Chapter: Chapter 5: File Backup</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#api" markdown="1">Application Programming Interface</a>, <a class="gl-ref" href="../glossary/#collision" markdown="1">collision</a>, <a class="gl-ref" href="../glossary/#csv" markdown="1">comma-separated values</a>, <a class="gl-ref" href="../glossary/#utc" markdown="1">Coordinated Universal Time</a>, <a class="gl-ref" href="../glossary/#cryptographic_hash_function" markdown="1">cryptographic hash function</a>, <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>, <a class="gl-ref" href="../glossary/#handler" markdown="1">handler</a>, <a class="gl-ref" href="../glossary/#hash_code" markdown="1">hash code</a>, <a class="gl-ref" href="../glossary/#hash_function" markdown="1">hash function</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock object</a>, <a class="gl-ref" href="../glossary/#pipe" markdown="1">pipe</a>, <a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a>, <a class="gl-ref" href="../glossary/#sha_1" markdown="1">SHA-1 hash</a>, <a class="gl-ref" href="../glossary/#stream" markdown="1">stream</a>, <a class="gl-ref" href="../glossary/#streaming_api" markdown="1">streaming API</a>, <a class="gl-ref" href="../glossary/#toctou" markdown="1">Time of check/time of use</a>, <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a>, <a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a>
</p>
<p>Now that we can test software we have something worth saving.
A <span class="ix-entry" ix-key="version control system" markdown="1"><a class="gl-ref" href="../glossary/#version_control_system" markdown="1">version control system</a></span>
like <span class="ix-entry" ix-key="Git;version control system!Git" markdown="1"><a href="https://git-scm.com/">Git</a></span>
keeps track of changes to files
so that we can recover old versions if we want to.
Its heart is a way to archive files that:</p>
<ol>
<li>records which versions of which files existed at the same time
    (so that we can go back to a consistent previous state), and</li>
<li>stores any particular version of a file only once,
    so that we don't waste disk space.</li>
</ol>
<p>In this chapter we will build a tool for doing both tasks.
It won't do everything Git does:
in particular, it won't let us create and merge branches.
If you would like to know how that works,
please see <span class="ix-entry" ix-key="Cook, Mary Rose" markdown="1"><a href="https://maryrosecook.com/">Mary Rose Cook's</a></span> excellent <a href="http://gitlet.maryrosecook.com/">Gitlet</a> project.</p>
<h2 id="file-backup-unique">Section 5.1: How can we uniquely identify files?</h2>
<p>To avoid storing redundant copies of files,
we need a way to tell when two files contain the same data.
We can't rely on names because files can be renamed or moved over time;
we could compare the files byte by byte,
but a quicker way is to use a <span class="ix-entry" ix-key="hash function" markdown="1"><a class="gl-ref" href="../glossary/#hash_function" markdown="1">hash function</a></span>
that turns arbitrary data into a fixed-length string of bits
(<a class="fig-ref" href="../file-backup/#file-backup-hash-function">Figure 5.1</a>).</p>
<figure id="file-backup-hash-function">
<img alt="Hash functions" src="./file-backup/hash-function.svg"/>
<figcaption markdown="1">Figure 5.1: How hash functions speed up lookup.</figcaption>
</figure>
<p>A hash function always produces the same <span class="ix-entry" ix-key="hash code" markdown="1"><a class="gl-ref" href="../glossary/#hash_code" markdown="1">hash code</a></span> for a given input.
A <span class="ix-entry" ix-key="cryptographic hash function;hash function!cryptographic" markdown="1"><a class="gl-ref" href="../glossary/#cryptographic_hash_function" markdown="1">cryptographic hash function</a></span>
has two extra properties:</p>
<ol>
<li>
<p>The output depends on the entire input:
    changing even a single byte results in a different hash code.</p>
</li>
<li>
<p>The outputs look like random numbers:
    they are unpredictable and evenly distributed
    (i.e., the odds of getting any specific hash code are the same).</p>
</li>
</ol>
<p>It's easy to write a bad hash function,
but very hard to write one that qualifies as cryptographic.
We will therefore use a library to calculate 160-bit <span class="ix-entry" ix-key="hash code!SHA-1;SHA-1 hash code" markdown="1"><a class="gl-ref" href="../glossary/#sha_1" markdown="1">SHA-1</a></span> hashes for our files.
These are not random enough to keep data secret from a patient, well-funded attacker,
but that's not what we're using them for:
we just want hashes that are random to make <span class="ix-entry" ix-key="hash function!collision;collision (in hashing)" markdown="1"><a class="gl-ref" href="../glossary/#collision" markdown="1">collision</a></span> extremely unlikely.</p>
<blockquote>
<h3>The Birthday Problem</h3>
<p>The odds that two people share a birthday are 1/365 (ignoring February 29).
The odds that they <em>don't</em> are therefore 364/365.
When we add a third person,
the odds that they don't share a birthday with either of the preceding two people are 363/365,
so the overall odds that nobody shares a birthday are (365/365)×(364/365)×(363/365).
If we keep calculating, there's a 50% chance of two people sharing a birthday in a group of just 23 people,
and a 99.9% chance with 70 people.</p>
<p>We can use the same math to calculate how many files we need to hash before there's a 50% chance of a collision.
Instead of 365 we use \(2^{160}\) (the number of values that are 160 bits long),
and after checking <a href="https://en.wikipedia.org/wiki/Birthday_problem#A_simple_exponentiation">Wikipedia</a>
and doing a few calculations with <span class="ix-entry" ix-key="Wolfram Alpha" markdown="1"><a href="http://wolframalpha.com">Wolfram Alpha</a></span>,
we calculate that we would need to have approximately \(10^{24}\) files
in order to have a 50% chance of a collision.
We're willing to take that risk…</p>
</blockquote>
<p><a href="https://nodejs.org/en/">Node's</a> <a href="https://nodejs.org/api/crypto.html"><code>crypto</code></a> module provides tools to create a SHA-1 hash.
To use them,
we create an object that keeps track of the current state of the hashing calculations,
tell it how we want to encode (or represent) the hash value,
and then feed it some bytes.
When we are done,
we call its <code>.end</code> method
and then use its <code>.read</code> method to get the final result:</p>
<div class="code-sample lang-js" title="hash-text.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'crypto'</span><span class="w"></span>

<span class="c1">// create a SHA1 hasher</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">)</span><span class="w"></span>

<span class="c1">// encode as hex (rather than binary)</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>

<span class="c1">// send it some text</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>

<span class="c1">// signal end of text</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span><span class="w"></span>

<span class="c1">// display the result</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sha1sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`SHA1 of "</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">" is </span><span class="si">${</span><span class="nx">sha1sum</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="hash-text.sh">
<div class="highlight"><pre><span></span><code>node hash-text.js something
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash-text.out">
<div class="highlight"><pre><span></span><code>SHA1 of "something" is 1af17e73721dbe0c40011b82ed4bb1a7dbe3ce29
</code></pre></div>
</div>
<p>Hashing a file instead of a fixed string is straightforward:
we just read the file's contents and pass those characters to the hashing object:</p>
<div class="code-sample lang-js" title="hash-file.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'crypto'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">).</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sha1sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`SHA1 of "</span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">" is </span><span class="si">${</span><span class="nx">sha1sum</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="hash-file.sh">
<div class="highlight"><pre><span></span><code>node hash-file.js hash-file.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash-file.out">
<div class="highlight"><pre><span></span><code>SHA1 of "hash-file.js" is c54c8ee3e576770d29ae2d0d73568e5a5c49eac0
</code></pre></div>
</div>
<p>However,
it is more efficient to process the file as a <a class="gl-ref" href="../glossary/#stream" markdown="1">stream</a>:</p>
<div class="code-sample lang-js" title="hash-stream.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'crypto'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">).</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filename</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span><span class="w"></span>
<span class="nx">hash</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'finish'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="kr">final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'final'</span><span class="p">,</span><span class="w"> </span><span class="kr">final</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'program ends'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="hash-stream.sh">
<div class="highlight"><pre><span></span><code>node hash-stream.js hash-stream.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="hash-stream.out">
<div class="highlight"><pre><span></span><code>program ends
final dc9e6c231e243860dace2dbf52845b121062b60e
</code></pre></div>
</div>
<p class="continue">This kind of interface is called
a <span class="ix-entry" ix-key="streaming API;execution!streaming" markdown="1"><a class="gl-ref" href="../glossary/#streaming_api" markdown="1">streaming</a></span> <a class="gl-ref" href="../glossary/#api" markdown="1">API</a>
because it is designed to process a stream of data one chunk at a time
rather than requiring all of the data to be in memory at once.
Many applications use streams
so that programs don't have to read entire (possibly large) files into memory.</p>
<p>To start,
this program asks the <code>fs</code> library to create a reading stream for a file
and to <a class="gl-ref" href="../glossary/#pipe" markdown="1">pipe</a> the data from that stream to the hashing object
(<a class="fig-ref" href="../file-backup/#file-backup-streaming">Figure 5.2</a>).
It then tells the hashing object what to do when there is no more data
by providing a <span class="ix-entry" ix-key="event handler!streaming API;streaming API!event handler" markdown="1"><a class="gl-ref" href="../glossary/#handler" markdown="1">handler</a></span> for the "finish" event.
This is called asynchronously:
as the output shows,
the main program ends before the task handling the end of data is scheduled and run.
Most programs also provide a handler for "data" events to do something with each block of data as it comes in;
the <code>hash</code> object in our program does that for us.</p>
<figure id="file-backup-streaming">
<img alt="Streaming file operations" src="./file-backup/streaming.svg"/>
<figcaption markdown="1">Figure 5.2: Processing files as streams of chunks.</figcaption>
</figure>
<h2 id="file-backup-backup">Section 5.2: How can we back up files?</h2>
<p>Many files only change occasionally after they're created, or not at all.
It would be wasteful for a version control system to make copies
each time the user wanted to save a snapshot of a project,
so instead our tool will copy each unique file to something like <code>abcd1234.bck</code>,
where <code>abcd1234</code> is a hash of the file's contents.
It will then store a data structure that records the filenames and hash keys for each snapshot.
The hash keys tell it which unique files are part of the snapshot,
while the filenames tell us what each file's contents were called when the snapshot was made
(since files can be moved or renamed).
To restore a particular snapshot,
all we have to do is copy the saved <code>.bck</code> files back to where they were
(<a class="fig-ref" href="../file-backup/#file-backup-storage">Figure 5.3</a>).</p>
<figure id="file-backup-storage">
<img alt="Backup file storage" src="./file-backup/storage.svg"/>
<figcaption markdown="1">Figure 5.3: Organization of backup file storage.</figcaption>
</figure>
<p>We can build the tools we need to do this using promises (<a class="x-ref" href="#async-programming">Chapter 3</a>).
The main function creates a promise that uses the asynchronous version of <code>glob</code> to find files
and then:</p>
<ol>
<li>
<p>checks that entries in the list are actually files;</p>
</li>
<li>
<p>reads each file into memory; and</p>
</li>
<li>
<p>calculates hashes for those files.</p>
</li>
</ol>
<div class="code-sample lang-js" title="hash-existing-promise.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'crypto'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hashExisting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">rootDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">rootDir</span><span class="si">}</span><span class="sb">/**/*`</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">glob</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">matches</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nx">matches</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">statPath</span><span class="p">(</span><span class="nx">path</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">readPath</span><span class="p">(</span><span class="nx">path</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">hashPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pairs</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This function uses <code>Promise.all</code>
to wait for the operations on all of the files in the list to complete
before going on to the next step.
A different design would combine stat, read, and hash into a single step
so that each file would be handled independently
and use one <code>Promise.all</code> at the end to bring them all together.</p>
<p>The first two <span class="ix-entry" ix-key="helper function" markdown="1">helper functions</span> that <code>hashExisting</code> relies on
wrap asynchronous operation in promises:</p>
<div class="code-sample lang-js" title="hash-existing-promise.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">statPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">stat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">]))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">readPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">reject</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">content</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">]))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The final helper function calculates the hash synchronously,
but we can use <code>Promise.all</code> to wait on those operations finishing anyway:</p>
<div class="code-sample lang-js" title="hash-existing-promise.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">hashPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">).</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">read</span><span class="p">()]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's try running it:</p>
<div class="code-sample lang-js" title="run-hash-existing-promise.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">hashExisting</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./hash-existing-promise.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">hashExisting</span><span class="p">(</span><span class="nx">root</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">)</span><span class="w"></span>
<span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="run-hash-existing-promise.sh">
<div class="highlight"><pre><span></span><code>node run-hash-existing-promise.js . <span class="p">|</span> fgrep -v test/ <span class="p">|</span> fgrep -v <span class="s1">'~'</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="run-hash-existing-promise.slice.out">
<div class="highlight"><pre><span></span><code>./backup.js 11422489e11be3d8ff76278503457665f6152ebe
./check-existing-files.js 66b933cf9e792e9a9204171d04e0f8b530ec3f4f
./figures/hash-function.pdf 0eb82de379a95ee2be3f00b38c0102e2f2f8170e
./figures/hash-function.svg 563996575d581f2a08e3e954d7faba4d189d0773
./figures/mock-fs.pdf 0b3bba44e69122ee53bcc9d777c186c84b7c2ff2
...
./x-from-to.md f0f63b3576042dfc0050029ddfcccc3c42fe275d
./x-io-streams.md 1fb4d8b7785c5e7b2f1e29588e2ba28d101ced1a
./x-json-manifests.md 223e0e4167acc6d4d81b76ba1287b90234c95e22
./x-mock-hashes.md 580edfc0cb8eaca4f3700307002ae10ee97af8d2
./x-pre-commit.md b7d945af4554fc0f64b708fe735417bee8b33eef
</code></pre></div>
</div>
<p>The code we have written is clearer than it would be with callbacks
(try rewriting it if you don't believe this)
but the layer of promises around everything still obscures its meaning.
The same operations are easier to read when written using <code>async</code> and <code>await</code>:</p>
<div class="code-sample lang-js" title="hash-existing-async.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">statPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">readPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hashPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">).</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">read</span><span class="p">()]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hashExisting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">rootDir</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">rootDir</span><span class="si">}</span><span class="sb">/**/*`</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">matches</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">statPath</span><span class="p">(</span><span class="nx">path</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">filter</span><span class="p">(([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">readPath</span><span class="p">(</span><span class="nx">path</span><span class="p">)))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">hashPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">hashes</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This version creates and resolves exactly the same promises as the previous one,
but those promises are created for us automatically by Node.
To check that it works,
let's run it for the same input files:</p>
<div class="code-sample lang-js" title="run-hash-existing-async.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">hashExisting</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./hash-existing-async.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="nx">hashExisting</span><span class="p">(</span><span class="nx">root</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">pairs</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="run-hash-existing-async.sh">
<div class="highlight"><pre><span></span><code>node run-hash-existing-async.js . <span class="p">|</span> fgrep -v test/ <span class="p">|</span> fgrep -v <span class="s1">'~'</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="run-hash-existing-async.slice.out">
<div class="highlight"><pre><span></span><code>./backup.js 11422489e11be3d8ff76278503457665f6152ebe
./check-existing-files.js 66b933cf9e792e9a9204171d04e0f8b530ec3f4f
./figures/hash-function.pdf 0eb82de379a95ee2be3f00b38c0102e2f2f8170e
./figures/hash-function.svg 563996575d581f2a08e3e954d7faba4d189d0773
./figures/mock-fs.pdf 0b3bba44e69122ee53bcc9d777c186c84b7c2ff2
...
./x-from-to.md f0f63b3576042dfc0050029ddfcccc3c42fe275d
./x-io-streams.md 1fb4d8b7785c5e7b2f1e29588e2ba28d101ced1a
./x-json-manifests.md 223e0e4167acc6d4d81b76ba1287b90234c95e22
./x-mock-hashes.md 580edfc0cb8eaca4f3700307002ae10ee97af8d2
./x-pre-commit.md b7d945af4554fc0f64b708fe735417bee8b33eef
</code></pre></div>
</div>
<h2 id="file-backup-track">Section 5.3: How can we track which files have already been backed up?</h2>
<p>The second part of our backup tool keeps track of which files have and haven't been backed up already.
It stores backups in a directory that contains backup files like <code>abcd1234.bck</code>
and files describing the contents of particular snapshots.
The latter are named <code>ssssssssss.csv</code>,
where <code>ssssssssss</code> is the <a class="gl-ref" href="../glossary/#utc" markdown="1">UTC</a> <a class="gl-ref" href="../glossary/#timestamp" markdown="1">timestamp</a> of the backup's creation
and the <code>.csv</code> extension indicates that the file is formatted as <a class="gl-ref" href="../glossary/#csv" markdown="1">comma-separated values</a>.
(We could store these files as <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a>, but CSV is easier for people to read.)</p>
<blockquote>
<h3>Time of check/time of use</h3>
<p>Our naming convention for index files will fail if we try to create more than one backup per second.
This might seem very unlikely,
but many faults and security holes are the result of programmers assuming things weren't going to happen.</p>
<p>We could try to avoid this problem by using a two-part naming scheme <code>ssssssss-a.csv</code>,
<code>ssssssss-b.csv</code>, and so on,
but this leads to a <span class="ix-entry" ix-key="race condition" markdown="1"><a class="gl-ref" href="../glossary/#race_condition" markdown="1">race condition</a></span>
called <span class="ix-entry" ix-key="race condition!time of check/time of use;time of check/time of use" markdown="1"><a class="gl-ref" href="../glossary/#toctou" markdown="1">time of check/time of use</a></span>.
If two users run the backup tool at the same time,
they will both see that there isn't a file (yet) with the current timestamp,
so they will both try to create the first one.</p>
</blockquote>
<div class="code-sample lang-js" title="check-existing-files.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">glob</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'glob-promise'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">findNew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">rootDir</span><span class="p">,</span><span class="w"> </span><span class="nx">pathHashPairs</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hashToPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathHashPairs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">obj</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">obj</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">{})</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">rootDir</span><span class="si">}</span><span class="sb">/*.bck`</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existingFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="nx">existingFiles</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">filename</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.bck$/</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">hashToPath</span><span class="p">[</span><span class="nx">stripped</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">hashToPath</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">findNew</span><span class="w"></span>
</code></pre></div>
</div>
<p>To test our program,
let's manually create testing directories with manufactured (shortened) hashes:</p>
<div class="code-sample lang-sh" title="tree-test.sh">
<div class="highlight"><pre><span></span><code>tree --charset unicode <span class="nb">test</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="tree-test.out">
<div class="highlight"><pre><span></span><code>test
|-- bck-0-csv-0
|-- bck-1-csv-1
|   |-- 0001.csv
|   `-- abcd1234.bck
|-- bck-4-csv-2
|   |-- 0001.csv
|   |-- 3028.csv
|   |-- 3456cdef.bck
|   |-- abcd1234.bck
|   `-- bcde2345.bck
|-- test-backup.js
|-- test-find-mock.js
`-- test-find.js

3 directories, 10 files
</code></pre></div>
</div>
<p>We use <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> to manage our tests.
Every test is an <code>async</code> function;
Mocha automatically waits for them all to complete before reporting results.
To run them,
we add the line:</p>
<div class="highlight"><pre><span></span><code><span class="s2">"test"</span><span class="o">:</span><span class="w"> </span><span class="s2">"mocha */test/test-*.js"</span><span class="w"></span>
</code></pre></div>
<p class="continue">in the <code>scripts</code> section of our project's <code>package.json</code> file
so that when we run <code>npm run test</code>,
Mocha looks for files in <code>test</code> sub-directories of the directories holding our lessons.</p>
<p>Here are our first few tests:</p>
<div class="code-sample lang-js" title="test-find.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">findNew</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../check-existing-files.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'pre-existing hashes and actual filesystem'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'finds no pre-existing files when none given or exist'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="s1">'file-backup/test/bck-0-csv-0'</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected no files'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'finds some files when one is given and none exist'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="s1">'somefile.txt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'9876fedc'</span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">'9876fedc'</span><span class="o">:</span><span class="w"> </span><span class="s1">'somefile.txt'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="s1">'file-backup/test/bck-0-csv-0'</span><span class="p">,</span><span class="w"> </span><span class="nx">check</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected one file'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'finds nothing needs backup when there is a match'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="s1">'alpha.js'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abcd1234'</span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="s1">'file-backup/test/bck-1-csv-1'</span><span class="p">,</span><span class="w"> </span><span class="nx">check</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected no files'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'finds something needs backup when there is a mismatch'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="s1">'alpha.js'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a1b2c3d4'</span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">a1b2c3d4</span><span class="o">:</span><span class="w"> </span><span class="s1">'alpha.js'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="s1">'file-backup/test/bck-1-csv-1'</span><span class="p">,</span><span class="w"> </span><span class="nx">check</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected one file'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'finds mixed matches'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'matches.js'</span><span class="p">,</span><span class="w"> </span><span class="s1">'3456cdef'</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'matches.txt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abcd1234'</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'mismatch.txt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'12345678'</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mf">12345678</span><span class="o">:</span><span class="w"> </span><span class="s1">'mismatch.txt'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="s1">'file-backup/test/bck-4-csv-2'</span><span class="p">,</span><span class="w"> </span><span class="nx">check</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected one file'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and here is Mocha's report:</p>
<div class="code-sample lang-out" title="test-check-filesystem.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test
&gt; mocha */test/test-*.js "-g" "pre-existing hashes"

sh: mocha: command not found
</code></pre></div>
</div>
<h2 id="file-backup-test">Section 5.4: How can we test code that modifies files?</h2>
<p>The final thing our tool needs to do
is copy the files that need copying and create a new index file.
The code itself will be relatively simple,
but testing will be complicated by the fact
that our tests will need to create directories and files before they run
and then delete them afterward
(so that they don't contaminate subsequent tests).</p>
<p>A better approach is to use a <span class="ix-entry" ix-key="mock object!for testing;unit test!using mock object" markdown="1"><a class="gl-ref" href="../glossary/#mock_object" markdown="1">mock object</a></span>
instead of the real filesystem.
A mock object has the same interface as the function, object, class, or library that it replaces,
but is designed to be used solely for testing.
Node's <a href="https://www.npmjs.com/package/mock-fs"><code>mock-fs</code></a> library provides the same functions as the <code>fs</code> library,
but stores everything in memory
(<a class="fig-ref" href="../file-backup/#file-backup-mock-fs">Figure 5.4</a>).
This prevents our tests from accidentally disturbing the filesystem,
and also makes tests much faster
(since in-memory operations are thousands of times faster than operations that touch the disk).</p>
<figure id="file-backup-mock-fs">
<img alt="Mock filesystem" src="./file-backup/mock-fs.svg"/>
<figcaption markdown="1">Figure 5.4: Using a mock filesystem to simplify testing.</figcaption>
</figure>
<p>We can create a mock filesystem by giving the library a JSON description of
the files and what they should contain:</p>
<div class="code-sample lang-js" title="test-find-mock.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">mock</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'mock-fs'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">findNew</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../check-existing-files.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'checks for pre-existing hashes using mock filesystem'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">mock</span><span class="p">({</span><span class="w"></span>
<span class="w">      </span><span class="s1">'bck-0-csv-0'</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">      </span><span class="s1">'bck-1-csv-1'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s1">'0001.csv'</span><span class="o">:</span><span class="w"> </span><span class="s1">'alpha.js,abcd1234'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'abcd1234.bck'</span><span class="o">:</span><span class="w"> </span><span class="s1">'alpha.js content'</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s1">'bck-4-csv-2'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s1">'0001.csv'</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">'alpha.js,abcd1234'</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s1">'beta.txt,bcde2345'</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="s1">'3024.csv'</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">'alpha.js,abcd1234'</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s1">'gamma.png,3456cdef'</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="s1">'subdir/renamed.txt,bcde2345'</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="s1">'3456cdef.bck'</span><span class="o">:</span><span class="w"> </span><span class="s1">'gamma.png content'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'abcd1234.bck'</span><span class="o">:</span><span class="w"> </span><span class="s1">'alpha content'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'bcde2345.bck'</span><span class="o">:</span><span class="w"> </span><span class="s1">'beta.txt became subdir/renamed.txt'</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">afterEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">mock</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue"><span class="ix-entry" ix-key="Mocha!beforeEach" markdown="1">Mocha</span> automatically calls <code>beforeEach</code> before running each tests,
and <span class="ix-entry" ix-key="Mocha!afterEach" markdown="1"><code>afterEach</code></span> after each tests completes
(which is yet another <span class="ix-entry" ix-key="protocol!for unit testing" markdown="1">protocol</span>).
All of the tests stay exactly the same,
and since <code>mock-fs</code> replaces the functions in the standard <code>fs</code> library with its own,
nothing in our application needs to change either.</p>
<p>We are finally ready to write the program that actually backs up files:</p>
<div class="code-sample lang-js" title="backup.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs-extra-promise'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">hashExisting</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./hash-existing-async.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">findNew</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./check-existing-files.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">backup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">src</span><span class="p">,</span><span class="w"> </span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s1">'0'</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">hashExisting</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">needToCopy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findNew</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">existing</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">copyFiles</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">needToCopy</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">saveManifest</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">timestamp</span><span class="p">,</span><span class="w"> </span><span class="nx">existing</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">copyFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">needToCopy</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">promises</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">needToCopy</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">hash</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">srcPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">needToCopy</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dstPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">dst</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">hash</span><span class="si">}</span><span class="sb">.bck`</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">copyFileAsync</span><span class="p">(</span><span class="nx">srcPath</span><span class="p">,</span><span class="w"> </span><span class="nx">dstPath</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">saveManifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="nx">timestamp</span><span class="p">,</span><span class="w"> </span><span class="nx">pathHash</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">pathHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathHash</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathHash</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">([</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">path</span><span class="si">}</span><span class="sb">,</span><span class="si">${</span><span class="nx">hash</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">dst</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">timestamp</span><span class="si">}</span><span class="sb">.csv`</span><span class="w"></span>
<span class="w">  </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">backup</span><span class="w"></span>
</code></pre></div>
</div>
<p>The tests for this are more complicated than tests we have written previously
because we want to check with actual file hashes.
Let's set up some fixtures to run tests on:</p>
<div class="code-sample lang-js" title="test-backup.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">backup</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../backup.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">hashString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">).</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">hasher</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">Contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">aaa</span><span class="o">:</span><span class="w"> </span><span class="s1">'AAA'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">bbb</span><span class="o">:</span><span class="w"> </span><span class="s1">'BBB'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">ccc</span><span class="o">:</span><span class="w"> </span><span class="s1">'CCC'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">Hashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Contents</span><span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hashString</span><span class="p">(</span><span class="nx">Contents</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">obj</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="p">{})</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">Fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s1">'alpha.txt'</span><span class="o">:</span><span class="w"> </span><span class="nx">Contents</span><span class="p">.</span><span class="nx">aaa</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'beta.txt'</span><span class="o">:</span><span class="w"> </span><span class="nx">Contents</span><span class="p">.</span><span class="nx">bbb</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">gamma</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s1">'delta.txt'</span><span class="o">:</span><span class="w"> </span><span class="nx">Contents</span><span class="p">.</span><span class="nx">ccc</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">backup</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">InitialBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Hashes</span><span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">set</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">set</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="sb">`backup/</span><span class="si">${</span><span class="nx">Hashes</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span><span class="si">}</span><span class="sb">.bck`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">set</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">())</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and then run some tests:</p>
<div class="code-sample lang-js" title="test-backup.js">
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'check entire backup process'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">beforeEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">mock</span><span class="p">(</span><span class="nx">Fixture</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">afterEach</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">mock</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'creates an initial CSV manifest'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">backup</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">((</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*'</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 4 files'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.bck'</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualBackups</span><span class="p">,</span><span class="w"> </span><span class="nx">InitialBackups</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 3 backup files'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualManifests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.csv'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualManifests</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">'backup/0000000000.csv'</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected one manifest'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'does not duplicate files unnecessarily'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">backup</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">((</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*'</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 4 files after first backup'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">backup</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">((</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*'</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 5 files after second backup'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.bck'</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualBackups</span><span class="p">,</span><span class="w"> </span><span class="nx">InitialBackups</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 3 backup files after second backup'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualManifests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.csv'</span><span class="p">)).</span><span class="nx">sort</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualManifests</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'backup/0000000000.csv'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup/0000000001.csv'</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected two manifests'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'adds a file as needed'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">backup</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">((</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*'</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 4 files after first backup'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="s1">'source/newfile.txt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'NNN'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hashOfNewFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hashString</span><span class="p">(</span><span class="s1">'NNN'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">backup</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">((</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*'</span><span class="p">)).</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 6 files after second backup'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">InitialBackups</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="sb">`backup/</span><span class="si">${</span><span class="nx">hashOfNewFile</span><span class="si">}</span><span class="sb">.bck`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.bck'</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualBackups</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected 4 backup files after second backup'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualManifests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">glob</span><span class="p">(</span><span class="s1">'backup/*.csv'</span><span class="p">)).</span><span class="nx">sort</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">actualManifests</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'backup/0000000000.csv'</span><span class="p">,</span><span class="w"> </span><span class="s1">'backup/0000000001.csv'</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Expected two manifests'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-backup.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test
&gt; mocha */test/test-*.js "-g" "check entire backup process"



  check entire backup process
    ✓ creates an initial CSV manifest
    ✓ does not duplicate files unnecessarily
    ✓ adds a file as needed


  3 passing (18ms)
</code></pre></div>
</div>
<blockquote class="break-before">
<h3>Design for test</h3>
<p>One of the best ways---maybe <em>the</em> best way---to evaluate software design
is by thinking about <span class="ix-entry" ix-key="testability!as design criterion;software design!testability" markdown="1">testability</span> <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Feathers2004">Feathers2004</a>]</span>.
We were able to use a mock filesystem instead of a real one
because the filesystem has a well-defined API
that is provided to us in a single library,
so replacing it is a matter of changing one thing in one place.
If you have to change several parts of your code in order to test it,
the code is telling you to consolidate those parts into one component.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="file-backup-exercises">Section 5.5: Exercises</h2>
<h3 class="exercise">Odds of collision</h3>
<p>If hashes were only 2 bits long,
then the chances of collision with each successive file
assuming no previous collision are:</p>
<table>
<thead>
<tr>
<th>Number of Files</th>
<th>Odds of Collision</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0%</td>
</tr>
<tr>
<td>2</td>
<td>25%</td>
</tr>
<tr>
<td>3</td>
<td>50%</td>
</tr>
<tr>
<td>4</td>
<td>75%</td>
</tr>
<tr>
<td>5</td>
<td>100%</td>
</tr>
</tbody>
</table>
<p>A colleague of yours says this means that if we hash four files,
there's only a 75% chance of any collision occurring.
What are the actual odds?</p>
<h3 class="exercise">Streaming I/O</h3>
<p>Write a small program using <code>fs.createReadStream</code> and <code>fs.createWriteStream</code>
that copies a file piece by piece
instead of reading it into memory and then writing it out again.</p>
<h3 class="exercise">Sequencing backups</h3>
<p>Modify the backup program so that manifests are numbered sequentially
as <code>00000001.csv</code>, <code>00000002.csv</code>, and so on
rather than being timestamped.
Why doesn't this solve the time of check/time of use race condition mentioned earlier.</p>
<h3 class="exercise">JSON manifests</h3>
<ol>
<li>
<p>Modify <code>backup.js</code> so that it can save JSON manifests as well as CSV manifests
    based on a command-line flag.</p>
</li>
<li>
<p>Write another program called <code>migrate.js</code> that converts a set of manifests
    from CSV to JSON.
    (The program's name comes from the term <a class="gl-ref" href="../glossary/#data_migration" markdown="1">data migration</a>.)</p>
</li>
<li>
<p>Modify <code>backup.js</code> programs so that each manifest stores the user name of the person who created it
    along with file hashes,
    and then modify <code>migrate.js</code> to transform old files into the new format.</p>
</li>
</ol>
<h3 class="exercise">Mock hashes</h3>
<ol>
<li>
<p>Modify the file backup program so that it uses a function called <code>ourHash</code> to hash files.</p>
</li>
<li>
<p>Create a replacement that returns some predictable value, such as the first few characters of the data.</p>
</li>
<li>
<p>Rewrite the tests to use this function.</p>
</li>
</ol>
<p>How did you modify the main program so that the tests could control which hashing function is used?</p>
<h3 class="exercise">Comparing manifests</h3>
<p>Write a program <code>compare-manifests.js</code> that reads two manifest files and reports:</p>
<ul>
<li>
<p>Which files have the same names but different hashes
    (i.e., their contents have changed).</p>
</li>
<li>
<p>Which files have the same hashes but different names
    (i.e., they have been renamed).</p>
</li>
<li>
<p>Which files are in the first hash but neither their names nor their hashes are in the second
    (i.e., they have been deleted).</p>
</li>
<li>
<p>Which files are in the second hash but neither their names nor their hashes are in the first
    (i.e., they have been added).</p>
</li>
</ul>
<h3 class="exercise">From one state to another</h3>
<ol>
<li>
<p>Write a program called <code>from-to.js</code> that takes the name of a directory
    and the name of a manifest file
    as its command-line arguments,
    then adds, removes, and/or renames files in the directory
    to restore the state described in the manifest.
    The program should only perform file operations when it needs to,
    e.g.,
    it should not delete a file and re-add it if the contents have not changed.</p>
</li>
<li>
<p>Write some tests for <code>from-to.js</code> using Mocha and <code>mock-fs</code>.</p>
</li>
</ol>
<h3 class="exercise">File history</h3>
<ol>
<li>
<p>Write a program called <code>file-history.js</code>
    that takes the name of a file as a command-line argument
    and displays the history of that file
    by tracing it back in time through the available manifests.</p>
</li>
<li>
<p>Write tests for your program using Mocha and <code>mock-fs</code>.</p>
</li>
</ol>
<h3 class="exercise">Pre-commit hooks</h3>
<p>Modify <code>backup.js</code> to load and run a function called <code>preCommit</code> from a file called <code>pre-commit.js</code>
stored in the root directory of the files being backed up.
If <code>preCommit</code> returns <code>true</code>, the backup proceeds;
if it returns <code>false</code> or throws an exception,
no backup is created.</p>
</section>
<section class="new-chapter"><h1 id="data-table">Chapter: Chapter 6: Data Tables</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#character_encoding" markdown="1">character encoding</a>, <a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major storage</a>, <a class="gl-ref" href="../glossary/#data_frame" markdown="1">data frame</a>, <a class="gl-ref" href="../glossary/#fixed_width_string" markdown="1">fixed-width (of strings)</a>, <a class="gl-ref" href="../glossary/#garbage_collection" markdown="1">garbage collection</a>, <a class="gl-ref" href="../glossary/#heterogeneous" markdown="1">heterogeneous</a>, <a class="gl-ref" href="../glossary/#homogeneous" markdown="1">homogeneous</a>, <a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a>, <a class="gl-ref" href="../glossary/#index_database" markdown="1">index (in a database)</a>, <a class="gl-ref" href="../glossary/#json" markdown="1">JavaScript Object Notation</a>, <a class="gl-ref" href="../glossary/#join" markdown="1">join</a>, <a class="gl-ref" href="../glossary/#pad_string" markdown="1">pad (a string)</a>, <a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major storage</a>, <a class="gl-ref" href="../glossary/#sparse_matrix" markdown="1">sparse matrix</a>, <a class="gl-ref" href="../glossary/#sql" markdown="1">SQL</a>, <a class="gl-ref" href="../glossary/#tagged_data" markdown="1">tagged data</a>, <a class="gl-ref" href="../glossary/#test_harness" markdown="1">test harness</a>
</p>
<p><a class="x-ref" href="#systems-programming">Chapter 2</a> said that
operations in memory are thousands of times faster than operations that touch the filesystem,
but what about different in-memory operations---how do they compare with each other?
Putting it another way,
how can we tell which of several designs is going to be the most efficient?</p>
<p>The best answer is to conduct some <span class="ix-entry" ix-key="experiments" markdown="1">experiments</span>.
To see how to do this,
we will take a look at several ways to implement data tables
with one or more named columns and zero or more rows.
Each row has one value for each column,
and all the values in a column have the same type
(<a class="fig-ref" href="../data-table/#data-table-conceptual">Figure 6.1</a>).
Data tables appear over and over again in programming,
from spreadsheets and databases
to the <span class="ix-entry" ix-key="data frame" markdown="1"><a class="gl-ref" href="../glossary/#data_frame" markdown="1">data frames</a></span> in
<span class="ix-entry" ix-key="R" markdown="1">R's</span> <span class="ix-entry" ix-key="tidyverse" markdown="1"><a href="https://www.tidyverse.org/">tidyverse</a></span> packages,
<span class="ix-entry" ix-key="Python" markdown="1"><a href="https://www.python.org/">Python's</a></span> <span class="ix-entry" ix-key="Pandas" markdown="1"><a href="https://pandas.pydata.org/">Pandas</a></span> library,
or the <span class="ix-entry" ix-key="DataForge" markdown="1"><a href="http://www.data-forge-js.com/">DataForge</a></span> library for JavaScript <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Davis2018">Davis2018</a>]</span>.</p>
<figure id="data-table-conceptual">
<img alt="Data table structure" src="./data-table/conceptual.svg"/>
<figcaption markdown="1">Figure 6.1: The structure of a data table.</figcaption>
</figure>
<p>The key operations on data tables are those provided by <span class="ix-entry" ix-key="SQL" markdown="1"><a class="gl-ref" href="../glossary/#sql" markdown="1">SQL</a></span>:
filter, select, summarize, and join.
These can be implemented in about five hundred lines of code,
but their performance depends on how the data table is stored.</p>
<h2 id="data-table-implement">Section 6.1: How can we implement data tables?</h2>
<p>One way to store a table is <span class="ix-entry" ix-key="row-major storage order;storage order!row-major" markdown="1"><a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major</a></span> order,
in which the values in each row are stored together in memory.
This is sometimes also called <span class="ix-entry" ix-key="heterogeneous storage;storage!heterogeneous" markdown="1"><a class="gl-ref" href="../glossary/#heterogeneous" markdown="1">heterogeneous</a></span> storage
because each "unit" of storage can contain values of different types.
We can implement this design in JavaScript using an array of objects,
each of which has the same keys
(<a class="fig-ref" href="../data-table/#data-table-storage-order">Figure 6.2</a>).</p>
<p>Another option is <span class="ix-entry" ix-key="column-major storage order;storage order!column-major" markdown="1"><a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major</a></span>
or <span class="ix-entry" ix-key="homogeneous storage;storage!homogeneous" markdown="1"><a class="gl-ref" href="../glossary/#homogeneous" markdown="1">homogeneous</a></span> order,
in which all the values in a column are stored together.
In JavaScript,
this could be implemented using an object
whose members are all arrays of the same length.</p>
<figure id="data-table-storage-order">
<img alt="Row-major vs. column-major storage order" src="./data-table/storage-order.svg"/>
<figcaption markdown="1">Figure 6.2: Row-major storage vs. column-major storage for data tables.</figcaption>
</figure>
<p>To find out which is better
we will construct one of each,
try some operations,
record their execution times and memory use,
and then compare them.
Crucially,
the answer will depend on both the implementations themselves
and on what mix of operations we measure.
For example,
if one strategy works better for filter and another for select,
the ratio of filters to selects may determine which is "best".</p>
<blockquote>
<h3>Immutability</h3>
<p>All of our implementations will treat each data table as <span class="ix-entry" ix-key="immutable data" markdown="1"><a class="gl-ref" href="../glossary/#immutable" markdown="1">immutable</a></span>:
once we have created it,
we will not modify its contents.
This doesn't actually have much impact on performance
an makes the programming easier and safer,
since shared data structures are a rich source of bugs.</p>
</blockquote>
<p>For our first experiment,
let's build a row-major table with some number of columns.
To keep it simple,
we will repeat the values 0, 1, and 2 to fill the table.</p>
<div class="code-sample lang-js" title="build.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">buildRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">nRows</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="nx">labels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">row</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">iR</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Next,
we write <code>filter</code> and <code>select</code> for tables laid out this way.
We need to provide a callback function to <code>filter</code> to determine which rows to keep
like the callback for <code>Array.filter</code>;
for selecting columns,
we provide a list of the keys that identify the columns we want to keep.
We expect filtering to be relatively fast,
since it is <span class="ix-entry" ix-key="recycling data" markdown="1">recycling</span> rows,
while selecting should be relatively slow because we have to construct a new set of arrays
(<a class="fig-ref" href="../data-table/#data-table-row-ops">Figure 6.3</a>).</p>
<div class="code-sample lang-js" title="table-performance.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">rowFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">table</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">func</span><span class="p">(</span><span class="nx">row</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">rowSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">toKeep</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">table</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="nx">toKeep</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">newRow</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">row</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newRow</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="data-table-row-ops">
<img alt="Row-major operations" src="./data-table/row-ops.svg"/>
<figcaption markdown="1">Figure 6.3: Operations on row-major data tables.</figcaption>
</figure>
<p>Now let's do the same for column-major storage.
Building the object that holds the columns is straightforward:</p>
<div class="code-sample lang-js" title="build.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">buildCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="nx">labels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">nRows</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">iR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Filtering is more complex because the values in each row are scattered across several arrays,
but selecting is just a matter of recycling the arrays we want in the new table.
We expect selecting to be relatively fast,
since only the references to the columns need to be copied,
but filtering will be relatively slow since we are constructing multiple new arrays
(<a class="fig-ref" href="../data-table/#data-table-col-ops">Figure 6.4</a>).</p>
<div class="code-sample lang-js" title="table-performance.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">colFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">labels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">table</span><span class="p">.</span><span class="nx">label_1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">iR</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">iR</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">labels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="nx">label</span><span class="p">][</span><span class="nx">iR</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">colSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">toKeep</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="nx">toKeep</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">table</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="data-table-col-ops">
<img alt="Column-major operations" src="./data-table/col-ops.svg"/>
<figcaption markdown="1">Figure 6.4: Operations on column-major data tables.</figcaption>
</figure>
<blockquote>
<h3>Not quite polymorphic</h3>
<p>Our tests would be simpler to write if the two versions of <code>filter</code> and <code>select</code>
took exactly the same parameters,
but the row-testing functions for <code>filter</code> are different
because of the differences in the ways the tables are stored.
We could force them to be the same by (for example)
packing the values for each row in the column-major implementation
into a temporary object
and passing that to the same filtering function we used for the row-major implementation,
but that extra work would bias the performance comparison in row-major's favor.</p>
</blockquote>
<h2 id="data-table-profile">Section 6.2: How can we test the performance of our implementations?</h2>
<p>Now that we have our tables and operations,
we can build a <span class="ix-entry" ix-key="test harness;experiments!test harness" markdown="1"><a class="gl-ref" href="../glossary/#test_harness" markdown="1">test harness</a></span> to run those operations
on data tables of varying sizes.
We arbitrarily decide to keep half of the columns and one-third of the rows;
these ratios will affect our decision about which is better,
so if we were doing this for a real application we would test what happens
as these fractions vary.
And as we said earlier,
the relative performance will also depend on the how many filters we do for each select;
our balance should be based on data from whatever application we intend to support.</p>
<p>Our performance measurement program looks like this:</p>
<div class="code-sample lang-js" title="table-performance.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">RANGE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">3</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filterPerSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">4</span><span class="p">])</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nb">Array</span><span class="p">(</span><span class="nx">nCols</span><span class="p">).</span><span class="nx">keys</span><span class="p">()].</span><span class="nx">map</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`label_</span><span class="si">${</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">someLabels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">someLabels</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Must have some labels for select (array too short)'</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rowTable</span><span class="p">,</span><span class="w"> </span><span class="nx">rowSize</span><span class="p">,</span><span class="w"> </span><span class="nx">rowHeap</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">memory</span><span class="p">(</span><span class="nx">buildRows</span><span class="p">,</span><span class="w"> </span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">colTable</span><span class="p">,</span><span class="w"> </span><span class="nx">colSize</span><span class="p">,</span><span class="w"> </span><span class="nx">colHeap</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">memory</span><span class="p">(</span><span class="nx">buildCols</span><span class="p">,</span><span class="w"> </span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rowFilterTime</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">time</span><span class="p">(</span><span class="nx">rowFilter</span><span class="p">,</span><span class="w"> </span><span class="nx">rowTable</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">((</span><span class="nx">row</span><span class="p">.</span><span class="nx">label_1</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">RANGE</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rowSelectTime</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">time</span><span class="p">(</span><span class="nx">rowSelect</span><span class="p">,</span><span class="w"> </span><span class="nx">rowTable</span><span class="p">,</span><span class="w"> </span><span class="nx">someLabels</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colFilterTime</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">time</span><span class="p">(</span><span class="nx">colFilter</span><span class="p">,</span><span class="w"> </span><span class="nx">colTable</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="nx">iR</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">((</span><span class="nx">table</span><span class="p">.</span><span class="nx">label_1</span><span class="p">[</span><span class="nx">iR</span><span class="p">]</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">RANGE</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">colSelectTime</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">time</span><span class="p">(</span><span class="nx">colSelect</span><span class="p">,</span><span class="w"> </span><span class="nx">colTable</span><span class="p">,</span><span class="w"> </span><span class="nx">someLabels</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateRatio</span><span class="p">(</span><span class="nx">filterPerSelect</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">rowFilterTime</span><span class="p">,</span><span class="w"> </span><span class="nx">rowSelectTime</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">colFilterTime</span><span class="p">,</span><span class="w"> </span><span class="nx">colSelectTime</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">nRows</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">nCols</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">filterPerSelect</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">rowSize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">rowHeap</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">colSize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">colHeap</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">rowFilterTime</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">rowSelectTime</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">colFilterTime</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">colSelectTime</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">ratio</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeDump</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The functions that actually do the measurements
use the <a href="https://www.npmjs.com/package/microtime"><code>microtime</code></a> library to get microsecond level timing
because JavaScript's <code>Date</code> only gives us millisecond-level resolution.
We use <a href="https://www.npmjs.com/package/object-sizeof"><code>object-sizeof</code></a> to estimate memory how much memory our structures require;
we also call <code>process.memoryUsage()</code> and look at the <code>heapUsed</code> value
to see how much memory <a href="https://nodejs.org/en/">Node</a> is using while the program runs,
but that may be affected by <a class="gl-ref" href="../glossary/#garbage_collection" markdown="1">garbage collection</a>
and a host of other factors outside our control.</p>
<div class="code-sample lang-js" title="table-performance.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">func</span><span class="p">(...</span><span class="nx">params</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">after</span><span class="p">.</span><span class="nx">heapUsed</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">before</span><span class="p">.</span><span class="nx">heapUsed</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sizeof</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">size</span><span class="p">,</span><span class="w"> </span><span class="nx">heap</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">microtime</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">func</span><span class="p">(...</span><span class="nx">params</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">microtime</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">before</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">calculateRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">f2S</span><span class="p">,</span><span class="w"> </span><span class="nx">rFilterT</span><span class="p">,</span><span class="w"> </span><span class="nx">rSelectT</span><span class="p">,</span><span class="w"> </span><span class="nx">cFilterT</span><span class="p">,</span><span class="w"> </span><span class="nx">cSelectT</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="nx">f2S</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">rFilterT</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">rSelectT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">((</span><span class="nx">f2S</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">cFilterT</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cSelectT</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's run our program for a table with 100 rows and 3 columns and a 3:1 ratio of filter to select:</p>
<div class="code-sample lang-sh" title="table-performance-100-03-03.sh">
<div class="highlight"><pre><span></span><code>node table-performance.js <span class="m">100</span> <span class="m">3</span> <span class="m">3</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="table-performance-100-03-03.out">
<div class="highlight"><pre><span></span><code>nRows: 100
nCols: 3
filterPerSelect: 3
rowSize: 6600
rowHeap: 26512
colSize: 2442
colHeap: 8536
rowFilterTime: 75
rowSelectTime: 111
colFilterTime: 137
colSelectTime: 48
ratio: 0.7320261437908496
</code></pre></div>
</div>
<p class="continue">What if we increase the table size to 10,000 rows by 30 columns with the same 3:1 filter/select ratio?</p>
<div class="code-sample lang-out" title="table-performance-10000-30-03.out">
<div class="highlight"><pre><span></span><code>nRows: 10000
nCols: 30
filterPerSelect: 3
rowSize: 7020000
rowHeap: 18392064
colSize: 2400462
colHeap: -3473800
rowFilterTime: 2929
rowSelectTime: 15863
colFilterTime: 4529
colSelectTime: 104
ratio: 1.8004528522386969
</code></pre></div>
</div>
<p class="continue">And if we keep the table size the same but use a 10:1 filter/select ratio?</p>
<div class="code-sample lang-out" title="table-performance-10000-30-10.out">
<div class="highlight"><pre><span></span><code>nRows: 10000
nCols: 30
filterPerSelect: 10
rowSize: 7020000
rowHeap: 18287160
colSize: 2400462
colHeap: -3645056
rowFilterTime: 2376
rowSelectTime: 15566
colFilterTime: 4380
colSelectTime: 90
ratio: 0.8960127591706539
</code></pre></div>
</div>
<div class="table break-before"><table id="data-table-performance"><caption>Table 6.1: Relative performance of operations on row-major and column-major data tables.</caption>
<thead>
<tr>
<th style="text-align: left;">value</th>
<th style="text-align: right;">100-03-03</th>
<th style="text-align: right;">10000-30-03</th>
<th style="text-align: right;">10000-30-10</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">nRows</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">10000</td>
<td style="text-align: right;">10000</td>
</tr>
<tr>
<td style="text-align: left;">nCols</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">30</td>
</tr>
<tr>
<td style="text-align: left;">filterPerSelect</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">10</td>
</tr>
<tr>
<td style="text-align: left;">rowFilterTime</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">2929</td>
<td style="text-align: right;">2376</td>
</tr>
<tr>
<td style="text-align: left;">rowSelectTime</td>
<td style="text-align: right;">111</td>
<td style="text-align: right;">15863</td>
<td style="text-align: right;">15566</td>
</tr>
<tr>
<td style="text-align: left;">colFilterTime</td>
<td style="text-align: right;">137</td>
<td style="text-align: right;">4529</td>
<td style="text-align: right;">4380</td>
</tr>
<tr>
<td style="text-align: left;">colSelectTime</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">104</td>
<td style="text-align: right;">90</td>
</tr>
</tbody>
</table>
</div>
<p>The results in <a class="tbl-ref" href="../data-table/#data-table-performance">Table 6.1</a> show that column-major storage is better.
It uses less memory (presumably because column labels aren't duplicated once per row)
and the time required to construct new objects when doing select with row-major storage
outweighs cost of appending to arrays when doing filter with column-major storage.
Unfortunately,
the code for column-major storage is a little more complicated to write,
which is a cost that doesn't show up in experiments.</p>
<h2 id="data-table-save">Section 6.3: What is the most efficient way to save a table?</h2>
<p>Data is valuable,
so we are going to store data tables in files of some kind.
If one storage scheme is much more efficient than another and we are reading or writing frequently,
that could change our mind about which implementation to pick.</p>
<p>Two simple text-based schemes are row-oriented and column-oriented <a class="gl-ref" href="../glossary/#json" markdown="1">JSON</a>---basically,
just printing the data structures we have.
Let's run the 10,000×30 test:</p>
<div class="code-sample lang-out" title="storage-performance-10000-30.out">
<div class="highlight"><pre><span></span><code>nRows: 10000
nCols: 30
rowStringTime: 57342
rowStringSize: 9393402
colStringTime: 13267
colStringSize: 2934164
</code></pre></div>
</div>
<p>The time needed for the row-major version is almost ten times greater than
that needed for the column-major version;
we assume that the redundant printing of the labels is mostly to blame,
just as redundant storage of the labels was to blame for row-major's greater memory requirements.</p>
<p>If that diagnosis is correct,
then a packed version of row-major storage ought to be faster.
We save the column headers once,
then copy the data values into an array of arrays and save that:</p>
<div class="code-sample lang-js" title="packed-rows.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">asPackedJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="nx">temp</span><span class="p">.</span><span class="nx">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="nx">temp</span><span class="p">.</span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">table</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">temp</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">row</span><span class="p">[</span><span class="nx">k</span><span class="p">]))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">temp</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="packed-rows-10000-30.out">
<div class="highlight"><pre><span></span><code>nRows: 10000
nCols: 30
packedRowStringTime: 29659
packedRowStringSize: 2974084
</code></pre></div>
</div>
<p>These results show that changing layout for storage
is faster than turning the data structure we have into a string.
Again,
we assume this is because copying data takes less time than turning labels into strings over and over,
but column-major storage is still the best approach.</p>
<h2 id="data-table-binary">Section 6.4: Does binary storage improve performance?</h2>
<p>Let's try one more strategy for storing our tables.
JavaScript stores values in <span class="ix-entry" ix-key="tagged data structure" markdown="1"><a class="gl-ref" href="../glossary/#tagged_data" markdown="1">tagged</a></span> data structures:
some bits define the value's type
while other bits store the value itself in a type-dependent way
(<a class="fig-ref" href="../data-table/#data-table-object-storage">Figure 6.5</a>).</p>
<figure id="data-table-object-storage">
<img alt="JavaScript object storage" src="./data-table/object-storage.svg"/>
<figcaption markdown="1">Figure 6.5: How JavaScript uses tagged data structures to store objects.</figcaption>
</figure>
<p>We can save space by keeping track of the types ourselves
and just storing the bits that represent the values.
JavaScript has an <span class="ix-entry" ix-key="ArrayBuffer" markdown="1"><code>ArrayBuffer</code></span> class for exactly this purpose.
It stores any value we want as a set of bits;
we then access those bits through a view that presents the data as a particular type,
such as Boolean (one byte per value) or number (64 bits per number).
As <a class="fig-ref" href="../data-table/#data-table-packed-storage">Figure 6.6</a> shows,
we can mix different types of data in a single <code>ArrayBuffer</code>,
but it's up to us to keep track of which bytes belong to which values.</p>
<figure id="data-table-packed-storage">
<img alt="Packing objects for storage" src="./data-table/packed-storage.svg"/>
<figcaption markdown="1">Figure 6.6: Storing object values as bits with lookup information.</figcaption>
</figure>
<p>To store a column-major table we will fill an <code>ArrayBuffer</code> with:</p>
<ol>
<li>
<p>Two integers that hold the table's size (number of rows and number of columns).</p>
</li>
<li>
<p>A string with the column labels joined by newline characters.
    (We use newlines as a separator because we assume column labels can't contain them.)</p>
</li>
<li>
<p>The numbers themselves.</p>
</li>
</ol>
<div class="code-sample lang-js" title="packed-cols.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">asBinary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">table</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">table</span><span class="p">[</span><span class="nx">labels</span><span class="p">[</span><span class="mf">0</span><span class="p">]].</span><span class="nx">length</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dimensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint32Array</span><span class="p">([</span><span class="nx">nCols</span><span class="p">,</span><span class="w"> </span><span class="nx">nRows</span><span class="p">])</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allLabels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TextEncoder</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">encodedLabels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">allLabels</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sizeof</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nCols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nRows</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalSize</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">encodedLabels</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dataSize</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">ArrayBuffer</span><span class="p">(</span><span class="nx">totalSize</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">dimensions</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">encodedLabels</span><span class="p">,</span><span class="w"> </span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dimensions</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">encodedLabels</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"></span>
<span class="w">  </span><span class="nx">labels</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Float64Array</span><span class="p">(</span><span class="nx">table</span><span class="p">[</span><span class="nx">label</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">temp</span><span class="p">,</span><span class="w"> </span><span class="nx">current</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">current</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">temp</span><span class="p">.</span><span class="nx">byteLength</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="packed-cols-10000-30.out">
<div class="highlight"><pre><span></span><code>nRows: 10000
nCols: 30
packedColBinaryTime: 6074
packedColBinarySize: 2400268
</code></pre></div>
</div>
<p>Packing the data table saves time
because copying bits is faster than turning numbers into characters,
but it doesn't save as much space as expected.
The reason is that double-precision numbers are 8 bytes long,
but because we have chosen simple integer values for our tests,
they can be represented by just 5 characters (which is 10 bytes).
If we had "real" numbers the storage benefit would probably be more pronounced;
once again,
the result of our experiment depends on the test cases we choose.</p>
<blockquote>
<h3>Engineering</h3>
<p>If science is the use of the experimental method to investigate the world,
engineering is the use of the experimental method
to investigate and improve the things that people build.
Good software designers collect and analyze data all the time
to find out whether one website design works better than another <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Kohavi2020">Kohavi2020</a>]</span>
or to improve the performance of CPUs <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Patterson2017">Patterson2017</a>]</span>;
a few simple experiments like these can sometimes save weeks or months of effort.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="data-table-exercises">Section 6.5: Exercises</h2>
<h3 class="exercise">Varying filter behavior</h3>
<p>How does our decision about which storage format is better change
if we keep 1% of rows when filtering instead of one third?
What if we keep 90% of rows?</p>
<h3 class="exercise">Filtering by strings</h3>
<p>Modify the comparison of filter and select to work with tables
that contain columns of strings instead of columns of numbers
and see how that changes performance.
For testing,
creating random 4-letter strings using the characters A-Z
and then filter by:</p>
<ul>
<li>an exact match,</li>
<li>strings starting with a specific character, and</li>
<li>strings that contain a specific character</li>
</ul>
<h3 class="exercise">Join performance</h3>
<p>A join combines data from two tables based on matching keys.
For example,
if the two tables are:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
</tr>
<tr>
<td>C</td>
<td>c1</td>
</tr>
</tbody>
</table>
<p class="continue">and:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p class="continue">then the join is:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a1</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p>Write a test to compare the performance of row-wise vs. column-wise storage
when joining two tables based on matching numeric keys.
Does the answer depend on the fraction of keys that match?</p>
<h3 class="exercise">Join optimization</h3>
<p>The simplest way to <a class="gl-ref" href="../glossary/#join" markdown="1">join</a> two tables is
to look for matching keys using a double loop.
An alternative is to build an <a class="gl-ref" href="../glossary/#index_database" markdown="1">index</a> for each table
and then use it to construct matches.
For example, suppose the tables are:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Left</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a1</td>
</tr>
<tr>
<td>B</td>
<td>b1</td>
</tr>
<tr>
<td>C</td>
<td>c1</td>
</tr>
</tbody>
</table>
<p class="continue">and:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Right</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>a2</td>
</tr>
<tr>
<td>A</td>
<td>a3</td>
</tr>
<tr>
<td>B</td>
<td>b2</td>
</tr>
</tbody>
</table>
<p>The first step is to create a <code>Map</code> showing where each key is found in the first table:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nx">A</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">B</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">C</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">]}</span><span class="w"></span>
</code></pre></div>
<p class="continue">The second step is to create a similar <code>Map</code> for the second table:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nx">A</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">B</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">]}</span><span class="w"></span>
</code></pre></div>
<p class="continue">We can then loop over the keys in one of the maps,
look up values in the second map,
and construct all of the matches.</p>
<p>Write a function that joins two tables this way.
Is it faster or slower than using a double loop?
How does the answer depend on the number of keys and the fraction that match?</p>
<h3 class="exercise">Flipping storage</h3>
<p>Our tests showed that storing row-oriented tables as JSON
is much slower than storing column-oriented tables.
Write a test to determine whether converting a row-oriented table to a column-oriented table
and then saving the latter
is faster than saving the row-oriented table directly.</p>
<h3 class="exercise">Sparse storage</h3>
<p>A <a class="gl-ref" href="../glossary/#sparse_matrix" markdown="1">sparse matrix</a> is one in which most of the values are zero.
Instead of storing them all,
a program can use a map to store non-zero values
and a lookup function to return zero for anything that isn't stored explicitly:</p>
<div class="highlight"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">spareMatrixGet</span><span class="p">(</span><span class="nx">matrix</span><span class="p">,</span><span class="w"> </span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">matrix</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="nx">matrix</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The same technique can be used if most of the entries in a data table are missing.
Write a function that creates a sparse table in which a random 5% of the values are non-zero
and the other 95% are zero,
then compare the memory requirements and performance of filter and select for this implementation
versus those of row-wise and column-wise storage.</p>
<h3 class="exercise">Loading time</h3>
<p>Modify the programs in this section to measure the time required to convert a data table from JSON or binary form
back to a data structure.</p>
<h3 class="exercise">Saving fixed-width strings</h3>
<p>To improve performance,
databases often store <a class="gl-ref" href="../glossary/#fixed_width_string" markdown="1">fixed-width</a> strings,
i.e.,
they limit the length of the strings in a column to some fixed size
and <a class="gl-ref" href="../glossary/#pad_string" markdown="1">pad</a> strings that are shorter than that.</p>
<ol>
<li>
<p>Write a function that takes an array of strings and an integer with
    and creates an <code>ArrayBuffer</code> containing the strings padded to that width.
    The function should throw an exception if any of the strings
    are longer than the specified width.</p>
</li>
<li>
<p>Write another function that takes an <code>ArrayBuffer</code> as input
    and returns an array of strings.
    This function should remove the padding
    so that strings shorter than the fixed width are restored to their original form.</p>
</li>
</ol>
<h3 class="exercise">Saving variable-width strings</h3>
<p><a class="gl-ref" href="../glossary/#fixed_width_string" markdown="1">Fixed-width</a> storage is inefficient for large blocks of text
such as contracts, novels, and resumés,
since padding every document to the length of the longest will probably waste a lot of space.
An alternative way to store these in binary is to save each entry as a (length, text) pair.</p>
<ol>
<li>
<p>Write a function that takes a list of strings as input
    and returns an <code>ArrayBuffer</code> containing (length, text) pairs.</p>
</li>
<li>
<p>Write another function that takes such an <code>ArrayBuffer</code>
    and returns an array containing the original text.</p>
</li>
<li>
<p>Write tests with Mocha to confirm that your functions work correctly.</p>
</li>
</ol>
<h3 class="exercise">ASCII storage</h3>
<p>The original ASCII standard specified
a 7-bit <a class="gl-ref" href="../glossary/#character_encoding" markdown="1">character encoding</a> for letters commonly used in English,
and many data files still only use characters whose numeric codes are in the range 0--127.</p>
<ol>
<li>
<p>Write a function that takes an array of single-letter strings
    and returns an <code>ArrayBuffer</code> that stores them using one byte per character
    if all of the characters will fit into 7 bits,
    and multiple bytes per character if any of the characters require more than 7 bits.</p>
</li>
<li>
<p>Write another function that takes an <code>ArrayBuffer</code> generated by the first function
    and re-creates the array of characters.
    The function must <em>only</em> take the <code>ArrayBuffer</code> as an argument,
    so the first element of the <code>ArrayBuffer</code> should indicate
    how to interpret the rest of its contents.</p>
</li>
<li>
<p>Write tests with Mocha to check that your functions work correctly.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="pattern-matching">Chapter: Chapter 7: Pattern Matching</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a>, <a class="gl-ref" href="../glossary/#chain_of_responsibility_pattern" markdown="1">Chain of Responsibility pattern</a>, <a class="gl-ref" href="../glossary/#child_tree" markdown="1">child (in a tree)</a>, <a class="gl-ref" href="../glossary/#coupling" markdown="1">coupling</a>, <a class="gl-ref" href="../glossary/#depth_first" markdown="1">depth-first</a>, <a class="gl-ref" href="../glossary/#derived_class" markdown="1">derived class</a>, <a class="gl-ref" href="../glossary/#dom" markdown="1">Document Object Model</a>, <a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager matching</a>, <a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy algorithm</a>, <a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy matching</a>, <a class="gl-ref" href="../glossary/#node" markdown="1">node</a>, <a class="gl-ref" href="../glossary/#open_closed_principle" markdown="1">Open-Closed Principle</a>, <a class="gl-ref" href="../glossary/#polymorphism" markdown="1">polymorphism</a>, <a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selector</a>, <a class="gl-ref" href="../glossary/#regular_expression" markdown="1">regular expression</a>, <a class="gl-ref" href="../glossary/#scope_creep" markdown="1">scope creep</a>, <a class="gl-ref" href="../glossary/#tdd" markdown="1">test-driven development</a>
</p>
<p>We have been globbing to match filenames against patterns since <a class="x-ref" href="#systems-programming">Chapter 2</a>.
This lesson will explore how that works
by building a simple version of the <span class="ix-entry" ix-key="regular expression" markdown="1"><a class="gl-ref" href="../glossary/#regular_expression" markdown="1">regular expressions</a></span>
used to match text in everything from editor and shell commands to web scrapers.
Our approach is inspired by <span class="ix-entry" ix-key="Kernighan, Brian" markdown="1"><a href="https://en.wikipedia.org/wiki/Brian_Kernighan">Brian Kernighan's</a></span> entry
in <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Oram2007">Oram2007</a>]</span>.</p>
<p>Regular expressions have inspired pattern matching for many other kinds of data,
such as <span class="ix-entry" ix-key="query selector (for HTML)" markdown="1"><a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selectors</a></span> for HTML.
They are easier to understand and implement than patterns for matching text,
so we will start by looking at them.</p>
<h2 id="pattern-matching-selectors">Section 7.1: How can we match query selectors?</h2>
<p>Programs stores HTML pages in memory using a <span class="ix-entry" ix-key="DOM;Document Object Model" markdown="1"><a class="gl-ref" href="../glossary/#dom" markdown="1">document object model</a></span> or DOM.
Each element in the page,
such as a heading and or paragraph,
is a <a class="gl-ref" href="../glossary/#node" markdown="1">nodes</a>;
the <a class="gl-ref" href="../glossary/#child_tree" markdown="1">children</a> of a node are the elements it contains
(<a class="fig-ref" href="../pattern-matching/#pattern-matching-dom-tree">Figure 7.1</a>).</p>
<figure id="pattern-matching-dom-tree">
<img alt="The Document Object Model" src="./pattern-matching/dom-tree.svg"/>
<figcaption markdown="1">Figure 7.1: Representing an HTML document as a tree.</figcaption>
</figure>
<p>The first step is to define the patterns we want to support
(<a class="tbl-ref" href="../pattern-matching/#pattern-matching-supported">Table 7.1</a>).</p>
<div class="table"><table id="pattern-matching-supported"><caption>Table 7.1: Supported patterns.</caption>
<thead>
<tr>
<th>Meaning</th>
<th>Selector</th>
</tr>
</thead>
<tbody>
<tr>
<td>Element with tag <code>"elt"</code></td>
<td><code>elt</code></td>
</tr>
<tr>
<td>Element with <code>class="cls"</code></td>
<td><code>.cls</code></td>
</tr>
<tr>
<td>Element with <code>id="ident"</code></td>
<td><code>#ident</code></td>
</tr>
<tr>
<td><code>child</code> element inside a <code>parent</code> element</td>
<td><code>parent child</code></td>
</tr>
</tbody>
</table>
</div>
<p>According to this grammar,
<code>blockquote#important p.highlight</code> is a highlighted paragraph inside the blockquote whose ID is <code>"important"</code>.
To find elements in a page that match it,
our <code>select</code> function breaks the query into pieces
and uses <code>firstMatch</code> to search recursively down the document tree
until all the selectors in the query string have matched or no matches have been found
(<a class="fig-ref" href="../pattern-matching/#pattern-matching-query-selectors">Figure 7.2</a>).</p>
<figure id="pattern-matching-query-selectors">
<img alt="Matching query selectors" src="./pattern-matching/query-selectors.svg"/>
<figcaption markdown="1">Figure 7.2: Matching a simple set of query selectors.</figcaption>
</figure>
<div class="code-sample lang-js" title="simple-selectors.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">root</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">selectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">firstMatch</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">firstMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">selectors</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Require selector(s)'</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Not a tag.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'tag'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// This node matches.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This is the last selector, so matching worked.</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selectors</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Try to match remaining selectors.</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">firstChildMatch</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// This node doesn't match, so try further down.</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">firstChildMatch</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">select</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>firstMatch</code> function handles three cases:</p>
<ol>
<li>
<p>This node isn't an element, i.e., it is plain text or a comment.
    This can't match a selector, and these nodes don't have children,
    so the function returns <code>null</code> to indicate that matching has failed.</p>
</li>
<li>
<p>This node matches the current selector.
    If there aren't any selectors left then the whole pattern must have matched,
    so the function returns this node as the match.
    If there <em>are</em> more selectors,
    we try to match those that remain against this node's children
    and return whatever result that produces.</p>
</li>
<li>
<p>This node <em>doesn't</em> match the current selector,
    so we search the children one by one to see if there is a match further down.</p>
</li>
</ol>
<p>This algorithm is called <span class="ix-entry" ix-key="depth-first search;search!depth-first" markdown="1"><a class="gl-ref" href="../glossary/#depth_first" markdown="1">depth-first search</a></span>:
it explores one possible match to the end before considering any others.
<code>firstMatch</code> relies on a helper function called <code>firstChildMatch</code>,
which finds the first child of a node to match a set of selectors:</p>
<div class="code-sample lang-js" title="simple-selectors.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">firstChildMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'tag'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sb">`Should only try to match first child of tags, not </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// First working match.</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">firstMatch</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">selectors</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">match</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Nothing worked.</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and on the function <code>matchHere</code> which compares a node against a selector:</p>
<div class="code-sample lang-js" title="simple-selectors.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">matchHere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'#'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">cls</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="nx">cls</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">.</span><span class="kd">class</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">cls</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>This version of <code>matchHere</code> is simple but inefficient,
since it breaks the selector into parts each time it is called
rather than doing that once and re-using the results.
We will build a more efficient version in the exercises,
but let's try out the one we have.
Our test cases are all in one piece of HTML:</p>
<div class="code-sample lang-js" title="simple-selectors-test.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">HTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;main&gt;</span>
<span class="sb">  &lt;p&gt;text of first p&lt;/p&gt;</span>
<span class="sb">  &lt;p id="id-01"&gt;text of p#id-01&lt;/p&gt;</span>
<span class="sb">  &lt;p id="id-02"&gt;text of p#id-02&lt;/p&gt;</span>
<span class="sb">  &lt;p class="class-03"&gt;text of p.class-03&lt;/p&gt;</span>
<span class="sb">  &lt;div&gt;</span>
<span class="sb">    &lt;p&gt;text of div / p&lt;/p&gt;</span>
<span class="sb">    &lt;p id="id-04"&gt;text of div / p#id-04&lt;/p&gt;</span>
<span class="sb">    &lt;p class="class-05"&gt;text of div / p.class-05&lt;/p&gt;</span>
<span class="sb">    &lt;p class="class-06"&gt;should not be found&lt;/p&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">  &lt;div id="id-07"&gt;</span>
<span class="sb">    &lt;p&gt;text of div#id-07 / p&lt;/p&gt;</span>
<span class="sb">    &lt;p class="class-06"&gt;text of div#id-07 / p.class-06&lt;/p&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">&lt;/main&gt;`</span><span class="w"></span>
</code></pre></div>
</div>
<p>The program contains a table of queries and the expected matches.
The function <code>main</code> loops over it to report whether each test passes or fails:</p>
<div class="code-sample lang-js" title="simple-selectors-test.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">htmlparser2</span><span class="p">.</span><span class="nx">parseDOM</span><span class="p">(</span><span class="nx">HTML</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'p'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of first p'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'p#id-01'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of p#id-01'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'p#id-02'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of p#id-02'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'p.class-03'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of p.class-03'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'div p'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of div / p'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'div p#id-04'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of div / p#id-04'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'div p.class-05'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of div / p.class-05'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'div#id-07 p'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of div#id-07 / p'</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'div#id-07 p.class-06'</span><span class="p">,</span><span class="w"> </span><span class="s1">'text of div#id-07 / p.class-06'</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">tests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">select</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getText</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">'pass'</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">'fail'</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`"</span><span class="si">${</span><span class="nx">selector</span><span class="si">}</span><span class="sb">": </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue"><code>main</code> uses a helper function called <code>getText</code> to extract text from a node
or return an error message if something has gone wrong:</p>
<div class="code-sample lang-js" title="simple-selectors-test.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">getText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'MISSING NODE'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">'children'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'MISSING CHILDREN'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'WRONG NUMBER OF CHILDREN'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'text'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'NOT TEXT'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>When we run our program it produces this result:</p>
<div class="code-sample lang-out" title="simple-selectors-test.out">
<div class="highlight"><pre><span></span><code>"p": pass
"p#id-01": pass
"p#id-02": pass
"p.class-03": pass
"div p": pass
"div p#id-04": pass
"div p.class-05": pass
"div#id-07 p": pass
"div#id-07 p.class-06": pass
</code></pre></div>
</div>
<p>We will rewrite these tests using <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> in the exercises.</p>
<blockquote>
<h3>Test then build</h3>
<p>We actually wrote our test cases <em>before</em> implementing the code to match query selectors
in order to give ourselves a goal to work toward.
Doing this is called <span class="ix-entry" ix-key="test-driven development;TDD" markdown="1"><a class="gl-ref" href="../glossary/#tdd" markdown="1">test-driven development</a></span>, or TDD;
while research doesn't support the claim that
it makes programmers more productive <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Fucci2016">Fucci2016</a>, <a class="bib-ref" href="../bibliography/#Fucci2017">Fucci2017</a>]</span>,
we find it helps prevent <span class="ix-entry" ix-key="scope creep!when writing lessons" markdown="1"><a class="gl-ref" href="../glossary/#scope_creep" markdown="1">scope creep</a></span> when writing lessons.</p>
</blockquote>
<h2 id="pattern-matching-re">Section 7.2: How can we implement a simple regular expression matcher?</h2>
<p>Matching regular expressions against text relies on the same recursive strategy
as matching query selectors against nodes in an HTML page.
If the first element of the pattern matches where we are,
we see if the rest of the pattern matches what's left;
otherwise,
we see if the the pattern will match further along.
Our matcher will initially handle just the five cases shown in
<a class="tbl-ref" href="../pattern-matching/#pattern-matching-cases">Table 7.2</a>.</p>
<div class="table"><table id="pattern-matching-cases"><caption>Table 7.2: Pattern matching cases.</caption>
<thead>
<tr>
<th>Meaning</th>
<th>Character</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any literal character <em>c</em></td>
<td><em>c</em></td>
</tr>
<tr>
<td>Any single character</td>
<td>.</td>
</tr>
<tr>
<td>Beginning of input</td>
<td>^</td>
</tr>
<tr>
<td>End of input</td>
<td>$</td>
</tr>
<tr>
<td>Zero or more of the previous character</td>
<td>*</td>
</tr>
</tbody>
</table>
</div>
<p class="continue">These five cases are a small subset of what JavaScript provides,
but as <span class="ix-entry" ix-key="Kernighan, Brian" markdown="1">Kernighan</span> wrote,
"This is quite a useful class;
in my own experience of using regular expressions on a day-to-day basis,
it easily accounts for 95 percent of all instances."</p>
<p>The top-level function that users call
handles the special case of <code>^</code> at the start of a pattern
matching the start of the target string being searched.
It then tries the pattern against each successive substring of the target string
until it finds a match or runs out of characters:</p>
<div class="code-sample lang-js" title="simple-regex.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// '^' at start of pattern matches start of text.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'^'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Try all possible starting points for pattern.</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">iText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">iText</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">iText</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">iText</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Nothing worked.</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p><code>matchHere</code> does the matching and recursing:</p>
<div class="code-sample lang-js" title="simple-regex.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">matchHere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">iPattern</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">iText</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// There is no more pattern to match.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">iPattern</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// '$' at end of pattern matches end of text.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">iPattern</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">iPattern</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'$'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">iText</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// '*' following current character means match many.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">iPattern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">iPattern</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'*'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="nx">iText</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">[</span><span class="nx">iText</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">pattern</span><span class="p">[</span><span class="nx">iPattern</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">iText</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">iPattern</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">iText</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Match a single character.</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">iPattern</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'.'</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">iPattern</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">text</span><span class="p">[</span><span class="nx">iText</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">matchHere</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">iPattern</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">iText</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Nothing worked.</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Once again,
we use a table of test cases and expected results to test it:</p>
<div class="code-sample lang-js" title="simple-regex.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">'baac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abbbc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abxc'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">tests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">regexp</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">match</span><span class="p">(</span><span class="nx">regexp</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">'pass'</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">'fail'</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`"</span><span class="si">${</span><span class="nx">regexp</span><span class="si">}</span><span class="sb">" X "</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">": </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="simple-regex.out">
<div class="highlight"><pre><span></span><code>"a" X "a": pass
"b" X "a": pass
"a" X "ab": pass
"b" X "ab": pass
"ab" X "ba": pass
"^a" X "ab": pass
"^b" X "ab": pass
"a$" X "ab": pass
"a$" X "ba": pass
"a*" X "": pass
"a*" X "baac": pass
"ab*c" X "ac": pass
"ab*c" X "abc": pass
"ab*c" X "abbbc": pass
"ab*c" X "abxc": pass
</code></pre></div>
</div>
<p>This program seems to work,
but it actually contains an error that we will correct in the exercises.
(Think about what happens if we match the pattern <code>/a*ab/</code> against the string <code>'aab'</code>.)
Our design is also hard to extend:
handling parentheses in patterns like <code>/a(bc)*d/</code> will require major changes.
We need to explore a different approach.</p>
<h2 id="pattern-matching-extensible">Section 7.3: How can we implement an extensible matcher?</h2>
<p>Instead of packing all of our code into one long function,
we can implement each kind of match as separate function.
Doing this makes it much easier to add more matchers:
we just define a function that we can mix in with calls to the ones we already have.</p>
<p>Rather than having these functions do the matching immediately,
though,
we will have each one return an object that knows how to match itself against some text.
Doing this allows us to build a complex match once and re-use it many times.
This is a common pattern in text processing:
we may want to apply a regular expression to each line in a large set of files,
so recycling the matchers will make our programs more efficient.</p>
<p>Each matching object has a method that takes the target string and the index to start matching at as inputs.
Its output is the index to continue matching at
or <code>undefined</code> indicating that matching failed.
We can then combine these objects to match complex patterns
(<a class="fig-ref" href="../pattern-matching/#pattern-matching-regex-objects">Figure 7.3</a>).</p>
<figure id="pattern-matching-regex-objects">
<img alt="Implementing regex with objects" src="./pattern-matching/regex-objects.svg"/>
<figcaption markdown="1">Figure 7.3: Using nested objects to match regular expressions.</figcaption>
</figure>
<p>The first step in implementing this is to write test cases,
which forces us to define the syntax we are going to support:</p>
<div class="code-sample lang-js" title="regex-complete.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Alt</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-alt.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Any</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-any.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">End</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-end.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Lit</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-lit.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Seq</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-seq.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Start</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-start.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Start</span><span class="p">(),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Start</span><span class="p">(),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">End</span><span class="p">())],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">End</span><span class="p">())],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">'baac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abbbc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abxc'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab|cd'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xaby'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'cd'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab|cd'</span><span class="p">,</span><span class="w"> </span><span class="s1">'acdc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'cd'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a(b|c)d'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xabdy'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'d'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a(b|c)d'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xabady'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">Seq</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'d'</span><span class="p">))]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">tests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">matcher</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">'pass'</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">'fail'</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`"</span><span class="si">${</span><span class="nx">pattern</span><span class="si">}</span><span class="sb">" X "</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">": </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p>Next,
we define a <a class="gl-ref" href="../glossary/#base_class" markdown="1">base class</a> that all matchers will inherit from.
This class contains the <code>match</code> method that users will call
so that we can start matching right away
no matter what kind of matcher we have at the top level of our pattern.</p>
<div class="code-sample lang-js" title="regex-base.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'derived classes must override "_match"'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The base class also defines a <code>_match</code> method (with a leading underscore)
that other classes will fill in with actual matching code.
The base implementation of this method throws an exception
so that if we forget to provide <code>_match</code> in a <a class="gl-ref" href="../glossary/#derived_class" markdown="1">derived class</a>
our code will fail with a meaningful reminder.</p>
<blockquote>
<h3>One interface to call them all</h3>
<p>Our design makes use of <span class="ix-entry" ix-key="polymorphism (in software design);software design!polymorphism" markdown="1"><a class="gl-ref" href="../glossary/#polymorphism" markdown="1">polymorphism</a></span>,
which literally means "having multiple forms".
If a set of objects all have methods that can be called the same way,
then those objects can be used interchangeably;
putting it another way,
a program can use them without knowing exactly what they are.
Polymorphism reduces the <span class="ix-entry" ix-key="coupling;software design!coupling" markdown="1"><a class="gl-ref" href="../glossary/#coupling" markdown="1">coupling</a></span> between different parts of our program,
which in turn makes it easier for those programs to evolve.</p>
</blockquote>
<p>We can now define empty versions of each matching class that all say "no match here"
like this one for literal characters:</p>
<div class="code-sample lang-js" title="regex-lit.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexLit</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chars</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="c1">// FIXME</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexLit</span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Our tests now run, but most of them fail:
"most" because we expect some tests not to match,
so the test runner reports <code>true</code>.</p>
<div class="code-sample lang-out" title="regex-initial.out">
<div class="highlight"><pre><span></span><code>"a" X "a": fail
"b" X "a": pass
"a" X "ab": fail
"b" X "ab": fail
"ab" X "ab": fail
"ba" X "ab": pass
"ab" X "ba": pass
"^a" X "ab": fail
"^b" X "ab": pass
"a$" X "ab": pass
"a$" X "ba": fail
"a*" X "": fail
"a*" X "baac": fail
"ab*c" X "ac": fail
"ab*c" X "abc": fail
"ab*c" X "abbbc": fail
"ab*c" X "abxc": pass
"ab|cd" X "xaby": fail
"ab|cd" X "acdc": fail
"a(b|c)d" X "xabdy": fail
"a(b|c)d" X "xabady": pass
</code></pre></div>
</div>
<p class="continue">This output tells us how much work we have left to do:
when all of these tests pass,
we're finished.</p>
<p>Let's implement a literal character string matcher first:</p>
<div class="code-sample lang-js" title="regex-lit.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexLit</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chars</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nextIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">nextIndex</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">nextIndex</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexLit</span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>Some tests now pass, others still fail as expected:</p>
<div class="code-sample lang-out" title="regex-beginning.out">
<div class="highlight"><pre><span></span><code>"a" X "a": pass
"b" X "a": pass
"a" X "ab": pass
"b" X "ab": pass
"ab" X "ab": fail
"ba" X "ab": pass
"ab" X "ba": pass
"^a" X "ab": fail
"^b" X "ab": pass
"a$" X "ab": pass
"a$" X "ba": fail
"a*" X "": fail
"a*" X "baac": fail
"ab*c" X "ac": fail
"ab*c" X "abc": fail
"ab*c" X "abbbc": fail
"ab*c" X "abxc": pass
"ab|cd" X "xaby": fail
"ab|cd" X "acdc": fail
"a(b|c)d" X "xabdy": fail
"a(b|c)d" X "xabady": pass
</code></pre></div>
</div>
<p>We will tackle <code>RegexSeq</code> next so that we can combine other matchers.
This is why we have tests for <code>Seq(Lit('a'), Lit('b'))</code> and <code>Lit('ab')</code>:
all children have to match in order without gaps.</p>
<p>But wait:
suppose we have the pattern <code>/a*ab/</code>.
This ought to match the text <code>"ab"</code>, but will it?
The <code>/*/</code> is <span class="ix-entry" ix-key="greedy algorithm;algorithm!greedy" markdown="1"><a class="gl-ref" href="../glossary/#greedy_algorithm" markdown="1">greedy</a></span>: it matches as much as it can
(which is also called <span class="ix-entry" ix-key="eager matching;matching!eager" markdown="1"><a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager matching</a></span>).
As a result,
<code>/a*/</code> will match the leading <code>"a"</code>, leaving nothing for the literal <code>/a/</code> to match
(<a class="fig-ref" href="../pattern-matching/#pattern-matching-greedy-failure">Figure 7.4</a>).
Our current implementation doesn't give us a way to try other possible matches when this happens.</p>
<figure id="pattern-matching-greedy-failure">
<img alt="Overly-greedy matching fails" src="./pattern-matching/greedy-failure.svg"/>
<figcaption markdown="1">Figure 7.4: Why overly-greedy matching doesn't work.</figcaption>
</figure>
<p>Let's re-think our design
and have each matcher take its own arguments and a <code>rest</code> parameter containing the rest of the matchers
(<a class="fig-ref" href="../pattern-matching/#pattern-matching-rest">Figure 7.5</a>).
(We will provide a default of <code>null</code> in the creation function
so we don't have to type <code>null</code> over and over again.)
Each matcher will try each of its possibilities and then see if the rest will also match.</p>
<figure id="pattern-matching-rest">
<img alt="Matching the rest of the pattern" src="./pattern-matching/rest.svg"/>
<figcaption markdown="1">Figure 7.5: Using `rest` to match the remainder of a pattern.</figcaption>
</figure>
<p>This design means we can get rid of <code>RegexSeq</code>,
but it does make our tests a little harder to read:</p>
<div class="code-sample lang-js" title="regex-complete.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Alt</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-alt.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Any</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-any.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">End</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-end.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Lit</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-lit.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Start</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-start.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Start</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'^b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Start</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ab'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">End</span><span class="p">())],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a$'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ba'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">End</span><span class="p">())],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a*'</span><span class="p">,</span><span class="w"> </span><span class="s1">'baac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ac'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abbbc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab*c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'abxc'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Any</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab|cd'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xaby'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'cd'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'ab|cd'</span><span class="p">,</span><span class="w"> </span><span class="s1">'acdc'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'cd'</span><span class="p">))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a(b|c)d'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xabdy'</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'d'</span><span class="p">)))],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s1">'a(b|c)d'</span><span class="p">,</span><span class="w"> </span><span class="s1">'xabady'</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">Alt</span><span class="p">(</span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'c'</span><span class="p">),</span><span class="w"> </span><span class="nx">Lit</span><span class="p">(</span><span class="s1">'d'</span><span class="p">)))]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">tests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">pattern</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">matcher</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">expected</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">'pass'</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">'fail'</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`"</span><span class="si">${</span><span class="nx">pattern</span><span class="si">}</span><span class="sb">" X "</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">": </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p>Here's how this works for matching a literal expression:</p>
<div class="code-sample lang-js" title="regex-lit.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexLit</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chars</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nextIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nextIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">nextIndex</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">chars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">nextIndex</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">nextIndex</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">chars</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexLit</span><span class="p">(</span><span class="nx">chars</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The <code>_match</code> method checks whether all of the pattern matches the target text starting at the current location.
If so, it checks whether the rest of the overall pattern matches what's left.
Matching the start <code>/^/</code> and end <code>/$/</code> anchors is just as straightforward:</p>
<div class="code-sample lang-js" title="regex-start.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexStart</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexStart</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="regex-end.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexEnd</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexEnd</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>Matching either/or is done by trying the first pattern and the rest,
and if that fails,
trying the second pattern and the rest:</p>
<div class="code-sample lang-js" title="regex-alt.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexAlt</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">left</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">right</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">pat</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">right</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">afterPat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pat</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">afterPat</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">afterPat</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">afterRest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">afterPat</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">afterRest</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">afterRest</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexAlt</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">create</span><span class="w"></span>
</code></pre></div>
</div>
<p>To match a repetition,
we figure out the maximum number of matches that might be left,
then count down until something succeeds.
(We start with the maximum because matching is supposed to be greedy.)
Each non-empty repetition matches at least one character,
so the number of remaining characters is the maximum number of matches worth trying.</p>
<div class="code-sample lang-js" title="regex-any.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./regex-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RegexAny</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">RegexBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">child</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_match</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxPossible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">maxPossible</span><span class="p">;</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">num</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">afterMany</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_matchMany</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">num</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">afterMany</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">afterMany</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">_matchMany</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">num</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">num</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">start</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rest</span><span class="p">.</span><span class="nx">_match</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">start</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RegexAny</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">create</span><span class="w"></span>
</code></pre></div>
</div>
<p>With these classes in place,
our tests all pass:</p>
<div class="code-sample lang-out" title="regex-recursive.out">
<div class="highlight"><pre><span></span><code>"a" X "a": pass
"b" X "a": pass
"a" X "ab": pass
"b" X "ab": pass
"ab" X "ab": pass
"ba" X "ab": pass
"ab" X "ba": pass
"^a" X "ab": pass
"^b" X "ab": pass
"a$" X "ab": pass
"a$" X "ba": pass
"a*" X "": pass
"a*" X "baac": pass
"ab*c" X "ac": pass
"ab*c" X "abc": pass
"ab*c" X "abbbc": pass
"ab*c" X "abxc": pass
"ab|cd" X "xaby": pass
"ab|cd" X "acdc": pass
"a(b|c)d" X "xabdy": pass
"a(b|c)d" X "xabady": pass
</code></pre></div>
</div>
<p>The most important thing about this design is how extensible it is:
if we want to add other kinds of matching,
all we have to do is add more classes.
That extensibility comes from the lack of centralized decision-making,
which in turn comes from our use of polymorphism
and the <span class="ix-entry" ix-key="Chain of Responsibility pattern;design pattern!Chain of Responsibility" markdown="1"><a class="gl-ref" href="../glossary/#chain_of_responsibility_pattern" markdown="1">Chain of Responsibility</a></span> design pattern.
Each component does its part and asks something else to handle the remaining work;
so long as each component takes the same inputs,
we can put them together however we want.</p>
<blockquote>
<h3>The Open-Closed Principle</h3>
<p>The <span class="ix-entry" ix-key="Open-Closed Principle;software design!Open-Closed Principle" markdown="1"><a class="gl-ref" href="../glossary/#open_closed_principle" markdown="1">Open-Closed Principle</a></span> states that
software should be open for extension but closed for modification,
i.e., that it should be possible to extend functionality
without having to rewrite existing code.
As we said in <a class="x-ref" href="#async-programming">Chapter 3</a>,
this allows old code to use new code,
but only if our design permits the kinds of extensions people are going to want to make.
Since we can't anticipate everything,
it is normal to have to revise a design the first two or three times we try to extend it.
As <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Brand1995">Brand1995</a>]</span> said of buildings,
the things we make learn how to do things better as we use them.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="pattern-matching-exercises">Section 7.4: Exercises</h2>
<h3 class="exercise">Split once</h3>
<p>Modify the query selector code so that selectors like <code>div#id</code> and <code>div.class</code> are only split into pieces once
rather than being re-split each time <code>matchHere</code> is called.</p>
<h3 class="exercise">Find and fix the error</h3>
<p>The first regular expression matcher contains an error:
the pattern <code>'a*ab'</code> should match the string <code>'aab'</code> but doesn't.
Figure out why it fails and fix it.</p>
<h3 class="exercise">Unit tests</h3>
<p>Rewrite the tests for selectors and regular expressions to use Mocha.</p>
<h3 class="exercise">Find all with query selectors</h3>
<p>Modify the query selector so that it returns <em>all</em> matches, not just the first one.</p>
<h3 class="exercise">Select based on attributes</h3>
<p>Modify the query selector to handle <code>[attribute="value"]</code> selectors,
so that (for example) <code>div[align=center]</code> returns all <code>div</code> elements
whose <code>align</code> attribute has the value <code>"center"</code>.</p>
<h3 class="exercise">Child selectors</h3>
<p>The expression <code>parent &gt; child</code> selects all nodes of type <code>child</code>
that are immediate children of nodes of type <code>parent</code>---for example,
<code>div &gt; p</code> selects all paragraphs that are immediate children of <code>div</code> elements.
Modify <code>simple-selectors.js</code> to handle this kind of matching.</p>
<h3 class="exercise">Find all with regular expressions</h3>
<p>Modify the regular expression matcher to return <em>all</em> matches rather than just the first one.</p>
<h3 class="exercise">Find one or more with regular expressions</h3>
<p>Extend the regular expression matcher to support <code>+</code>, meaning "one or more".</p>
<h3 class="exercise">Match sets of characters</h3>
<p>Add a new regular expression matching class that matches any character from a set,
so that <code>Charset('aeiou')</code> matches any lower-case vowel.</p>
<h3 class="exercise">Make repetition more efficient</h3>
<p>Rewrite <code>RegexAny</code> so that it does not repeatedly re-match text.</p>
<h3 class="exercise">Lazy matching</h3>
<p>The regular expressions we have seen so far are <a class="gl-ref" href="../glossary/#eager_matching" markdown="1">eager</a>:
they match as much as they can, as early as they can.
An alternative is <a class="gl-ref" href="../glossary/#lazy_matching" markdown="1">lazy matching</a>,
in which expressions match as little as they need to.
For example,
given the string <code>"ab"</code>,
an eager match with the expression <code>/ab*/</code> will match both letters
(because <code>/b*/</code> matches a 'b' if one is available)
but a lazy match will only match the first letter
(because <code>/b*/</code> can match no letters at all).
Implement lazy matching for the <code>*</code> operator.</p>
<h3 class="exercise">Optional matching</h3>
<p>The <code>?</code> operator means "optional",
so that <code>/a?/</code> matches either zero or one occurrences of the letter 'a'.
Implement this operator.</p>
</section>
<section class="new-chapter"><h1 id="regex-parser">Chapter: Chapter 8: Parsing Expressions</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#fsm" markdown="1">finite state machine</a>, <a class="gl-ref" href="../glossary/#literal" markdown="1">literal</a>, <a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a>, <a class="gl-ref" href="../glossary/#precedence" markdown="1">precedence</a>, <a class="gl-ref" href="../glossary/#token" markdown="1">token</a>, <a class="gl-ref" href="../glossary/#turing_machine" markdown="1">Turing Machine</a>, <a class="gl-ref" href="../glossary/#well_formed" markdown="1">well formed</a>, <a class="gl-ref" href="../glossary/#yaml" markdown="1">YAML</a>
</p>
<p>In <a class="x-ref" href="#pattern-matching">Chapter 7</a> we created regular expressions by constructing objects.
It takes a lot less typing to write them as strings as we did for HTML selectors,
but if we're going to do that we need something to convert those strings to the required objects.
In other words, we need to write a <span class="ix-entry" ix-key="parser" markdown="1"><a class="gl-ref" href="../glossary/#parser" markdown="1">parser</a></span>.</p>
<div class="table"><table id="regex-parser-grammar-codes"><caption>Table 8.1: Regular expression grammar.</caption>
<thead>
<tr>
<th>Meaning</th>
<th>Character</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any literal character <em>c</em></td>
<td><em>c</em></td>
</tr>
<tr>
<td>Beginning of input</td>
<td>^</td>
</tr>
<tr>
<td>End of input</td>
<td>$</td>
</tr>
<tr>
<td>Zero or more of the previous thing</td>
<td>*</td>
</tr>
<tr>
<td>Either/or</td>
<td>|</td>
</tr>
<tr>
<td>Grouping</td>
<td>(…)</td>
</tr>
</tbody>
</table>
</div>
<p><a class="tbl-ref" href="../regex-parser/#regex-parser-grammar-codes">Table 8.1</a> shows the grammar we will handle.
When we are done
we should be able to parse <code>/^(a|b|$)*z$/</code> as
"start of text",
"any number of 'a', 'b', or '$'",
"a single 'z',
and "end of text".
(We write regular expressions inside slashes to distinguish them from strings.)
To keep things simple,
we will create a tree of objects (<a class="fig-ref" href="../regex-parser/#regex-parser-expression-tree">Figure 8.1</a>)
rather than instances of the regular expression classes from <a class="x-ref" href="#pattern-matching">Chapter 7</a>;
the exercises will tackle the latter.</p>
<figure id="regex-parser-expression-tree">
<img alt="Expression tree for regular expression" src="./regex-parser/expression-tree.svg"/>
<figcaption markdown="1">Figure 8.1: Representing the result of parsing a regular expression as an tree.</figcaption>
</figure>
<blockquote>
<h3>Please don't write parsers</h3>
<p>Languages that are comfortable for people to read are usually difficult for computers to understand
and vice versa,
so we need parsers to translate human-friendly notation into computer-friendly representations.
However,
<span class="ix-entry" ix-key="parser!reasons not to write" markdown="1">the world doesn't need more file formats</span>;
if you need a configuration file or lookup table,
please use CSV, JSON, <a class="gl-ref" href="../glossary/#yaml" markdown="1">YAML</a>,
or something else that already has an acronym
rather than inventing a format of your own.</p>
</blockquote>
<h2 id="regex-parser-tokenize">Section 8.1: How can we break text into tokens?</h2>
<p>A <span class="ix-entry" ix-key="token (in parsing)" markdown="1"><a class="gl-ref" href="../glossary/#token" markdown="1">token</a></span> is an atom of text,
such as the digits making up a number or the letters making up a variable name.
In our grammar the tokens are the special characters <code>*</code>, <code>|</code>, <code>(</code>, <code>)</code>, <code>^</code>, and <code>$</code>,
plus any sequence of one or more other characters (which count as one multi-letter token).
This classification guides the design of our parser:</p>
<ol>
<li>
<p>If a character is special, create a token for it.</p>
</li>
<li>
<p>If it is a <span class="ix-entry" ix-key="literal (in parsing)" markdown="1"><a class="gl-ref" href="../glossary/#literal" markdown="1">literal</a></span> then:</p>
<ol>
<li>combine it with the current literal if there is one, or</li>
<li>start a new literal.</li>
</ol>
</li>
<li>
<p>Since <code>^</code> and <code>$</code> are either special or regular depending on position,
    we must treat them as separate tokens or as part of a literal
    based on where they appear.</p>
</li>
</ol>
<p>We can translate these rules almost directly into code
to create a list of objects whose keys are <code>kind</code> and <code>loc</code> (short for location),
with the extra key <code>value</code> for literal values:</p>
<div class="code-sample lang-js" title="tokenizer-collapse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s1">'*'</span><span class="o">:</span><span class="w"> </span><span class="s1">'Any'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'|'</span><span class="o">:</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'('</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupStart'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">')'</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupEnd'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'^'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">combineOrPush</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'$'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'End'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">combineOrPush</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">combineOrPush</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"></span>
</code></pre></div>
</div>
<p>The helper function <code>combineOrPush</code> does exactly what its name says.
If the thing most recently added to the list of tokens isn't a literal,
the new character becomes a new token;
otherwise,
we append the new character to the literal we're building:</p>
<div class="code-sample lang-js" title="tokenizer-collapse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">combineOrPush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">soFar</span><span class="p">,</span><span class="w"> </span><span class="nx">character</span><span class="p">,</span><span class="w"> </span><span class="nx">location</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">topIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">soFar</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">soFar</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">soFar</span><span class="p">[</span><span class="nx">topIndex</span><span class="p">].</span><span class="nx">token</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">soFar</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">character</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">location</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">soFar</span><span class="p">[</span><span class="nx">topIndex</span><span class="p">].</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">character</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can try this out with a three-line test program:</p>
<div class="code-sample lang-js" title="tokenizer-collapse-example.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./tokenizer-collapse.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'^a^b*'</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="tokenizer-collapse-example.out">
<div class="highlight"><pre><span></span><code>[
  {
    "kind": "Start",
    "loc": 0
  },
  {
    "kind": "Lit",
    "value": "a",
    "loc": 1
  },
  {
    "kind": "Lit",
    "value": "^",
    "loc": 2
  },
  {
    "kind": "Lit",
    "value": "b",
    "loc": 3
  },
  {
    "kind": "Any",
    "loc": 4
  }
]
</code></pre></div>
</div>
<p>This simple tokenizer is readable, efficient, and wrong.
The problem is that the expression <code>/ab*/</code> means "a single <code>a</code> followed by zero or more <code>b</code>".
If we combine the <code>a</code> and <code>b</code> as we read them,
though,
we wind up with "zero or more repetitions of <code>ab</code>".
(Don't feel bad if you didn't spot this:
we didn't notice the problem until we were implementing the next step.)</p>
<p>The solution is to treat each regular character as its own literal in this stage
and then combine things later.
Doing this lets us get rid of the nested <code>if</code> for handling <code>^</code> and <code>$</code> as well:</p>
<div class="code-sample lang-js" title="tokenizer.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s1">'*'</span><span class="o">:</span><span class="w"> </span><span class="s1">'Any'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'|'</span><span class="o">:</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'('</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupStart'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">')'</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupEnd'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'^'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'$'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'End'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"></span>
</code></pre></div>
</div>
<p>Software isn't done until it's tested,
so let's build some <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> tests for our tokenizer.
The listing below shows a few of these
along with the output for the full set:</p>
<div class="code-sample lang-js" title="test-tokenizer.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../tokenizer.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'tokenizes correctly'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'tokenizes a single character'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">tokenize</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'tokenizes a sequence of characters'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">tokenize</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'tokenizes start anchor alone'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">tokenize</span><span class="p">(</span><span class="s1">'^'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'tokenizes start anchor followed by characters'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">tokenize</span><span class="p">(</span><span class="s1">'^a'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'tokenizes a complex expression'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">tokenize</span><span class="p">(</span><span class="s1">'^a*(bcd|e^)*f$gh$'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Any'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupStart'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'b'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'c'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'d'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'e'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'^'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'GroupEnd'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Any'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">11</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'f'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">13</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'$'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">14</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'g'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'h'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'End'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">16</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="tokenizer-test.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "tokenizes correctly"



  tokenizes correctly
    ✓ tokenizes a single character
    ✓ tokenizes a sequence of characters
    ✓ tokenizes start anchor alone
    ✓ tokenizes start anchor followed by characters
    ✓ tokenizes circumflex not at start
    ✓ tokenizes start anchor alone
    ✓ tokenizes end anchor preceded by characters
    ✓ tokenizes dollar sign not at end
    ✓ tokenizes repetition alone
    ✓ tokenizes repetition in string
    ✓ tokenizes repetition at end of string
    ✓ tokenizes alternation alone
    ✓ tokenizes alternation in string
    ✓ tokenizes alternation at start of string
    ✓ tokenizes the start of a group alone
    ✓ tokenizes the start of a group in a string
    ✓ tokenizes the end of a group alone
    ✓ tokenizes the end of a group at the end of a string
    ✓ tokenizes a complex expression


  19 passing (12ms)
</code></pre></div>
</div>
<h2 id="regex-parser-tree">Section 8.2: How can we turn a list of tokens into a tree?</h2>
<p>We now have a list of tokens,
but we need a tree that captures the nesting introduced by parentheses
and the way that <code>*</code> applies to whatever comes before it.
Let's trace a few cases in order to see how to build this tree:</p>
<ol>
<li>
<p>If the regular expression is <code>/a/</code>, we create a <code>Lit</code> token for the letter <code>a</code>
    (where "create" means "append to the output list").</p>
</li>
<li>
<p>What if the regular expression is <code>/a*/</code>?
    We first create a <code>Lit</code> token for the <code>a</code> and append it to the output list.
    When we see the <code>*</code>,
    we take that <code>Lit</code> token off the tail of the output list
    and replace it with an <code>Any</code> token that has the <code>Lit</code> token as its child.</p>
</li>
<li>
<p>Our next thought experiment is <code>/(ab)/</code>.
    We don't know how long the group is going to be when we see the <code>(</code>,
    so we put the parenthesis onto the output as a marker.
    We then add the <code>Lit</code> tokens for the <code>a</code> and <code>b</code>
    until we see the <code>)</code>,
    at which point we pull tokens off the end of the output list
    until we get back to the <code>(</code> marker.
    When we find it,
    we put everything we have temporarily collected into a <code>Group</code> token and append it to the output list.
    This algorithm automatically handles <code>/(a*)/</code> and <code>/(a(b*)c)/</code>.</p>
</li>
<li>
<p>What about <code>/a|b/</code>?
    We append a <code>Lit</code> token for <code>a</code>, get the <code>|</code> and---and we're stuck,
    because we don't yet have the next token we need to finish building the <code>Alt</code>.</p>
</li>
</ol>
<p>One way to solve this problem is to check to see if the thing on the top of the stack is waiting to combine
each time we append a new token.
However,
this doesn't handle <code>/a|b*/</code> properly.
The pattern is supposed to mean "one <code>a</code> or any number of <code>b</code>",
but the <span class="ix-entry" ix-key="parser!check-and-combine" markdown="1">check-and-combine strategy</span> will turn it into the equivalent of <code>/(a|b)*/</code>.</p>
<p>A better (i.e., correct) solution is
to leave some partially-completed tokens in the output and <span class="ix-entry" ix-key="parser!post-hoc compression strategy" markdown="1">compress</span> them later
(<a class="fig-ref" href="../regex-parser/#regex-parser-mechanics">Figure 8.2</a>).
If our input is the pattern <code>/a|b/</code>, we can:</p>
<ol>
<li>
<p>Append a <code>Lit</code> token for <code>a</code>.</p>
</li>
<li>
<p>When we see <code>|</code>,
    make that <code>Lit</code> token the left child of the <code>Alt</code>
    and append that without filling in the right child.</p>
</li>
<li>
<p>Append the <code>Lit</code> token for <code>b</code>.</p>
</li>
<li>
<p>After all tokens have been handled,
    look for partially-completed <code>Alt</code> tokens and make whatever comes after them their right child.</p>
</li>
</ol>
<p>Again, this automatically handles patterns like <code>/(ab)|c*|(de)/</code>.</p>
<figure id="regex-parser-mechanics">
<img alt="Mechanics of combining tokens" src="./regex-parser/mechanics.svg"/>
<figcaption markdown="1">Figure 8.2: Mechanics of combining tokens while parsing regular expressions.</figcaption>
</figure>
<p>It's time to turn these ideas into code.
The main structure of our parser is:</p>
<div class="code-sample lang-js" title="parser.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">tokenize</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./tokenizer.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">parse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allTokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">allTokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allTokens</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">allTokens</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="nx">handle</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">last</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">compress</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">parse</span><span class="w"></span>
</code></pre></div>
</div>
<p>We handle tokens case by case
(with a few assertions to check that patterns are <a class="gl-ref" href="../glossary/#well_formed" markdown="1">well formed</a>):</p>
<div class="code-sample lang-js" title="parser.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">last</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Start'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Should not have start token after other tokens'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'End'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">last</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Should not have end token before other tokens'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'GroupStart'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'GroupEnd'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">groupEnd</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Any'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`No operand for '*' (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">loc</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">token</span><span class="p">.</span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`No operand for '*' (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">loc</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">token</span><span class="p">.</span><span class="nx">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">token</span><span class="p">.</span><span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">'UNIMPLEMENTED'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>When we find the <code>)</code> that marks the end of a group,
we take items from the end of the output list
until we find the matching start
and use them to create a group:</p>
<div class="code-sample lang-js" title="parser.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">groupEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Group'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">loc</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">           </span><span class="sb">`Unmatched end parenthesis (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">loc</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'GroupStart'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">group</span><span class="p">.</span><span class="nx">loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">loc</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">group</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">group</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
when we have finished with the input,
we go through the output list one last time to fill in the right side of <code>Alt</code>s:</p>
<div class="code-sample lang-js" title="parser.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">compress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cooked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">raw</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">raw</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">(</span><span class="nx">cooked</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="sb">`No right operand for alt (location </span><span class="si">${</span><span class="nx">token</span><span class="p">.</span><span class="nx">loc</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">token</span><span class="p">.</span><span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cooked</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">cooked</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cooked</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Once again,
it's not done until we've tested it:</p>
<div class="code-sample lang-js" title="test-parser.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">parse</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../parser.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'parses correctly'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'parses the empty string'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s1">''</span><span class="p">),</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'parses a single literal'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'parses multiple literals'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s1">'ab'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'b'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>


<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'parses alt of groups'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s1">'a|(bc)'</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Alt'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'a'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Group'</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'b'</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">'Lit'</span><span class="p">,</span><span class="w"> </span><span class="nx">loc</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">'c'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="parser-test.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "parses correctly"



  parses correctly
    ✓ parses the empty string
    ✓ parses a single literal
    ✓ parses multiple literals
    ✓ parses start anchors
    ✓ handles circumflex not at start
    ✓ parses end anchors
    ✓ parses circumflex not at start
    ✓ parses empty groups
    ✓ parses groups containing characters
    ✓ parses two groups containing characters
    ✓ parses any
    ✓ parses any of group
    ✓ parses alt
    ✓ parses alt of any
    ✓ parses alt of groups


  15 passing (11ms)
</code></pre></div>
</div>
<p>While our final parser is less than 90 lines of code,
it is doing a lot of complex things.
Compared to parsers for things like JSON and YAML,
though,
it is still very simple.
If we have more operators with different <span class="ix-entry" ix-key="operator precedence!implementing" markdown="1"><a class="gl-ref" href="../glossary/#precedence" markdown="1">precedences</a></span>
we should switch to the <span class="ix-entry" ix-key="shunting-yard algorithm;parser!shunting-yard algorithm" markdown="1"><a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">shunting-yard algorithm</a></span>,
and if we need to handle a language like JavaScript we should explore tools like <span class="ix-entry" ix-key="ANTLR" markdown="1"><a href="https://www.antlr.org/">ANTLR</a></span>,
which can generate a parser automatically given a description of the language to be parsed.
As we said at the start,
though,
if our design requires us to write a parser we should try to come up with a better design.
CSV, JSON, YAML, and other formats <a href="https://third-bit.com/2015/06/11/why-we-cant-have-nice-things/">have their quirks</a>,
but at least they're broken the same way everywhere.</p>
<blockquote>
<h3>The limits of computing</h3>
<p>One of the most important theoretical results in computer science is that
every formal language corresponds to a type of abstract machine and vice versa,
and that some languages (or machines) are more or less powerful than others.
For example,
every regular expression corresponds to a <span class="ix-entry" ix-key="finite state machine!correspondence with regular expressions" markdown="1"><a class="gl-ref" href="../glossary/#fsm" markdown="1">finite state machine</a></span> (FSM)
like the one in <a class="fig-ref" href="../regex-parser/#regex-parser-finite-state-machine">Figure 8.3</a>.
As powerful as FSMs are,
they cannot match things like nested parentheses or HTML tags,
and <span class="ix-entry" ix-key="sin!using regular expressions to parse HTML" markdown="1"><a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">attempting to do so is a sin</a></span>.
If you add a stack to the system you can process a much richer set of languages,
and if you add two stacks you have something equivalent to a <span class="ix-entry" ix-key="Turing Machine" markdown="1"><a class="gl-ref" href="../glossary/#turing_machine" markdown="1">Turing Machine</a></span>
that can do any conceivable computation.
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Conery2021">Conery2021</a>]</span> presents this idea and others for self-taught developers.</p>
</blockquote>
<figure id="regex-parser-finite-state-machine">
<img alt="Finite state machine" src="./regex-parser/finite-state-machine.svg"/>
<figcaption markdown="1">Figure 8.3: A finite state machine equivalent to a regular expression.</figcaption>
</figure>
<div class="break-before"></div>
<h2 id="regex-parser-exercises">Section 8.3: Exercises</h2>
<h3 class="exercise">Create objects</h3>
<p>Modify the parser to return instances of classes derived from <code>RegexBase</code>.</p>
<h3 class="exercise">Escape characters</h3>
<p>Modify the parser to handle escape characters,
so that (for example) <code>\*</code> is interpreted as "a literal '*' character"
and <code>\\</code> is interpreted as "a literal backslash".</p>
<h3 class="exercise">Lazy matching</h3>
<p>Modify the parser so that <code>*?</code> is interpreted as a single token
meaning "lazy match zero or more".</p>
<h3 class="exercise">Character sets</h3>
<p>Modify the parser so that expressions like <code>[xyz]</code> are interpreted to mean
"match any one of the characters 'x', 'y', or 'z'".</p>
<h3 class="exercise">Back reference</h3>
<p>Modify the tokenizer so that it recognizes <code>\1</code>, <code>\2</code>, and so on to mean "back reference".
The number may contain any number of digits.</p>
<h3 class="exercise">Named groups</h3>
<ol>
<li>
<p>Modify the tokenizer to recognize named groups.
    For example, the named group <code>/(?&lt;triple&gt;aaa)/</code>
    would create a named group called <code>triple</code> that matches exactly three consecutive occurrences of 'a'.</p>
</li>
<li>
<p>Write Mocha tests for your modified tokenizer.
    Does it handle nested named groups?</p>
</li>
</ol>
<h3 class="exercise">Object streams</h3>
<p>Write a parser that turns files of key-value pairs separated by blank lines into objects.
For example, if the input is:</p>
<div class="highlight"><pre><span></span><code>left: "left value"
first: 1

middle: "middle value"
second: 2

right: "right value"
third: 3
</code></pre></div>
<p class="continue">then the output will be:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="s2">"left value"</span><span class="p">,</span><span class="w"> </span><span class="nx">first</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="nx">middle</span><span class="o">:</span><span class="w"> </span><span class="s2">"middle value"</span><span class="p">,</span><span class="w"> </span><span class="nx">second</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="s2">"right value"</span><span class="p">,</span><span class="w"> </span><span class="nx">third</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>Keys are always upper- and lower-case characters;
values may be strings in double quotes or unquoted numbers.</p>
<h3 class="exercise">Tokenize HTML</h3>
<ol>
<li>
<p>Write a tokenizer for a subset of HTML that consists of:</p>
<ul>
<li>Opening tags without attributes, such as <code>&lt;div&gt;</code> and <code>&lt;p&gt;</code></li>
<li>Closing tags, such as <code>&lt;/p&gt;</code> and <code>&lt;/div&gt;</code></li>
<li>Plain text between tags that does <em>not</em> contain '&lt;' or '&gt;' characters</li>
</ul>
</li>
<li>
<p>Modify the tokenizer to handle <code>key="value"</code> attributes in opening tags.</p>
</li>
<li>
<p>Write Mocha tests for your tokenizer.</p>
</li>
</ol>
<h3 class="exercise">The Shunting Yard Algorithm</h3>
<ol>
<li>
<p>Use the <a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">shunting-yard algorithm</a>
    to implement a tokenizer for a simple subset of arithmetic that includes:</p>
<ul>
<li>single-letter variable names</li>
<li>single-digit numbers</li>
<li>the <code>+</code>, <code>*</code>, and <code>^</code> operators, where <code>+</code> has the lowest precedence and <code>^</code> has the highest</li>
</ul>
</li>
<li>
<p>Write Mocha tests for your tokenizer.</p>
</li>
</ol>
<h3 class="exercise">Handling errors</h3>
<ol>
<li>
<p>What does the regular expression tokenizer do
    with expressions that contain unmatched opening parentheses like <code>/a(b/</code>?
    What about expressions that contain unmatched closing parentheses like <code>/ab)/</code>?</p>
</li>
<li>
<p>Modify it so it produces a more useful error message.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="page-templates">Chapter: Chapter 9: Page Templates</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#bare_object" markdown="1">bare object</a>, <a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a>, <a class="gl-ref" href="../glossary/#environment" markdown="1">environment</a>, <a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a>, <a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a>, <a class="gl-ref" href="../glossary/#static_site_generator" markdown="1">static site generator</a>, <a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor pattern</a>
</p>
<p>Every program needs documentation in order to be usable,
and the best place to put that documentation is on the web.
Writing and updating pages by hand is time-consuming and error-prone,
particularly when many parts are the same,
so most documentation sites use some kind of
<span class="ix-entry" ix-key="static site generator" markdown="1"><a class="gl-ref" href="../glossary/#static_site_generator" markdown="1">static site generator</a></span>
to create web pages from templates.</p>
<p>At the heart of every static site generator is a page templating system.
Thousands of these have been written in the last thirty years
in every popular programming language
(and one language, <span class="ix-entry" ix-key="PHP" markdown="1"><a href="https://www.php.net/">PHP</a></span>, was created for this purpose).
Most of these systems use one of three designs
(<a class="fig-ref" href="../page-templates/#page-templates-options">Figure 9.1</a>):</p>
<ol>
<li>
<p>Mix commands in a language such as JavaScript with the HTML or Markdown
    using some kind of marker to indicate which parts are commands
    and which parts are to be taken as-is.
    This approach is taken by <span class="ix-entry" ix-key="EJS" markdown="1"><a href="https://ejs.co/">EJS</a></span>,
    which we used to write these lessons.</p>
</li>
<li>
<p>Create a mini-language with its own commands like <span class="ix-entry" ix-key="Jekyll" markdown="1"><a href="https://jekyllrb.com/">Jekyll</a></span>
    (which is used by <span class="ix-entry" ix-key="GitHub Pages" markdown="1"><a href="https://pages.github.com/">GitHub Pages</a></span>).
    Mini-languages are appealing because they are smaller and safer than general-purpose languages,
    but experience shows that they eventually grow
    most of the features of a general-purpose language.
    Again, some kind of marker must be used to show
    which parts of the page are code and which are ordinary text.</p>
</li>
<li>
<p>Put directives in specially-named attributes in the HTML.
    This approach has been the least popular,
    but since pages are valid HTML,
    it eliminates the need for a special parser.</p>
</li>
</ol>
<figure id="page-templates-options">
<img alt="Three options for page templates" src="./page-templates/options.svg"/>
<figcaption markdown="1">Figure 9.1: Three different ways to implement page templating.</figcaption>
</figure>
<p>In this chapter we will build a simple page templating system using the third strategy.
We will process each page independently by parsing the HTML
and walking the <span class="ix-entry" ix-key="DOM" markdown="1">DOM</span> to find nodes with special attributes.
Our program will execute the instructions in those nodes
to do the equivalent of loops and if/else statements;
other nodes will be copied as-is to create text.</p>
<div class="break-before"></div>
<h2 id="page-templates-syntax">Section 9.1: What will our system look like?</h2>
<p>Let's start by deciding what "done" looks like.
Suppose we want to turn an array of strings into an HTML list.
Our page will look like this:</p>
<div class="code-sample lang-html" title="input-loop.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"item:names"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">/&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<p class="continue">The attribute <code>z-loop</code> tells the tool to repeat the contents of that node;
the loop variable and the collection being looped over are separated by a colon.
The attribute <code>z-var</code> tells the tool to fill in the node with the value of the variable.</p>
<p>When our tool processes this page,
the output will be standard HTML without any traces of how it was created:</p>
<div class="code-sample lang-html" title="output-loop.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Johnson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Vaughan<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Jackson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<blockquote>
<h3>Human-readable vs. machine-readable</h3>
<p>The introduction said that mini-languages for page templating
quickly start to accumulate extra features.
We have already started down that road
by putting the loop variable and loop target in a single attribute
and splitting that attribute to get them out.
Doing this makes loops easy for people to type,
but hides important information from standard HTML processing tools.
They can't know that this particular attribute of these particular elements
contains multiple values
or that those values should be extracted by splitting a string on a colon.
We could instead require people to use two attributes, as in:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"names"</span> <span class="na">z-loop-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">but we have decided to err on the side of minimal typing.
And note that strictly speaking,
we should call our attributes <code>data-something</code> instead of <code>z-something</code>
to conform with <span class="ix-entry" ix-key="HTML5 specification" markdown="1"><a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes">the HTML5 specification</a></span>,
but by the time we're finished processing our templates,
there shouldn't be any <code>z-*</code> attributes left to confuse a browser.</p>
</blockquote>
<p>The next step is to define the API for filling in templates.
Our tool needs the template itself,
somewhere to write its output,
and some variables to use in the expansion.
These variables might come from a configuration file,
from a YAML header in the file itself,
or from some mix of the two;
for the moment,
we will just pass them into the expansion function as an object:</p>
<div class="code-sample lang-js" title="example-call.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">names</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">'Johnson'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Vaughan'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Jackson'</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readHtml</span><span class="p">(</span><span class="s1">'template.html'</span><span class="p">)</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">expander</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Expander</span><span class="p">(</span><span class="nx">dom</span><span class="p">,</span><span class="w"> </span><span class="nx">variables</span><span class="p">)</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="nx">expander</span><span class="p">.</span><span class="nx">walk</span><span class="p">()</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">expander</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<h2 id="page-templates-values">Section 9.2: How can we keep track of values?</h2>
<p>Speaking of variables,
we need a way to keep track of their current values;
we say "current" because the value of a loop variable changes each time we go around the loop.
We also need to maintain multiple sets of variables
so that variables used inside a loop
don't conflict with ones used outside it.
(We don't actually "need" to do this---we could just have one global set of variables---but
experience teaches us that if all our variables are global,
all of our programs will be buggy.)</p>
<p>The standard way to manage variables is to create a stack of lookup tables.
Each <span class="ix-entry" ix-key="stack frame" markdown="1"><a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a></span> is an object with names and values;
when we need to find a variable,
we look through the stack frames in order to find the uppermost definition of that variable..</p>
<blockquote>
<h3>Scoping rules</h3>
<p>Searching the stack <span class="ix-entry" ix-key="call stack!stack frame;stack frame" markdown="1">frame</span> by frame
while the program is running
is called is <span class="ix-entry" ix-key="dynamic scoping;scoping!dynamic" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a></span>,
since we find variables while the program is running.
In contrast,
most programming languages used <span class="ix-entry" ix-key="lexical scoping;scoping!lexical" markdown="1"><a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a></span>,
which figures out what a variable name refers to based on the structure of the program text.</p>
</blockquote>
<p>The values in a running program are sometimes called
an <span class="ix-entry" ix-key="environment (to store variables);call stack!environment" markdown="1"><a class="gl-ref" href="../glossary/#environment" markdown="1">environment</a></span>,
so we have named our stack-handling class <code>Env</code>.
Its methods let us push and pop new stack frames
and find a variable given its name;
if the variable can't be found,
<code>Env.find</code> returns <code>undefined</code> instead of throwing an exception
(<a class="fig-ref" href="../page-templates/#page-templates-stack">Figure 9.2</a>).</p>
<div class="code-sample lang-js" title="env.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Env</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">initial</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">push</span><span class="w"> </span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">pop</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">find</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">name</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">toString</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Env</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="page-templates-stack">
<img alt="Variable stack" src="./page-templates/stack.svg"/>
<figcaption markdown="1">Figure 9.2: Using a stack to manage variables.</figcaption>
</figure>
<h2 id="page-templates-nodes">Section 9.3: How do we handle nodes?</h2>
<p>HTML pages have a nested structure,
so we will process them using
the <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1"><a class="gl-ref" href="../glossary/#visitor_pattern" markdown="1">Visitor</a></span> design pattern.
<code>Visitor</code>'s constructor takes the root node of the DOM tree as an argument and saves it.
When we call <code>Visitor.walk</code> without a value,
it starts recursing from that saved root;
if <code>.walk</code> is given a value (as it is during recursive calls),
it uses that instead.</p>
<div class="code-sample lang-js" title="visitor.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Visitor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">root</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">walk</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">open</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Must implemented "open"'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Must implemented "close"'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Visitor</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue"><code>Visitor</code> defines two methods called <code>open</code> and <code>close</code> that are called
when we first arrive at a node and when we are finished with it
(<a class="fig-ref" href="../page-templates/#page-templates-visitor">Figure 9.3</a>).
The default implementations of these methods throw exceptions
to remind the creators of derived classes to implement their own versions.</p>
<figure id="page-templates-visitor">
<img alt="The Visitor pattern" src="./page-templates/visitor.svg"/>
<figcaption markdown="1">Figure 9.3: Using the Visitor pattern to evaluate a page template.</figcaption>
</figure>
<p>The <code>Expander</code> class is specialization of <code>Visitor</code>
that uses an <code>Env</code> to keep track of variables.
It imports a handler
for each type of special node we support---we will write those in a moment---and
uses them to process each type of node:</p>
<ol>
<li>
<p>If the node is plain text, copy it to the output.</p>
</li>
<li>
<p>If there is a handler for the node,
    call the handler's <code>open</code> or <code>close</code> method.</p>
</li>
<li>
<p>Otherwise, open or close a regular tag.</p>
</li>
</ol>
<div class="code-sample lang-js" title="expander.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">Visitor</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./visitor.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Env</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./env.js'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">z_if</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./z-if.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">z_loop</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./z-loop.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">z_num</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./z-num.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">z_var</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./z-var.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">HANDLERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s1">'z-if'</span><span class="o">:</span><span class="w"> </span><span class="nx">z_if</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'z-loop'</span><span class="o">:</span><span class="w"> </span><span class="nx">z_loop</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'z-num'</span><span class="o">:</span><span class="w"> </span><span class="nx">z_num</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">'z-var'</span><span class="o">:</span><span class="w"> </span><span class="nx">z_var</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Expander</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Visitor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">root</span><span class="p">,</span><span class="w"> </span><span class="nx">vars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Env</span><span class="p">(</span><span class="nx">vars</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">HANDLERS</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">open</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'text'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'text'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">getHandler</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">close</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Expander</span><span class="w"></span>
</code></pre></div>
</div>
<p>Checking to see if there is a handler for a particular node
and getting that handler are straightforward---we just
look at the node's attributes:</p>
<div class="code-sample lang-js" title="expander.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">hasHandler</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getHandler</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">possible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">possible</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Should be exactly one handler'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">possible</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally, we need a few helper methods to show tags and generate output:</p>
<div class="code-sample lang-js" title="expander.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">showTag</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">closing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">closing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="sb">`&lt;/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">&gt;`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="sb">`&lt;</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'body'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="s1">' style="font-size: 200%; margin-left: 0.5em"'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'z-'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="sb">` </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">="</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">output</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">text</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">'UNDEF'</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getResult</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Notice that this class adds strings to an array and joins them all right at the end
rather than concatenating strings repeatedly.
Doing this is more efficient and also helps with debugging,
since each string in the array corresponds to a single method call.</p>
<h2 id="page-templates-handlers">Section 9.4: How do we implement node handlers?</h2>
<p>At this point
we have built a lot of infrastructure but haven't actually processed any special nodes.
To do that,
let's write a handler that copies a constant number into the output:</p>
<div class="code-sample lang-js" title="z-num.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">open</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-num'</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">When we enter a node like <code>&lt;span z-num="123"/&gt;</code>
this handler asks the expander to show an opening tag
followed by the value of the <code>z-num</code> attribute.
When we exit the node,
the handler asks the expander to close the tag.
The handler doesn't know whether things are printed immediately,
added to an output list,
or something else;
it just knows that whoever called it implements the low-level operations it needs.</p>
<p>Note that this expander is <em>not</em> a class,
but instead an object with two functions stored under the keys <code>open</code> and <code>close</code>.
We could use a class for each handler
so that handlers can store any extra state they need,
but <span class="ix-entry" ix-key="bare object;software design!bare object" markdown="1"><a class="gl-ref" href="../glossary/#bare_object" markdown="1">bare objects</a></span> are common and useful in JavaScript
(though we will see below that we <em>should</em> have used classes).</p>
<p>So much for constants; what about variables?</p>
<div class="code-sample lang-js" title="z-var.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">open</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">output</span><span class="p">(</span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-var'</span><span class="p">]))</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This code is almost the same as the previous example.
The only difference is that instead of copying the attribute's value
directly to the output,
we use it as a key to look up a value in the environment.</p>
<p>These two pairs of handlers look plausible, but do they work?
To find out,
we can build a program that loads variable definitions from a JSON file,
reads an HTML template,
and does the expansion:</p>
<div class="code-sample lang-js" title="template.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">htmlparser2</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'htmlparser2'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">Expander</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./expander.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readJSON</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readHtml</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">3</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expander</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Expander</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span><span class="w"> </span><span class="nx">vars</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">expander</span><span class="p">.</span><span class="nx">walk</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">expander</span><span class="p">.</span><span class="nx">getResult</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">readJSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">readHtml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">htmlparser2</span><span class="p">.</span><span class="nx">parseDOM</span><span class="p">(</span><span class="nx">text</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p>We added new variables for our test cases one by one
as we were writing this chapter.
To avoid repeating text repeatedly,
we show the entire set once:</p>
<div class="code-sample lang-json" title="vars.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"firstVariable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"firstValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"secondVariable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"secondValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"variableName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"variableValue"</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"showThis"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"doNotShowThis"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Johnson"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Vaughan"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Jackson"</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Our first test:
is static text copied over as-is (<a class="fig-ref" href="../page-templates/#page-templates-output-static-text">Figure 9.4</a>)?</p>
<div class="code-sample lang-html" title="input-static-text.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Static Text<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This page has:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>static<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>text<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="static-text.sh">
<div class="highlight"><pre><span></span><code>node template.js vars.json input-static-text.html
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-static-text.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Static Text<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This page has:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>static<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>text<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-static-text">
<img alt="Generating static text" src="./page-templates/output-static-text.svg"/>
<figcaption markdown="1">Figure 9.4: Static text generated by page templates.</figcaption>
</figure>
<p>Good.
Now, does the expander handle constants (<a class="fig-ref" href="../page-templates/#page-templates-output-single-constant">Figure 9.5</a>)?</p>
<div class="code-sample lang-html" title="input-single-constant.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-num</span><span class="o">=</span><span class="s">"123"</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-single-constant.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>123<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-single-constant">
<img alt="Generating a single constant" src="./page-templates/output-single-constant.svg"/>
<figcaption markdown="1">Figure 9.5: A single constant generated by page templates.</figcaption>
</figure>
<p>What about a single variable (<a class="fig-ref" href="../page-templates/#page-templates-output-single-variable">Figure 9.6</a>)?</p>
<div class="code-sample lang-html" title="input-single-variable.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"variableName"</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-single-variable.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>variableValue<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-single-variable">
<img alt="Generating a single variable" src="./page-templates/output-single-variable.svg"/>
<figcaption markdown="1">Figure 9.6: A single variable generated by page templates.</figcaption>
</figure>
<p>What about a page containing multiple variables?
There's no reason it should fail if the single-variable case works,
but we should still check---again,
software isn't done until it has been tested (<a class="fig-ref" href="../page-templates/#page-templates-output-multiple-variables">Figure 9.7</a>).</p>
<div class="code-sample lang-html" title="input-multiple-variables.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"firstVariable"</span> <span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"secondVariable"</span> <span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-multiple-variables.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>firstValue<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>secondValue<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-multiple-variables">
<img alt="Generating multiple variables" src="./page-templates/output-multiple-variables.svg"/>
<figcaption markdown="1">Figure 9.7: Multiple variables generated by page templates.</figcaption>
</figure>
<h2 id="page-templates-flow">Section 9.5: How can we implement control flow?</h2>
<p>Our tool supports two types of control flow:
conditional expressions and loops.
Since we don't support Boolean expressions like <code>and</code> and <code>or</code>,
implementing a conditional is as simple as looking up a variable
(which we know how to do)
and then expanding the node if the value is true:</p>
<div class="code-sample lang-js" title="z-if.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">open</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">doRest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-if'</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">doRest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">doRest</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-if'</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's test it (<a class="fig-ref" href="../page-templates/#page-templates-output-conditional">Figure 9.8</a>):</p>
<div class="code-sample lang-html" title="input-conditional.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">"showThis"</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">z-if</span><span class="o">=</span><span class="s">"doNotShowThis"</span><span class="p">&gt;</span>This should <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>not<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;</span> be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-conditional.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>This should be shown.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-conditional">
<img alt="Generating conditional text" src="./page-templates/output-conditional.svg"/>
<figcaption markdown="1">Figure 9.8: Conditional text generated by page templates.</figcaption>
</figure>
<blockquote class="break-before">
<h3>Spot the bug</h3>
<p>This implementation of <code>if</code> contains a subtle bug.
The <code>open</code> and <code>close</code> functions both check the value of the control variable.
If something inside the body of the <code>if</code> changes that value,
the result could be an opening tag without a matching closing tag or vice versa.
We haven't implemented an assignment operator,
so right now there's no way for that to happen,
but it's a plausible thing for us to add later,
and tracking down a bug in old code that is revealed by new code
is always a headache.</p>
</blockquote>
<p>Finally we come to loops.
For these,
we need to get the array we're looping over from the environment
and do something for each of its elements.
That "something" is:</p>
<ol>
<li>
<p>Create a new stack frame holding the current value of the loop variable.</p>
</li>
<li>
<p>Expand all of the node's children with that stack frame in place.</p>
</li>
<li>
<p>Pop the stack frame to get rid of the temporary variable.</p>
</li>
</ol>
<div class="code-sample lang-js" title="z-loop.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">open</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">indexName</span><span class="p">,</span><span class="w"> </span><span class="nx">targetName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-loop'</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attribs</span><span class="p">[</span><span class="s1">'z-loop'</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">targetName</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="p">[</span><span class="nx">indexName</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">expander</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>

<span class="w">  </span><span class="nx">close</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">expander</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">expander</span><span class="p">.</span><span class="nx">showTag</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Once again,
it's not done until we test it (<a class="fig-ref" href="../page-templates/#page-templates-output-loop">Figure 9.9</a>):</p>
<div class="code-sample lang-html" title="input-loop.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"item:names"</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">/&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="output-loop.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 200%; margin-left: 0.5em"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Johnson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Vaughan<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;</span>Jackson<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="page-templates-output-loop">
<img alt="Generating text with a loop" src="./page-templates/output-loop.svg"/>
<figcaption markdown="1">Figure 9.9: Repeated text generated with a loop by page templates.</figcaption>
</figure>
<p>Notice how we create the new stack frame using:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="nx">indexName</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">This is an ugly but useful trick.
We can't write:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="nx">indexName</span><span class="o">:</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">because that would create an object with the string <code>indexName</code> as a key,
rather than one with the value of the variable <code>indexName</code> as its key.
We can't do this either:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">indexName</span><span class="si">}</span><span class="sb">`</span><span class="o">:</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">though it seems like we should be able to.
Instead,
we create an array containing the string we want.
Since JavaScript automatically converts arrays to strings
by concatenating their elements when it needs to,
our expression is a quick way to get the same effect as:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">temp</span><span class="p">[</span><span class="nx">indexName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="w"></span>
<span class="nx">expander</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">temp</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">Those three lines <em>are</em> much easier to understand, though,
so we should probably have been less clever.</p>
<h2 id="page-templates-learning">Section 9.6: How did we know how to do all of this?</h2>
<p>We have just implemented a simple programming language.
It can't do arithmetic,
but if we wanted to add tags like:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="nx">math</span><span class="o">=</span><span class="s2">"+"</span><span class="o">&gt;&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="kd">var</span><span class="o">=</span><span class="s2">"width"</span><span class="o">/&gt;&lt;</span><span class="nx">span</span><span class="w"> </span><span class="nx">z</span><span class="o">-</span><span class="nx">num</span><span class="o">=</span><span class="s2">"1"</span><span class="c1">//&gt;</span><span class="w"></span>
</code></pre></div>
<p class="continue">we could.
It's unlikely anyone would use the result---typing all of that
is so much clumsier than typing <code>width+1</code> that people wouldn't use it
unless they had no other choice---but the basic design is there.</p>
<p>We didn't invent any of this from scratch,
any more than we invented the parsing algorithm of <a class="x-ref" href="#regex-parser">Chapter 8</a>.
Instead,
we did what you are doing now:
we read what other programmers had written
and tried to make sense of the key ideas.</p>
<p>The problem is that "making sense" depends on who we are.
When we use a low-level language,
we incur the <span class="ix-entry" ix-key="cognitive load" markdown="1">cognitive load</span> of assembling micro-steps into something more meaningful.
When we use a high-level language,
on the other hand,
we incur a similar load translating functions of functions of functions
(or meta-classes templated on object factories)
into actual operations on actual data.</p>
<p>More experienced programmers are more capable at both ends of the curve,
but that's not the only thing that changes.
If a novice's comprehension curve looks like the one on the left
of <a class="fig-ref" href="../page-templates/#page-templates-comprehension">Figure 9.10</a>,
then an expert's looks like the one on the right.
Experts don't just understand more at all levels of abstraction;
their <em>preferred</em> level has also shifted
so that \(\sqrt{x^2 + y^2}\)
is actually more readable than the medieval expression
"the side of the square whose area is the sum of the areas of the two squares
whose sides are given by the first part and the second part".</p>
<figure id="page-templates-comprehension">
<img alt="Comprehension curves" src="./page-templates/comprehension.svg"/>
<figcaption markdown="1">Figure 9.10: Novice and expert comprehension curves.</figcaption>
</figure>
<p>One implication of this is that for any given task,
the software that is quickest for a novice to comprehend
will almost certainly be different from the software that
an expert can understand most quickly.
In an ideal world our tools would automatically re-represent programs at different levels,
so that with a click of a button we could view our code as either:</p>
<div class="highlight"><pre><span></span><code>const hosts = links.map(a =&gt; a.href.split(':')[1].split('/')[0]).unique()
</code></pre></div>
<p>or:</p>
<div class="highlight"><pre><span></span><code>hosts = []
for (each a in links) do
  temp &lt;- attr(a, 'href').split(':')[1].split('/')[0]
  if (not (temp in hosts)) do
    hosts.append(temp)
  end
end
</code></pre></div>
<p>just as we could change the colors used for syntax highlighting
or the depth to which loop bodies are indented.
But today's tools don't do that,
and I suspect that any IDE smart enough to translate between comprehension levels automatically
would also be smart enough to write the code without our help.</p>
<div class="break-before"></div>
<h2 id="page-templates-exercises">Section 9.7: Exercises</h2>
<h3 class="exercise">Tracing execution</h3>
<p>Add a directive <code>&lt;span z-trace="variable"/&gt;</code>
that prints the current value of a variable using <code>console.error</code> for debugging.</p>
<h3 class="exercise">Unit tests</h3>
<p>Write unit tests for template expansion using Mocha.</p>
<h3 class="exercise">Trimming text</h3>
<p>Modify all of the directives to take an extra optional attribute <code>z-trim="true"</code>
If this attribute is set,
leading and trailing whitespace is trimmed from the directive's expansion.</p>
<h3 class="exercise">Literal text</h3>
<p>Add a directive <code>&lt;div z-literal="true"&gt;…&lt;/div&gt;</code> that copies the enclosed text as-is
without interpreting or expanding any contained directives.
(A directive like this would be needed when writing documentation for the template expander.)</p>
<h3 class="exercise">Including other files</h3>
<ol>
<li>
<p>Add a directive <code>&lt;div z-include="filename.html"/&gt;</code> that includes another file
    in the file being processed.</p>
</li>
<li>
<p>Should included files be processed and the result copied into the including file,
    or should the text be copied in and then processed?
    What difference does it make to the way variables are evaluated?</p>
</li>
</ol>
<h3 class="exercise">HTML snippets</h3>
<p>Add a directive <code>&lt;div z-snippet="variable"&gt;…&lt;/div&gt;</code> that saves some text in a variable
so that it can be displayed later.
For example:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">z-snippet</span><span class="o">=</span><span class="s">"prefix"</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>Important:<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Expect three items<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span> <span class="na">z-loop</span><span class="o">=</span><span class="s">"item:names"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"prefix"</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"item"</span><span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">would printed the word "Important:" in bold before each item in the list.</p>
<h3 class="exercise">YAML headers</h3>
<p>Modify the template expander to handle variables defined in a YAML header in the page being processed.
For example, if the page is:</p>
<div class="highlight"><pre><span></span><code>---
name: "Dorothy Johnson Vaughan"
---
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">z-var</span><span class="o">=</span><span class="s">"name"</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">will create a paragraph containing the given name.</p>
<h3 class="exercise">Expanding all files</h3>
<p>Write a program <code>expand-all.js</code> that takes two directory names as command-line arguments
and builds a website in the second directory by expanding all of the HTML files found in the first
or in sub-directories of the first.</p>
<h3 class="exercise">Counting loops</h3>
<p>Add a directive <code>&lt;div z-index="indexName" z-limit="limitName"&gt;…&lt;/div&gt;</code>
that loops from zero to the value in the variable <code>limitName</code>,
putting the current iteration index in <code>indexName</code>.</p>
<h3 class="exercise">Auxiliary functions</h3>
<ol>
<li>
<p>Modify <code>Expander</code> so that it takes an extra argument <code>auxiliaries</code>
    containing zero or more named functions:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">expander</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Expander</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span><span class="w"> </span><span class="nx">vars</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">trim</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Add a directive <code>&lt;span z-call="functionName" z-args="var,var"/&gt;</code>
    that looks up a function in <code>auxiliaries</code> and calls it
    with the given variables as arguments.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="build-manager">Chapter: Chapter 10: Build Manager</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variable</a>, <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">build target</a>, <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycle (in a graph)</a>, <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependency</a>, <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#driver" markdown="1">driver</a>, <a class="gl-ref" href="../glossary/#interpreted_language" markdown="1">interpreted language</a>, <a class="gl-ref" href="../glossary/#link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rule</a>, <a class="gl-ref" href="../glossary/#runnable_documentation" markdown="1">runnable documentation</a>, <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method pattern</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>
</p>
<p>Suppose we are using a page templating system to create a website (<a class="x-ref" href="#page-templates">Chapter 9</a>).
If we a change a single page our tool should translate it,
but shouldn't waste time translating others.
If we change a template,
on the other hand,
the tool should realize that every page in the site is potentially affected
and automatically re-translate all of them.</p>
<p>Choosing what actions to take based on how files depend on one another is a common pattern.
For example,
programs in <span class="ix-entry" ix-key="compiled language;language!compiled" markdown="1"><a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled languages</a></span>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>
have to be translated into lower-level forms before they can run.
In fact,
there are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <span class="ix-entry" ix-key="linking (compiled language);compiled language!linking" markdown="1"><a class="gl-ref" href="../glossary/#link" markdown="1">linking</a></span> the compiled modules
to each other and to libraries
to create a runnable program
(<a class="fig-ref" href="../build-manager/#build-manager-compiling">Figure 10.1</a>).
If a source file hasn't changed,
there's no need to recompile it before linking.</p>
<figure id="build-manager-compiling">
<img alt="Compiling and linking" src="./build-manager/compiling.svg"/>
<figcaption markdown="1">Figure 10.1: Compiling source files and linking the resulting modules.</figcaption>
</figure>
<p>A <span class="ix-entry" ix-key="build manager" markdown="1"><a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a></span> takes a description of what depends on what,
figures out which files are out of date,
determines an order in which to rebuild things,
and then executes any necessary steps.
Originally created to manage compilation,
they are also useful for programs written in <span class="ix-entry" ix-key="language!interpreted;interpreted language" markdown="1"><a class="gl-ref" href="../glossary/#interpreted_language" markdown="1">interpreted languages</a></span>
like JavaScript
when we want to bundle multiple modules into a single loadable file (<a class="x-ref" href="#module-bundler">Chapter 17</a>)
or re-create documentation from source code (<a class="x-ref" href="#doc-generator">Chapter 16</a>).
In this chapter we will create a simple build manager
based on <span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>, <span class="ix-entry" ix-key="Bajel" markdown="1"><a href="https://www.npmjs.com/package/bajel">Bajel</a></span>, <span class="ix-entry" ix-key="Jake" markdown="1"><a href="https://jakejs.com/">Jake</a></span>,
and other systems discussed in <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Smith2011">Smith2011</a>]</span>.</p>
<h2 id="build-manager-contents">Section 10.1: What's in a build manager?</h2>
<p>The input to a build manager is a set of rules,
each of which has:</p>
<ul>
<li>
<p>a <span class="ix-entry" ix-key="build target;target!build" markdown="1"><a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a></span>, which is the file to be updated;</p>
</li>
<li>
<p>some <span class="ix-entry" ix-key="dependency (in build);build!dependency" markdown="1"><a class="gl-ref" href="../glossary/#dependency" markdown="1">dependencies</a></span>, which are the things that file depends on;
    and</p>
</li>
<li>
<p>a <span class="ix-entry" ix-key="recipe (in build);build!recipe" markdown="1"><a class="gl-ref" href="../glossary/#build_recipe" markdown="1">recipe</a></span> that specifies how to update the target
    if it is out of date compared to its dependencies.</p>
</li>
</ul>
<p>The target of one rule can be a dependency of another rule,
so the relationships between the files form a <span class="ix-entry" ix-key="directed acyclic graph (DAG);DAG" markdown="1"><a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a></span> or DAG
(<a class="fig-ref" href="../build-manager/#build-manager-dependencies">Figure 10.2</a>).
The graph is directed because "A depends on B" is a one-way relationship;
it cannot contain cycles (or loops) because
if something depends on itself we can never finish updating it.
We say that a target is <span class="ix-entry" ix-key="stale (in build);build!stale" markdown="1"><a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale</a></span> if it is older than any of its dependencies.
When this happens,
we use the recipes to bring it up to date.</p>
<figure id="build-manager-dependencies">
<img alt="Respecting dependencies" src="./build-manager/dependencies.svg"/>
<figcaption markdown="1">Figure 10.2: How a build manager finds and respects dependencies.</figcaption>
</figure>
<p>Our build manager must:</p>
<ol>
<li>
<p>Read a file containing rules.</p>
</li>
<li>
<p>Construct the dependency graph.</p>
</li>
<li>
<p>Figure out which targets are stale.</p>
</li>
<li>
<p>Build those targets,
    making sure to build things <em>before</em> anything that depends on them is built.</p>
</li>
</ol>
<blockquote>
<h3>Topological order</h3>
<p>A <span class="ix-entry" ix-key="topological order" markdown="1"><a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a></span> of a graph
arranges the nodes so that every node comes after everything it depends on.
For example,
if A depends on both B and C,
then (B, C, A) and (C, B, A) are both valid topological orders of the graph.</p>
</blockquote>
<h2 id="build-manager-start">Section 10.2: Where should we start?</h2>
<p>We will store our rules in YAML files like this:</p>
<div class="code-sample lang-yml" title="three-simple-rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  - C
  recipes:
  - "update A from B and C"
- target: B
  depends:
  - C
  recipes:
  - "update B from C"
- target: C
  depends: []
  recipes: []
</code></pre></div>
</div>
<p class="continue">We could equally well have used JSON,
but it wouldn't have made sense to use CSV:
rules have a nested structure,
and CSV doesn't represent nesting particularly gracefully.</p>
<p>We are going to create our build manager in stages,
so we start by writing a simple <span class="ix-entry" ix-key="software design!driver" markdown="1"><a class="gl-ref" href="../glossary/#driver" markdown="1">driver</a></span> that loads a JavaScript source file,
creates an object of whatever class that file exports,
and runs the <code>.build</code> method of that object with the rest of the command-line parameters:</p>
<div class="code-sample lang-js" title="driver.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">BuilderClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])).</span><span class="k">default</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BuilderClass</span><span class="p">(...</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">3</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">builder</span><span class="p">.</span><span class="nx">build</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'Build failed:'</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We use the <code>import</code> function to dynamically load files containing in <a class="x-ref" href="#unit-test">Chapter 4</a> as well.
It only saves us a few lines of code in this case,
but we will use this idea of a general-purpose driver for larger programs in future chapters.</p>
<p>To work with our driver,
each version of our build manager must be a class that satisfies two requirements:</p>
<ol>
<li>
<p>Its constructor must take a configuration file as an argument.</p>
</li>
<li>
<p>It must provide a <code>build</code> method that needs no arguments.</p>
</li>
</ol>
<p>The <code>build</code> method must create a graph from the configuration file,
check that it does not contain any <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycles</a>,
and then run whatever commands are needed to update stale targets.
Just as we built a generic <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1"><code>Visitor</code></span> class in <a class="x-ref" href="#page-templates">Chapter 9</a>,
we can build a generic base class for our build manager that does these steps in this order
without actually implementing any of them:</p>
<div class="code-sample lang-js" title="skeleton-builder.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">configFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configFile</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">build</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loadConfig</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkCycles</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">loadConfig</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">'not implemented'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">'not implemented'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">checkCycles</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">'not implemented'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">'run method not implemented'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"></span>
</code></pre></div>
</div>
<p>This is an example of
the <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1"><a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method</a></span> design pattern:
the parent class defines the order of the steps
and child classes fill them in
(<a class="fig-ref" href="../build-manager/#build-manager-template-method">Figure 10.3</a>).
This design pattern ensures that every child does the same things in the same order,
even if the details of <em>how</em> vary from case to case.</p>
<figure id="build-manager-template-method">
<img alt="Template Method pattern" src="./build-manager/template-method.svg"/>
<figcaption markdown="1">Figure 10.3: The Template Method pattern in action.</figcaption>
</figure>
<p>We would normally implement all of the methods required by the <code>build</code> method at the same time,
but to make the evolving code easier to follow we will write them them one by one.
The <code>loadConfig</code> method loads the configuration file
as the builder object is being constructed:</p>
<div class="code-sample lang-js" title="config-loader.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'js-yaml'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./skeleton-builder.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">loadConfig</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Configuration must be array'</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">'target'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'string'</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb"> does not string as 'target'`</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">'depends'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">dep</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'string'</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Bad 'depends' for rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">'recipes'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">recipe</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'string'</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Bad 'recipes' for rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The first line does the loading;
the rest of the method checks that the rules are at least superficially plausible.
We need these checks because YAML is a generic file format
that doesn't know anything about the extra requirements of our rules.
And as we first saw in <a class="x-ref" href="#async-programming">Chapter 3</a>,
we have to specify that the character encoding of our file is UTF-8
so that JavaScript knows how to convert bytes into text.</p>
<p>The next step is to turn the configuration into a graph in memory.
We use the <a href="https://www.npmjs.com/package/graphlib"><code>graphlib</code></a> module to manage nodes and links
rather than writing our own classes for graphs,
and store the recipe to rebuild a node in that node.
Two features of <code>graphlib</code> that took us a while to figure out are that:</p>
<ol>
<li>
<p>links go <em>from</em> the dependency <em>to</em> the target,
    and</p>
</li>
<li>
<p><code>setEdge</code> automatically adds nodes if they aren't already present.</p>
</li>
</ol>
<p><code>graphlib</code> provides implementations of some common graph algorithms,
including one to check for cycles,
so we might as well write that method at this point as well:</p>
<div class="code-sample lang-js" title="graph-creator.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@dagrejs/graphlib'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./config-loader.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">Graph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">checkCycles</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cycles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">findCycles</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">cycles</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Dependency graph contains cycles </span><span class="si">${</span><span class="nx">cycles</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now create something that displays our configuration when it runs
but does nothing else:</p>
<div class="code-sample lang-js" title="display-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@dagrejs/graphlib'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./graph-creator.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DisplayOnly</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Graph'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Sorted'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">topsort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DisplayOnly</span><span class="w"></span>
</code></pre></div>
</div>
<p>If we run this with our three simple rules as input,
it shows the graph with <code>v</code> and <code>w</code> keys to represent the ends of the links:</p>
<div class="code-sample lang-sh" title="display-only.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./display-only.js three-simple-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="display-only.out">
<div class="highlight"><pre><span></span><code>Graph
{
  options: { directed: true, multigraph: false, compound: false },
  nodes: [
    { v: 'A', value: [Object] },
    { v: 'B', value: [Object] },
    { v: 'C', value: [Object] }
  ],
  edges: [ { v: 'B', w: 'A' }, { v: 'C', w: 'A' }, { v: 'C', w: 'B' } ]
}
Sorted
[ 'C', 'B', 'A' ]
</code></pre></div>
</div>
<p>Let's write a quick test to make sure the cycle detector works as intended:</p>
<div class="code-sample lang-yml" title="circular-rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  recipes:
  - "update A from B"
- target: B
  depends:
  - A
  recipes:
  - "update B from A"
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="check-cycles.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./display-only.js circular-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="check-cycles.out">
<div class="highlight"><pre><span></span><code>Build failed: AssertionError [ERR_ASSERTION]: Dependency graph contains \
 cycles B,A
    at DisplayOnly.checkCycles \
     (/u/stjs/build-manager/graph-creator.js:19:12)
    at DisplayOnly.build \
     (/u/stjs/build-manager/skeleton-builder.js:11:10)
    at main (/u/stjs/build-manager/driver.js:5:13) {
  generatedMessage: false,
  code: 'ERR_ASSERTION',
  actual: 1,
  expected: 0,
  operator: 'strictEqual'
}
</code></pre></div>
</div>
<h2 id="build-manager-timestamp">Section 10.3: How can we specify that a file is out of date?</h2>
<p>The next step is to figure out which files are out of date.
Make does this by comparing the <span class="ix-entry" ix-key="timestamp!in build;build!timestamp" markdown="1">timestamps</span> of the files in question,
but this isn't always reliable:
<span class="ix-entry" ix-key="clock synchronization (in build);build!clock synchronization" markdown="1">computers' clocks may be slightly out of sync</span>,
which can produce a wrong answer on a networked filesystem,
and the operating system may only report file update times to the nearest millisecond
(which seemed very short in 1970 but seems very long today).</p>
<p>More modern build systems store a <span class="ix-entry" ix-key="hash code!in build;build!hash code" markdown="1">hash</span> of each file's contents
and compare the current hash to the stored one to see if the file has changed.
Since we already looked at hashing in <a class="x-ref" href="#file-backup">Chapter 5</a>,
we will use the timestamp approach here.
And instead of using a mock filesystem as we did in <a class="x-ref" href="#file-backup">Chapter 5</a>,
we will simply load another configuration file that specifies fake timestamps for files:</p>
<div class="code-sample lang-yml" title="add-timestamps.yml">
<div class="highlight"><pre><span></span><code>A: 2
B: 5
C: 8
</code></pre></div>
</div>
<p>Since we want to associate those timestamps with files,
we add a step to <code>buildGraph</code> to read the timestamp file and add information to the graph's nodes:</p>
<div class="code-sample lang-js" title="add-timestamps.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'js-yaml'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./graph-creator.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="nx">timesFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">timesFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timesFile</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">addTimestamps</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">addTimestamps</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timesFile</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">times</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">hasNode</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span><span class="w"></span>
<span class="w">             </span><span class="sb">`Graph does not have node </span><span class="si">${</span><span class="nx">node</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">times</span><span class="p">[</span><span class="nx">node</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">missing</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Timestamp missing for node(s) </span><span class="si">${</span><span class="nx">missing</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Not quite what we were expecting</h3>
<p>The steps defined in <code>SkeletonBuilder.build</code> don't change when we do this,
so people reading the code don't have to change their mental model of what it does overall.
However,
if we had realized in advance that we were going to want to add timestamps from a file,
we would probably have added a step for that in the template method.
And if someone ever wants to inject a new step between building the graph and adding timestamps,
they will have to override <code>addTimestamps</code> and put their step at the top before calling <code>super.addTimestamps</code>,
which will make the code a lot harder to understand.
We will reflect on this in the last section of this chapter.</p>
</blockquote>
<p>Before we move on,
let's make sure that adding timestamps works as we want:</p>
<div class="code-sample lang-sh" title="add-timestamps.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./add-timestamps.js three-simple-rules.yml add-timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="add-timestamps.out">
<div class="highlight"><pre><span></span><code>[
  'A: {"recipes":["update A from B and C"],"timestamp":2}',
  'B: {"recipes":["update B from C"],"timestamp":5}',
  'C: {"recipes":[],"timestamp":8}'
]
</code></pre></div>
</div>
<h2 id="build-manager-update">Section 10.4: How can we update out-of-date files?</h2>
<p>To figure out which recipes to execute and in which order,
we set the pretended current time to the latest time of any file,
then look at each file in topological order.
If a file is older than any of its dependencies,
we update the file <em>and</em> its pretended timestamp
to trigger an update of anything that depends on it.</p>
<p>We can pretend that updating a file always takes one unit of time,
so we advance our fictional clock by one for each build.
Using <code>graphlib.alg.topsort</code> to create the topological order,
we get this:</p>
<div class="code-sample lang-js" title="update-timestamps.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@dagrejs/graphlib'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./add-timestamps.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">topsort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">timestamp</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">startTime</span><span class="si">}</span><span class="sb">: START`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sorted</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">currTime</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isStale</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">currTime</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">node</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`    </span><span class="si">${</span><span class="nx">a</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currTime</span><span class="w"></span>
<span class="w">        </span><span class="nx">currTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">currTime</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">startTime</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">endTime</span><span class="si">}</span><span class="sb">: END`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">isStale</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">some</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">other</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">other</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>run</code> method:</p>
<ol>
<li>
<p>Gets a sorted list of nodes.</p>
</li>
<li>
<p>Sets the starting time to be one unit past the largest file time.</p>
</li>
<li>
<p>Uses <span class="ix-entry" ix-key="Array.reduce" markdown="1"><code>Array.reduce</code></span> to operate on each node (i.e., each file) in order.
    If that file is stale,
    we print the steps we would run and then update the file's timestamp.
    We only advance the notional current time when we do an update.</p>
</li>
</ol>
<p>In order to check if a file is stale,
we see if any of its dependencies currently have timestamps greater than or equal to its.
When we run this,
it seems to do the right thing:</p>
<div class="code-sample lang-sh" title="update-timestamps.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./update-timestamps.js three-simple-rules.yml add-timestamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="update-timestamps.out">
<div class="highlight"><pre><span></span><code>9: START
9: B
    update B from C
10: A
    update A from B and C
11: END
</code></pre></div>
</div>
<div class="break-before"></div>
<h2 id="build-manager-generic">Section 10.5: How can we add generic build rules?</h2>
<p>If our website has a hundred blog posts
or a hundred pages of documentation about particular JavaScript files,
we don't want to have to write a hundred nearly-identical recipes.
Instead,
we want to be able to write generic <span class="ix-entry" ix-key="build!rule;rule (in build)" markdown="1"><a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a></span> that say,
"Build all things of this kind the same way."
These generic rules need:</p>
<ul>
<li>
<p>a way to define a set of files;</p>
</li>
<li>
<p>a way to specify a generic rule;
    and</p>
</li>
<li>
<p>a way to fill in parts of that rule.</p>
</li>
</ul>
<p>We will achieve this by overriding <code>buildGraph</code> to replace variables in recipes with values.
Once again,
object-oriented programming helps us change only what we need to change,
provided we divided our problem into sensible chunks in the first place.</p>
<p>Make provides <span class="ix-entry" ix-key="automatic variable (in build);build!automatic variable" markdown="1"><a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variables</a></span>
with names like <code>$&lt;</code> and <code>$@</code>
to represent the parts of a rule.
Our variables will be more readable:
we will use <code>@TARGET</code> for the target,
<code>@DEPENDENCIES</code> for the dependencies (in order),
and <code>@DEP[1]</code>, <code>@DEP[2]</code>, and so on for specific dependencies
(<a class="fig-ref" href="../build-manager/#build-manager-pattern-rules">Figure 10.4</a>).</p>
<figure id="build-manager-pattern-rules">
<img alt="Pattern rules" src="./build-manager/pattern-rules.svg"/>
<figcaption markdown="1">Figure 10.4: Turning patterns rules into runnable commands.</figcaption>
</figure>
<p>Our variable expander looks like this:</p>
<div class="code-sample lang-js" title="variable-expander.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./update-timestamps.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandVariables</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">recipes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">act</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">act</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">act</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'@TARGET'</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'@DEPENDENCIES'</span><span class="p">,</span><span class="w"> </span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">act</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">act</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`@DEP[</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">]`</span><span class="p">,</span><span class="w"> </span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="p">})</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">act</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Cannot find </span><span class="si">${</span><span class="nx">target</span><span class="si">}</span><span class="sb"> in graph`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"></span>
</code></pre></div>
</div>
<p>The first thing we do is test that it works when there <em>aren't</em> any variables to expand
by running it on the same example we used previously:</p>
<div class="code-sample lang-out" title="variable-expander.out">
<div class="highlight"><pre><span></span><code>9: START
9: B
    update B from C
10: A
    update A from B C
11: END
</code></pre></div>
</div>
<p class="continue">This is perhaps the most important reason to create tests:
they tell us right away if something we have added or changed
has broken something that used to work.
That gives us a firm base to build on as we debug the new code.</p>
<p>Now we need to add <span class="ix-entry" ix-key="pattern rule (in build);build!pattern rule" markdown="1"><a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rules</a></span>.
Our first attempt at a rules file looks like this:</p>
<div class="code-sample lang-yml" title="pattern-rules.yml">
<div class="highlight"><pre><span></span><code>- target: left.out
  depends: []
  recipes: []
  timestamp: 1
- target: left.in
  depends: []
  recipes: []
  timestamp: 2
- target: right.out
  depends: []
  recipes: []
  timestamp: 1
- target: right.in
  depends: []
  recipes: []
  timestamp: 3
- target: "%.out"
  depends:
  - "%.in"
  recipes:
  - "update @TARGET from @DEPENDENCIES"
</code></pre></div>
</div>
<p class="continue">and our first attempt at reading it extracts rules before expanding variables:</p>
<div class="code-sample lang-js" title="pattern-user-attempt.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./variable-expander.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserAttempt</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">extractRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">extractRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'%'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">removeNode</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserAttempt</span><span class="w"></span>
</code></pre></div>
</div>
<p>However,
that doesn't work:</p>
<div class="code-sample lang-out" title="pattern-user-attempt.out">
<div class="highlight"><pre><span></span><code>Build failed: AssertionError [ERR_ASSERTION]: Graph does not have node A
    at PatternUserAttempt.addTimestamps \
    (/u/stjs/build-manager/add-timestamps.js:21:7)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/add-timestamps.js:15:10)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/variable-expander.js:5:11)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/pattern-user-attempt.js:5:11)
    at PatternUserAttempt.build \
    (/u/stjs/build-manager/skeleton-builder.js:10:10)
    at main (/u/stjs/build-manager/driver.js:5:13) {
  generatedMessage: false,
  code: 'ERR_ASSERTION',
  actual: false,
  expected: true,
  operator: '=='
}
</code></pre></div>
</div>
<p class="continue">The problem is that our simple graph loader creates nodes for dependencies even if they aren't targets.
As a result,
we wind up tripping over the lack of a node for <code>%.in</code> before we get to extracting rules.</p>
<blockquote>
<h3>Errors become assertions</h3>
<p>When we first wrote <code>add-timestamps.js</code>,
it didn't contain the assertion
that printed the error message shown above.
Once we tracked down our bug,
though,
we added the assertion to ensure we didn't make the same mistake again,
and as <span class="ix-entry" ix-key="runnable documentation (assertions as);assertion!as runnable documentation" markdown="1"><a class="gl-ref" href="../glossary/#runnable_documentation" markdown="1">runnable documentation</a></span>
to tell the next programmer more about the code.
Regular code tells the computer what to do;
assertions with meaningful error messages tell the reader why.</p>
</blockquote>
<p>We can fix our problem by rewriting the rule loader
to separate pattern rules from simple rules;
we can tell the two apart by checking if the rule's dependencies include <code>%</code>.
While we're here,
we will enable timestamps as an optional field in the rules for testing purposes
rather than having them in a separate file:</p>
<div class="code-sample lang-js" title="pattern-user-read.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@dagrejs/graphlib'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./variable-expander.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraphAndRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraphAndRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">Graph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'%'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">depends</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">'timestamp'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'%'</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s1">'Cannot have "%" in a non-pattern rule'</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"></span>
</code></pre></div>
</div>
<p>Before we try to run this,
let's add methods to show the state of our two internal data structures:</p>
<div class="code-sample lang-js" title="pattern-user-show.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@dagrejs/graphlib'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pattern-user-read.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserShow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">toJSON</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">graph</span><span class="o">:</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">keys</span><span class="p">()).</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">k</span><span class="o">:</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserShow</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="pattern-user-show.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./pattern-user-show.js pattern-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern-user-show.out">
<div class="highlight"><pre><span></span><code>{
  "graph": {
    "options": {
      "directed": true,
      "multigraph": false,
      "compound": false
    },
    "nodes": [
      {
        "v": "left.out",
        "value": {
          "recipes": [],
          "timestamp": 1
        }
      },
      {
        "v": "left.in",
        "value": {
          "recipes": [],
          "timestamp": 2
        }
      },
      {
        "v": "right.out",
        "value": {
          "recipes": [],
          "timestamp": 1
        }
      },
      {
        "v": "right.in",
        "value": {
          "recipes": [],
          "timestamp": 3
        }
      }
    ],
    "edges": []
  },
  "rules": [
    {
      "k": "%.out",
      "v": {
        "recipes": [
          "update @TARGET from @DEPENDENCIES"
        ],
        "depends": [
          "%.in"
        ]
      }
    }
  ]
}
</code></pre></div>
</div>
<p>The output seems to be right,
so let's try expanding rules <em>after</em> building the graph and rules
but <em>before</em> expanding variables:</p>
<div class="code-sample lang-js" title="pattern-user-run.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./pattern-user-read.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserRun</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraphAndRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandAllRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandAllRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findRule</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">expandRule</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRule</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`%.</span><span class="si">${</span><span class="nx">target</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandRule</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">dep</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="w"> </span><span class="nx">stem</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">act</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">act</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="w"> </span><span class="nx">stem</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserRun</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern-user-run.out">
<div class="highlight"><pre><span></span><code>4: START
4: left.out
    update left.out from left.in
5: right.out
    update right.out from right.in
6: END
</code></pre></div>
</div>
<h2 id="build-manager-next">Section 10.6: What should we do next?</h2>
<p>We have added a lot of steps to our original template method,
which makes it a bit of a stretch to claim that the overall operation hasn't changed.
Knowing what we know now,
we could go back and modify the original <code>SkeletonBuilder.build</code> method
to include those extra steps and provide do-nothing implementations.</p>
<p>The root of the problem is that we didn't anticipate all the steps that would be involved
when we wrote our template method.
It typically takes a few child classes for this to settle down;
if it never does,
then <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1">Template Method</span> is probably the wrong pattern for our situation.
Realizing this isn't a failure in initial design:
we always learn about our problem as we try to capture it in code,
and if we know enough to anticipate 100% of the issues that are going to come up,
it's time to put what we've learned in a library for future use.</p>
<div class="break-before"></div>
<h2 id="build-manager-exercises">Section 10.7: Exercises</h2>
<h3 class="exercise">Handle failure</h3>
<ol>
<li>
<p>Modify the build manager to accommodate build steps that fail.</p>
</li>
<li>
<p>Write Mocha tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Dry run</h3>
<p>Add an option to the build manager to show what commands would be executed and why
if a build were actually run.
For example,
the output should display things like, "'update A' because A older than B".</p>
<h3 class="exercise">Change directories</h3>
<p>Modify the build manager so that:</p>
<div class="highlight"><pre><span></span><code>node build.js -C some/sub/directory rules.yml timestamps.yml
</code></pre></div>
<p class="continue">runs the build in the specified directory rather than the current directory.</p>
<h3 class="exercise">Merge files</h3>
<p>Modify the build manager so that it can read multiple configuration files
and execute their combined rules.</p>
<h3 class="exercise">Show recipes</h3>
<p>Add a method to build manager to display all unique recipes,
i.e.,
all of the commands it might execute if asked to rebuild everything.</p>
<h3 class="exercise">Conditional execution</h3>
<p>Modify the build manager so that:</p>
<ol>
<li>
<p>The user can pass <code>variable=true</code> and <code>variable=false</code> arguments on the command-line
    to define variables.</p>
</li>
<li>
<p>Rules can contain an <code>if: variable</code> field.</p>
</li>
<li>
<p>Those rules are only executed if the variable is defined and true.</p>
</li>
<li>
<p>Write Mocha tests to check that this works correctly.</p>
</li>
</ol>
<h3 class="exercise">Define filesets</h3>
<p>Modify the build manager so that users can define sets of files:</p>
<div class="highlight"><pre><span></span><code>fileset:
  name: everything
  contains:
    - X
    - Y
    - Z
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @everything
</code></pre></div>
<h3 class="exercise">Globbing</h3>
<p>Modify the build manager so that it can dynamically construct a set of files:</p>
<div class="highlight"><pre><span></span><code>glob:
  name: allAvailableInputs
  pattern: "./*.in"
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @allAvailableInputs
</code></pre></div>
<h3 class="exercise">Use hashes</h3>
<ol>
<li>
<p>Write a program called <code>build-init.js</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file's name in <code>build-hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build-hash.json</code>
    in order to determine what is out of date,
    and to update <code>build-hash.json</code> each time it runs.</p>
</li>
</ol>
<h3 class="exercise">Auxiliary functions</h3>
<ol>
<li>
<p>Modify the builder manager so that it takes an extra argument <code>auxiliaries</code>
    containing zero or more named functions:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExtensibleBuilder</span><span class="p">(</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="nx">timesFile</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">slice</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">simplify</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Modify the <code>run</code> method to call these functions
    before executing the rules for a node,
    and to only execute the rules if all of them return <code>true</code>.</p>
</li>
<li>
<p>Write Mocha tests to check that this works correctly.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="layout-engine">Chapter: Chapter 11: Layout Engine</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#attribute" markdown="1">attribute</a>, <a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a>, <a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a>, <a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a>, <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>, <a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a>, <a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a>, <a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selector</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
</p>
<p>You might be reading this as an HTML page,
an e-book (which is basically the same thing),
or on the printed page.
In all three cases,
a <span class="ix-entry" ix-key="layout engine" markdown="1"><a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a></span> took some text and some layout instructions
and decided where to put each character and image.
We will build a small layout engine in this chapter
based on <span class="ix-entry" ix-key="Brubeck, Matt" markdown="1"><a href="https://limpet.net/mbrubeck/">Matt Brubeck's</a></span> <a href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">tutorial</a>
to explore how browsers decide what to put where.</p>
<p>Our inputs will be a very small subset of HTML and an equally small subset of CSS.
We will create our own classes to represent these
instead of using those provided by various <a href="https://nodejs.org/en/">Node</a> libraries;
to translate the combination of HTML and CSS into text on the screen,
we will label each node in the DOM tree with the appropriate styles,
walk that tree to figure out where each visible element belongs,
and then draw the result as text on the screen.</p>
<blockquote>
<h3>Upside down</h3>
<p>The <span class="ix-entry" ix-key="coordinate system" markdown="1">coordinate systems</span> for screens
puts (0, 0) in the upper left corner instead of the lower left.
X increases to the right as usual,
but Y increases as we go down, rather than up
(<a class="fig-ref" href="../layout-engine/#layout-engine-coordinate-system">Figure 11.1</a>).
This convention is a holdover from the days of teletype terminals
that printed lines on rolls of paper;
as <span class="ix-entry" ix-key="Hoye, Mike" markdown="1"><a href="http://exple.tive.org/blarg/">Mike Hoye</a></span> has <a href="http://exple.tive.org/blarg/2020/11/26/punching-holes/">repeatedly observed</a>,
the past is all around us.</p>
</blockquote>
<figure id="layout-engine-coordinate-system">
<img alt="Coordinate system" src="./layout-engine/coordinate-system.svg"/>
<figcaption markdown="1">Figure 11.1: Coordinate system with (0, 0) in the upper left corner.</figcaption>
</figure>
<h2 id="layout-engine-size">Section 11.1: How can we size rows and columns?</h2>
<p>Let's start on <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>
without margins, padding, line-wrapping, or other complications.
Everything we can put on the screen is represented as a rectangular cell,
and every cell is either a row, a column, or a block.
A block has a fixed width and height:</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">width</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">height</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>A row arranges one or more cells horizontally;
its width is the sum of the widths of its children,
while its height is the height of its tallest child
(<a class="fig-ref" href="../layout-engine/#layout-engine-sizing">Figure 11.2</a>):</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Row</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="layout-engine-sizing">
<img alt="Calculating sizes of fixed blocks" src="./layout-engine/sizing.svg"/>
<figcaption markdown="1">Figure 11.2: Calculating sizes of blocks with fixed width and height.</figcaption>
</figure>
<p>Finally,
a column arranges one or more cells vertically;
its width is the width of its widest child
and its height is the sum of the heights of its children.
(Here and elsewhere we use the abbreviation <code>col</code> when referring to columns.)</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Col</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Rows and columns nest inside one another:
a row cannot span two or more columns,
and a column cannot cross the boundary between two rows.
Any time we have a structure with that property
we can represent it as a tree of nested objects.
Given such a tree,
we can calculate the width and height of each cell every time we need to.
This is simple but inefficient:
we could calculate both width and height at the same time
and <span class="ix-entry" ix-key="cache!calculated values" markdown="1"><a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a></span> those values to avoid recalculation,
but we called this "easy mode" for a reason.</p>
<p>As simple as it is,
this code could still contain errors (and did during development),
so we write some <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> tests to check that it works as desired
before trying to build anything more complicated:</p>
<div class="code-sample lang-js" title="test-easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Block</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">Row</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">Col</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../easy-mode.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'lays out in easy mode'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'lays out a single unit block'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'lays out a large block'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'lays out a row of two blocks'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'lays out a column of two blocks'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'lays out a grid of rows of columns'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">14</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">22</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-easy-mode.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "easy mode"



  lays out in easy mode
    ✓ lays out a single unit block
    ✓ lays out a large block
    ✓ lays out a row of two blocks
    ✓ lays out a column of two blocks
    ✓ lays out a grid of rows of columns


  5 passing (7ms)
</code></pre></div>
</div>
<h2 id="layout-engine-position">Section 11.2: How can we position rows and columns?</h2>
<p>Now that we know how big each cell is
we can figure out where to put it.
Suppose we start with the upper left corner of the browser:
upper because we lay out the page top-to-bottom
and left because we are doing left-to-right layout.
If the cell is a block, we place it there.
If the cell is a row, on the other hand,
we get its height
and then calculate its lower edge as y1 = y0 + height.
We then place the first child's lower-left corner at (x0, y1),
the second child's at (x0 + width0, y1), and so on
(<a class="fig-ref" href="../layout-engine/#layout-engine-layout">Figure 11.3</a>).
Similarly,
if the cell is a column
we place the first child at (x0, y0),
the next at (x0, y0 + height0),
and so on.</p>
<figure id="layout-engine-layout">
<img alt="Laying out rows and columns" src="./layout-engine/layout.svg"/>
<figcaption markdown="1">Figure 11.3: Laying out rows and columns of fixed-size blocks.</figcaption>
</figure>
<p>To save ourselves some testing we will derive the classes that know how to do layout
from the classes we wrote before.
Our blocks are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while our columns are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Col</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">yCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">child</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">yCurrent</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">yCurrent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s1">'col'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">report</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and our rows are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Row</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">xCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="nx">child</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nx">xCurrent</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">xCurrent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">report</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Once again,
we write and run some tests to check that everything is doing what it's supposed to:</p>
<div class="code-sample lang-js" title="test-placed.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Block</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Col</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Row</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../placed.js'</span><span class="w"></span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'places blocks'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'places a single unit block'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'places a large block'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'places a row of two blocks'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'places a column of two blocks'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'col'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-placed.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "places blocks"



  places blocks
    ✓ places a single unit block
    ✓ places a large block
    ✓ places a row of two blocks
    ✓ places a column of two blocks
    ✓ places a grid of rows of columns


  5 passing (8ms)
</code></pre></div>
</div>
<h2 id="layout-engine-render">Section 11.3: How can we render elements?</h2>
<p>We drew the blocks on a piece of graph paper
in order to figure out the expected answers for the tests shown above.
We can do something similar in software by creating a "screen" of space characters
and then having each block draw itself in the right place.
If we do this starting at the root of the tree,
child blocks will overwrite the markings made by their parents,
which will automatically produce the right appearance
(<a class="fig-ref" href="../layout-engine/#layout-engine-draw-over">Figure 11.4</a>).
(A more sophisticated version of this called <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
keeps track of the visual depth of each pixel
in order to draw things in three dimensions.)</p>
<figure id="layout-engine-draw-over">
<img alt="Children drawing over their parents" src="./layout-engine/draw-over.svg"/>
<figcaption markdown="1">Figure 11.4: Render blocks by drawing child nodes on top of parent nodes.</figcaption>
</figure>
<p>Our pretended screen is just an array of arrays of characters:</p>
<div class="code-sample lang-js" title="render.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeScreen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">height</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">screen</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">width</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">screen</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We will use successive lower-case characters to show each block,
i.e.,
the root block will draw itself using 'a',
while its children will be 'b', 'c', and so on.</p>
<div class="code-sample lang-js" title="render.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextFill</span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">node</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">'children'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">draw</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fill</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">nextFill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">fill</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">'a'</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">fill</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To teach each kind of cell how to render itself,
we have to derive a new class from each of the ones we have
and give the new class a <code>render</code> method with the same <span class="ix-entry" ix-key="signature!of function;function signature" markdown="1"><a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a></span>:</p>
<div class="code-sample lang-js" title="rendered.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedCol</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">PlacedRow</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./placed.js'</span><span class="w"></span>

<span class="c1">// [keep]</span><span class="w"></span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">drawBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">();</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">();</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">screen</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">iy</span><span class="p">][</span><span class="nx">node</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ix</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fill</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// [/keep]</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">These <code>render</code> methods do exactly the same thing,
so we have each one call a shared function that does the actual work.
If we were building a real layout engine,
a cleaner solution would be to go back and create a class called <code>Cell</code> with this <code>render</code> method,
then derive our <code>Block</code>, <code>Row</code>, and <code>Col</code> classes from that.
In general,
if two or more classes need to be able to do something,
we should add a method to do that to their lowest common ancestor.</p>
<p>Our simpler tests are a little easier to read once we have rendering in place,
though we still had to draw things on paper to figure out our complex ones:</p>
<div class="code-sample lang-js" title="test-rendered.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'renders a grid of rows of columns'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">render</span><span class="p">(</span><span class="nx">fixture</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s1">'bddd'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'bddd'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'cddd'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'cddd'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'ehhh'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'ehhh'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'ehhh'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'ehhh'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'eiig'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'fiig'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'fiig'</span><span class="w"></span>
<span class="w">      </span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The fact that we find our own tests difficult to understand
is a sign that we should do more testing.
It would be very easy for us to get a wrong result
and convince ourselves that it was actually correct;
<span class="ix-entry" ix-key="confirmation bias" markdown="1"><a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a></span> of this kind
is very common in software development.</p>
<h2 id="layout-engine-fit">Section 11.4: How can we wrap elements to fit?</h2>
<p>One of the biggest differences between a browser and a printed page
is that the text in the browser wraps itself automatically as the window is resized.
(The other, these days, is that the printed page doesn't spy on us,
though someone is undoubtedly working on that.)</p>
<p>To add wrapping to our layout engine,
suppose we fix the width of a row.
If the total width of the children is greater than the row's width,
the layout engine needs to wrap the children around.
This assumes that columns can be made as big as they need to be,
i.e.,
that we can grow vertically to make up for limited space horizontally.
It also assumes that all of the row's children are no wider than the width of the row;
we will look at what happens when they're not in the exercises.</p>
<p>Our layout engine manages wrapping by transforming the tree.
The height and width of blocks are fixed,
so they become themselves.
Columns become themselves as well,
but since they have children that might need to wrap,
the class representing columns needs a new method:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">wrap</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Rows do all the hard work.
Each original row is replaced with a new row that contains a single column with one or more rows,
each of which is one "line" of wrapped cells
(<a class="fig-ref" href="../layout-engine/#layout-engine-wrap">Figure 11.5</a>).
This replacement is unnecessary when everything will fit on a single row,
but it's easiest to write the code that does it every time;
we will look at making this more efficient in the exercises.</p>
<figure id="layout-engine-wrap">
<img alt="Wrapping rows" src="./layout-engine/wrap.svg"/>
<figcaption markdown="1">Figure 11.5: Wrapping rows by introducing a new row and column.</figcaption>
</figure>
<p>Our new wrappable row's constructor takes a fixed width followed by the children
and returns that fixed width when asked for its size:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">width</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Need non-negative width'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">width</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Wrapping puts the row's children into buckets,
then converts the buckets to a row of a column of rows:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">wrap</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>

<span class="w">    </span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">childWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">currentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">childWidth</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">currentRow</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">currentX</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">childWidth</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">currentRow</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">currentRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">child</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nx">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">childWidth</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">currentRow</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="p">(...</span><span class="nx">row</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="p">(...</span><span class="nx">newRows</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="p">(</span><span class="nx">newCol</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Once again we bring forward all the previous tests
and write some new ones to test the functionality we've added:</p>
<div class="code-sample lang-js" title="test-wrapped.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'wrap a row of two blocks that do not fit on one row'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="mf">3</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">wrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="s1">'col'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">],</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">[</span><span class="s1">'block'</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-wrapped.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "wraps blocks"



  wraps blocks
    ✓ wraps a single unit block
    ✓ wraps a large block
    ✓ wrap a row of two blocks that fit on one row
    ✓ wraps a column of two blocks
    ✓ wraps a grid of rows of columns that all fit on their row
    ✓ wrap a row of two blocks that do not fit on one row
    ✓ wrap multiple blocks that do not fit on one row


  7 passing (10ms)
</code></pre></div>
</div>
<blockquote>
<h3>The Liskov Substitution Principle</h3>
<p>We are able to re-use tests like this because of
the <span class="ix-entry" ix-key="Liskov Substitution Principle;software design!Liskov Substitution Principle" markdown="1"><a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a></span>,
which states that
it should be possible to replace objects in a program
with objects of derived classes
without breaking anything.
In order to satisfy this principle,
new code must handle the same set of inputs as the old code,
though it may be able to process more inputs as well.
Conversely,
its output must be a subset of what the old code produced
so that whatever is downstream from it won't be surprised.
Thinking in these terms leads to a methodology called
<span class="ix-entry" ix-key="design by contract;software design!design by contract" markdown="1"><a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a></span>.</p>
</blockquote>
<h2 id="layout-engine-css">Section 11.5: What subset of CSS will we support?</h2>
<p>It's finally time to style pages that contain text.
Our final subset of HTML has rows, columns, and text blocks as before.
Each text block has one or more lines of text;
the number of lines determines the block's height
and the length of the longest line determines its width.</p>
<p>Rows and columns can have <a class="gl-ref" href="../glossary/#attribute" markdown="1">attributes</a> just as they can in real HTML,
and each attribute must have a single value in quotes.
Rows no longer take a fixed width:
instead,
we will specify that with our little subset of <span class="ix-entry" ix-key="CSS" markdown="1">CSS</span>.
Together,
these three classes are just over 40 lines of code:</p>
<div class="code-sample lang-js" title="micro-dom.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedBlock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">lines</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">)),</span><span class="w"></span>
<span class="w">      </span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lines</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'text'</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedCol</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">attributes</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'col'</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">css</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedRow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">attributes</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'row'</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">css</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We will use regular expressions to parse HTML
(though as we explained in <a class="x-ref" href="#regex-parser">Chapter 8</a>,
<a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">this is a sin</a>).
The main body of our parser is:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">DomBlock</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">DomCol</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">DomRow</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./micro-dom.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TEXT_AND_TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^([^&lt;]*)(&lt;[^]+?&gt;)(.*)$/ms</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TAG_AND_ATTR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/&lt;(\w+)([^&gt;]*)&gt;/</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">KEY_AND_VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/\s*(\w+)="([^"]*)"\s*/g</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">parseHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunkify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Must have enclosing outer node'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeNode</span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">remainder</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Cannot have dangling content'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">chunkify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">TEXT_AND_TAG</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matches</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nonEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">raw</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">chunk</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">nonEmpty</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">isElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'&lt;'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">parseHTML</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while the two functions that do most of the work are:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Cannot make nodes without chunks'</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="ow">new</span><span class="w"> </span><span class="nx">DomBlock</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeOpening</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">closing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&gt;`</span><span class="w"></span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">closing</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeNode</span><span class="p">(</span><span class="nx">remainder</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">closing</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="sb">`Node with tag </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb"> not closed`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeOpening</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">outer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunk</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">TAG_AND_ATTR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">outer</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">outer</span><span class="p">[</span><span class="mf">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">matchAll</span><span class="p">(</span><span class="nx">KEY_AND_VALUE</span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">all</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">obj</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{})</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'col'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DomCol</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'row'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DomRow</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">Cls</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="sb">`Unrecognized tag name </span><span class="si">${</span><span class="nx">tag</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Cls</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The next step is to define a generic class for CSS rules
with a subclass for each type of rule.
From highest precedence to lowest,
the three types of rules we support identify specific nodes via their ID,
classes of nodes via their <code>class</code> attribute,
and types of nodes via their element name.
We keep track of which rules take precedence over which through the simple expedient of numbering the classes:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">order</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">styles</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>An ID rule's <span class="ix-entry" ix-key="query selector" markdown="1"><a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selector</a></span> is written as <code>#name</code>
and matches HTML like <code>&lt;tag id="name"&gt;...&lt;/tag&gt;</code> (where <code>tag</code> is <code>row</code> or <code>col</code>):</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">IdRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`ID rule </span><span class="si">${</span><span class="nx">selector</span><span class="si">}</span><span class="sb"> must start with # and have a selector`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">IdRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">'attributes'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="s1">'id'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">IdRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
</code></pre></div>
</div>
<p>A class rule's query selector is written as <code>.kind</code> and matches HTML like <code>&lt;tag class="kind"&gt;...&lt;/tag&gt;</code>.
Unlike real CSS,
we only allow one class per node:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ClassRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Class rule </span><span class="si">${</span><span class="nx">selector</span><span class="si">}</span><span class="sb"> must start with . and have a selector`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">ClassRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">'attributes'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="s1">'class'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="kd">class</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">ClassRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
tag rules just have the name of the type of node they apply to without any punctuation:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TagRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">TagRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">TagRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="w"></span>
</code></pre></div>
</div>
<p>We could build yet another parser to read a subset of CSS and convert it to objects,
but this chapter is long enough,
so we will write our rules as JSON:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s1">'row'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="s1">'.kind'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="s1">'#name'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">and build a class that converts this representation to a set of objects:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CssRuleSet</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="p">,</span><span class="w"> </span><span class="nx">mergeDefaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">jsonToRules</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">jsonToRules</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">json</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">selector</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">selector</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'string'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="s1">'Require non-empty string as selector'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">IdRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ClassRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matches</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">left</span><span class="p">.</span><span class="nx">order</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">right</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sorted</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Our CSS ruleset class also has a method for finding the rules for a given DOM node.
This method relies on the precedence values we defined for our classes
in order to sort them
so that we can find the most specific.</p>
<p>Here's our final set of tests:</p>
<div class="code-sample lang-js" title="test-styled.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'styles a tree of nodes with multiple rules'</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s1">'&lt;col id="name"&gt;'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'&lt;row class="kind"&gt;first\nsecond&lt;/row&gt;'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'&lt;row&gt;third\nfourth&lt;/row&gt;'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'&lt;/col&gt;'</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parseHTML</span><span class="p">(</span><span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CssRuleSet</span><span class="p">({</span><span class="w"></span>
<span class="w">      </span><span class="s1">'.kind'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s1">'#name'</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="nx">dom</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">IdRule</span><span class="p">(</span><span class="s1">'#name'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">ClassRule</span><span class="p">(</span><span class="s1">'.kind'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}),</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="s1">'row'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>If we were going on,
we would override the cells' <code>getWidth</code> and <code>getHeight</code> methods to pay attention to styles.
We would also decide what to do with cells that don't have any styles defined:
use a default,
flag it as an error,
or make a choice based on the contents of the child nodes.
We will explore these possibilities in the exercises.</p>
<blockquote>
<h3>Where it all started</h3>
<p>This chapter's topic was one of the seeds from which this entire book grew
(the other being debuggers discussed in <a class="x-ref" href="#debugger">Chapter 20</a>).
After struggling with <span class="ix-entry" ix-key="CSS!struggles with" markdown="1">CSS</span> for several years,
<span class="ix-entry" ix-key="Wilson, Greg" markdown="1"><a href="https://third-bit.com/">Greg Wilson</a></span> began wondering whether it really had to be so complicated.
That question led to others,
which eventually led to all of this.
The moral is,
be careful what you ask.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="layout-engine-exercises">Section 11.6: Exercises</h2>
<h3 class="exercise">Refactoring the node classes</h3>
<p>Refactor the classes used to represent blocks, rows, and columns so that:</p>
<ol>
<li>
<p>They all derive from a common parent.</p>
</li>
<li>
<p>All common behavior is defined in that parent (if only with placeholder methods).</p>
</li>
</ol>
<h3 class="exercise">Handling rule conflicts</h3>
<p>Modify the rule lookup mechanism so that if two conflicting rules are defined,
the one that is defined second takes precedence.
For example,
if there are two definitions for <code>row.bold</code>,
whichever comes last in the JSON representation of the CSS wins.</p>
<h3 class="exercise">Handling arbitrary tags</h3>
<p>Modify the existing code to handle arbitrary HTML elements.</p>
<ol>
<li>
<p>The parser should recognize <code>&lt;anyTag&gt;...&lt;/anyTag&gt;</code>.</p>
</li>
<li>
<p>Instead of separate classes for rows and columns,
    there should be one class <code>Node</code> whose <code>tag</code> attribute identifies its type.</p>
</li>
</ol>
<h3 class="exercise">Recycling nodes</h3>
<p>Modify the wrapping code so that new rows and columns are only created if needed.
For example,
if a row of width 10 contains a text node with the string "fits",
a new row and column are <em>not</em> inserted.</p>
<h3 class="exercise">Rendering a clear background</h3>
<p>Modify the rendering code so that only the text in block nodes is shown,
i.e.,
so that the empty space in rows and columns is rendered as spaces.</p>
<h3 class="exercise">Clipping text</h3>
<ol>
<li>
<p>Modify the wrapping and rendering so that
    if a block of text is too wide for the available space
    the extra characters are clipped.
    For example,
    if a column of width 5 contains a line "unfittable",
    only "unfit" appears.</p>
</li>
<li>
<p>Extend your solution to break lines on spaces as needed
    in order to avoid clipping.</p>
</li>
</ol>
<h3 class="exercise">Bidirectional rendering</h3>
<p>Modify the existing software to do either left-to-right or right-to-left rendering
upon request.</p>
<h3 class="exercise">Equal sizing</h3>
<p>Modify the existing code to support elastic columns,
i.e.,
so that all of the columns in a row are automatically sized to have the same width.
If the number of columns does not divide evenly into the width of the row,
allocate the extra space as equally as possible from left to right.</p>
<h3 class="exercise">Padding elements</h3>
<p>Modify the existing code so that:</p>
<ol>
<li>
<p>Authors can define a <code>padding</code> attribute for row and column elements.</p>
</li>
<li>
<p>When the node is rendered, that many blank spaces are added on all four sides of the contents.</p>
</li>
</ol>
<p class="continue">For example, the HTML <code>&lt;row&gt;text&lt;/row&gt;</code> would render as:</p>
<div class="highlight"><pre><span></span><code>+------+
|      |
| text |
|      |
+------+
</code></pre></div>
<p class="continue">where the lines show the outer border of the rendering.</p>
<h3 class="exercise">Drawing borders</h3>
<ol>
<li>
<p>Modify the existing code so that elements may specify <code>border: true</code> or <code>border: false</code>
    (with the latter being the default).
    If an element's <code>border</code> property is <code>true</code>,
    it is drawn with a dashed border.
    For example,
    if the <code>border</code> property of <code>row</code> is <code>true</code>,
    then <code>&lt;row&gt;text&lt;/row&gt;</code> is rendered as:</p>
<div class="highlight"><pre><span></span><code>+----+
|text|
+----+
</code></pre></div>
</li>
<li>
<p>Extend your solution so that if two adjacent cells both have borders,
    only a single border is drawn.
    For example,
    if the <code>border</code> property of <code>col</code> is <code>true</code>,
    then:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">row</span><span class="p">&gt;&lt;</span><span class="nt">col</span><span class="p">&gt;</span>left<span class="p">&lt;/</span><span class="nt">col</span><span class="p">&gt;&lt;</span><span class="nt">col</span><span class="p">&gt;</span>right<span class="p">&lt;/</span><span class="nt">col</span><span class="p">&gt;&lt;/</span><span class="nt">row</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">is rendered as:</p>
<div class="highlight"><pre><span></span><code>+----+-----+
|left|right|
+----+-----+
</code></pre></div>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="file-interpolator">Chapter: Chapter 12: File Interpolator</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#header_file" markdown="1">header file</a>, <a class="gl-ref" href="../glossary/#literate_programming" markdown="1">literate programming</a>, <a class="gl-ref" href="../glossary/#loader" markdown="1">loader</a>, <a class="gl-ref" href="../glossary/#sandbox" markdown="1">sandbox</a>, <a class="gl-ref" href="../glossary/#search_path" markdown="1">search path</a>, <a class="gl-ref" href="../glossary/#shell_variable" markdown="1">shell variable</a>
</p>
<p>Many of the examples in these lessons are too long
to show comfortably in one block of code on a printed page,
so we needed a way to break them up.
As an experiment,
we wrote a custom <span class="ix-entry" ix-key="module loader" markdown="1"><a class="gl-ref" href="../glossary/#loader" markdown="1">module loader</a></span>
that reads a source file containing specially-formatted comments
and then reads and inserts the files specified in those comments
before running the code
(<a class="fig-ref" href="../file-interpolator/#file-interpolator-conceptual">Figure 12.1</a>).
Modern programming languages don't work this way,
but <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="C++" markdown="1">C++</span> do this
with <span class="ix-entry" ix-key="header file!in C and C++" markdown="1"><a class="gl-ref" href="../glossary/#header_file" markdown="1">header files</a></span>,
and <span class="ix-entry" ix-key="static site generator!header file;header file!static site generator" markdown="1">static site generators</span>
(<a class="x-ref" href="#page-templates">Chapter 9</a>) do this to share fragments of HTML.</p>
<figure id="file-interpolator-conceptual">
<img alt="Using file inclusions" src="./file-interpolator/conceptual.svg"/>
<figcaption markdown="1">Figure 12.1: Including fragments of code to create runnable programs.</figcaption>
</figure>
<p>The special comments in our source files contain two fields:
the text to put in the displayed version
and file to include when loading:</p>
<div class="code-sample lang-js" title="interpolation-example.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Something</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/*+ constructor + constructor.js +*/</span><span class="w"></span>

<span class="w">  </span><span class="cm">/*+ a long method + long_method.js +*/</span><span class="w"></span>

<span class="w">  </span><span class="cm">/*+ another method + another_method.js +*/</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We got this to work,
but decided to use a different approach in this book.
The stumbling block was that the style-checking tool <span class="ix-entry" ix-key="ESLint" markdown="1"><a href="https://eslint.org/">ESLint</a></span>
didn't know what to make of our inclusions,
so we would either have to modify it or build a style checker of our own.
(We will actually do that in <a class="x-ref" href="#style-checker">Chapter 14</a>,
but we won't go nearly as far as ESLint.)</p>
<p>Despite being a dead end,
the inclusion tool is a good way to show
how JavaScript turns source code into something it can execute.
We need to be able to do this in the next couple of chapters,
so we might as well tackle it now.</p>
<h2 id="file-interpolator-dynamic">Section 12.1: How can we evaluate JavaScript dynamically?</h2>
<p>We want to display files as they are on the web and in print,
but interpolate the files referenced in special comments
when we load things with <code>import</code>.
To do this,
we need to understand the lifecycle of a JavaScript program.
When we ask for a file,
<a href="https://nodejs.org/en/">Node</a> reads the text,
translates it into runnable instructions,
and runs those instructions.
We can do the second and third steps whenever we want using a function called <code>eval</code>,
which takes a string as input and executes it as if it were part of the program
(<a class="fig-ref" href="../file-interpolator/#file-interpolator-eval">Figure 12.2</a>).</p>
<figure id="file-interpolator-eval">
<img alt="How eval works" src="./file-interpolator/eval.svg"/>
<figcaption markdown="1">Figure 12.2: `eval` vs. normal translation and execution.</figcaption>
</figure>
<blockquote>
<h3>This is not a good idea</h3>
<p><span class="ix-entry" ix-key="eval!insecurity of" markdown="1"><code>eval</code></span> is a security risk:
arbitrary code can do arbitrary things,
so if we take a string typed in by a user and execute it without any checks
it could email our bookmark list to villains all over the world,
erase our hard drive,
or do anything else that code can do (which is pretty much anything).
Browsers do their best to run code in a <span class="ix-entry" ix-key="sandbox (for safe execution)" markdown="1"><a class="gl-ref" href="../glossary/#sandbox" markdown="1">sandbox</a></span> for safety,
but Node doesn't,
so it's up to us to be (very) careful.</p>
</blockquote>
<p>To see <code>eval</code> in action,
let's evaluate an expression:</p>
<div class="code-sample lang-js" title="eval-two-plus-two.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">'2 + 2'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="eval-two-plus-two.out">
<div class="highlight"><pre><span></span><code>4
</code></pre></div>
</div>
<p class="continue">Notice that the input to <code>eval</code> is <em>not</em> <code>2 + 2</code>,
but rather a string containing the digit 2,
a space,
a plus sign,
another space,
and another 2.
When we call <code>eval</code>,
it translates this string
using exactly the same parser that Node uses for our program
and immediately runs the result.</p>
<p>We can make the example a little more interesting
by constructing the string dynamically:</p>
<div class="code-sample lang-js" title="eval-loop.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="s1">'x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'y'</span><span class="p">,</span><span class="w"> </span><span class="s1">'z'</span><span class="p">,</span><span class="w"> </span><span class="s1">'oops'</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb"> + 1`</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">'+ 1 ='</span><span class="p">,</span><span class="w"> </span><span class="nb">eval</span><span class="p">(</span><span class="nx">expr</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="eval-loop.out">
<div class="highlight"><pre><span></span><code>x + 1 = 2
y + 1 = 4
z + 1 = 6
undefined:1
oops + 1
^

ReferenceError: oops is not defined
    at eval (eval at &lt;anonymous&gt; \
    (/u/stjs/file-interpolator/eval-loop.js:7:30), &lt;anonymous&gt;:1:1)
    at /u/stjs/file-interpolator/eval-loop.js:7:30
    at ModuleJob.run (internal/modules/esm/module_job.js:152:23)
    at async Loader.import (internal/modules/esm/loader.js:166:24)
    at async Object.loadESM (internal/process/esm_loader.js:68:5)
</code></pre></div>
</div>
<p class="continue">The first time the loop runs the string is <code>'x + 1'</code>;
since there's a variable called <code>x</code> in scope,
<code>eval</code> does the addition and we print the result.
The same thing happens for the variables <code>y</code> and <code>z</code>,
but we get an error when we try to evaluate the string <code>'oops + 1'</code>
because there is no variable in scope called <code>oops</code>.</p>
<p><code>eval</code> can use whatever variables are in scope when it's called,
but what happens to any variables it defines?
This example creates a variable called <code>x</code> and runs <code>console.log</code> to display it,
but as the output shows,
<code>x</code> is local to the <code>eval</code> call
just as variables created inside a function
only exist during a call to that function:</p>
<div class="code-sample lang-js" title="eval-local-vars.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">  const x = 'hello'</span>
<span class="sb">  console.log('x in eval is', x)</span>
<span class="sb">`</span><span class="w"></span>

<span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'typeof x after eval'</span><span class="p">,</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">x</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="eval-local-vars.out">
<div class="highlight"><pre><span></span><code>x in eval is hello
typeof x after eval undefined
</code></pre></div>
</div>
<p>However,
<code>eval</code> can modify variables defined outside the text being evaluated
in the same way that a function can modify global variables:</p>
<div class="code-sample lang-js" title="eval-global-vars.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'original'</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="nb">eval</span><span class="p">(</span><span class="s1">'x = "modified"'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'x after eval is'</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="eval-global-vars.out">
<div class="highlight"><pre><span></span><code>x after eval is modified
</code></pre></div>
</div>
<p class="continue">This means that
if the text we give to <code>eval</code> modifies a structure that is defined outside the text,
that change outlives the call to <code>eval</code>:</p>
<div class="code-sample lang-js" title="eval-global-structure.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="s1">'x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'y'</span><span class="p">,</span><span class="w"> </span><span class="s1">'z'</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`seen["</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">"] = "</span><span class="si">${</span><span class="nx">name</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="si">}</span><span class="sb">"`</span><span class="w"></span>
<span class="w">  </span><span class="nb">eval</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">seen</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="eval-global-structure.out">
<div class="highlight"><pre><span></span><code>{ x: 'X', y: 'Y', z: 'Z' }
</code></pre></div>
</div>
<p>The examples so far have all evaluated strings embedded in the program itself,
but <code>eval</code> doesn't care where its input comes from.
Let's move the code that does the modifying into <code>to-be-loaded.js</code>:</p>
<div class="code-sample lang-js" title="to-be-loaded.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="c1">// Modify a global structure defined by whoever loads us.</span><span class="w"></span>
<span class="nx">Seen</span><span class="p">.</span><span class="nx">from_loaded_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'from loaded file'</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This doesn't work on its own because <code>Seen</code> isn't defined:</p>
<div class="code-sample lang-out" title="to-be-loaded.out">
<div class="highlight"><pre><span></span><code>/u/stjs/file-interpolator/to-be-loaded.js:3
Seen.from_loaded_file = 'from loaded file'
^

ReferenceError: Seen is not defined
    at /u/stjs/file-interpolator/to-be-loaded.js:3:1
    at ModuleJob.run (internal/modules/esm/module_job.js:152:23)
    at async Loader.import (internal/modules/esm/loader.js:166:24)
    at async Object.loadESM (internal/process/esm_loader.js:68:5)
</code></pre></div>
</div>
<p class="continue">But if we read the file and <code>eval</code> the text <em>after</em> defining <code>Seen</code>,
it does what we want:</p>
<div class="code-sample lang-js" title="does-the-loading.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">Seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'before eval, Seen is'</span><span class="p">,</span><span class="w"> </span><span class="nx">Seen</span><span class="p">)</span><span class="w"></span>
<span class="nb">eval</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'after eval, Seen is'</span><span class="p">,</span><span class="w"> </span><span class="nx">Seen</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="does-the-loading.sh">
<div class="highlight"><pre><span></span><code>node does-the-loading.js to-be-loaded.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="does-the-loading.out">
<div class="highlight"><pre><span></span><code>before eval, Seen is {}
after eval, Seen is { from_loaded_file: 'from loaded file' }
</code></pre></div>
</div>
<h2 id="file-interpolator-manage">Section 12.2: How can we manage files?</h2>
<p>The source files in this book are small enough
that we don't have to worry about reading them repeatedly,
but we would like to avoid re-reading things unnecessarily
in large systems or when there might be network delays.
The usual approach is to create a <span class="ix-entry" ix-key="cache!of loaded files" markdown="1">cache</span>
using the <span class="ix-entry" ix-key="Singleton pattern;design pattern!Singleton" markdown="1">Singleton pattern</span>
that we first met in <a class="x-ref" href="#unit-test">Chapter 4</a>.
Whenever we want to read a file,
we check to see if it's already in the cache
(<a class="fig-ref" href="../file-interpolator/#file-interpolator-cache">Figure 12.3</a>).
If it is,
we use that copy;
if not,
we read it and add it to the cache
using the file path as a lookup key.</p>
<figure id="file-interpolator-cache">
<img alt="Implementing a cache as a singleton" src="./file-interpolator/cache.svg"/>
<figcaption markdown="1">Figure 12.3: Using the Singleton pattern to implement a cache of loaded files.</figcaption>
</figure>
<p>We can write a simple cache in just a few lines of code:</p>
<div class="code-sample lang-js" title="need-simple.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Cache</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">need</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`returning cached value for </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`loading </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">eval</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Cache</span><span class="p">()</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">need</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Since we are using <code>eval</code>, though,
we can't rely on <code>export</code> to make things available to the rest of the program.
Instead,
we rely on the fact that the result of an <code>eval</code> call is the value of
the last expression evaluated.
Since a variable name on its own evaluates to the variable's value,
we can create a function and then use its name
to "export" it from the evaluated file:</p>
<div class="code-sample lang-js" title="import-simple.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="c1">// Define.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`report in import-01.js with message "</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Export.</span><span class="w"></span>
<span class="nx">report</span><span class="w"></span>
</code></pre></div>
</div>
<p>To test our program,
we load the implementation of the cache using <code>import</code>,
then use it to load and evaluate another file.
This example expects that "other file" to define a function,
which we call in order to show that everything is working:</p>
<div class="code-sample lang-js" title="test-simple.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need-simple.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">imported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'./import-simple.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">imported</span><span class="p">(</span><span class="s1">'called from test-simple.js'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="test-simple.sh">
<div class="highlight"><pre><span></span><code>node test-simple.js
</code></pre></div>
</div>
<h2 id="file-interpolator-find">Section 12.3: How can we find files?</h2>
<p>Each of the files included in our examples is in the same directory as the file including it,
but in C/C++ or a page templating system
we might include a particular file in several different places.
We don't want to have to put all of our files in a single directory,
so we need a way specify where to look for files that are being included.</p>
<p>One option is to use relative paths,
but another option is to give our program
a list of directories to look in.
This is called a <span class="ix-entry" ix-key="search path" markdown="1"><a class="gl-ref" href="../glossary/#search_path" markdown="1">search path</a></span>,
and many programs use them,
including Node itself.
By convention,
a search path is written as a colon-separated list of directories on Unix
or using semi-colons on Windows.
If the path to an included starts with <code>./</code>,
we look for it locally;
if not,
we go through the directories in the search path in order
until we find a file with a matching name
(<a class="fig-ref" href="../file-interpolator/#file-interpolator-search-path">Figure 12.4</a>).</p>
<figure id="file-interpolator-search-path">
<img alt="Implementing a search path" src="./file-interpolator/search-path.svg"/>
<figcaption markdown="1">Figure 12.4: Using a colon-separated list of directories as a search path.</figcaption>
</figure>
<blockquote>
<h3>That's just how it is</h3>
<p>The rules about search paths in the paragraph above are a convention:
somebody did it this way years ago
and (almost) everyone has imitated it since.
We could implement search paths some other way,
but as with configuration file formats,
variable naming conventions,
and many other things,
the last thing the world needs is more innovation.</p>
</blockquote>
<p>Since the cache is responsible for finding files,
it should also handle the search path.
The outline of the class stays the same:</p>
<div class="code-sample lang-js" title="need-path.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable no-eval */</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Cache</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">constructSearchPath</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">need</span><span class="w"> </span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`returning cached value for </span><span class="si">${</span><span class="nx">fileSpec</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`loading value for </span><span class="si">${</span><span class="nx">fileSpec</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">eval</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Cache</span><span class="p">()</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">need</span><span class="p">(</span><span class="nx">fileSpec</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To get the search path,
we look for the <span class="ix-entry" ix-key="shell variable (for storing search path);search path!shell variable" markdown="1"><a class="gl-ref" href="../glossary/#shell_variable" markdown="1">shell variable</a></span> <code>NEED_PATH</code>.
(Writing shell variables' names in upper case is another convention.)
If <code>NEED_PATH</code> exists,
we split it on colons to create a list of directories:</p>
<div class="code-sample lang-js" title="need-path.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">constructSearchPath</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">searchPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">'NEED_PATH'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">searchPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEED_PATH</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>When we need to find a file we first check to see if the path is local.
If it's not,
we try the directories in the search path in order:</p>
<div class="code-sample lang-js" title="need-path.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">constructSearchPath</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">searchPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">'NEED_PATH'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">searchPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEED_PATH</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To test this,
we put the file to import in a subdirectory called <code>modules</code>:</p>
<div class="code-sample lang-js" title="imported-left.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="c1">// Define.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`in LEFT with message "</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Export.</span><span class="w"></span>
<span class="nx">report</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and then put the file doing the importing in the current directory:</p>
<div class="code-sample lang-js" title="test-import-left.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need-path.js'</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">imported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'imported-left.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">imported</span><span class="p">(</span><span class="s1">'called from test-import-left.js'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>We now need to set the variable <code>NEED_PATH</code>.
There are many ways to do this in shell;
if we only need the variable to exist for a single command,
the simplest is to write it as:</p>
<div class="highlight"><pre><span></span><code><span class="nv">NAME</span><span class="o">=</span>value <span class="nb">command</span>
</code></pre></div>
<p class="continue">right before the command (on the same line).
Here's the shell command that runs our test case
using <code>$PWD</code> to get the current working directory:</p>
<div class="code-sample lang-sh" title="test-import-left.sh">
<div class="highlight"><pre><span></span><code><span class="nv">NEED_PATH</span><span class="o">=</span><span class="nv">$PWD</span>/modules/ node test-import-left.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-import-left.out">
<div class="highlight"><pre><span></span><code>loading value for imported-left.js
trying /u/stjs/file-interpolator/modules/imported-left.js for \
imported-left.js
in LEFT with message "called from test-import-left.js"
</code></pre></div>
</div>
<p>Now let's create a second importable file in the <code>modules</code> directory:</p>
<div class="code-sample lang-js" title="imported-right.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="c1">// Define.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`in RIGHT with message "</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Export.</span><span class="w"></span>
<span class="nx">report</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and load that twice to check that caching works:</p>
<div class="code-sample lang-js" title="test-import-right.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need-path.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">imported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'imported-right.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">imported</span><span class="p">(</span><span class="s1">'called from test-import-right.js'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">alsoImported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'imported-right.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">alsoImported</span><span class="p">(</span><span class="s1">'called from test-import-right.js'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-import-right.out">
<div class="highlight"><pre><span></span><code>loading value for imported-right.js
trying /u/stjs/file-interpolator/modules/imported-right.js for \
imported-right.js
in RIGHT with message "called from test-import-right.js"
returning cached value for imported-right.js
in RIGHT with message "called from test-import-right.js"
</code></pre></div>
</div>
<h2 id="file-interpolator-interpolate">Section 12.4: How can we interpolate pieces of code?</h2>
<p>Interpolating files is straightforward once we have this machinery in place.
We modify <code>Cache.find</code> to return a directory and a file path,
then add an <code>interpolate</code> method to replace special comments:</p>
<div class="code-sample lang-js" title="caching.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Cache</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span><span class="w"></span>
<span class="w">  </span><span class="nx">interpolate</span><span class="w"> </span><span class="p">(</span><span class="nx">fileDir</span><span class="p">,</span><span class="w"> </span><span class="nx">outer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">outer</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">INTERPOLATE_PAT</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="p">(</span><span class="nx">match</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fileDir</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Cannot find </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">inner</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">Cache</span><span class="p">.</span><span class="nx">INTERPOLATE_PAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/\/\*\+(.+?)\+(.+?)\+\*\//g</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now have a file like this:</p>
<div class="code-sample lang-js" title="import-interpolate.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">constructorMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="cm">/*+ top method + import-interpolate-topmethod.js +*/</span><span class="w"></span>
<span class="w">  </span><span class="cm">/*+ bottom method + import-interpolate-bottommethod.js +*/</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">Example</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and subfiles like this:</p>
<div class="code-sample lang-js" title="import-interpolate-topmethod.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="nx">topMethod</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">bottomMethod</span><span class="p">(</span><span class="sb">`(topMethod </span><span class="si">${</span><span class="nx">msg</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and this:</p>
<div class="code-sample lang-js" title="import-interpolate-bottommethod.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="nx">bottomMethod</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`(bottomMethod </span><span class="si">${</span><span class="nx">msg</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's test it:</p>
<div class="code-sample lang-sh" title="test-import-interpolate.sh">
<div class="highlight"><pre><span></span><code>node test-import-interpolate.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-import-interpolate.out">
<div class="highlight"><pre><span></span><code>(bottomMethod (topMethod called from test-import-interpolate.js))
</code></pre></div>
</div>
<p>When this program runs, its <span class="ix-entry" ix-key="lifecycle!of file interpolation" markdown="1">lifecycle</span> is:</p>
<ol>
<li>Node starts to run <code>test-import-interpolate.js</code>.</li>
<li>It sees the <code>import</code> of need-interpolate` so it reads and evaluates that code.</li>
<li>Doing this creates a singleton cache object.</li>
<li>The program then calls <code>need('./import-interpolate.js')</code>.</li>
<li>This checks the cache: nope, nothing there.</li>
<li>So it loads <code>import-interpolate.js</code>.</li>
<li>It finds two specially-formatted comments in the text…</li>
<li>…so it loads the file described by each one and inserts the text in place of the comment.</li>
<li>Now that it has the complete text, it calls <code>eval</code>…</li>
<li>…and stores the result of <code>eval</code> (which is a class) in the cache.</li>
<li>It also returns that class.</li>
<li>We then create an instance of that class and call its method.</li>
</ol>
<p>This works,
but as we said in the introduction we decided not to use it
because it didn't play well with other tools.
No piece of software exists in isolation;
when we evaluate a design,
we always have to ask how it fits into everything else we have.</p>
<h2 id="file-interpolator-instead">Section 12.5: What did we do instead?</h2>
<p>Rather than interpolating file fragments,
we extract or erase parts of regular JavaScript files
based on specially-formatted comments
like the <code>&lt;fragment&gt;...&lt;/fragment&gt;</code> pair shown below.</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// &lt;fragment&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nx">fragment</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// &lt;/fragment&gt;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The code that selects the part of the file we want to display
is part of our page templating system.
It re-extracts code for display every time the web version of this site is built,
which ensures that we always shows what's in the current version of our examples.
However,
this system doesn't automatically update the description of the code:
if we write, "It does X,"
then modify the code to do Y,
our lesson can be inconsistent.
<span class="ix-entry" ix-key="literate programming" markdown="1"><a class="gl-ref" href="../glossary/#literate_programming" markdown="1">Literate programming</a></span> was invented
to try to prevent this from happening,
but it never really caught on---unfortunately,
most programming systems that describe themselves as "literate" these days
only implement part of <span class="ix-entry" ix-key="Knuth, Donald" markdown="1"><a href="https://www-cs-faculty.stanford.edu/~knuth/">Donald Knuth's</a></span> original vision.</p>
<div class="break-before"></div>
<h2 id="file-interpolator-exercises">Section 12.6: Exercises</h2>
<h3 class="exercise">Security concerns</h3>
<ol>
<li>
<p>Write a function <code>loadAndRun</code> that reads a file, evaluates it, and returns the result.</p>
</li>
<li>
<p>Create a file <code>trust-me.js</code> that prints "nothing happening here" when it is evaluated,
    but also deletes everything in the directory called <code>target</code>.</p>
</li>
<li>
<p>Write tests for this using <a href="https://www.npmjs.com/package/mock-fs"><code>mock-fs</code></a>.</p>
</li>
</ol>
<p class="continue">Please be careful doing this exercise.</p>
<h3 class="exercise">Loading functions</h3>
<p>Write a function that reads a file containing single-argument functions like this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">addOne</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="nx">halve</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="w"></span>
<span class="nx">array</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">and returns an object containing callable functions.</p>
<h3 class="exercise">Registering functions</h3>
<p>Write a function that loads one or more files containing function definitions like this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="kr">double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">EXPORTS</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="kr">double</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">and returns a list containing all the loaded functions.</p>
<h3 class="exercise">Indenting inclusions</h3>
<p>Modify the file inclusion system
so that inclusions are indented by the same amount as the including comment.
For example,
if the including file is:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">withLogging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/*+ logging call + logging.js +*/</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">withLogging</span><span class="w"></span>
</code></pre></div>
<p class="continue">and the included file is:</p>
<div class="highlight"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first message'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'second message'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">then the result will be:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">withLogging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first message'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'second message'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">withLogging</span><span class="w"></span>
</code></pre></div>
<p class="continue">i.e., all lines of the inclusion will be indented to match the first.</p>
<h3 class="exercise">Interpolating from subdirectories</h3>
<p>Modify the file interpolator so that snippets can be included from sub-directories using relative paths.</p>
<h3 class="exercise">Recursive search for inclusions</h3>
<ol>
<li>
<p>Modify the file interpolator so that it searches recursively
    through all subdirectories of the directories on the search path
    to find inclusions.</p>
</li>
<li>
<p>Explain why this is a bad idea.</p>
</li>
</ol>
<h3 class="exercise">Defining variables</h3>
<p>Modify the file inclusion system so that users can pass in a <code>Map</code> containing name-value pairs
and have these interpolated into the text of the files being loaded.
To interpolate a value,
the included file must use <code>@@name@@</code>.</p>
<h3 class="exercise">Specifying markers</h3>
<p>Modify the file inclusion system so that the user can override the inclusion comment markers.
For example, the user should be able to specify that <code>/*!</code> and <code>!*/</code> be used to mark inclusions.
(This is often used in tutorials that need to show the inclusion markers without them being interpreted.)</p>
<h3 class="exercise">Recursive inclusions</h3>
<p>Modify the file interpolator to support recursive includes,
i.e.,
to handle inclusion markers in files that are being included.
Be sure to check for the case of infinite includes.</p>
<h3 class="exercise">Slicing files</h3>
<p>Write a function that reads a JavaScript source file
containing specially-formatted comments like the ones shown below
and extracts the indicated section.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">toBeLeftOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'this should not appear'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// &lt;keepThis&gt;</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">toBeKept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'only this function should appear'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// &lt;/keepThis&gt;</span><span class="w"></span>
</code></pre></div>
<p>Users should be able to specify any tag they want,
and if that tag occurs multiple times,
all of the sections marked with that tag should be kept.
(This is the approach we took for this book instead of file interpolation.)</p>
</section>
<section class="new-chapter"><h1 id="module-loader">Chapter: Chapter 13: Module Loader</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#absolute_path" markdown="1">absolute path</a>, <a class="gl-ref" href="../glossary/#alias" markdown="1">alias</a>, <a class="gl-ref" href="../glossary/#circular_dependency" markdown="1">circular dependency</a>, <a class="gl-ref" href="../glossary/#closure" markdown="1">closure</a>, <a class="gl-ref" href="../glossary/#directed_graph" markdown="1">directed graph</a>, <a class="gl-ref" href="../glossary/#encapsulate" markdown="1">encapsulate</a>, <a class="gl-ref" href="../glossary/#iife" markdown="1">immediately-invoked function expression</a>, <a class="gl-ref" href="../glossary/#inner_function" markdown="1">inner function</a>, <a class="gl-ref" href="../glossary/#lru_cache" markdown="1">Least Recently Used cache</a>, <a class="gl-ref" href="../glossary/#namespace" markdown="1">namespace</a>, <a class="gl-ref" href="../glossary/#plugin_architecture" markdown="1">plugin architecture</a>
</p>
<p><a class="x-ref" href="#file-interpolator">Chapter 12</a> showed how to use <code>eval</code> to load code dynamically.
We can use this to build our own version of JavaScript's <code>require</code> function.
Our function will take the name of a source file as an argument
and return whatever that file exports.
The key requirement for such a function is to avoid accidentally overwriting things:
if we just <code>eval</code> some code and it happens to assign to a variable called <code>x</code>,
anything called <code>x</code> already in our program might be overwritten.
We therefore need a way to <span class="ix-entry" ix-key="encapsulation;software design!encapsulation" markdown="1"><a class="gl-ref" href="../glossary/#encapsulate" markdown="1">encapsulate</a></span> the contents of what we're loading.
Our approach is based on <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Casciaro2020">Casciaro2020</a>]</span>,
which contains a lot of other useful information as well.</p>
<h2 id="module-loader-namespace">Section 13.1: How can we implement namespaces?</h2>
<p>A <span class="ix-entry" ix-key="namespace" markdown="1"><a class="gl-ref" href="../glossary/#namespace" markdown="1">namespace</a></span> is a collection of names in a program
that are isolated from other namespaces.
Most modern languages provide namespaces as a built-in feature
so that programmers don't accidentally step on each other's toes.
JavaScript doesn't,
so we have to implement them ourselves.</p>
<p>We can do this using <span class="ix-entry" ix-key="closure" markdown="1"><a class="gl-ref" href="../glossary/#closure" markdown="1">closures</a></span>.
Every function is a namespace:
variables defined inside the function are distinct from variables defined outside it
(<a class="fig-ref" href="../module-loader/#module-loader-closures">Figure 13.1</a>).
If we create the variables we want to manage inside a function,
then defined another function inside the first
and return that <span class="ix-entry" ix-key="inner function;function!inner" markdown="1"><a class="gl-ref" href="../glossary/#inner_function" markdown="1">inner function</a></span>,
that inner function will be the only thing with references to those variables.</p>
<figure id="module-loader-closures">
<img alt="How closures work" src="./module-loader/closures.svg"/>
<figcaption markdown="1">Figure 13.1: Using closures to create private variables.</figcaption>
</figure>
<p>For example,
let's create a function that always appends the same string to its argument:</p>
<div class="code-sample lang-js" title="manual-namespacing.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">createAppender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">suffix</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">appender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">suffix</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">appender</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">exampleFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createAppender</span><span class="p">(</span><span class="s1">' and that'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exampleFunction</span><span class="p">(</span><span class="s1">'this'</span><span class="p">))</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'suffix is'</span><span class="p">,</span><span class="w"> </span><span class="nx">suffix</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">When we run it,
the value that was assigned to the parameter <code>suffix</code> still exists
but can only be reached by the inner function:</p>
<div class="code-sample lang-out" title="manual-namespacing.out">
<div class="highlight"><pre><span></span><code>this and that
/u/stjs/module-loader/manual-namespacing.js:10
console.log('suffix is', suffix)
                         ^

ReferenceError: suffix is not defined
    at /u/stjs/module-loader/manual-namespacing.js:10:26
    at ModuleJob.run (internal/modules/esm/module_job.js:152:23)
    at async Loader.import (internal/modules/esm/loader.js:166:24)
    at async Object.loadESM (internal/process/esm_loader.js:68:5)
</code></pre></div>
</div>
<p>We could require every module to define a setup function like this for users to call,
but thanks to <code>eval</code> we can wrap the file's contents in a function and call it automatically.
To do this we will create something called
an <span class="ix-entry" ix-key="immediately-invoked function expression" markdown="1"><a class="gl-ref" href="../glossary/#iife" markdown="1">immediately-invoked function expression</a></span> (IIFE).
The syntax <code>() =&gt; {...}</code> defines a function.
If we put the definition in parentheses and then put another pair of parentheses right after it:</p>
<div class="highlight"><pre><span></span><code><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{...})()</span><span class="w"></span>
</code></pre></div>
<p class="continue">we have code that defines a function of no arguments and immediately calls it.
We can use this trick to achieve the same effect as the previous example in one step:</p>
<div class="code-sample lang-js" title="automatic-namespacing.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">privateValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'private value'</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">publicValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'public value'</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">publicValue</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">})()</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`contents.publicValue is </span><span class="si">${</span><span class="nx">contents</span><span class="p">.</span><span class="nx">publicValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`contents.privateValue is </span><span class="si">${</span><span class="nx">contents</span><span class="p">.</span><span class="nx">privateValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="automatic-namespacing.out">
<div class="highlight"><pre><span></span><code>contents.publicValue is public value
contents.privateValue is undefined
</code></pre></div>
</div>
<blockquote>
<h3>Unconfusing the parser</h3>
<p>The extra parentheses around the original definition force the parser to evaluate things in the right order;
if we write:</p>
<div class="highlight"><pre><span></span><code><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{...}()</span><span class="w"></span>
</code></pre></div>
<p class="continue">then JavaScript interprets it as a function definition followed by an empty expression
rather than an immediate call to the function just defined.</p>
</blockquote>
<h2 id="module-loader-load">Section 13.2: How can we load a module?</h2>
<p>We want the module we are loading to export names by assigning to <code>module.exports</code> just as <code>require</code> does,
so we need to provide an object called <code>module</code> and create a IIFE.
(We will handle the problem of the module loading other modules later.)
Our <code>loadModule</code> function takes a filename and returns a newly-created module object;
the parameter to the function we build and <code>eval</code> must be called <code>module</code> so that we can assign to <code>module.exports</code>.
For clarity,
we call the object we pass in <code>result</code> in <code>loadModule</code>.</p>
<div class="code-sample lang-js" title="load-module-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">loadModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fullText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`((module) =&gt; {</span><span class="si">${</span><span class="nx">source</span><span class="si">}</span><span class="sb">})(result)`</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`full text for eval:\n</span><span class="si">${</span><span class="nx">fullText</span><span class="si">}</span><span class="sb">\n`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nb">eval</span><span class="p">(</span><span class="nx">fullText</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">exports</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">loadModule</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="module-loader-iife-a">
<img alt="Implementing modules with IIFEs (part 1)" src="./module-loader/iife-a.svg"/>
<figcaption markdown="1">Figure 13.2: Using IIFEs to encapsulate modules and get their exports (part 1).</figcaption>
</figure>
<figure id="module-loader-iife-b">
<img alt="Implementing modules with IIFEs (part 2)" src="./module-loader/iife-b.svg"/>
<figcaption markdown="1">Figure 13.3: Using IIFEs to encapsulate modules and get their exports (part 2).</figcaption>
</figure>
<p><a class="fig-ref" href="../module-loader/#module-loader-iife-a">Figure 13.2</a> and <a class="fig-ref" href="../module-loader/#module-loader-iife-b">Figure 13.3</a> show the structure of our loader so far.
We can use this code as a test:</p>
<div class="code-sample lang-js" title="small-module.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">publicValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'public value'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">privateValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'private value'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">publicFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`publicFunction called from </span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">publicValue</span><span class="p">,</span><span class="w"> </span><span class="nx">publicFunction</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and this short program to load the test and check its exports:</p>
<div class="code-sample lang-js" title="test-load-module-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">loadModule</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./load-module-only.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`result.publicValue is </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">publicValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`result.privateValue is </span><span class="si">${</span><span class="nx">result</span><span class="p">.</span><span class="nx">privateValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">publicFunction</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="test-load-module-only.sh">
<div class="highlight"><pre><span></span><code>node test-load-module-only.js small-module.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-load-module-only.out">
<div class="highlight"><pre><span></span><code>full text for eval:
((module) =&gt; {const publicValue = 'public value'

const privateValue = 'private value'

const publicFunction = (caller) =&gt; {
  return `publicFunction called from ${caller}`
}

module.exports = { publicValue, publicFunction }
})(result)

result.publicValue is public value
result.privateValue is undefined
publicFunction called from main
</code></pre></div>
</div>
<h2 id="module-loader-circular">Section 13.3: Do we need to handle circular dependencies?</h2>
<p>What if the code we are loading loads other code?
We can visualize the network of who requires whom as a <span class="ix-entry" ix-key="directed graph" markdown="1"><a class="gl-ref" href="../glossary/#directed_graph" markdown="1">directed graph</a></span>:
if X requires Y,
we draw an arrow from X to Y.
Unlike the <span class="ix-entry" ix-key="directed acyclic graph" markdown="1">directed <em>acyclic</em> graphs</span> we met in <a class="x-ref" href="#build-manager">Chapter 10</a>,
though,
these graphs can contain cycles:
we say a <span class="ix-entry" ix-key="circular dependency" markdown="1"><a class="gl-ref" href="../glossary/#circular_dependency" markdown="1">circular dependency</a></span> exists
if X depends on Y and Y depends on X
either directly or indirectly.
This may seem nonsensical,
but can easily arise with <span class="ix-entry" ix-key="plugin architecture;software design!plugin architecture" markdown="1"><a class="gl-ref" href="../glossary/#plugin_architecture" markdown="1">plugin architectures</a></span>:
the file containing the main program loads an extension,
and that extension calls utility functions defined in the file containing the main program.</p>
<p>Most compiled languages can handle circular dependencies easily:
they compile each module into low-level instructions,
then link those to resolve dependencies before running anything
(<a class="fig-ref" href="../module-loader/#module-loader-circularity">Figure 13.4</a>).
But interpreted languages usually run code as they're loading it,
so if X is in the process of loading Y and Y tries to call X,
X may not (fully) exist yet.</p>
<figure id="module-loader-circularity">
<img alt="Circularity test case" src="./module-loader/circularity.svg"/>
<figcaption markdown="1">Figure 13.4: Testing circular imports.</figcaption>
</figure>
<p>Circular dependencies work in <span class="ix-entry" ix-key="Python" markdown="1"><a href="https://www.python.org/">Python</a></span>,
but only sort of.
Let's create two files called <code>major.py</code> and <code>minor.py</code>:</p>
<div class="code-sample lang-py" title="major.py">
<div class="highlight"><pre><span></span><code><span class="c1"># major.py</span>

<span class="kn">import</span> <span class="nn">minor</span>

<span class="k">def</span> <span class="nf">top</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"top"</span><span class="p">)</span>
    <span class="n">minor</span><span class="o">.</span><span class="n">middle</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">bottom</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"bottom"</span><span class="p">)</span>

<span class="n">top</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample lang-py" title="minor.py">
<div class="highlight"><pre><span></span><code><span class="c1"># minor.py</span>

<span class="kn">import</span> <span class="nn">major</span>

<span class="k">def</span> <span class="nf">middle</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"middle"</span><span class="p">)</span>
    <span class="n">major</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span>
</code></pre></div>
</div>
<p>Loading fails when we run <code>major.py</code> from the command line:</p>
<div class="code-sample lang-out" title="py-command-line.out">
<div class="highlight"><pre><span></span><code>top
Traceback (most recent call last):
  File "major.py", line 3, in &lt;module&gt;
    import minor
  File "/u/stjs/module-loader/checking/minor.py", line 3, in &lt;module&gt;
    import major
  File "/u/stjs/module-loader/checking/major.py", line 12, in &lt;module&gt;
    top()
  File "/u/stjs/module-loader/checking/major.py", line 7, in top
    minor.middle()
AttributeError: module 'minor' has no attribute 'middle'
</code></pre></div>
</div>
<p class="continue">but works in the interactive interpreter:</p>
<div class="code-sample lang-out" title="py-interactive.out">
<div class="highlight"><pre><span></span><code>$ python
&gt;&gt;&gt; import major
top
middle
bottom
</code></pre></div>
</div>
<p>The equivalent test in JavaScript also has two files:</p>
<div class="code-sample lang-js" title="major.js">
<div class="highlight"><pre><span></span><code><span class="c1">// major.js</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">middle</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./minor'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'top'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">middle</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">bottom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'bottom'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">top</span><span class="p">()</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">top</span><span class="p">,</span><span class="w"> </span><span class="nx">bottom</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="minor.js">
<div class="highlight"><pre><span></span><code><span class="c1">// minor.js</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">bottom</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./major'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">middle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'middle'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">bottom</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">middle</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">It fails on the command line:</p>
<div class="code-sample lang-out" title="js-command-line.out">
<div class="highlight"><pre><span></span><code>top
middle
/u/stjs/module-loader/checking/minor.js:6
  bottom()
  ^

TypeError: bottom is not a function
    at middle (/u/stjs/module-loader/checking/minor.js:6:3)
    at top (/u/stjs/module-loader/checking/major.js:6:3)
    at Object.&lt;anonymous&gt; (/u/stjs/module-loader/checking/major.js:13:1)
    at Module._compile (internal/modules/cjs/loader.js:1063:30)
    at Object.Module._extensions..js \
 (internal/modules/cjs/loader.js:1092:10)
    at Module.load (internal/modules/cjs/loader.js:928:32)
    at Function.Module._load (internal/modules/cjs/loader.js:769:14)
    at Function.executeUserEntryPoint [as runMain] \
 (internal/modules/run_main.js:72:12)
    at internal/main/run_main_module.js:17:47
</code></pre></div>
</div>
<p class="continue">and also fails in the interactive interpreter
(which is more consistent):</p>
<div class="code-sample lang-out" title="js-interactive.out">
<div class="highlight"><pre><span></span><code>$ node
&gt; require('./major')
top
middle
/u/stjs/module-loader/checking/minor.js:6
  bottom()
  ^

TypeError: bottom is not a function
    at middle (/u/stjs/module-loader/checking/minor.js:6:3)
    at top (/u/stjs/module-loader/checking/major.js:6:3)
    at Object.&lt;anonymous&gt; (/u/stjs/module-loader/checking/major.js:13:1)
    at Module._compile (internal/modules/cjs/loader.js:1063:30)
    at Object.Module._extensions..js \
 (internal/modules/cjs/loader.js:1092:10)
    at Module.load (internal/modules/cjs/loader.js:928:32)
    at Function.Module._load (internal/modules/cjs/loader.js:769:14)
    at Module.require (internal/modules/cjs/loader.js:952:19)
    at require (internal/modules/cjs/helpers.js:88:18)
    at [stdin]:1:1
</code></pre></div>
</div>
<p>We therefore won't try to handle circular dependencies.
However,
we will detect them and generate a sensible error message.</p>
<blockquote>
<h3><code>import</code> vs. <code>require</code></h3>
<p>Circular dependencies work JavaScript's <code>import</code> syntax
because we can analyze files to determine what needs what,
get everything into memory,
and then resolve dependencies.
We can't do this with <code>require</code>-based code
because someone might create an <span class="ix-entry" ix-key="alias!during import;import!alias" markdown="1"><a class="gl-ref" href="../glossary/#alias" markdown="1">alias</a></span>
and call <code>require</code> through that
or <code>eval</code> a string that contains a <code>require</code> call.
(Of course, they can also do these things with the function version of <code>import</code>.)</p>
</blockquote>
<h2 id="module-loader-subload">Section 13.4: How can a module load another module?</h2>
<p>While we're not going to handle circular dependencies,
modules do need to be able to load other modules.
To enable this,
we need to provide the module with a function called <code>require</code>
that it can call as it's loading.
As in <a class="x-ref" href="#file-interpolator">Chapter 12</a>,
this function checks a <span class="ix-entry" ix-key="cache!of loaded files" markdown="1">cache</span>
to see if the file being asked for has already been loaded.
If not, it loads it and saves it;
either way, it returns the result.</p>
<p>Our cache needs to be careful about how it identifies files
so that it can detect duplicates loading attempts that use different names.
For example,
suppose that <code>major.js</code> loads <code>subdir/first.js</code> and <code>subdir/second.js</code>.
When <code>subdir/second.js</code> loads <code>./first.js</code>,
our system needs to realize that it already has that file
even though the path looks different.
We will use <a class="gl-ref" href="../glossary/#absolute_path" markdown="1">absolute paths</a> as cache keys
so that every file has a unique, predictable key.</p>
<p>To reduce confusion,
we will call our function <code>need</code> instead of <code>require</code>.
In order to make the cache available to modules while they're loading,
we will make it a property of <code>need</code>.
(Remember,
a function is just another kind of object in JavaScript;
every function gets several properties automatically,
and we can always add more.)
Since we're using the built-in <code>Map</code> class as a cache,
the entire implementation of <code>need</code> is just 15 lines long:</p>
<div class="code-sample lang-js" title="need.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">loadModule</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./load-module.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">absPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">need</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">absPath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">absPath</span><span class="p">,</span><span class="w"> </span><span class="nx">need</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">need</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">absPath</span><span class="p">,</span><span class="w"> </span><span class="nx">contents</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">need</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">absPath</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">need</span><span class="p">.</span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">need</span><span class="w"></span>
</code></pre></div>
</div>
<p>We now need to modify <code>loadModule</code> to take our function <code>need</code> as a parameter.
(Again, we'll have our modules call <code>need('something.js')</code> instead of <code>require('something')</code> for clarity.)
Let's test it with the same small module that doesn't need anything else to make sure we haven't broken anything:</p>
<div class="code-sample lang-js" title="test-need-small-module.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'small-module.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`small.publicValue is </span><span class="si">${</span><span class="nx">small</span><span class="p">.</span><span class="nx">publicValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`small.privateValue is </span><span class="si">${</span><span class="nx">small</span><span class="p">.</span><span class="nx">privateValue</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">small</span><span class="p">.</span><span class="nx">publicFunction</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-need-small-module.out">
<div class="highlight"><pre><span></span><code>full text for eval:
((module, need) =&gt; {
const publicValue = 'public value'

const privateValue = 'private value'

const publicFunction = (caller) =&gt; {
  return `publicFunction called from ${caller}`
}

module.exports = { publicValue, publicFunction }

})(result, need)

small.publicValue is public value
small.privateValue is undefined
publicFunction called from main
</code></pre></div>
</div>
<p>What if we test it with a module that <em>does</em> load something else?</p>
<div class="code-sample lang-js" title="large-module.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'small-module.js'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`large from </span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">small</span><span class="p">.</span><span class="nx">publicFunction</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb"> to large`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">large</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-need-large-module.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'large-module.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">large</span><span class="p">.</span><span class="nx">large</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-need-large-module.out">
<div class="highlight"><pre><span></span><code>full text for eval:
((module, need) =&gt; {
import need from './need'

const small = need('small-module.js')

const large = (caller) =&gt; {
  console.log(`large from ${caller}`)
  small.publicFunction(`${caller} to large`)
}

export default large

})(result, need)

undefined:2
import need from './need'
^^^^^^

SyntaxError: Cannot use import statement outside a module
    at loadModule (/u/stjs/module-loader/load-module.js:8:8)
    at need (/u/stjs/module-loader/need.js:8:22)
    at /u/stjs/module-loader/test-need-large-module.js:3:15
    at ModuleJob.run (internal/modules/esm/module_job.js:152:23)
    at async Loader.import (internal/modules/esm/loader.js:166:24)
    at async Object.loadESM (internal/process/esm_loader.js:68:5)
</code></pre></div>
</div>
<p>This doesn't work because <code>import</code> only works at the top level of a program,
not inside a function.
Our system can therefore only run loaded modules by <code>need</code>ing them:</p>
<div class="code-sample lang-js" title="large-needless.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'small-module.js'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">small</span><span class="p">.</span><span class="nx">publicFunction</span><span class="p">(</span><span class="sb">`large called from </span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">large</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-need-large-needless.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./need.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">need</span><span class="p">(</span><span class="s1">'large-needless.js'</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">large</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-need-large-needless.out">
<div class="highlight"><pre><span></span><code>full text for eval:
((module, need) =&gt; {
const small = need('small-module.js')

const large = (caller) =&gt; {
  return small.publicFunction(`large called from ${caller}`)
}

module.exports = large

})(result, need)

full text for eval:
((module, need) =&gt; {
const publicValue = 'public value'

const privateValue = 'private value'

const publicFunction = (caller) =&gt; {
  return `publicFunction called from ${caller}`
}

module.exports = { publicValue, publicFunction }

})(result, need)

publicFunction called from large called from main
</code></pre></div>
</div>
<blockquote>
<h3>"It's so deep it's meaningless"</h3>
<p>The programs we have written in this chapter are harder to understand
than most of the programs in earlier chapters
because they are so abstract.
Reading through them,
it's easy to get the feeling that everything is happening somewhere else.
Programmers' tools are often like this:
there's always a risk of confusing the thing in the program
with the thing the program is working on.
Drawing pictures of data structures can help,
and so can practicing with closures
(which are one of the most powerful ideas in programming),
but a lot of the difficulty is irreducible,
so don't feel bad if it takes you a while to wrap your head around it.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="module-loader-exercises">Section 13.5: Exercises</h2>
<h3 class="exercise">Counting with closures</h3>
<p>Write a function <code>makeCounter</code> that returns a function
that produces the next integer in sequence starting from zero each time it is called.
Each function returned by <code>makeCounter</code> must count independently, so:</p>
<div class="highlight"><pre><span></span><code><span class="nx">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeCounter</span><span class="p">()</span><span class="w"></span>
<span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeCounter</span><span class="p">()</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`left </span><span class="si">${</span><span class="nx">left</span><span class="p">()</span><span class="sb">`)</span>
<span class="sb">console.log(`</span><span class="nx">right</span><span class="w"> </span><span class="nx">$</span><span class="p">{</span><span class="nx">right</span><span class="p">()</span><span class="sb">`)</span>
<span class="sb">console.log(`</span><span class="nx">left</span><span class="w"> </span><span class="nx">$</span><span class="p">{</span><span class="nx">left</span><span class="p">()</span><span class="sb">`)</span>
<span class="sb">console.log(`</span><span class="nx">right</span><span class="w"> </span><span class="nx">$</span><span class="p">{</span><span class="nx">right</span><span class="p">()</span><span class="sb">`)</span>
</code></pre></div>
<p class="continue">must produce:</p>
<div class="highlight"><pre><span></span><code>left 0
right 0
left 1
right `
</code></pre></div>
<h3 class="exercise">Objects and namespaces</h3>
<p>A JavaScript object stores key-value pairs,
and the keys in one object are separate from the keys in another.
Why doesn't this provide the same level of safety as a closure?</p>
<h3 class="exercise">Testing module loading</h3>
<p>Write tests for <code>need.js</code> using Mocha and <code>mock-fs</code>.</p>
<h3 class="exercise">Using <code>module</code> as a name</h3>
<p>What happens if we define the variable <code>module</code> in <code>loadModule</code>
so that it is in scope when <code>eval</code> is called
rather than creating a variable called <code>result</code> and passing that in:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">loadModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fullText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`(() =&gt; {</span><span class="si">${</span><span class="nx">source</span><span class="si">}</span><span class="sb">})()`</span><span class="w"></span>
<span class="w">  </span><span class="nb">eval</span><span class="p">(</span><span class="nx">fullText</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 class="exercise">Implementing a search path</h3>
<p>Add a search path to <code>need.js</code> so that if a module isn't found locally,
it will be looked for in each directory in the search path in order.</p>
<h3 class="exercise">Using a setup function</h3>
<p>Rewrite the module loader so that every module has a function called <code>setup</code>
that must be called after loading it to create its exports
rather than using <code>module.exports</code>.</p>
<h3 class="exercise">Handling errors while loading</h3>
<ol>
<li>
<p>Modify <code>need.js</code> so that it does something graceful
    if an exception is thrown while a module is being loaded.</p>
</li>
<li>
<p>Write unit tests for this using Mocha.</p>
</li>
</ol>
<h3 class="exercise">Refactoring circularity</h3>
<p>Suppose that <code>main.js</code> contains this:</p>
<div class="code-sample lang-js" title="main.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">PLUGINS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">plugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./plugin'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">PLUGINS</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">loadPlugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">plugin</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">PLUGINS</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">plugin</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">main</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">loadPlugin</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and <code>plugin.js</code> contains this:</p>
<div class="code-sample lang-js" title="plugin.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">loadPlugin</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./main'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">printMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'running plugin'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">loadPlugin</span><span class="p">(</span><span class="nx">printMessage</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Refactor this code so that it works correctly while still using <code>require</code> rather than <code>import</code>.</p>
<h3 class="exercise break-before">An LRU cache</h3>
<p>A <a class="gl-ref" href="../glossary/#lru_cache" markdown="1">Least Recently Used (LRU) cache</a>
reduces access time while limiting the amount of memory used
by keeping track of the N items that have been used most recently.
For example,
if the cache size is 3 and objects are accessed in the order shown in the first column,
the cache's contents will be as shown in the second column:</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Action</th>
<th>Cache After Access</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>read A</td>
<td>[A]</td>
</tr>
<tr>
<td>A</td>
<td>get A from cache</td>
<td>[A]</td>
</tr>
<tr>
<td>B</td>
<td>read B</td>
<td>[B, A]</td>
</tr>
<tr>
<td>A</td>
<td>get A from cache</td>
<td>[A, B]</td>
</tr>
<tr>
<td>C</td>
<td>read C</td>
<td>[C, A, B]</td>
</tr>
<tr>
<td>D</td>
<td>read D</td>
<td>[D, C, A]</td>
</tr>
<tr>
<td>B</td>
<td>read B</td>
<td>[B, D, C]</td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Implement a function <code>cachedRead</code> that takes the number of entries in the cache as an argument
    and returns a function that uses an LRU cache
    to either read files or return cached copies.</p>
</li>
<li>
<p>Modify <code>cachedRead</code> so that the number of items in the cache
    is determined by their combined size
    rather than by the number of files.</p>
</li>
</ol>
<h3 class="exercise">Make functions safe for renaming</h3>
<p>Our implementation of <code>need</code> implemented the cache as a property of the function itself.</p>
<ol>
<li>
<p>How can this go wrong?
    (Hint: thing about aliases.)</p>
</li>
<li>
<p>Modify the implementation to solve this problem using a closure.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="style-checker">Chapter: Chapter 14: Style Checker</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a>, <a class="gl-ref" href="../glossary/#adapter_pattern" markdown="1">Adapter pattern</a>, <a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major storage</a>, <a class="gl-ref" href="../glossary/#dynamic_lookup" markdown="1">dynamic lookup</a>, <a class="gl-ref" href="../glossary/#generator_function" markdown="1">generator function</a>, <a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a>, <a class="gl-ref" href="../glossary/#iterator_pattern" markdown="1">Iterator pattern</a>, <a class="gl-ref" href="../glossary/#linter" markdown="1">linter</a>, <a class="gl-ref" href="../glossary/#markdown" markdown="1">Markdown</a>, <a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major storage</a>, <a class="gl-ref" href="../glossary/#walk_tree" markdown="1">walk (a tree)</a>
</p>
<p>Programmers argue endlessly about the best way to format their programs,
but everyone agrees that the most important thing is to be <span class="ix-entry" ix-key="coding style!importance of consistency" markdown="1">consistent</span>
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Binkley2012">Binkley2012</a>, <a class="bib-ref" href="../bibliography/#Johnson2019">Johnson2019</a>]</span>.
Since checking rules by hand is tedious,
most programmers use tools to compare code against various rules and report any violations.
Programs that do this are often called <span class="ix-entry" ix-key="linter;coding style!linter" markdown="1"><a class="gl-ref" href="../glossary/#linter" markdown="1">linters</a></span>
in honor of an early one for <span class="ix-entry" ix-key="C" markdown="1">C</span> named <code>lint</code>
(because it looked for fluff in source code).</p>
<p>In this chapter we will build a simple linter of our own inspired by <span class="ix-entry" ix-key="ESLint" markdown="1"><a href="https://eslint.org/">ESLint</a></span>,
which we use to check the code in this book.
Our tool will parse source code to create a data structure,
then go through that data structure and apply rules for each part of the program.
It will also introduce us to one of the key ideas of this book,
which is that source code is just another kind of data.</p>
<blockquote>
<h3>Don't define your own style</h3>
<p>Just as the world doesn't need more file format (<a class="x-ref" href="#regex-parser">Chapter 8</a>)
it also doesn't need more programming styles,
or more arguments among programmers about whether there should be spaces before curly braces or not.
<span class="ix-entry" ix-key="Standard JS" markdown="1"><a href="https://standardjs.com/">Standard JS</a></span> may not do everything exactly the way you want,
but adopting it increases the odds that other programmers will be able to read your code at first glance.</p>
</blockquote>
<h2 id="style-checker-ast">Section 14.1: How can we parse JavaScript to create an AST?</h2>
<p>A parser for a simple language like arithmetic or JSON is relatively easy to write.
A parser for a language as complex as JavaScript is much more work,
so we will use one called <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span> instead.
Acorn takes a string containing source code as input
and produces an <span class="ix-entry" ix-key="abstract syntax tree" markdown="1"><a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a></span> (AST)
whose nodes store information about what's in the program
(<a class="fig-ref" href="../style-checker/#style-checker-parse-tree">Figure 14.1</a>).
An AST is for a program what the <span class="ix-entry" ix-key="Document Object Model" markdown="1">DOM</span> is for HTML:
an in-memory representation that is easy for software to inspect and manipulate.</p>
<figure id="style-checker-parse-tree">
<img alt="A small parse tree" src="./style-checker/parse-tree.svg"/>
<figcaption markdown="1">Figure 14.1: The parse tree of a simple program.</figcaption>
</figure>
<p>ASTs can be quite complex---for example,
the JSON representation of the AST for a single constant declaration
is 84 lines long:</p>
<div class="code-sample lang-js" title="parse-single-const.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">'const x = 0'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="parse-single-const.slice.out">
<div class="highlight"><pre><span></span><code>{
  "type": "Program",
  "start": 0,
  "end": 11,
  "loc": {
    "start": {
      "line": 1,
      "column": 0
    },
    "end": {
...
            "value": 0,
            "raw": "0"
          }
        }
      ],
      "kind": "const"
    }
  ],
  "sourceType": "script"
}
</code></pre></div>
</div>
<p>Acorn's output is in <span class="ix-entry" ix-key="Esprima format" markdown="1"><a href="https://esprima.org/">Esprima</a> format</span>
(so-called because it was originally defined by a tool with that name).
The format's specification is very detailed,
but we can usually figure out most of what we need by inspection.
For example,
here is the output for a 15-line program:</p>
<div class="code-sample lang-js" title="parse-const-func.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const value = 2</span>

<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="parse-const-func.slice.out">
<div class="highlight"><pre><span></span><code>{
  "type": "Program",
  "start": 0,
  "end": 122,
  "loc": {
    "start": {
      "line": 1,
      "column": 0
    },
    "end": {
...
          "line": 1,
          "column": 0
        },
        "end": {
          "line": 1,
          "column": 15
        }
      },
      "declarations": [
...480 more lines...
</code></pre></div>
</div>
<p class="continue">Yes, it really is almost 500 lines long…</p>
<h2 id="style-checker-search">Section 14.2: How can we find things in an AST?</h2>
<p>If we want to find functions, variables, or anything else in an AST
we need to <span class="ix-entry" ix-key="walk a tree" markdown="1"><a class="gl-ref" href="../glossary/#walk_tree" markdown="1">walk the tree</a></span>,
i.e.,
to visit each node in turn.
The <a href="https://www.npmjs.com/package/acorn-walk"><code>acorn-walk</code></a> library will do this for us
using the <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1">Visitor design pattern</span> we first saw in <a class="x-ref" href="#page-templates">Chapter 9</a>
If we provide a function to act on nodes of type <code>Identifier</code>,
<code>acorn-walk</code> will call that function each time it finds an identifier.
We can use other options to say that we want to record the locations of nodes (i.e., their line numbers)
and to collect comments in an array called <code>onComment</code>.
Our function can do whatever we want;
for demonstration purposes we will add nodes to an array called <code>state</code>
and report them all at the end
(<a class="fig-ref" href="../style-checker/#style-checker-walk-tree">Figure 14.2</a>).</p>
<figure id="style-checker-walk-tree">
<img alt="Walking a tree" src="./style-checker/walk-tree.svg"/>
<figcaption markdown="1">Figure 14.2: Walking a tree to perform an operation at each node.</figcaption>
</figure>
<div class="code-sample lang-js" title="walk-ast.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">walk</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn-walk'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`// Constant</span>
<span class="sb">const value = 2</span>

<span class="sb">// Function</span>
<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">// Main body</span>
<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>

<span class="nx">state</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="sb">`identifier </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> on line </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="p">))</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`comments on lines </span><span class="si">${</span><span class="nx">comments</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="walk-ast.out">
<div class="highlight"><pre><span></span><code>identifier x on line 6
identifier y on line 7
identifier double on line 11
identifier value on line 11
identifier console on line 12
identifier result on line 12
comments on lines 1, 4, 10
</code></pre></div>
</div>
<blockquote>
<h3>There's more than one way to do it</h3>
<p><code>walk.simple</code> takes four arguments:</p>
<ol>
<li>
<p>The root node of the AST, which is used as the starting point.</p>
</li>
<li>
<p>An object containing callback functions for handling various kinds of nodes.</p>
</li>
<li>
<p>Another object that specifies what algorithm to use---we have set this to <code>null</code>
    to use the default because
    we don't particularly care about the order in which the nodes are processed.</p>
</li>
<li>
<p>Something we want passed in to each of the node handlers,
    which in our case is the <code>state</code> array.
    If our node handling functions don't require any extra data
    from one call to the next
    we can leave this out;
    if we want to accumulate information across calls,
    this argument acts as the Visitor's memory.</p>
</li>
</ol>
<p>Any general-purpose implementation of the Visitor pattern
is going to need these four things,
but as we will see below,
we can implement them in different ways.</p>
</blockquote>
<h2 id="style-checker-apply">Section 14.3: How can we apply checks?</h2>
<p>We don't just want to collect nodes:
we want to check their properties against a set of rules.
One way to do this would be to call <code>walk.simple</code> once for each rule,
passing it a function that checks just that rule.
Another way---the one we'll use---is to write a <span class="ix-entry" ix-key="software design!generic function" markdown="1">generic function</span>
that checks a rule and records any nodes that don't satisfy it,
and then call that function once for each rule inside our <code>Identifier</code> handler.
This may see like extra work,
but it ensures that all of our rule-checkers store their results in the same way,
which in turn means that we can write one reporting function
and be sure it will handle everything.</p>
<p>The function  <code>applyCheck</code> takes the current state (where we are accumulating rule violations),
a label that identifies this rule (so that violations of it can be stored together),
the node,
and a logical value telling it whether the node passed the test or not.
If the node failed the test
we make sure that <code>state</code> contains a list with the appropriate label
and then append this node to it.
This "create storage space on demand" pattern
is widely used but doesn't have a well-known name.</p>
<div class="code-sample lang-js" title="check-name-lengths.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">applyCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">label</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">passes</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">passes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">state</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">state</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">state</span><span class="p">[</span><span class="nx">label</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now put a call to <code>applyCheck</code> inside the handler for <code>Identifier</code>:</p>
<div class="code-sample lang-js" title="check-name-lengths.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">applyCheck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">'name_length'</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>

<span class="nx">state</span><span class="p">.</span><span class="nx">name_length</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> at line </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We can't just use <code>applyCheck</code> as the handler for <code>Identifier</code>
because <code>walk.simple</code> wouldn't know how to call it.
This is a (very simple) example of the <span class="ix-entry" ix-key="Adapter pattern;design pattern!Adapter" markdown="1"><a class="gl-ref" href="../glossary/#adapter_pattern" markdown="1">Adapter</a></span> design pattern:
we write a function or class to connect the code we want to call
to the already-written code that is going to call it.</p>
<p>The output for the same sample program as before is:</p>
<div class="code-sample lang-out" title="check-name-lengths.out">
<div class="highlight"><pre><span></span><code>x at line 6
y at line 7
</code></pre></div>
</div>
<p class="continue">The exercises will ask why the parameter <code>x</code> doesn't show up
as a violation of our rule
that variables' names must be at least four characters long.</p>
<h2 id="style-checker-walker">Section 14.4: How does the AST walker work?</h2>
<p>The AST walker uses the Visitor pattern,
but how does it actually work?
We can build our own by defining a class with methods that walk the tree,
take action depending on the kind of node,
and then go through the children of that node (if any).
The user can then derive a class of their own from this
and override the set of action methods they're interested in.</p>
<p>One key difference between our implementation and <code>acorn-walk</code>'s is that
our methods don't need to take <code>state</code> as a parameter
because it's contained in the object that they're part of.
That simplifies the methods---one less parameter---but it does mean that
anyone who wants to use our visitor has to derive a class,
which is a bit more complicated than writing a function.
This tradeoff is a sign that managing state is part of the problem's
<span class="ix-entry" ix-key="intrinsic complexity" markdown="1"><a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a></span>:
we can move it around,
but we can't get rid of it.</p>
<p>The other difference between our visitor and <code>acorn-walk</code> is that
our class uses <span class="ix-entry" ix-key="dynamic lookup" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_lookup" markdown="1">dynamic lookup</a></span>
(a form of <span class="ix-entry" ix-key="introspection!of methods" markdown="1">introspection</span>)
to look up a method
with the same name as the node type in the object.
While we normally refer to a particular method of an object using <code>object.method</code>,
we can also look them up by asking for <code>object[name]</code>
in the same way that we would look up any other property of any other object.
Our completed class looks like this:</p>
<div class="code-sample lang-js" title="walker-class.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Walker</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Construct a new AST tree walker.</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ast</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Walk the tree.</span><span class="w"></span>
<span class="w">  </span><span class="nx">walk</span><span class="w"> </span><span class="p">(</span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">accumulator</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Act on node and then on children.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_walk</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="s1">'type'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_doNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_doChildren</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Handle a single node by lookup.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_doNode</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Recurse for anything interesting within the node.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_doChildren</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Is the current node a child of some other type of node?</span><span class="w"></span>
<span class="w">  </span><span class="nx">_childOf</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeTypes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="nx">nodeTypes</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">type</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The code we need to use it is:</p>
<div class="code-sample lang-js" title="walker-class.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>


<span class="c1">// Walk to accumulate variable and parameter definitions.</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">VariableWalker</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Walker</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_childOf</span><span class="p">([</span><span class="s1">'ArrowFunctionExpression'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'VariableDeclarator'</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">accumulator</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Test.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const value = 2</span>

<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">walker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">VariableWalker</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">accumulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="nx">walker</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'definitions are'</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and its output is:</p>
<div class="code-sample lang-out" title="walker-class.out">
<div class="highlight"><pre><span></span><code>definitions are [ 'value', 'double', 'x', 'y', 'result' ]
</code></pre></div>
</div>
<p>We think this approach to implementing the Visitor pattern is easier to understand and extend
than one that relies on callbacks,
but that could just be a reflection of our background and experience.
As with code style,
the most important thing is consistency:
if we implement Visitor using classes in one place,
we should implement it that way everywhere.</p>
<h2 id="style-checker-alternatives">Section 14.5: How else could the AST walker work?</h2>
<p>A third approach to this problem uses
the <span class="ix-entry" ix-key="Iterator pattern;design pattern!Iterator" markdown="1"><a class="gl-ref" href="../glossary/#iterator_pattern" markdown="1">Iterator</a></span> design pattern.
Instead of taking the computation to the nodes as a visitor does,
an iterator returns the elements of a complex structure one by one for processing
(<a class="fig-ref" href="../style-checker/#style-checker-iterator">Figure 14.3</a>).
One way to think about it is that the Visitor pattern encapsulates recursion,
while the Iterator pattern turns everything into a <code>for</code> loop.</p>
<figure id="style-checker-iterator">
<img alt="The Iterator pattern" src="./style-checker/iterator.svg"/>
<figcaption markdown="1">Figure 14.3: Finding nodes in the tree using the Iterator pattern.</figcaption>
</figure>
<p>We can implement the Iterator pattern in JavaScript using
<span class="ix-entry" ix-key="generator function;Iterator pattern!generator function" markdown="1"><a class="gl-ref" href="../glossary/#generator_function" markdown="1">generator functions</a></span>.
If we declare a function using <code>function *</code> (with an asterisk) instead of <code>function</code>
then we can use the <code>yield</code> keyword to return a value and suspend processing to be resumed later.
The result of <code>yield</code> is a two-part structure with a value and a flag showing whether or not processing is done:</p>
<div class="code-sample lang-js" title="generator-example.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">threeWords</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">'first'</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">'second'</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">'third'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">threeWords</span><span class="p">()</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="generator-example.out">
<div class="highlight"><pre><span></span><code>{ value: 'first', done: false }
{ value: 'second', done: false }
{ value: 'third', done: false }
{ value: undefined, done: true }
</code></pre></div>
</div>
<p class="continue">A generator function doesn't actually generate anything;
instead,
it creates an object that we can then ask for values repeatedly.
This gives us a way to have several generators in play at the same time.</p>
<p>As another example,
this generator takes a string and produces its vowels one by one:</p>
<div class="code-sample lang-js" title="generator-vowels-while.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getVowels</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">'AEIOUaeiou'</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="kr">char</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">yield</span><span class="w"> </span><span class="kr">char</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'this is a test'</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getVowels</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">current</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="generator-vowels-while.out">
<div class="highlight"><pre><span></span><code>i
i
a
e
</code></pre></div>
</div>
<p>Instead of a <code>while</code> loop it is much more common to use <code>for...of</code>,
which knows how to work with generators:</p>
<div class="code-sample lang-js" title="generator-vowels-for.js">
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">vowel</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getVowels</span><span class="p">(</span><span class="nx">test</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">vowel</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
just as <code>function *</code> says "this function is a generator",
<code>yield *</code> says "yield the values from a nested generator one by one".
We can use it to walk irregular structures like nested arrays:</p>
<div class="code-sample lang-js" title="generator-tree.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="w"> </span><span class="p">(</span><span class="nx">here</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">here</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'string'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">yield</span><span class="w"> </span><span class="nx">here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">here</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">here</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`unknown type "</span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">here</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">nested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'first'</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">'second'</span><span class="p">,</span><span class="w"> </span><span class="s1">'third'</span><span class="p">]]</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">nested</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's use generators to count the number of expressions of various types in a program.
The generator function that visits each node is:</p>
<div class="code-sample lang-js" title="generator-count.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="s1">'type'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">yield</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and the program that uses it is:</p>
<div class="code-sample lang-js" title="generator-count.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">ast</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'BinaryExpression'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'counts are'</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>When we run it with our usual test program as input, we get:</p>
<div class="code-sample lang-out" title="generator-count.out">
<div class="highlight"><pre><span></span><code>counts are { '*': 2, '+': 1 }
</code></pre></div>
</div>
<p>Generators are a clean solution to many hard problems,
but we find it more difficult to check variable identifiers using generators
than using the class-based Visitor approach
because we want to accumulate violations to report later.
Again,
this could be a reflection of what we're used to rather than anything intrinsic;
as with coding style,
the most important thing is to be consistent.</p>
<h2 id="style-checker-analysis">Section 14.6: What other kinds of analysis can we do?</h2>
<p>As one final example,
consider the problem of keeping track of which methods are defined where
in a deeply-nested class hierarchy.
(This problem comes up in some of the later chapters in this book:
we wrote so many classes that incrementally extended their predecessors for pedagogical purposes
that we lost track of what was defined where.)
To create a table of method definitions,
we first need to find the ancestors of the last class in the hierarchy:</p>
<div class="code-sample lang-js" title="find-ancestors.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">walk</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn-walk'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">find</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">traceAncestry</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">traceAncestry</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fullPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findClassDef</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">accum</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="nx">classDef</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ancestorName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAncestor</span><span class="p">(</span><span class="nx">classDef</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ancestorName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">accum</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ancestorFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findImport</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorName</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">traceAncestry</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorFile</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorName</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finding class definitions is a straightforward extension of what we have already done:</p>
<div class="code-sample lang-js" title="find-ancestors.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">findClassDef</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">ClassDeclaration</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Identifier'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">className</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`No definition for </span><span class="si">${</span><span class="nx">className</span><span class="si">}</span><span class="sb"> in </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To test this code, we start with the last of these three short files:</p>
<div class="code-sample lang-js" title="upper.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'upper'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">modify</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Upper</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="middle.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./upper.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'middle'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">modify</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`** </span><span class="si">${</span><span class="k">super</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="si">}</span><span class="sb"> **`</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Middle</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="lower.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./middle.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Lower</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">additional</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">additional</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">'lower'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Lower</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="run-find-ancestors.out">
<div class="highlight"><pre><span></span><code>Lower in lower.js
Middle in ./middle.js
Upper in ./upper.js
</code></pre></div>
</div>
<p>Good: we can recover the <span class="ix-entry" ix-key="chain of inheritance" markdown="1">chain of inheritance</span>.
Finding method definitions is also straightforward:</p>
<div class="code-sample lang-js" title="find-methods.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./find-ancestors.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">FindMethods</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">find</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">super</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">classes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">record</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">record</span><span class="p">.</span><span class="nx">methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findMethods</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">classDef</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">classes</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findMethods</span><span class="w"> </span><span class="p">(</span><span class="nx">classDef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">classDef</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'MethodDefinition'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'constructor'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="s1">'constructor'</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'method'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">FindMethods</span><span class="w"></span>
</code></pre></div>
</div>
<p>And finally,
we can print a <span class="ix-entry" ix-key="Markdown" markdown="1"><a class="gl-ref" href="../glossary/#markdown" markdown="1">Markdown</a></span>-formatted table
showing which methods are defined in which class:</p>
<div class="code-sample lang-out" title="run-find-methods.raw.out">
<div class="highlight"><pre><span></span><code>| method | Upper | Middle | Lower |
| ---- | ---- | ---- | ---- |
| additional | . | . | X |
| constructor | X | X | . |
| modify | X | X | . |
| report | X | . | X |
</code></pre></div>
</div>
<p class="continue">which renders as:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>Upper</th>
<th>Middle</th>
<th>Lower</th>
</tr>
</thead>
<tbody>
<tr>
<td>additional</td>
<td>.</td>
<td>.</td>
<td>X</td>
</tr>
<tr>
<td>constructor</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>modify</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>report</td>
<td>X</td>
<td>.</td>
<td>X</td>
</tr>
</tbody>
</table>
<p>This may seem rather pointless for our toy example,
but it proves its worth when we are looking at something like
the virtual machine we will build in <a class="x-ref" href="#virtual-machine">Chapter 19</a>,
which has a more complex method definition table:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>DebuggerBase</th>
<th>DebuggerInteractive</th>
<th>DebuggerTest</th>
<th>DebuggerExit</th>
</tr>
</thead>
<tbody>
<tr>
<td>clear</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>constructor</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>exit</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>X</td>
</tr>
<tr>
<td>getCommand</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>handle</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>help</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>input</td>
<td>.</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>interact</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>list</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>message</td>
<td>X</td>
<td>.</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>next</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>print</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>run</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>setTester</td>
<td>.</td>
<td>.</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>setVM</td>
<td>X</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>stop</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>variables</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
</tbody>
</table>
<div class="break-before"></div>
<h2 id="style-checker-exercises">Section 14.7: Exercises</h2>
<h3 class="exercise">Function length</h3>
<p>Derive a class from <code>Walker</code> that reports the length in lines of each function defined in the code being checked.</p>
<h3 class="exercise">Expression depth</h3>
<p>Derive a class from <code>Walker</code> that reports how deep each top-level expression in the source code is.
For example,
the depth of <code>1 + 2 * 3</code> is 2,
while the depth of <code>max(1 + 2 + 3)</code> is 3
(one level for the function call, one for the first addition, and one for the nested addition).</p>
<h3 class="exercise">Downward and upward</h3>
<p>Modify <code>Walker</code> so that users can specify
one action to take at a node on the way down the tree
and a separate action to take on the way up.
(Hint: require users to specify <code>Nodename_downward</code> and/or <code>Nodename_upward</code> methods in their class,
then use string concatenation to construct method names while traversing the tree.)</p>
<h3 class="exercise">Aggregating across files</h3>
<p>Create a command-line program called <code>sniff.js</code>
that checks for style violations in any number of source files.
The first command-line argument to <code>sniff.js</code> must be a JavaScript source file
that exports a class derived from <code>Walker</code> called <code>Check</code>
that implements the checks the user wants.
The other command-line arguments must be the names of JavaScript source files to be checked:</p>
<div class="code-sample lang-sh" title="sniff.sh">
<div class="highlight"><pre><span></span><code>node sniff.js my-check.js source-1.js source-2.js
</code></pre></div>
</div>
<h3 class="exercise">Finding assertions</h3>
<p>Write a program <code>find-assertions.js</code> that finds all calls to <code>assert</code> or <code>assert.something</code>
and prints the assertion message (if any).</p>
<h3 class="exercise">Finding a missing parameter</h3>
<ol>
<li>
<p>Why doesn't the parameter <code>x</code> show up as a rule violation
    in the example where we check name lengths?</p>
</li>
<li>
<p>Modify the example so that it does.</p>
</li>
</ol>
<h3 class="exercise">Finding nested indexes</h3>
<p>Write a tool that finds places where nested indexing is used,
i.e.,
where the program contains expression like <code>arr[table[i]]</code>.</p>
<h3 class="exercise">Dynamic lookup</h3>
<ol>
<li>
<p>Write a function <code>dynamicExecution</code> that takes an object,
    the name of a method,
    and zero or more parameters as arguments
    and calls that method on that object:</p>
<div class="highlight"><pre><span></span><code><span class="nx">dynamicExecution</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s1">'meth'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">)</span><span class="w"></span>
<span class="c1">// same as obj.meth(1, 'a')</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>What <em>doesn't</em> this work for?</p>
</li>
</ol>
<h3 class="exercise">Generators and arrays</h3>
<ol>
<li>
<p>Write a generator that takes a two-dimensional table represented as an array of arrays
    and returns the values in <a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major</a> order.</p>
</li>
<li>
<p>Write another generator that takes a similar table
    and returns the values in <a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major</a> order.</p>
</li>
</ol>
<h3 class="exercise">Generators and identifiers</h3>
<p>Rewrite the tool to check identifier lengths using a generator.</p>
</section>
<section class="new-chapter"><h1 id="code-generator">Chapter: Chapter 15: Code Generator</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#byte_code" markdown="1">byte code</a>, <a class="gl-ref" href="../glossary/#code_coverage" markdown="1">code coverage (in testing)</a>, <a class="gl-ref" href="../glossary/#compiler" markdown="1">compiler</a>, <a class="gl-ref" href="../glossary/#decorator_pattern" markdown="1">Decorator pattern</a>, <a class="gl-ref" href="../glossary/#macro" markdown="1">macro</a>, <a class="gl-ref" href="../glossary/#nested_function" markdown="1">nested function</a>, <a class="gl-ref" href="../glossary/#two_hard_problems" markdown="1">two hard problems in computer science</a>
</p>
<p>We've been writing tests since <a class="x-ref" href="#unit-test">Chapter 4</a>,
but how much of our code do they actually check?
One way to find out is to use a <span class="ix-entry" ix-key="code coverage" markdown="1"><a class="gl-ref" href="../glossary/#code_coverage" markdown="1">code coverage</a></span> tool
like <span class="ix-entry" ix-key="Istanbul" markdown="1"><a href="https://istanbul.js.org/">Istanbul</a></span>
that watches a program while it executes
and keeps track of which lines have run and which haven't.
Making sure that each line is tested at least once doesn't guarantee that the code is bug-free,
but any code that <em>isn't</em> run shouldn't be trusted.</p>
<p>Our code coverage tool will keep track of which functions have and haven't been called.
Rather than rewriting <a href="https://nodejs.org/en/">Node</a> to keep track of this for us,
we will modify the functions themselves
by parsing the code with <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span>,
inserting the instructions we need into the <span class="ix-entry" ix-key="abstract syntax tree" markdown="1">AST</span>,
and then turning the AST back into code.</p>
<blockquote>
<h3>Simple usually isn't</h3>
<p>At first glance it would be a lot simpler
to use regular expressions to find every line that looks like the start of a function definition
and insert a line right after each one
to record the information we want.
Of course,
some people split function headers across several lines if they have lots of parameters,
and there might be things that look like function definitions embedded in comments or strings.
It doesn't take long before our simple solution turns into
a poorly-implemented parser for a subset of JavaScript that no-one else understands.
Using a full-blown parser and working with the AST is almost always less work.</p>
</blockquote>
<h2 id="code-generator-replace">Section 15.1: How can we replace a function with another function?</h2>
<p>The first thing we need is a way to wrap up an arbitrary function call.
If we declare a function in JavaScript with a parameter like <code>...args</code>,
all of the "extra" arguments in the call that don't line up with regular parameters
are stuffed into the variable <code>args</code>
(<a class="fig-ref" href="../code-generator/#code-generator-spread">Figure 15.1</a>).
We can also call a function by putting values in a variable
and using <code>func(...var)</code> to <span class="ix-entry" ix-key="spread!function arguments" markdown="1">spread</span> those values out.
There's nothing special about the names <code>args</code> and <code>vars</code>:
what matters is the ellipsis <code>...</code></p>
<figure id="code-generator-spread">
<img alt="Spreading parameters" src="./code-generator/spread.svg"/>
<figcaption markdown="1">Figure 15.1: Using ...args to capture and spread parameters.</figcaption>
</figure>
<p>We can use <code>...args</code> to capture all of the arguments to a function call
and forward them to another function.
Let's start by creating functions with a varying number of parameters
that run to completion or throw an exception,
then run them to make sure they do what we want:</p>
<div class="code-sample lang-js" title="replace-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'zero'</span><span class="p">)</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="nx">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">first</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`one(</span><span class="si">${</span><span class="nx">first</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="nx">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">first</span><span class="p">,</span><span class="w"> </span><span class="nx">second</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`two(</span><span class="si">${</span><span class="nx">first</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">second</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'from error'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'should not reach this'</span><span class="p">)</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">runAll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">title</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">zero</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="nx">one</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">two</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">error</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`caught </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb"> as expected`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">runAll</span><span class="p">(</span><span class="s1">'first time'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now write a function that takes a function as an input
and creates a new function that handles all of the errors in the original function:</p>
<div class="code-sample lang-js" title="replace-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">func</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'before'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">func</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'after'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">replace</span><span class="p">(</span><span class="nx">zero</span><span class="p">)</span><span class="w"></span>
<span class="nx">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">replace</span><span class="p">(</span><span class="nx">one</span><span class="p">)</span><span class="w"></span>
<span class="nx">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">replace</span><span class="p">(</span><span class="nx">two</span><span class="p">)</span><span class="w"></span>
<span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">replace</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"></span>

<span class="nx">runAll</span><span class="p">(</span><span class="s1">'second time'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's try it out:</p>
<div class="code-sample lang-out" title="replace-func.out">
<div class="highlight"><pre><span></span><code>first time
zero
one(1)
two(1, 2)
error
caught Error: from error as expected

second time
before
zero
after
before
one(1)
after
before
two(1, 2)
after
before
error
error
caught Error: from error as expected
</code></pre></div>
</div>
<p>This is an example of the <span class="ix-entry" ix-key="Decorator pattern;design pattern!Decorator" markdown="1"><a class="gl-ref" href="../glossary/#decorator_pattern" markdown="1">Decorator</a></span> design pattern.
A decorator is a function whose job is to modify the behavior of other functions
in some general ways.
Decorators are built in to some languages (like <span class="ix-entry" ix-key="Python" markdown="1"><a href="https://www.python.org/">Python</a></span>),
and we can add them in most others as we have done here.</p>
<h2 id="code-generator-generate">Section 15.2: How can we generate JavaScript?</h2>
<p>We could use a decorator to replace every function in our program
with one that keeps track of whether or not it was called,
but it would be tedious to apply the decorator to every one of our functions by hand.
What we really want is a way to do this automatically for everything,
and for that we need to parse and generate code.</p>
<blockquote>
<h3>Other ways to do it</h3>
<p>A third way to achieve what we want is
to let the system turn code into runnable instructions
and then modify those instructions.
This approach is often used in compiled languages like <span class="ix-entry" ix-key="Java" markdown="1"><a href="https://en.wikipedia.org/wiki/Java_(programming_language)">Java</a></span>,
where the <a class="gl-ref" href="../glossary/#byte_code" markdown="1">byte code</a> produced by the <a class="gl-ref" href="../glossary/#compiler" markdown="1">compiler</a> is saved in files
in order to be run.
We can't do this here because Node compiles and runs code in a single step.</p>
</blockquote>
<p>Our tool will parse the JavaScript with Acorn to create an AST,
modify the AST,
and then use a library called <span class="ix-entry" ix-key="Escodegen" markdown="1"><a href="https://github.com/estools/escodegen/">Escodegen</a></span> to turn the AST back into JavaScript.
To start,
let's look at the AST for a simple function definition,
which is 75 lines of pretty-printed JSON:</p>
<div class="code-sample lang-js" title="func-def.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const func = (param) =&gt; {</span>
<span class="sb">  return param + 1</span>
<span class="sb">}`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func-def.out">
<div class="highlight"><pre><span></span><code>{
  "type": "Program",
  "start": 0,
  "end": 46,
  "body": [
    {
      "type": "VariableDeclaration",
      "start": 0,
      "end": 46,
      "declarations": [
        {
          "type": "VariableDeclarator",
          "start": 6,
          "end": 46,
          "id": {
            "type": "Identifier",
            "start": 6,
            "end": 10,
            "name": "func"
          },
          "init": {
            "type": "ArrowFunctionExpression",
            "start": 13,
            "end": 46,
            "id": null,
            "expression": false,
            "generator": false,
            "async": false,
            "params": [
              {
                "type": "Identifier",
                "start": 14,
                "end": 19,
                "name": "param"
              }
            ],
            "body": {
              "type": "BlockStatement",
              "start": 24,
              "end": 46,
              "body": [
                {
                  "type": "ReturnStatement",
                  "start": 28,
                  "end": 44,
                  "argument": {
                    "type": "BinaryExpression",
                    "start": 35,
                    "end": 44,
                    "left": {
                      "type": "Identifier",
                      "start": 35,
                      "end": 40,
                      "name": "param"
                    },
                    "operator": "+",
                    "right": {
                      "type": "Literal",
                      "start": 43,
                      "end": 44,
                      "value": 1,
                      "raw": "1"
                    }
                  }
                }
              ]
            }
          }
        }
      ],
      "kind": "const"
    }
  ],
  "sourceType": "module"
}
</code></pre></div>
</div>
<p>After inspecting a few nodes,
we can try to create some of our own and turn them into code.
Here,
for example,
we have the JSON representation of the expression <code>40+2</code>:</p>
<div class="code-sample lang-js" title="one-plus-two.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">escodegen</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'escodegen'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">escodegen</span><span class="p">.</span><span class="nx">generate</span><span class="p">({</span><span class="w"></span>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">'BinaryExpression'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">operator</span><span class="o">:</span><span class="w"> </span><span class="s1">'+'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">'Literal'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">40</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">'Literal'</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="one-plus-two.out">
<div class="highlight"><pre><span></span><code>40 + 2
</code></pre></div>
</div>
<h2 id="code-generator-count">Section 15.3: How can we count how often functions are executed?</h2>
<p>Our tool will find all the function declaration nodes in the program
and insert a node to increment an entry in a global variable called <code>__counters</code>.
(Prefixing the name with two underscores doesn't guarantee that
we won't accidentally clobber a variable in the user's program with the same name,
but hopefully it makes that less likely.)
Our test case is:</p>
<div class="code-sample lang-js" title="multi-func-counter.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">TEXT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">const funcOuter = (param) =&gt; {</span>
<span class="sb">  return param + 1</span>
<span class="sb">}</span>
<span class="sb">const funcInner = (param) =&gt; {</span>
<span class="sb">  return param + 1</span>
<span class="sb">}</span>
<span class="sb">for (const i of [1, 3, 5]) {</span>
<span class="sb">  funcOuter(funcInner(i) + funcInner(i))</span>
<span class="sb">}</span>
<span class="sb">`</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and the main function of our program is:</p>
<div class="code-sample lang-js" title="multi-func-counter.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">TEXT</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">VariableDeclarator</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">init</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'ArrowFunctionExpression'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">allNodes</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="nx">allNodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">insertCounter</span><span class="p">(</span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">initializeCounters</span><span class="p">(</span><span class="nx">names</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">escodegen</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reportCounters</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To insert a count we call <code>insertCounter</code>
to record the function's name and modify the node:</p>
<div class="code-sample lang-js" title="multi-func-counter.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">insertCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">  </span><span class="nx">names</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">increment</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="sb">`__counters['</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">'] += 1`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">increment</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Notice how we don't try to build the nodes by hand,
but instead construct the string we need,
use <span class="ix-entry" ix-key="Acorn" markdown="1">Acorn</span> to parse that,
and use the result.
Doing this saves us from embedding multiple lines of JSON in our program
and also ensures that if a newer version of Acorn decides to generate a different AST,
our program will do the right thing automatically.</p>
<p>Finally,
we need to add a couple of <span class="ix-entry" ix-key="helper function" markdown="1">helper functions</span>:</p>
<div class="code-sample lang-js" title="multi-func-counter.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">initializeCounters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">names</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`'</span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">': 0`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">',\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'const __counters = {\n'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'\n}'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">reportCounters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">'console.log(__counters)'</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and run it to make sure it all works:</p>
<div class="code-sample lang-out" title="multi-func-counter.out">
<div class="highlight"><pre><span></span><code>const __counters = {
'funcOuter': 0,
'funcInner': 0
}
const funcOuter = param =&gt; {
        __counters['funcOuter'] += 1;
    return param + 1;
};
const funcInner = param =&gt; {
        __counters['funcInner'] += 1;
    return param + 1;
};
for (const i of [
        1,
        3,
        5
    ]) {
    funcOuter(funcInner(i) + funcInner(i));
}
console.log(__counters)
</code></pre></div>
</div>
<blockquote>
<h3>Too simple to be safe</h3>
<p>Our simple approach to naming counters doesn't work if functions can have the same names,
which they can if we use modules or <span class="ix-entry" ix-key="nested function;function!nested" markdown="1"><a class="gl-ref" href="../glossary/#nested_function" markdown="1">nested functions</a></span>.
One way to solve this would be to manufacture a label from the function's name
and the line number in the source code;
another would be to keep track of which functions are nested within which
and concatenate their names to produce a unique key.
Problems like this are why people say that naming things
is one of the <span class="ix-entry" ix-key="two hard problems in computer science" markdown="1"><a class="gl-ref" href="../glossary/#two_hard_problems" markdown="1">two hard problems</a></span> in computer science.</p>
</blockquote>
<h2 id="code-generator-time">Section 15.4: How can we time function execution?</h2>
<p>Now that we have a way to insert code into functions
we can use it to do many other things.
For example,
we can find out how long it takes functions to run
by wrapping them up in code that records the start and end time of each call.
As before,
we find the nodes of interest and decorate them,
then stitch the result together with a bit of bookkeeping:</p>
<div class="code-sample lang-js" title="time-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">timeFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gatherNodes</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">allNodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">wrapFuncDef</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nx">initializeCounters</span><span class="p">(</span><span class="nx">allNodes</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">escodegen</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">reportCounters</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Gathering nodes is straightforward:</p>
<div class="code-sample lang-js" title="time-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">gatherNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">VariableDeclarator</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">init</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'ArrowFunctionExpression'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">allNodes</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">as is wrapping the function definition:</p>
<div class="code-sample lang-js" title="time-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">wrapFuncDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">originalAst</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalAst</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">wrapperAst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeWrapperAst</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">wrapperAst</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">declarations</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">originalAst</span><span class="p">.</span><span class="nx">init</span><span class="w"></span>
<span class="w">  </span><span class="nx">originalAst</span><span class="p">.</span><span class="nx">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wrapperAst</span><span class="p">.</span><span class="nx">init</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The only big difference is how we make the wrapper function.
We create it with a placeholder for the original function
so that we have a spot in the AST to insert the actual code:</p>
<div class="code-sample lang-js" title="time-func.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">timeFunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gatherNodes</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">allNodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">wrapFuncDef</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nx">initializeCounters</span><span class="p">(</span><span class="nx">allNodes</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">escodegen</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nx">reportCounters</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's run one last test:</p>
<div class="code-sample lang-out" title="test-time-func.out">
<div class="highlight"><pre><span></span><code>const __counters = {
'assignment': 0,
'readFile': 0
}
const assignment = (...originalArgs) =&gt; {
    const originalFunc = range =&gt; {
        let j = 0;
        for (let i = 0; i &lt; range; i += 1) {
            j = i;
        }
    };
    const startTime = Date.now();
    try {
        const result = originalFunc(...originalArgs);
        const endTime = Date.now();
        __counters['assignment'] += endTime - startTime;
        return result;
    } catch (error) {
        const endTime = Date.now();
        __counters['assignment'] += endTime - startTime;
        throw error;
    }
};
const readFile = (...originalArgs) =&gt; {
    const originalFunc = (range, filename) =&gt; {
        for (let i = 0; i &lt; range; i += 1) {
            fs.readFileSync(filename, 'utf-8');
        }
    };
    const startTime = Date.now();
    try {
        const result = originalFunc(...originalArgs);
        const endTime = Date.now();
        __counters['readFile'] += endTime - startTime;
        return result;
    } catch (error) {
        const endTime = Date.now();
        __counters['readFile'] += endTime - startTime;
        throw error;
    }
};
const numLoops = 100000;
assignment(numLoops);
readFile(numLoops, 'index.md');
console.log(__counters)
OUTPUT
{ assignment: 1, readFile: 3879 }
</code></pre></div>
</div>
<p>Source-to-source translation is widely used in JavaScript:
tools like <span class="ix-entry" ix-key="Babel" markdown="1"><a href="https://babeljs.io/">Babel</a></span> use it to transform modern features like <code>async</code> and <code>await</code>
(<a class="x-ref" href="#async-programming">Chapter 3</a>)
into code that older browsers can understand.
The technique is so powerful that it is built into languages like Scheme,
which allow programmers to add new syntax to the language
by defining <span class="ix-entry" ix-key="macro" markdown="1"><a class="gl-ref" href="../glossary/#macro" markdown="1">macros</a></span>.
Depending on how carefully they are used,
macros can make programs elegant, incomprehensible, or both.</p>
<div class="break-before"></div>
<h2 id="code-generator-exercises">Section 15.5: Exercises</h2>
<h3 class="exercise">JSON to JavaScript</h3>
<p>Write a tool that uses <a href="https://github.com/estools/escodegen/">Escodegen</a>
to translate simple expressions written in JSON into runnable JavaScript.
For example, the tool should translate:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s1">'+'</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">'*'</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">]]</span><span class="w"></span>
</code></pre></div>
<p class="continue">into:</p>
<div class="highlight"><pre><span></span><code><span class="mf">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3 class="exercise">JavaScript to HTML</h3>
<p>Write a function that takes nested JavaScript function calls for generating HTML like this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">div</span><span class="p">(</span><span class="nx">h1</span><span class="p">(</span><span class="s1">'title'</span><span class="p">),</span><span class="w"> </span><span class="nx">p</span><span class="p">(</span><span class="s1">'explanation'</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p class="continue">and turns them into HTML like this:</p>
<div class="highlight"><pre><span></span><code>&lt;div&gt;&lt;h1&gt;title&lt;/h1&gt;&lt;p&gt;explanation&lt;/p&gt;&lt;/div&gt;
</code></pre></div>
<h3 class="exercise">Handling modules</h3>
<p>Modify the code that counts the number of times a function is called
to handle functions with the same name from different modules.</p>
<h3 class="exercise">Tracking calls</h3>
<p>Write a decorator that takes a function as its argument
and returns a new function that behaves exactly the same way
except that it keeps track of who called it.</p>
<ol>
<li>
<p>The program contains a stack where decorated functions push and pop their names
    as they are called and as they exit.</p>
</li>
<li>
<p>Each time a function is called
    it adds a record to an array to record its name and the name at the top of the stack
    (i.e., the most-recently-called decorated function).</p>
</li>
</ol>
<h3 class="exercise">Counting classical function definitions</h3>
<p>Modify the code generator to handle functions declared with the <code>function</code> keyword
as well as functions declared using <code>=&gt;</code>.</p>
<h3 class="exercise">Recording input file size</h3>
<ol>
<li>
<p>Write a program that replaces all calls to <code>fs.readFileSync</code>
    with calls to <code>readFileSyncCount</code>.</p>
</li>
<li>
<p>Write the function <code>readFileSyncCount</code> to read and return a file using <code>fs.readFileSync</code>
    but to also record the file's name and size in bytes.</p>
</li>
<li>
<p>Write a third function <code>reportInputFileSizes</code> that reports
    what files were read and how large they were.</p>
</li>
<li>
<p>Write tests for these functions using Mocha and <code>mock-fs</code>.</p>
</li>
</ol>
<h3 class="exercise">Checking argument types</h3>
<p>Write a tool that modifies functions to check the types of their arguments at run-time.</p>
<ol>
<li>
<p>Each function is replaced by a function that passes all of its arguments to <code>checkArgs</code>
    along with the function's name,
    then continues with the function's original operation.</p>
</li>
<li>
<p>The first time <code>checkArgs</code> is called for a particular function
    it records the actual types of the arguments.</p>
</li>
<li>
<p>On subsequent calls, it checks that the argument types match those of the first call
    and throws an exception if they do not.</p>
</li>
</ol>
<h3 class="exercise">Two-dimensional arrays</h3>
<p>The function <code>make2D</code> takes a row length and one or more values
and creates a two-dimensional array from those values:</p>
<div class="highlight"><pre><span></span><code><span class="nx">make2D</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'a'</span><span class="p">,</span><span class="w"> </span><span class="s1">'b'</span><span class="p">,</span><span class="w"> </span><span class="s1">'c'</span><span class="p">,</span><span class="w"> </span><span class="s1">'d'</span><span class="p">)</span><span class="w"></span>
<span class="c1">// produces [['a', 'b'], ['c', 'd']]</span><span class="w"></span>
</code></pre></div>
<p class="continue">Write a function that searches code to find calls to <code>make2D</code>
and replaces them with inline arrays-of-arrays.
This function only has to work for calls with a fixed row length,
i.e., it does <em>not</em> have to handle <code>make2D(N, 'a', 'b')</code>.</p>
<h3 class="exercise">From require to import</h3>
<p>Write a function that searches code for simple calls to <code>require</code>
and replaces them with calls to <code>import</code>.
This function only needs to work for the simplest case;
for example, if the input is:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'module'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p class="continue">then the output is:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'module'</span><span class="w"></span>
</code></pre></div>
<h3 class="exercise">Removing empty constructors</h3>
<p>Write a function that removes empty constructors from class definitions.
For example, if the input is:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">someMethod</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'some method'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">then the output should be:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">someMethod</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'some method'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</section>
<section class="new-chapter"><h1 id="doc-generator">Chapter: Chapter 16: Documentation Generator</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#accumulator" markdown="1">accumulator</a>, <a class="gl-ref" href="../glossary/#block_comment" markdown="1">block comment</a>, <a class="gl-ref" href="../glossary/#deprecation" markdown="1">deprecation</a>, <a class="gl-ref" href="../glossary/#doc_comment" markdown="1">doc comment</a>, <a class="gl-ref" href="../glossary/#line_comment" markdown="1">line comment</a>, <a class="gl-ref" href="../glossary/#slug" markdown="1">slug</a>
</p>
<p>Many programmers believe they're more likely to write documentation and keep it up to date
if it is close to the code.
Tools that extract specially-formatted comments from code and turn them into documentation
have been around since at least the 1980s;
many are used for JavaScript,
including <span class="ix-entry" ix-key="JSDoc" markdown="1"><a href="https://jsdoc.app/">JSDoc</a></span> and <span class="ix-entry" ix-key="ESDoc" markdown="1"><a href="https://esdoc.org/">ESDoc</a></span>.
This chapter will use what we learned in <a class="x-ref" href="#code-generator">Chapter 15</a> about parsing source code
to build a simple documentation generator of our own.</p>
<h2 id="doc-generator-extract">Section 16.1: How can we extract documentation comments?</h2>
<p>We will use <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span> once again to parse our source files.
This time we will use the parser's <code>onComment</code> option,
giving it an array to fill in.
For the moment we won't bother to assign the <span class="ix-entry" ix-key="abstract syntax tree" markdown="1">AST</span> produced by parsing to a variable
because we are just interested in the comments:</p>
<div class="code-sample lang-js" title="extract-comments.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="two-kinds-of-comment.js">
<div class="highlight"><pre><span></span><code><span class="c1">// double-slash comment</span><span class="w"></span>
<span class="cm">/* slash-star comment */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="two-kinds-of-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    "type": "Line",
    "value": " double-slash comment",
    "start": 0,
    "end": 23,
    "loc": {
      "start": {
        "line": 1,
        "column": 0
      },
      "end": {
        "line": 1,
        "column": 23
      }
    }
  },
  {
    "type": "Block",
    "value": " slash-star comment ",
    "start": 24,
    "end": 48,
    "loc": {
      "start": {
        "line": 2,
        "column": 0
      },
      "end": {
        "line": 2,
        "column": 24
      }
    }
  }
]
</code></pre></div>
</div>
<p>There is more information here than we need,
so let's slim down the JSON that we extract:</p>
<div class="code-sample lang-js" title="extract-comments-subset.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">subset</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="two-kinds-of-comment-subset.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js two-kinds-of-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="two-kinds-of-comment-subset.out">
<div class="highlight"><pre><span></span><code>[
  {
    "type": "Line",
    "value": " double-slash comment",
    "start": 1,
    "end": 1
  },
  {
    "type": "Block",
    "value": " slash-star comment ",
    "start": 2,
    "end": 2
  }
]
</code></pre></div>
</div>
<figure id="doc-generator-comments">
<img alt="Line and block comments" src="./doc-generator/comments.svg"/>
<figcaption markdown="1">Figure 16.1: How line comments and block comments are distinguished and represented.</figcaption>
</figure>
<p>Acorn distinguishes two kinds of comments (<a class="fig-ref" href="../doc-generator/#doc-generator-comments">Figure 16.1</a>).
<span class="ix-entry" ix-key="line comment;comment!line" markdown="1"><a class="gl-ref" href="../glossary/#line_comment" markdown="1">Line comments</a></span> cannot span multiple lines;
if one line comment occurs immediately after another,
Acorn reports two comments:</p>
<div class="code-sample lang-js" title="multi-line-double-slash-comment.js">
<div class="highlight"><pre><span></span><code><span class="c1">//</span><span class="w"></span>
<span class="c1">// multi-line double-slash comment</span><span class="w"></span>
<span class="c1">//</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="multi-line-double-slash-comment.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js multi-line-double-slash-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="multi-line-double-slash-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    "type": "Line",
    "value": "",
    "start": 1,
    "end": 1
  },
  {
    "type": "Line",
    "value": " multi-line double-slash comment",
    "start": 2,
    "end": 2
  },
  {
    "type": "Line",
    "value": "",
    "start": 3,
    "end": 3
  }
]
</code></pre></div>
</div>
<p><span class="ix-entry" ix-key="block comment;comment!block" markdown="1"><a class="gl-ref" href="../glossary/#block_comment" markdown="1">Block comments</a></span>,
on the other hand,
can span any number of lines.
We don't need to prefix each line with <code>*</code> but most people do for readability:</p>
<div class="code-sample lang-js" title="multi-line-slash-star-comment.js">
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * multi-line slash-star comment</span>
<span class="cm"> */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="multi-line-slash-star-comment.sh">
<div class="highlight"><pre><span></span><code>node extract-comments-subset.js multi-line-slash-star-comment.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="multi-line-slash-star-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    "type": "Block",
    "value": "\n * multi-line slash-star comment\n ",
    "start": 1,
    "end": 3
  }
]
</code></pre></div>
</div>
<p>By convention,
we use block comments that start with <code>/**</code> for documentation.
The first two characters are recognized by the parser as "start of comment",
so the first character in the extracted text is <code>*</code>:</p>
<div class="code-sample lang-js" title="doc-comment.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * doc comment</span>
<span class="cm"> */</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="doc-comment.out">
<div class="highlight"><pre><span></span><code>[
  {
    "type": "Block",
    "value": "*\n * doc comment\n ",
    "start": 1,
    "end": 3
  }
]
</code></pre></div>
</div>
<h2 id="doc-generator-input">Section 16.2: What input will we try to handle?</h2>
<p>We will use <span class="ix-entry" ix-key="Markdown" markdown="1"><a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a></span> for formatting our documentation.
The <span class="ix-entry" ix-key="doc comment;comment!doc" markdown="1"><a class="gl-ref" href="../glossary/#doc_comment" markdown="1">doc comments</a></span> for function definitions look like this:</p>
<div class="code-sample lang-js" title="example-plain.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * # Demonstrate documentation generator.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">util</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./util-plain'</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `main`: Main driver.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Parse arguments.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Process input stream.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `parseArgs`: Parse command line.</span>
<span class="cm"> * - `args` (`string[]`): arguments to parse.</span>
<span class="cm"> * - `defaults` (`Object`): default values.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: program configuration object.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">parseArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">defaults</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `process`: Transform data.</span>
<span class="cm"> * - `input` (`stream`): where to read.</span>
<span class="cm"> * - `output` (`stream`): where to write.</span>
<span class="cm"> * - `op` (`class`): what to do.</span>
<span class="cm"> *    Use @BaseProcessor unless told otherwise.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">output</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">BaseProcessor</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while the ones for class definitions look like this:</p>
<div class="code-sample lang-js" title="util-plain.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * # Utilities to demonstrate doc generator.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * ## `BaseProcessor`: General outline.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">BaseProcessor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * ### `constructor`: Build processor.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">    </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * ### `run`: Pass input to output.</span>
<span class="cm">   * - `input` (`stream`): where to read.</span>
<span class="cm">   * - `output` (`stream`): where to write.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">BaseProcessor</span><span class="w"></span>
</code></pre></div>
</div>
<p>The doc comments are unpleasant at the moment:
they repeat the function and method names from the code,
we have to create titles ourselves,
and we have to remember the back-quotes for formatting code.
We will fix some of these problems once we have a basic tool up and running.</p>
<p>The next step in doing that is to translate Markdown into HTML.
There are many <span class="ix-entry" ix-key="Markdown!parser" markdown="1">Markdown parsers</span> in JavaScript;
after experimenting with a few,
we decided to use <a href="https://markdown-it.github.io/"><code>markdown-it</code></a>
along with the <a href="https://www.npmjs.com/package/markdown-it-anchor"><code>markdown-it-anchor</code></a> extension
that creates HTML anchors for headings.
The main program gets all the doc comments from all of the input files,
converts the Markdown to HTML,
and displays that:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;html&gt;&lt;body style="font-size: 100%; margin-left: 0.5em"&gt;'</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">FOOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;/body&gt;&lt;/html&gt;'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAllComments</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="p">({</span><span class="w"> </span><span class="nx">html</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">MarkdownAnchor</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">slugify</span><span class="o">:</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">allComments</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">HEAD</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">FOOT</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To get all the comments
we extract comments from all the files,
remove the leading <code>*</code> characters (which aren't part of the documentation),
and then join the results after stripping off extraneous blanks:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">getAllComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">allFilenames</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">allFilenames</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extractComments</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comments</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">removePrefix</span><span class="p">(</span><span class="nx">comment</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comments</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">stripped</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`# </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">\n\n</span><span class="si">${</span><span class="nx">combined</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n\n'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Extracting the comments from a single file is done as before:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">extractComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">subset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Block'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">end</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">subset</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and removing the prefix <code>*</code> characters is a matter of splitting the text into lines,
removing the leading spaces and asterisks,
and putting the lines back together:</p>
<div class="code-sample lang-js" title="process-plain.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">removePrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">comment</span><span class="p">.</span><span class="nx">stripped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">value</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^ *\/?\* */</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'*/'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">comment</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>One thing that isn't in this file (because we're going to use it in later versions)
is the function <code>slugify</code>.
A <span class="ix-entry" ix-key="slug (unique identifier)" markdown="1"><a class="gl-ref" href="../glossary/#slug" markdown="1">slug</a></span> is a short string that identifies a header or a web page;
the name comes from the era of newspapers,
where a slug was a short name used to identify an article while it was in production.
Our <code>slugify</code> function strips unnecessary characters out of a title,
adds hyphens,
and generally makes it something you might see in a URL:</p>
<div class="code-sample lang-js" title="slugify.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/.js$/</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^ \w]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">'-'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">slugify</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's run this generator and see what it produces
(<a class="fig-ref" href="../doc-generator/#doc-generator-process-plain">Figure 16.2</a> and <a class="fig-ref" href="../doc-generator/#doc-generator-mapping">Figure 16.3</a>):</p>
<div class="code-sample lang-sh" title="process-plain.sh">
<div class="highlight"><pre><span></span><code>node process-plain.js example-plain.js util-plain.js
</code></pre></div>
</div>
<div class="code-sample lang-html" title="process-plain.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 100%; margin-left: 0.5em"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">"exampleplain"</span><span class="p">&gt;</span>example-plain.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">"demonstrate"</span><span class="p">&gt;</span>Demonstrate documentation generator.<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"main"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>main<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Main driver.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"parseargs"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>parseArgs<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Parse command line.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>args<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>string[]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): arguments to parse.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>defaults<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Object<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): default values.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Returns: program configuration object.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"process"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>process<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Transform data.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>op<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>class<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): what to do.
Use @BaseProcessor unless told otherwise.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">"utilplain"</span><span class="p">&gt;</span>util-plain.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">"utilities"</span><span class="p">&gt;</span>Utilities to demonstrate doc generator.<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"baseprocessor"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>BaseProcessor<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: General outline.<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">"constructor"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>constructor<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Build processor.<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">"run"</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>run<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>: Pass input to output.<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="doc-generator-process-plain">
<img alt="Output of documentation generator" src="./doc-generator/process-plain.svg"/>
<figcaption markdown="1">Figure 16.2: The page produced by the documentation generator.</figcaption>
</figure>
<figure id="doc-generator-mapping">
<img alt="Mapping comments to documentation" src="./doc-generator/mapping.svg"/>
<figcaption markdown="1">Figure 16.3: How comments in code map to documentation in HTML.</figcaption>
</figure>
<p>It works,
but there is a double <code>h1</code> header for each file (the filename and and the title comment),
the anchor IDs are hard to read,
there are no cross-references,
and so on.
Some of the visual issues can be resolved with <span class="ix-entry" ix-key="CSS" markdown="1">CSS</span>,
and we can change our input format to make processing easier
as long as it also makes authoring easier.
However,
anything that is written twice will eventually be wrong in one place or another,
so our first priority is to remove duplication.</p>
<h2 id="doc-generator-dup">Section 16.3: How can we avoid duplicating names?</h2>
<p>If a comment is the first thing in a file,
we want to use it as title text;
this will save us having to write an explicit level-1 title in a comment.
For each other comment,
we can extract the name of the function or method
from the node on the line immediately following the doc comment.
This allows us to write much tidier comments:</p>
<div class="code-sample lang-js" title="find-following-input.js">
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Overall file header.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Double the input.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="kr">double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Triple the input.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">triple</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Define a class.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">Example</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Method description.</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="nx">someMethod</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To extract and display information from nodes immediately following doc comments
we must find all the block comments,
record the last line of each,
and then search the AST to find nodes that are on lines
immediately following any of those trailing comment lines.
(We will assume for now that there are no blank lines between the comment
and the start of the class or function.)
The main program finds the comments as usual,
creates a set containing the line numbers we are looking for,
then searches for the nodes we want:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">'module'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Block'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">comments</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">comment</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">comment</span><span class="p">.</span><span class="nx">end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">nodes</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">condense</span><span class="p">(</span><span class="nx">node</span><span class="p">)))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The recursive search is straightforward as well---we delete line numbers from the target set
and add nodes to the <span class="ix-entry" ix-key="Accumulator pattern;design pattern!Accumulator" markdown="1"><a class="gl-ref" href="../glossary/#accumulator" markdown="1">accumulator</a></span> as we find matches:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">findFollowing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">'type'</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">targets</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">accum</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">targets</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'object'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">findFollowing</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="w"> </span><span class="nx">targets</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
we use a function called <code>condense</code> to get the name we want out of the AST we have:</p>
<div class="code-sample lang-js" title="find-following.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">condense</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">'VariableDeclaration'</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">declarations</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">'FunctionDeclaration'</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">'ClassDeclaration'</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">'MethodDefinition'</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="sb">`Unknown node type </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We need this because we get a different structure with:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">than we get with:
{: .break-before}</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>When we run this on our test case we get:</p>
<div class="code-sample lang-out" title="find-following.out">
<div class="highlight"><pre><span></span><code>[
  { type: 'VariableDeclaration', start: 8, name: 'double' },
  { type: 'FunctionDeclaration', start: 13, name: 'triple' },
  { type: 'ClassDeclaration', start: 20, name: 'Example' },
  { type: 'MethodDefinition', start: 24, name: 'someMethod' }
]
</code></pre></div>
</div>
<p>We can use this to create better output (<a class="fig-ref" href="../doc-generator/#doc-generator-fill-in-headers">Figure 16.4</a>):</p>
<div class="code-sample lang-js" title="fill-in-headers.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'markdown-it'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">MarkdownAnchor</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'markdown-it-anchor'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">getComments</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./get-comments.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">getDefinitions</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./get-definitions.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fillIn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./fill-in.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./slugify.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;html&gt;&lt;body style="font-size: 100%; margin-left: 0.5em"&gt;'</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">FOOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;/body&gt;&lt;/html&gt;'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filenames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allComments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getComments</span><span class="p">(</span><span class="nx">filenames</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allDefinitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getDefinitions</span><span class="p">(</span><span class="nx">filenames</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">allComments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">definitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allDefinitions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fillIn</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">comments</span><span class="p">,</span><span class="w"> </span><span class="nx">definitions</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">combined</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">MarkdownIt</span><span class="p">({</span><span class="w"> </span><span class="nx">html</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">MarkdownAnchor</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">slugify</span><span class="o">:</span><span class="w"> </span><span class="nx">slugify</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">combined</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n\n'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">HEAD</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">FOOT</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-html" title="fill-in-headers.html">
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">body</span> <span class="na">style</span><span class="o">=</span><span class="s">"font-size: 100%; margin-left: 0.5em"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span> <span class="na">id</span><span class="o">=</span><span class="s">"fillinheadersinput"</span><span class="p">&gt;</span>fill-in-headers-input.js<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Demonstrate documentation generator.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"main"</span><span class="p">&gt;</span>main<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Main driver.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"parseargs"</span><span class="p">&gt;</span>parseArgs<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Parse command-line arguments.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>args<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>string[]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): arguments to parse.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>defaults<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Object<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): default values.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Program configuration object.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">id</span><span class="o">=</span><span class="s">"baseprocessor"</span><span class="p">&gt;</span>BaseProcessor<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Default processing class.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">"constructor"</span><span class="p">&gt;</span>constructor<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Build base processor.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span> <span class="na">id</span><span class="o">=</span><span class="s">"run"</span><span class="p">&gt;</span>run<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Pass input to output.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>input<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to read.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>output<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> (<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>stream<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>): where to write.<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
</div>
<figure id="doc-generator-fill-in-headers">
<img alt="Filling in headers" src="./doc-generator/fill-in-headers.svg"/>
<figcaption markdown="1">Figure 16.4: Filling in headers when generating documentation.</figcaption>
</figure>
<blockquote>
<h3>Code is data</h3>
<p>We haven't made this point explicitly in a while,
so we will repeat it here:
<span class="ix-entry" ix-key="code!as data" markdown="1">code is just another kind of data</span>,
and we can process it just like we would process any other data.
Parsing code to produce an AST is no different from parsing HTML to produce DOM;
in both cases we are simply transforming a textual representation that's easy for people to author
into a data structure that's easy for a program to manipulate.
Pulling things out of that data to create a report
is no different from pulling numbers out of a hospital database to report monthly vaccination rates.</p>
<p>Treating code as data enables us to do routine programming tasks with a single command,
which in turn gives us more time to think about the tasks that we can't (yet) automate.
Doing this is the foundation of a tool-based approach to software engineering;
as the mathematician <span class="ix-entry" ix-key="Whitehead, Alfred North" markdown="1">Alfred North Whitehead</span> once wrote,
"Civilization advances by extending the number of important operations which we can perform without thinking about them."</p>
</blockquote>
<div class="break-before"></div>
<h2 id="doc-generator-exercises">Section 16.4: Exercises</h2>
<h3 class="exercise">Building an index</h3>
<p>Modify the documentation generator to produce an alphabetical index of all classes and methods found.
Index entries should be hyperlinks to the documentation for the corresponding item.</p>
<h3 class="exercise">Documenting exceptions</h3>
<p>Extend the documentation generator to allow people to document the exceptions that a function throws.</p>
<h3 class="exercise">Deprecation warning</h3>
<p>Add a feature to the documentation generator
to allow authors to mark functions and methods as <a class="gl-ref" href="../glossary/#deprecation" markdown="1">deprecation</a>
(i.e., to indicate that while they still exist,
they should not be used because they are being phased out).</p>
<h3 class="exercise">Usage examples</h3>
<p>Enhance the documentation generator so that
if a horizontal rule <code>---</code> appears in a documentation comment,
the text following is typeset as usage example.
(A doc comment may contain several usage examples.)</p>
<h3 class="exercise">Unit testing</h3>
<p>Write unit tests for the documentation generator using Mocha.</p>
<h3 class="exercise">Summarizing functions</h3>
<p>Modify the documentation generator so that line comments inside a function that use <code>//*</code>
are formatted as a bullet list in the documentation for that function.</p>
<h3 class="exercise">Cross referencing</h3>
<p>Modify the documentation generator so that
the documentation for one class or function
can include Markdown links to other classes or functions.</p>
<h3 class="exercise">Data types</h3>
<p>Modify the documentation generator to allow authors to define new data types
in the same way as <a href="https://jsdoc.app/">JSDoc</a>.</p>
<h3 class="exercise">Inline parameter documentation</h3>
<p>Some documentation generators put the documentation for a parameter
on the same line as the parameter:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Transform data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">process</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">input</span><span class="p">,</span><span class="w">  </span><span class="cm">/*- {stream} where to read */</span><span class="w"></span>
<span class="w">  </span><span class="nx">output</span><span class="p">,</span><span class="w"> </span><span class="cm">/*- {stream} where to write */</span><span class="w"></span>
<span class="w">  </span><span class="nx">op</span><span class="w">      </span><span class="cm">/*- {Operation} what to do */</span><span class="w"></span>
<span class="p">){</span><span class="w"></span>
<span class="w">  </span><span class="c1">// body would go here</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">Modify the documentation generator to handle this.</p>
<h3 class="exercise">Tests as documentation</h3>
<p>The <a href="https://docs.python.org/3/library/doctest.html">doctest</a> library for Python
allows programmers to embed unit tests as documentation in their programs.
Write a tool that:</p>
<ol>
<li>
<p>Finds functions that start with a block comment.</p>
</li>
<li>
<p>Extracts the code and output from those blocks comments
    and turns them into assertions.</p>
</li>
</ol>
<p class="continue">For example, given this input:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">findIncreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">values</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * &gt; findIncreasing([])</span>
<span class="cm">   * []</span>
<span class="cm">   * &gt; findIncreasing([1])</span>
<span class="cm">   * [1]</span>
<span class="cm">   * &gt; findIncreasing([1, 2])</span>
<span class="cm">   * [1, 2]</span>
<span class="cm">   * &gt; findIncreasing([2, 1])</span>
<span class="cm">   * [2]</span>
<span class="cm">   */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p class="continue">the tool would produce:</p>
<div class="highlight"><pre><span></span><code><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([]),</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">1</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">findIncreasing</span><span class="p">([</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
</section>
<section class="new-chapter"><h1 id="module-bundler">Chapter: Chapter 17: Module Bundler</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#entry_point" markdown="1">entry point</a>, <a class="gl-ref" href="../glossary/#module_bundler" markdown="1">module bundler</a>, <a class="gl-ref" href="../glossary/#transitive_closure" markdown="1">transitive closure</a>
</p>
<p><span class="ix-entry" ix-key="JavaScript!hurried design of" markdown="1">JavaScript</span> was designed in a hurry 25 years ago to make web pages interactive.
Nobody realized it would become one of the most popular programming languages in the world,
so it didn't include support for things that large programs need.
One of those things was a way to turn a set of easy-to-edit source files
into a single easy-to-load file
so that browsers could get what they needed with one request.</p>
<p>A <span class="ix-entry" ix-key="module bundler" markdown="1"><a class="gl-ref" href="../glossary/#module_bundler" markdown="1">module bundler</a></span>
finds all the files that an application depends on
and combines them into a single loadable file
(<a class="fig-ref" href="../module-bundler/#module-bundler-bundling">Figure 17.1</a>).
This file is much more efficient to load:
it's the same number of bytes but just one network request.
(See <a class="tbl-ref" href="../systems-programming/#systems-programming-times">Table 2.1</a> for a reminder of why this is important.)
Bundling files also tests that dependencies actually resolve
so that the application has at least a chance of being able to run.</p>
<figure id="module-bundler-bundling">
<img alt="Bundling modules" src="./module-bundler/bundling.svg"/>
<figcaption markdown="1">Figure 17.1: Combining multiple modules into one.</figcaption>
</figure>
<p>Bundling requires an <span class="ix-entry" ix-key="entry point (of module);module!entry point" markdown="1"><a class="gl-ref" href="../glossary/#entry_point" markdown="1">entry point</a></span>,
i.e.,
a place to start searching for dependencies.
Given that,
it finds all dependencies,
combines them into one file,
and ensures they can find each other correctly once loaded.
The sections below go through these steps one by one.</p>
<h2 id="module-bundler-tests">Section 17.1: What will we use as test cases?</h2>
<p>The simplest test case is a single file that doesn't require anything else:
if this doesn't work,
nothing will.
Our test case and the expected output are:</p>
<div class="code-sample lang-js" title="main.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in main'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="expected-single.out">
<div class="highlight"><pre><span></span><code>in main
</code></pre></div>
</div>
<p>In our second test case,
<code>main.js</code> requires <code>other.js</code>,
which doesn't require anything.
The main file is:</p>
<div class="code-sample lang-js" title="main.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./other'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">other</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and the required file is:</p>
<div class="code-sample lang-js" title="main.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./other'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">other</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The output we expect is:</p>
<div class="code-sample lang-out" title="expected-simple.out">
<div class="highlight"><pre><span></span><code>other called from main
</code></pre></div>
</div>
<blockquote>
<h3>Why <code>require</code>?</h3>
<p>Our tests cases use the old-style <span class="ix-entry" ix-key="require vs. import;import vs. require" markdown="1"><code>require</code></span> function
and assign things that are to be visible outside the module to <code>module.exports</code>
rather than using <code>import</code> and <code>export</code>.
We tried writing the chapter using the latter,
but kept stumbling over whether we were talking about <code>import</code> in Node's module loader
or the <code>import</code> we were building.
This kind of confusion is common when building programming tools;
we hope that splitting terminology as we have will help.</p>
</blockquote>
<p>Our third test case has multiple inclusions in multiple directories
and is shown in <a class="fig-ref" href="../module-bundler/#module-bundler-complicated">Figure 17.2</a>:</p>
<ul>
<li><code>./main</code> requires all four of the files below.</li>
<li><code>./top-left</code> doesn't require anything.</li>
<li><code>./top-right</code> requires <code>top-left</code> and <code>bottom-right</code>.</li>
<li><code>./subdir/bottom-left</code> also requires <code>top-left</code> and <code>bottom-right</code>.</li>
<li><code>./subdir/bottom-right</code> doesn't require anything.</li>
</ul>
<figure id="module-bundler-complicated">
<img alt="Module bundler dependencies" src="./module-bundler/complicated.svg"/>
<figcaption markdown="1">Figure 17.2: Dependencies in large module bundler test case.</figcaption>
</figure>
<p class="continue">The main program is:</p>
<div class="code-sample lang-js" title="main.js">
<div class="highlight"><pre><span></span><code><span class="c1">// main.js</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">topLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./top-left'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">topRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./top-right'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">bottomLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./subdir/bottom-left'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">bottomRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./subdir/bottom-right'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">functions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">topLeft</span><span class="p">,</span><span class="w"> </span><span class="nx">topRight</span><span class="p">,</span><span class="w"> </span><span class="nx">bottomLeft</span><span class="p">,</span><span class="w"> </span><span class="nx">bottomRight</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">functions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">func</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="p">(</span><span class="s1">'main'</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and the other four files use <code>require</code> and <code>module.exports</code> to get what they need.
The output we expect is:</p>
<div class="code-sample lang-out" title="expected-full.out">
<div class="highlight"><pre><span></span><code>topLeft from main
topRight from main with topLeft from topRight and bottomRight from \
 topRight
bottomLeft from main with topLeft from bottomLeft and bottomRight from \
 bottomLeft
bottomRight from main
</code></pre></div>
</div>
<p>We do not handle circular dependencies
because <code>require</code> itself doesn't (<a class="x-ref" href="#module-loader">Chapter 13</a>).</p>
<h2 id="module-bundler-find">Section 17.2: How can we find dependencies?</h2>
<p>To get all the dependencies for one source file,
we parse it and extract all of the calls to <code>require</code>.
The code to do this is relatively straightforward given what we know about <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span>:</p>
<div class="code-sample lang-js" title="get-requires.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">walk</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'acorn-walk'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">getRequires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entryPointFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">entryPointFile</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">CallExpression</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">node</span><span class="p">.</span><span class="nx">callee</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'Identifier'</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">          </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">callee</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'require'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">requires</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">requires</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">getRequires</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-get-requires.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">getRequires</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./get-requires.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getRequires</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="test-get-requires.sh">
<div class="highlight"><pre><span></span><code>node test-get-requires.js simple/main.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-get-requires.out">
<div class="highlight"><pre><span></span><code>[ './other' ]
</code></pre></div>
</div>
<blockquote>
<h3>An unsolvable problem</h3>
<p>The dependency finder shown above gives the right answer for reasonable JavaScript programs,
but not all JavaScript is reasonable.
Suppose creates an alias for <code>require</code> and uses that to load other files:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">weWillMissThis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">(</span><span class="s1">'./other-file'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>We could try to trace variable assignments to catch cases like these,
but someone could still fool us by writing this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">clever</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">eval</span><span class="p">(</span><span class="sb">`require`</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">weWillMissThisToo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clever</span><span class="p">(</span><span class="s1">'./other-file'</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p><em>There is no general solution to this problem</em>
other than running the code to see what it does.
If you would like to understand why not,
and learn about a pivotal moment in the history of computing,
we highly recommend <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Petzold2008">Petzold2008</a>]</span>.</p>
</blockquote>
<p>To get all of the dependencies a bundle needs
we need to find the <span class="ix-entry" ix-key="transitive closure" markdown="1"><a class="gl-ref" href="../glossary/#transitive_closure" markdown="1">transitive closure</a></span> of the entry point's dependencies,
i.e.,
the requirements of the requirements and so on recursively.
Our algorithm for doing this uses two sets:
<code>pending</code>,
which contains the things we haven't looked at yet,
and <code>seen</code>,
which contains the things we have
(<a class="fig-ref" href="../module-bundler/#module-bundler-transitive-closure">Figure 17.3</a>).
<code>pending</code> initially contains the entry point file and <code>seen</code> is initially empty.
We keep taking items from <code>pending</code> until it is empty.
If the current thing is already in <code>seen</code> we do nothing;
otherwise we get its dependencies and add them to either <code>seen</code> or <code>pending</code>.</p>
<figure id="module-bundler-transitive-closure">
<img alt="Implementing transitive closure" src="./module-bundler/transitive-closure.svg"/>
<figcaption markdown="1">Figure 17.3: Implementing transitive closure using two sets.</figcaption>
</figure>
<p>Finding dependencies is complicated by the fact that we can load something under different names,
such as <code>./subdir/bottom-left</code> from <code>main</code> but <code>./bottom-left</code> from <code>./subdir/bottom-right</code>.
As with the module loader in <a class="x-ref" href="#module-loader">Chapter 13</a>,
we use absolute paths as unique identifiers.
Our code is also complicated by the fact that JavaScript's <code>Set</code> class doesn't have an equivalent of <code>Array.pop</code>,
so we will actually maintain the "set" of pending items as a list.
The resulting code is:</p>
<div class="code-sample lang-js" title="transitive-closure-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">getRequires</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./get-requires.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">entryPointPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">entryPointPath</span><span class="p">)]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filenames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">pending</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">candidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pending</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filenames</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">candidate</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">filenames</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">candidateDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">getRequires</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">raw</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">candidateDir</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">raw</span><span class="si">}</span><span class="sb">.js`</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">cooked</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">filenames</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">cooked</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cooked</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pending</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cooked</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[...</span><span class="nx">filenames</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-transitive-closure-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./transitive-closure-only.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="test-transitive-closure-only.sh">
<div class="highlight"><pre><span></span><code>node test-transitive-closure-only.js full/main.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-transitive-closure-only.out">
<div class="highlight"><pre><span></span><code>[
  "/u/stjs/module-bundler/full/main.js",
  "/u/stjs/module-bundler/full/subdir/bottom-right.js",
  "/u/stjs/module-bundler/full/subdir/bottom-left.js",
  "/u/stjs/module-bundler/full/top-left.js",
  "/u/stjs/module-bundler/full/top-right.js"
]
</code></pre></div>
</div>
<p>This works,
but it isn't keeping track of the mapping from required names within files to absolute paths,
so when one of the files in our bundle tries to access something,
we might not know what it's after.
The fix is to modify transitive closure to construct and return a two-level structure.
The primary keys are the absolute paths to the files being required,
while sub-keys are the paths they refer to when loading things
(<a class="fig-ref" href="../module-bundler/#module-bundler-structure">Figure 17.4</a>).</p>
<figure id="module-bundler-structure">
<img alt="Data structure for modules" src="./module-bundler/structure.svg"/>
<figcaption markdown="1">Figure 17.4: Data structure used to map names to absolute paths.</figcaption>
</figure>
<p>Adding this takes our transitive closure code from
23 lines
to 29 lines:</p>
<div class="code-sample lang-js" title="transitive-closure.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">getRequires</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./get-requires.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">entryPointPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">entryPointPath</span><span class="p">)]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filenames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">pending</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">candidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pending</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filenames</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">candidate</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">continue</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">filenames</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">mapping</span><span class="p">[</span><span class="nx">candidate</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">candidateDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">getRequires</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">raw</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">mapping</span><span class="p">[</span><span class="nx">candidate</span><span class="p">][</span><span class="nx">raw</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">          </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">candidateDir</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">raw</span><span class="si">}</span><span class="sb">.js`</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">mapping</span><span class="p">[</span><span class="nx">candidate</span><span class="p">][</span><span class="nx">raw</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">cooked</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">cooked</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cooked</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">pending</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cooked</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">mapping</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-transitive-closure.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./transitive-closure.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="test-transitive-closure.sh">
<div class="highlight"><pre><span></span><code>node test-transitive-closure.js full/main.js
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-transitive-closure.out">
<div class="highlight"><pre><span></span><code>{
  "/u/stjs/module-bundler/full/main.js": {
    "./top-left": "/u/stjs/module-bundler/full/top-left.js",
    "./top-right": "/u/stjs/module-bundler/full/top-right.js",
    "./subdir/bottom-left": \
    "/u/stjs/module-bundler/full/subdir/bottom-left.js",
    "./subdir/bottom-right": \
    "/u/stjs/module-bundler/full/subdir/bottom-right.js"
  },
  "/u/stjs/module-bundler/full/subdir/bottom-right.js": {},
  "/u/stjs/module-bundler/full/subdir/bottom-left.js": {
    "../top-left": "/u/stjs/module-bundler/full/top-left.js",
    "./bottom-right": \
    "/u/stjs/module-bundler/full/subdir/bottom-right.js"
  },
  "/u/stjs/module-bundler/full/top-left.js": {},
  "/u/stjs/module-bundler/full/top-right.js": {
    "./top-left": "/u/stjs/module-bundler/full/top-left.js",
    "./subdir/bottom-right": \
    "/u/stjs/module-bundler/full/subdir/bottom-right.js"
  }
}
</code></pre></div>
</div>
<p class="continue">The real cost, though, is the extra complexity of the data structure:
it took a couple of tries to get it right,
and it will be harder for the next person to understand than the original.
Comprehension and maintenance would be a little easier
if we could draw diagrams directly in our source code,
but as long as we insist that our programs be stored in a punchcard-compatible format
(i.e., as lines of text),
that will remain a dream.</p>
<h2 id="module-bundler-combine">Section 17.3: How can we safely combine several files into one?</h2>
<p>We now need to combine the files we have found into one
while keeping each in its own namespace.
We do this using the same method we used in <a class="x-ref" href="#module-loader">Chapter 13</a>:
wrap the source code in an <span class="ix-entry" ix-key="immediately-invoked function expression" markdown="1">IIFE</span>,
giving that IIFE a <code>module</code> object to fill in
and an implementation of <code>require</code> to resolve dependencies <em>within the bundle</em>.
For example, suppose we have this file:</p>
<div class="code-sample lang-js" title="sanity-check-unwrapped.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in main'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The wrapped version will look like this:</p>
<div class="code-sample lang-js" title="sanity-check-wrapped.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// eslint-disable-line</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in main'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">And we can test it like this:</p>
<div class="code-sample lang-js" title="sanity-check-test.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in main'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">_require</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">wrapper</span><span class="p">(</span><span class="nx">temp</span><span class="p">,</span><span class="w"> </span><span class="nx">_require</span><span class="p">)</span><span class="w"></span>
<span class="nx">temp</span><span class="p">.</span><span class="nx">exports</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="sanity-check-test.out">
<div class="highlight"><pre><span></span><code>in main
</code></pre></div>
</div>
<p>We need to do this for multiple files,
so we will put these IIFEs in a lookup table
that uses the files' absolute paths as its keys.
We will also wrap loading in a function
so that we don't accidentally step on anyone else's toys:</p>
<div class="code-sample lang-js" title="combine-files.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const initialize = (creators) =&gt; {</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TAIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">}</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">combineFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">allFilenames</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allFilenames</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`(module, require) =&gt; {</span><span class="si">${</span><span class="nx">source</span><span class="si">}</span><span class="sb">}`</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`creators.set('</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">',\n</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">)`</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="sb">`// </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">\n</span><span class="si">${</span><span class="nx">entry</span><span class="si">}</span><span class="sb">\n`</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">HEAD</span><span class="si">}</span><span class="sb">\n</span><span class="si">${</span><span class="nx">body</span><span class="si">}</span><span class="sb">\n</span><span class="si">${</span><span class="nx">TAIL</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">func</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">combineFiles</span><span class="w"></span>
</code></pre></div>
</div>
<p>Breaking this down,
the code in <code>HEAD</code> creates a function of no arguments
while the code in <code>TAIL</code> returns the lookup table from that function.
In between,
<code>combineFiles</code> adds an entry to the lookup table for each file
(<a class="fig-ref" href="../module-bundler/#module-bundler-head-tail">Figure 17.5</a>).</p>
<figure id="module-bundler-head-tail">
<img alt="Assembling runnable code" src="./module-bundler/head-tail.svg"/>
<figcaption markdown="1">Figure 17.5: Assembling fragments and modules to create a bundle.</figcaption>
</figure>
<p>We can test that this works in our two-file case:</p>
<div class="code-sample lang-js" title="test-combine-files.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">combineFiles</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./combine-files.js'</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">combineFiles</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="test-combine-files-simple.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">creators</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="c1">// /u/stjs/stjs/module-bundler/simple/main.js</span><span class="w"></span>
<span class="nx">creators</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/main.js'</span><span class="p">,</span><span class="w"></span>
<span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./other'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">other</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>

<span class="c1">// /u/stjs/stjs/module-bundler/simple/other.js</span><span class="w"></span>
<span class="nx">creators</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/other.js'</span><span class="p">,</span><span class="w"></span>
<span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`other called from </span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">other</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>


<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and then load the result and call <code>initialize</code>:</p>
<div class="code-sample lang-out" title="show-combine-files-simple.out">
<div class="highlight"><pre><span></span><code>Map(2) {
  '/u/stjs/module-bundler/simple/main.js' =&gt; [Function (anonymous)],
  '/u/stjs/module-bundler/simple/other.js' =&gt; [Function (anonymous)]
}
</code></pre></div>
</div>
<h2 id="module-bundler-access">Section 17.4: How can files access each other?</h2>
<p>The code we have built so far has not created our exports;
instead,
it has build a lookup table of functions that can create what we asked for.
More specifically we have:</p>
<ul>
<li>
<p>a lookup table from absolute filenames
    to functions that create the exports for those modules;</p>
</li>
<li>
<p>a lookup table from the importer's absolute filename
    to pairs storing the name of the required file as it was written
    and the required file's absolute filename;
    and</p>
</li>
<li>
<p>an entry point.</p>
</li>
</ul>
<p>To turn this into what we want,
we must look up the function associated with the entry point and run it,
giving it an empty module object and a <code>require</code> function that we will describe below,
then get the <code>exports</code> it has added to that module object.
Our replacement for <code>require</code> is only allowed to take one argument
(because that's all that JavaScript's <code>require</code> takes).
However,
it actually needs four things:
the argument to the user's <code>require</code> call,
the absolute path of the file making the call,
and the two lookup tables described above.
Those two tables can't be global variables because of possible name collisions:
no matter what we call them,
the user might have given a variable the same name.</p>
<p>As in <a class="x-ref" href="#module-loader">Chapter 13</a> we solve this problem using closures.
The result is probably the most difficult code in this book to understand
because of its many levels of abstraction.
First, we write a function that takes the two tables as arguments
and returns a function that takes an absolute path identifying this module.
When that function is called,
it creates and returns a function that takes a local path inside a module and returns the exports.
Each of these wrapping layers remembers more information for us
(<a class="fig-ref" href="../module-bundler/#module-bundler-returning-functions">Figure 17.6</a>),
but we won't pretend that it's easy to trace.</p>
<figure id="module-bundler-returning-functions">
<img alt="Functions returning functions returning functions" src="./module-bundler/returning-functions.svg"/>
<figcaption markdown="1">Figure 17.6: A function that returns functions that return functions.</figcaption>
</figure>
<p>We also need a third structure:
a cache for the modules we've already loaded.
Putting it all together we have:</p>
<div class="code-sample lang-js" title="create-bundle.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'fs'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'path'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./transitive-closure.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">HEAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const creators = new Map()</span>
<span class="sb">const cache = new Map()</span>

<span class="sb">const makeRequire = (absPath) =&gt; {</span>
<span class="sb">  return (localPath) =&gt; {</span>
<span class="sb">    const actualKey = translate[absPath][localPath]</span>
<span class="sb">    if (!cache.has(actualKey)) {</span>
<span class="sb">      const m = {}</span>
<span class="sb">      creators.get(actualKey)(m)</span>
<span class="sb">      cache.set(actualKey, m.exports)</span>
<span class="sb">    }</span>
<span class="sb">    return cache.get(actualKey)</span>
<span class="sb">  }</span>
<span class="sb">}</span>

<span class="sb">const initialize = (creators) =&gt; {</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TAIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">}</span>

<span class="sb">initialize(creators)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">makeProof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">entryPoint</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">const start = creators.get('</span><span class="si">${</span><span class="nx">entryPoint</span><span class="si">}</span><span class="sb">')</span>
<span class="sb">const m = {}</span>
<span class="sb">start(m)</span>
<span class="sb">m.exports()</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">entryPoint</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">entryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">entryPoint</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">transitiveClosure</span><span class="p">(</span><span class="nx">entryPoint</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">translate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const translate = </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">creators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">table</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">makeCreator</span><span class="p">(</span><span class="nx">filename</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">proof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeProof</span><span class="p">(</span><span class="nx">entryPoint</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nx">translate</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">HEAD</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="nx">creators</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">TAIL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">proof</span><span class="w"></span>
<span class="w">  </span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">makeCreator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="s1">'utf-8'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`(module, require = makeRequire('</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">')) =&gt;\n{</span><span class="si">${</span><span class="nx">source</span><span class="si">}</span><span class="sb">}`</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`creators.set('</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">',\n</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">)`</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`// </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">\n</span><span class="si">${</span><span class="nx">entry</span><span class="si">}</span><span class="sb">\n`</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">createBundle</span><span class="w"></span>
</code></pre></div>
</div>
<p>This code is hard to read
because we have to distinguish what is being printed in the output versus what is being executed right now
and because of the levels of nesting needed to capture variables safely.
Getting this right took much more time per line of finished code than anything we have seen so far
except the promises in <a class="x-ref" href="#async-programming">Chapter 3</a>.
However,
it is all <span class="ix-entry" ix-key="intrinsic complexity" markdown="1">intrinsic complexity</span>:
anything that does what <code>require</code> does is going to be equally convoluted.</p>
<p>To prove that our code works
we will look up the function <code>main</code> in the first file and call it.
(If we were loading in the browser,
we'd capture the exports in a variable for later use.)
First, we create the bundled file:</p>
<div class="code-sample lang-sh" title="test-create-bundle-single.sh">
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s1">'/* eslint-disable */'</span> &gt; bundle-single.js
node test-create-bundle.js single/main.js &gt;&gt; bundle-single.js
</code></pre></div>
</div>
<div class="code-sample lang-js" title="bundle-single.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">translate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s2">"/u/stjs/stjs/module-bundler/single/main.js"</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">creators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">makeRequire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">absPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">localPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">translate</span><span class="p">[</span><span class="nx">absPath</span><span class="p">][</span><span class="nx">localPath</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">      </span><span class="nx">creators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">)(</span><span class="nx">m</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">creators</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="c1">// /u/stjs/stjs/module-bundler/single/main.js</span><span class="w"></span>
<span class="nx">creators</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/single/main.js'</span><span class="p">,</span><span class="w"></span>
<span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="nx">makeRequire</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/single/main.js'</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="p">{</span><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'in main'</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>


<span class="p">}</span><span class="w"></span>

<span class="nx">initialize</span><span class="p">(</span><span class="nx">creators</span><span class="p">)</span><span class="w"></span>


<span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">creators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/single/main.js'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">start</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"></span>
<span class="nx">m</span><span class="p">.</span><span class="nx">exports</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and then we run it:
{: .break-before}</p>
<div class="code-sample lang-out" title="test-bundle-single.out">
<div class="highlight"><pre><span></span><code>n main
</code></pre></div>
</div>
<p>That was a lot of work to print one line,
but what we have should work for other files.
The two-file case with <code>main</code> and <code>other</code> works:</p>
<div class="code-sample lang-js" title="bundle-simple.js">
<div class="highlight"><pre><span></span><code><span class="cm">/* eslint-disable */</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">translate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s2">"/u/stjs/stjs/module-bundler/simple/main.js"</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">"./other"</span><span class="o">:</span><span class="w"> </span><span class="s2">"/u/stjs/stjs/module-bundler/simple/other.js"</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="s2">"/u/stjs/stjs/module-bundler/simple/other.js"</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">creators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">makeRequire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">absPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">localPath</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actualKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">translate</span><span class="p">[</span><span class="nx">absPath</span><span class="p">][</span><span class="nx">localPath</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">      </span><span class="nx">creators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">)(</span><span class="nx">m</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">actualKey</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">creators</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="c1">// /u/stjs/stjs/module-bundler/simple/main.js</span><span class="w"></span>
<span class="nx">creators</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/main.js'</span><span class="p">,</span><span class="w"></span>
<span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="nx">makeRequire</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/main.js'</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="p">{</span><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'./other'</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">other</span><span class="p">(</span><span class="s1">'main'</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>

<span class="c1">// /u/stjs/stjs/module-bundler/simple/other.js</span><span class="w"></span>
<span class="nx">creators</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/other.js'</span><span class="p">,</span><span class="w"></span>
<span class="p">(</span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="nx">makeRequire</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/other.js'</span><span class="p">))</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"></span>
<span class="p">{</span><span class="kd">const</span><span class="w"> </span><span class="nx">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">caller</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`other called from </span><span class="si">${</span><span class="nx">caller</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">other</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>


<span class="p">}</span><span class="w"></span>

<span class="nx">initialize</span><span class="p">(</span><span class="nx">creators</span><span class="p">)</span><span class="w"></span>


<span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">creators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/u/stjs/stjs/module-bundler/simple/main.js'</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">start</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"></span>
<span class="nx">m</span><span class="p">.</span><span class="nx">exports</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-bundle-simple.out">
<div class="highlight"><pre><span></span><code>other called from main
</code></pre></div>
</div>
<p class="continue">and so does our most complicated test with <code>main</code> and four other files:</p>
<div class="code-sample lang-out" title="test-bundle-full.out">
<div class="highlight"><pre><span></span><code>topLeft from main
topRight from main with topLeft from topRight and bottomRight from \
topRight
bottomLeft from main with topLeft from bottomLeft and bottomRight from \
bottomLeft
bottomRight from main
</code></pre></div>
</div>
<div class="break-before"></div>
<h2 id="module-bundler-exercises">Section 17.5: Exercises</h2>
<h3 class="exercise">Using test-driven development</h3>
<p>Suppose we wanted to compress the files being stored by the file backup system in <a class="x-ref" href="#file-backup">Chapter 5</a>
instead of copying them as-is.
What tests would you write before adding this feature in order to ensure that it worked correctly
once it was implemented?</p>
<h3 class="exercise">Finding <code>import</code> dependencies</h3>
<p>Modify the dependency finder to work with <code>import</code> statements instead of <code>require</code> calls.</p>
<h3 class="exercise">Track files using hashes</h3>
<p>Modify the dependency finder to track files by hashing them instead of relying on paths,
so that if exactly the same file is being required from two locations,
only one copy is loaded.</p>
<h3 class="exercise">Using asynchronous file operations</h3>
<p>Modify the dependency finder to use <code>async</code> and <code>await</code> instead of synchronous file operations.</p>
<h3 class="exercise">Unit testing transitive closure</h3>
<p>Write unit tests for the tool that finds the transitive closure of files' requirements
using Mocha and <code>mock-fs</code>.
(Rather than parsing JavaScript files in the mock filesystem,
have each file contain only a list of the names of the files it depends on.)</p>
<h3 class="exercise">Exporting multiple functions</h3>
<p>Create test cases for the module bundler in which files export more than one function
and fix any bugs in the module bundler that they uncover.</p>
<h3 class="exercise">Checking integrity</h3>
<p>Write a function that checks the integrity of the data structure returned by the transitive closure routine,
i.e.,
that makes sure every cross-reference resolves correctly.</p>
<h3 class="exercise">Logging module loading</h3>
<ol>
<li>
<p>Write a function called <code>logLoad</code> that takes a module name as an argument
    and prints a message using <code>console.error</code> saying that the module has been loaded.</p>
</li>
<li>
<p>Modify the bundle generator to insert calls to this function
    to report when modules are actually loaded.</p>
</li>
</ol>
<h3 class="exercise">Tracing execution</h3>
<p>Trace the execution of every function called
when the <code>main</code> function in the full bundle is called.</p>
<h3 class="exercise break-before">Making bundles more readable</h3>
<p>Modify the bundle creator to make its output more readable,
e.g.,
by adding comments and indentation.
(This does not matter to the computer,
but can help debugging.)</p>
</section>
<section class="new-chapter"><h1 id="package-manager">Chapter: Chapter 18: Package Manager</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#backward_compatible" markdown="1">backward-compatible</a>, <a class="gl-ref" href="../glossary/#combinatorial_explosion" markdown="1">combinatorial explosion</a>, <a class="gl-ref" href="../glossary/#heuristic" markdown="1">heuristic</a>, <a class="gl-ref" href="../glossary/#manifest" markdown="1">manifest</a>, <a class="gl-ref" href="../glossary/#patch" markdown="1">patch</a>, <a class="gl-ref" href="../glossary/#prune" markdown="1">prune</a>, <a class="gl-ref" href="../glossary/#sat_solver" markdown="1">SAT solver</a>, <a class="gl-ref" href="../glossary/#scoring_function" markdown="1">scoring function</a>, <a class="gl-ref" href="../glossary/#seed" markdown="1">seed</a>, <a class="gl-ref" href="../glossary/#semantic_versioning" markdown="1">semantic versioning</a>
</p>
<p>There is no point building software if you can't install it.
Inspired by the <span class="ix-entry" ix-key="Comprehensive TeX Archive Network" markdown="1">Comprehensive TeX Archive Network</span> <a href="https://www.ctan.org/">CTAN</a>,
most languages now have an online archive from which developers can download packages.
Each package typically has a name and one or more version(s);
each version may have a list of dependencies,
and the package may specify a version or range of versions for each dependency.</p>
<p>Downloading files requires some web programming that is out of scope for this book,
while installing those files in the right places
uses the systems programming skills of <a class="x-ref" href="#systems-programming">Chapter 2</a>.
The piece we are missing is a way to figure out exactly what versions of different packages to install
in order to create a consistent setup.
If packages A and B require different versions of C,
it might not be possible to use A and B together.
On the other hand,
if each one requires a range of versions of C and those ranges overlap,
we might be able to find a combination that works---at least,
until we try to install packages D and E.</p>
<p>We <em>could</em> install every package's dependencies separately with it;
the disk space wouldn't be much of an obstacle,
but loading dozens of copies of the same package into the browser
would slow applications down.
This chapter therefore explores how to find a workable installation or prove that there isn't one.
It is based in part on <a href="https://classic.yarnpkg.com/blog/2017/07/11/lets-dev-a-package-manager/">this tutorial</a> by <span class="ix-entry" ix-key="Nison, Maël" markdown="1"><a href="https://arcanis.github.io/">Maël Nison</a></span>.</p>
<blockquote>
<h3>Satisfiability</h3>
<p>What we are trying to do is find a version for each package
that makes the assertion "P is compatible with all its dependencies" true
for every package P.
The general-purpose tools for doing this are called <span class="ix-entry" ix-key="satisfiability;SAT solver" markdown="1"><a class="gl-ref" href="../glossary/#sat_solver" markdown="1">SAT solvers</a></span>
because they determine whether there is some assignment of values
that satisfies the claim (i.e., makes it true).
Finding a solution can be extremely hard in the general case,
so most SAT solvers use heuristics to try to reduce the work.</p>
</blockquote>
<h2 id="package-manager-semver">Section 18.1: What is semantic versioning?</h2>
<p>Most software projects use <span class="ix-entry" ix-key="semantic versioning" markdown="1"><a class="gl-ref" href="../glossary/#semantic_versioning" markdown="1">semantic versioning</a></span> for software releases.
Each version number consists of three integers X.Y.Z,
where X is the major version,
Y is the minor version,
and Z is the <span class="ix-entry" ix-key="patch number;semantic versioning!patch number" markdown="1"><a class="gl-ref" href="../glossary/#patch" markdown="1">patch</a></span> number.
(The <a href="https://semver.org/">full specification</a> allows for more fields,
but we will ignore them in this tutorial.)</p>
<p>A package's authors increment its major version number
every time something changes in a way that makes the package incompatible with previous versions
For example,
if they add a required parameter to a function,
then code built for the old version will fail or behave unpredictably with the new one.
The minor version number is incremented when new functionality
is <span class="ix-entry" ix-key="backward compatibility" markdown="1"><a class="gl-ref" href="../glossary/#backward_compatible" markdown="1">backward-compatible</a></span>---i.e.,
it won't break any existing code---and the patch number is changed
for backward-compatible bug fixes that don't add any new features.</p>
<p>The notation for specifying a project's dependencies looks a lot like arithmetic:
<code>&gt;= 1.2.3</code> means "any version from 1.2.3 onward",
<code>&lt; 4</code> means "any version before 4.anything",
and <code>1.0 - 3.1</code> means "any version in the specified range (including patches)".
Note that version 2.1 is greater than version 1.99:
no matter how large a minor version number becomes,
it never spills over into the major version number
in the way that minutes add up to hours or months add up to years.</p>
<p>It isn't hard to write a few simple comparisons for semantic version identifiers,
but getting all the different cases right is almost as tricky as handling dates and times correctly,
so we will rely on the <a href="https://www.npmjs.com/package/semver"><code>semver</code></a> module.
<code>semver.valid('1.2.3')</code> checks that <code>1.2.3</code> is a valid version identifier,
while <code>semver.satisfies('2.2', '1.0 - 3.1')</code> checks that its first argument
is compatible with the range specified in its second.</p>
<h2 id="package-manager-consistent">Section 18.2: How can we find a consistent set of packages?</h2>
<p>Imagine that each package we need is represented as an axis on a multi-dimensional grid,
with its versions as the tick marks
(<a class="fig-ref" href="../package-manager/#package-manager-allowable">Figure 18.1</a>).
Each point on the grid is a possible combination of package versions.
We can block out regions of this grid using the constraints on the package versions;
whatever points are left when we're done represent legal combinations.</p>
<figure id="package-manager-allowable">
<img alt="Allowable versions" src="./package-manager/allowable.svg"/>
<figcaption markdown="1">Figure 18.1: Finding allowable combinations of package versions.</figcaption>
</figure>
<p>For example,
suppose we have the set of requirements shown in <a class="tbl-ref" href="../package-manager/#package-manager-example-dependencies">Table 18.1</a>.
There are 18 possible configurations
(2 for X × 3 for Y × 3 for Z)
but 16 are excluded by various incompatibilities.
Of the two remaining possibilities,
X/2 + Y/3 + Z/3 is strictly greater than X/2 + Y/2 + Z/2,
so we would probably choose the former
(<a class="tbl-ref" href="../package-manager/#package-manager-example-result">Table 18.2</a>).
if we wound up with A/1 + B/2 versus A/2 + B/1,
we would need to add rules for resolving ties.</p>
<blockquote>
<h3>Reproducibility</h3>
<p>No matter what kind of software you build,
a given set of inputs should always produce the same output;
if they don't,
testing is much more difficult (or impossible) <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Taschuk2017">Taschuk2017</a>]</span>.
There may not be a strong reason to prefer one mutually-compatible set of packages over another,
but a package manager should still resolve the ambiguity the same way every time.
It may not be what everyone wants,
but at least they will be unhappy for the same reasons everywhere.
This is why <a href="https://www.npmjs.com/">NPM</a> has both <code>package.json</code> and a <code>package-lock.json</code> files:
the former is written by the user and specifies what they <em>want</em>,
while the latter is created by the package manager and specifies exactly what they <em>got</em>.
If you want to reproduce someone else's setup for debugging purposes,
you should install what is described in the latter file.</p>
</blockquote>
<div class="table"><table id="package-manager-example-dependencies"><caption>Table 18.1: Example package dependencies.</caption>
<thead>
<tr>
<th>Package</th>
<th>Requires</th>
</tr>
</thead>
<tbody>
<tr>
<td>X/1</td>
<td>Y/1-2</td>
</tr>
<tr>
<td>X/1</td>
<td>Z/1</td>
</tr>
<tr>
<td>X/2</td>
<td>Y/2-3</td>
</tr>
<tr>
<td>X/2</td>
<td>Z/1-2</td>
</tr>
<tr>
<td>Y/1</td>
<td>Z/2</td>
</tr>
<tr>
<td>Y/2</td>
<td>Z/2-3</td>
</tr>
<tr>
<td>Y/3</td>
<td>Z/3</td>
</tr>
<tr>
<td>Z/1</td>
<td></td>
</tr>
<tr>
<td>Z/2</td>
<td></td>
</tr>
<tr>
<td>Z/3</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="table break-before"><table id="package-manager-example-result"><caption>Table 18.2: Result for example package dependencies.</caption>
<thead>
<tr>
<th>X</th>
<th>Y</th>
<th>Z</th>
<th>Excluded</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Y/1 - Z/1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>2</td>
<td>X/1 - Z/2</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>3</td>
<td>X/1 - Z/3</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>1</td>
<td>Y/2 - Z/1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2</td>
<td>X/1 - Z/2</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>3</td>
<td>X/1 - Z/3</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>1</td>
<td>X/1 - Y/3</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2</td>
<td>X/1 - Y/3</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>3</td>
<td>X/1 - Y/3</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
<td>X/2 - Y/1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>2</td>
<td>X/2 - Y/1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>3</td>
<td>X/2 - Y/1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1</td>
<td>Y/2 - Z/1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>3</td>
<td>X/2 - Z/3</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>1</td>
<td>Y/3 - Z/1</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2</td>
<td>Y/3 - Z/2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>3</td>
<td>X/2 - Z/3</td>
</tr>
</tbody>
</table>
</div>
<p>To construct <a class="tbl-ref" href="../package-manager/#package-manager-example-dependencies">Table 18.1</a>
we find the <span class="ix-entry" ix-key="transitive closure" markdown="1">transitive closure</span> of all packages plus all of their dependencies.
We then pick two packages and create a list of their valid pairs.
Choosing a third package,
we cross off pairs that can't be satisfied
to leave triples of legal combinations.
We repeat this until all packages are included in our table.</p>
<p>In the worst case this procedure will create
a <span class="ix-entry" ix-key="combinatorial explosion" markdown="1"><a class="gl-ref" href="../glossary/#combinatorial_explosion" markdown="1">combinatorial explosion</a></span> of possibilities.
Smart algorithms will try to add packages to the mix
in an order that minimize the number of new possibilities at each stage,
or create pairs and then combine them to create pairs of pairs and so on.
Our algorithm will be simpler (and therefore slower),
but illustrates the key idea.</p>
<h2 id="package-manager-constraints">Section 18.3: How can we satisfy constraints?</h2>
<p>To avoid messing around with parsers,
our programs reads a JSON data structure describing the problem;
a real package manager would read the <span class="ix-entry" ix-key="manifest (of package);package manifest" markdown="1"><a class="gl-ref" href="../glossary/#manifest" markdown="1">manifests</a></span> of the packages in question
and construct a similar data structure.
We will stick to single-digit version numbers for readability,
and will use this as our first test case:</p>
<div class="code-sample lang-json" title="double-chained.json">
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">"X"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"Y"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"1"</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">"2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">"Y"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2"</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nt">"Y"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"1"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">    </span><span class="nt">"2"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Comments</h3>
<p>If you ever design a data format,
please include a standard way for people to add comments,
because they will always want to.
YAML has this,
but JSON and CSV don't.</p>
</blockquote>
<p>To check if a combination of specific versions of packages is compatible with a manifest,
we add each package to our active list in turn and look for violations.
If there aren't any more packages to add and we haven't found a violation,
then what we have must be a legal configuration.</p>
<div class="code-sample lang-js" title="sweep.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">configStr</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./config-str.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">sweep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">recurse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">allows</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">config</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">next</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">config</span><span class="p">[</span><span class="nx">next</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">version</span><span class="w"></span>
<span class="w">      </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">sweep</span><span class="w"></span>
</code></pre></div>
</div>
<p>The simplest way to find configurations is to sweep over all possibilities.
For debugging purposes,
our function prints possibilities as it goes:</p>
<div class="code-sample lang-js" title="sweep.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">allows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">requirements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">leftN</span><span class="p">][</span><span class="nx">leftV</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightVAll</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">requirements</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rightVAll</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">config</span><span class="p">[</span><span class="nx">rightN</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="nx">rightN</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb"> @ </span><span class="si">${</span><span class="nx">leftN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">leftV</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">rightN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">missing</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>If we run this program on the two-package example shown earlier we get this output:</p>
<div class="code-sample lang-sh" title="sweep-double-chained.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./sweep.js double-chained.json
</code></pre></div>
</div>
<div class="code-sample lang-out" title="sweep-double-chained.out">
<div class="highlight"><pre><span></span><code>{X:1 Y:1}
{X:1 Y:2} @ X/1 Y/2
{X:2 Y:1} @ X/2 Y/1
{X:2 Y:2}
</code></pre></div>
</div>
<p>When we run it on our triple-package example we get this:</p>
<div class="code-sample lang-sh" title="sweep-triple.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./sweep.js triple.json
</code></pre></div>
</div>
<div class="code-sample lang-out" title="sweep-triple.out">
<div class="highlight"><pre><span></span><code>{X:1 Y:1 Z:1} @ Y/1 Z/1
{X:1 Y:1 Z:2} @ X/1 Z/2
{X:1 Y:1 Z:3} @ X/1 Z/3
{X:1 Y:2 Z:1} @ Y/2 Z/1
{X:1 Y:2 Z:2} @ X/1 Z/2
{X:1 Y:2 Z:3} @ X/1 Z/3
{X:1 Y:3 Z:1} @ X/1 Y/3
{X:1 Y:3 Z:2} @ X/1 Y/3
{X:1 Y:3 Z:3} @ X/1 Y/3
{X:2 Y:1 Z:1} @ X/2 Y/1
{X:2 Y:1 Z:2} @ X/2 Y/1
{X:2 Y:1 Z:3} @ X/2 Y/1
{X:2 Y:2 Z:1} @ Y/2 Z/1
{X:2 Y:2 Z:2}
{X:2 Y:2 Z:3} @ X/2 Z/3
{X:2 Y:3 Z:1} @ Y/3 Z/1
{X:2 Y:3 Z:2} @ Y/3 Z/2
{X:2 Y:3 Z:3} @ X/2 Z/3
</code></pre></div>
</div>
<p>This works,
but it is doing a lot of unnecessary work.
If we sort the output by the case that caught the exclusion
it turns out that 9 of the 17 exclusions are redundant rediscovery of a previously-known problem
<a class="tbl-ref" href="../package-manager/#package-manager-exclusions">Table 18.3</a>.</p>
<div class="table"><table id="package-manager-exclusions"><caption>Table 18.3: Package exclusions.</caption>
<thead>
<tr>
<th>Excluded</th>
<th>X</th>
<th>Y</th>
<th>Z</th>
</tr>
</thead>
<tbody>
<tr>
<td>X/1 - Y/3</td>
<td>1</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>1</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>…</td>
<td>1</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>X/1 - Z/2</td>
<td>1</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>…</td>
<td>1</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>X/1 - Z/3</td>
<td>1</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>…</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>X/2 - Y/1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>X/2 - Z/3</td>
<td>2</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>Y/1 - Z/1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>Y/2 - Z/1</td>
<td>1</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>Y/3 - Z/1</td>
<td>2</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
<div class="break-before"></div>
<h2 id="package-manager-optimize">Section 18.4: How can we do less work?</h2>
<p>In order to make this more efficient we need to <span class="ix-entry" ix-key="prune (a search tree)" markdown="1"><a class="gl-ref" href="../glossary/#prune" markdown="1">prune</a></span> the search tree
as we go along
(<a class="fig-ref" href="../package-manager/#package-manager-pruning">Figure 18.2</a>).
After all,
if we know that X and Y are incompatible,
there is no need to check Z as well.</p>
<figure id="package-manager-pruning">
<img alt="Pruning the search tree" src="./package-manager/pruning.svg"/>
<figcaption markdown="1">Figure 18.2: Pruning options in the search tree to reduce work.</figcaption>
</figure>
<p>This version of the program collects possible solutions and displays them at the end.
It only keeps checking a partial solution if what it has found so far looks good:</p>
<div class="code-sample lang-js" title="prune.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">configStr</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./config-str.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">prune</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">recurse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">config</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">next</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">config</span><span class="p">[</span><span class="nx">next</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">version</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">compatible</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="ow">delete</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="nx">next</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb"> @ </span><span class="si">${</span><span class="nx">leftN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">leftV</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">rightN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">rightV</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">prune</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>compatible</code> function checks to see if adding something will leave us with a consistent configuration:</p>
<div class="code-sample lang-js" title="prune.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">leftR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">leftN</span><span class="p">][</span><span class="nx">leftV</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">rightN</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">leftR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">leftR</span><span class="p">[</span><span class="nx">rightN</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">rightV</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rightR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">rightN</span><span class="p">][</span><span class="nx">rightV</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">leftN</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rightR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rightR</span><span class="p">[</span><span class="nx">leftN</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">leftV</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Checking as we go gets us from 18 complete solutions to 11.
One is workable
and two are incomplete---they represent 6 possible complete solutions that we didn't need to finish:</p>
<div class="code-sample lang-out" title="prune-triple.out">
<div class="highlight"><pre><span></span><code>{X:1 Y:1 Z:1} @ Y/1 Z/1
{X:1 Y:1 Z:2} @ X/1 Z/2
{X:1 Y:1 Z:3} @ X/1 Z/3
{X:1 Y:2 Z:1} @ Y/2 Z/1
{X:1 Y:2 Z:2} @ X/1 Z/2
{X:1 Y:2 Z:3} @ X/1 Z/3
{X:1 Y:3} @ X/1 Y/3
{X:2 Y:1} @ X/2 Y/1
{X:2 Y:2 Z:1} @ Y/2 Z/1
{X:2 Y:2 Z:3} @ X/2 Z/3
{X:2 Y:3 Z:1} @ Y/3 Z/1
{X:2 Y:3 Z:2} @ Y/3 Z/2
{X:2 Y:3 Z:3} @ X/2 Z/3
{X:2 Y:2 Z:2}
</code></pre></div>
</div>
<p>Another way to look at the work is the number of steps in the search.
The full search had 18×3 = 54 steps.
Pruning leaves us with (12×3) + (2×2) = 40 steps
so we have eliminated roughly 1/4 of the work.</p>
<p>What if we searched in the reverse order?</p>
<div class="code-sample lang-js" title="reverse.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">configStr</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./config-str.js'</span><span class="w"></span>

<span class="c1">// [reverse]</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">manifest</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">names</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">  </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// [/reverse]</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">recurse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">config</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">next</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">config</span><span class="p">[</span><span class="nx">next</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">version</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">compatible</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">recurse</span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">rest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="ow">delete</span><span class="w"> </span><span class="nx">config</span><span class="p">[</span><span class="nx">next</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">manifest</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">leftR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">leftN</span><span class="p">][</span><span class="nx">leftV</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">rightN</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">leftR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">leftR</span><span class="p">[</span><span class="nx">rightN</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">rightV</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rightR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">manifest</span><span class="p">[</span><span class="nx">rightN</span><span class="p">][</span><span class="nx">rightV</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">leftN</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rightR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rightR</span><span class="p">[</span><span class="nx">leftN</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">leftV</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">report</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">leftN</span><span class="p">,</span><span class="w"> </span><span class="nx">leftV</span><span class="p">,</span><span class="w"> </span><span class="nx">rightN</span><span class="p">,</span><span class="w"> </span><span class="nx">rightV</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configStr</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">title</span><span class="si">}</span><span class="sb"> @ </span><span class="si">${</span><span class="nx">leftN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">leftV</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">rightN</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">rightV</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">reverse</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="reverse-triple.out">
<div class="highlight"><pre><span></span><code>{Z:1 Y:1} @ Z/1 Y/1
{Z:1 Y:2} @ Z/1 Y/2
{Z:1 Y:3} @ Z/1 Y/3
{Z:2 Y:1 X:1} @ Z/2 X/1
{Z:2 Y:1 X:2} @ Y/1 X/2
{Z:2 Y:2 X:1} @ Z/2 X/1
{Z:2 Y:3} @ Z/2 Y/3
{Z:3 Y:1} @ Z/3 Y/1
{Z:3 Y:2 X:1} @ Z/3 X/1
{Z:3 Y:2 X:2} @ Z/3 X/2
{Z:3 Y:3 X:1} @ Z/3 X/1
{Z:3 Y:3 X:2} @ Z/3 X/2
{Z:2 Y:2 X:2}
</code></pre></div>
</div>
<p>Now we have (8×3) + (5×2) = 34 steps,
i.e.,
we have eliminated roughly 1/3 of the work.
That may not seem like a big difference,
but if we go five levels deep at the same rate
it cuts the work in half.
There are lots of <a class="gl-ref" href="../glossary/#heuristic" markdown="1">heuristics</a> for searching trees;
none are guaranteed to give better performance in every case,
but most give better performance in most cases.</p>
<blockquote>
<h3>What research is for</h3>
<p><span class="ix-entry" ix-key="SAT solver" markdown="1">SAT solvers</span> are like regular expression libraries and random number generators:
it is the work of many lifetimes to create ones that are both fast and correct.
A lot of computer science researchers devote their careers to highly-specialized topics like this.
The debates often seem esoteric to outsiders,
and most ideas turn out to be dead ends,
but even small improvements in fundamental tools can have a profound impact.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="package-manager-exercises">Section 18.5: Exercises</h2>
<h3 class="exercise">Comparing semantic versions</h3>
<p>Write a function that takes an array of semantic version specifiers
and sorts them in ascending order.
Remember that <code>2.1</code> is greater than <code>1.99</code>.</p>
<h3 class="exercise">Parsing semantic versions</h3>
<p>Using the techniques of <a class="x-ref" href="#regex-parser">Chapter 8</a>,
write a parser for a subset of the <a href="https://semver.org/">semantic versioning specification</a>.</p>
<h3 class="exercise">Using scoring functions</h3>
<p>Many different combinations of package versions can be mutually compatible.
One way to decide which actual combination to install
is to create a <a class="gl-ref" href="../glossary/#scoring_function" markdown="1">scoring function</a>
that measures how good or bad a particular combination is.
For example,
a function could measure the "distance" between two versions as:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="p">(</span><span class="nx">X</span><span class="p">,</span><span class="w"> </span><span class="nx">Y</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">X</span><span class="p">.</span><span class="nx">major</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">Y</span><span class="p">.</span><span class="nx">major</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">abs</span><span class="p">(</span><span class="nx">X</span><span class="p">.</span><span class="nx">major</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Y</span><span class="p">.</span><span class="nx">major</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">X</span><span class="p">.</span><span class="nx">minor</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">Y</span><span class="p">.</span><span class="nx">minor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">abs</span><span class="p">(</span><span class="nx">X</span><span class="p">.</span><span class="nx">minor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Y</span><span class="p">.</span><span class="nx">minor</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">abs</span><span class="p">(</span><span class="nx">X</span><span class="p">.</span><span class="nx">patch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Y</span><span class="p">.</span><span class="nx">patch</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ol>
<li>
<p>Implement a working version of this function
    and use it to measure the total distance between
    the set of packages found by the solver
    and the set containing the most recent version of each package.</p>
</li>
<li>
<p>Explain why this doesn't actually solve the original problem.</p>
</li>
</ol>
<h3 class="exercise">Using full semantic versions</h3>
<p>Modify the constraint solver to use full semantic versions instead of single digits.</p>
<h3 class="exercise">Regular releases</h3>
<p>Some packages release new versions on a regular cycle,
e.g.,
Version 2021.1 is released on March 1 of 2021,
Version 2021.2 is released on September 1 of that year,
version 2022.1 is released on March 1 of the following year,
and so on.</p>
<ol>
<li>
<p>How does this make package management easier?</p>
</li>
<li>
<p>How does it make it more difficult?</p>
</li>
</ol>
<h3 class="exercise">Writing unit tests</h3>
<p>Write unit tests for the constraint solver using Mocha.</p>
<h3 class="exercise">Generating test fixtures</h3>
<p>Write a function that creates fixtures for testing the constraint solver:</p>
<ol>
<li>
<p>Its first argument is an object whose keys are (fake) package names
    and whose values are integers indicating the number of versions of that package
    to include in the test set,
    such as <code>{'left': 3, 'middle': 2, 'right': 15}</code>.
    Its second argument is a <a class="gl-ref" href="../glossary/#seed" markdown="1">seed</a> for random number generation.</p>
</li>
<li>
<p>It generates one valid configuration,
    such as <code>{'left': 2, 'middle': 2, 'right': 9}</code>.
    (This is to ensure that there is at least one installable set of packages.)</p>
</li>
<li>
<p>It then generates random constraints between the packages.
    (These may or may not result in other installable combinations.)
    When this is done,
    it adds constraints so that the valid configuration from the previous step is included.</p>
</li>
</ol>
<h3 class="exercise">Searching least first</h3>
<p>Rewrite the constraint solver so that it searches packages
by looking at those with the fewest available versions first.
Does this reduce the amount of work done for the small examples in this chapter?
Does it reduce the amount of work done for larger examples?</p>
<h3 class="exercise">Using generators</h3>
<p>Rewrite the constraint solver to use generators.</p>
<h3 class="exercise">Using exclusions</h3>
<ol>
<li>
<p>Modify the constraint solver so that
    it uses a list of package exclusions instead of a list of package requirements,
    i.e.,
    its input tells it that version 1.2 of package Red
    can <em>not</em> work with versions 3.1 and 3.2 of package Green
    (which implies that Red 1.2 can work with any other versions of Green).</p>
</li>
<li>
<p>Explain why package managers aren't built this way.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="virtual-machine">Chapter: Chapter 19: Virtual Machine</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#abi" markdown="1">Application Binary Interface</a>, <a class="gl-ref" href="../glossary/#assembler" markdown="1">assembler</a>, <a class="gl-ref" href="../glossary/#assembly_code" markdown="1">assembly code</a>, <a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operation</a>, <a class="gl-ref" href="../glossary/#disassembler" markdown="1">disassembler</a>, <a class="gl-ref" href="../glossary/#instruction_pointer" markdown="1">instruction pointer</a>, <a class="gl-ref" href="../glossary/#instruction_set" markdown="1">instruction set</a>, <a class="gl-ref" href="../glossary/#label_address" markdown="1">label (address in memory)</a>, <a class="gl-ref" href="../glossary/#op_code" markdown="1">op code</a>, <a class="gl-ref" href="../glossary/#register" markdown="1">register</a>, <a class="gl-ref" href="../glossary/#virtual_machine" markdown="1">virtual machine</a>, <a class="gl-ref" href="../glossary/#word_memory" markdown="1">word (of memory)</a>
</p>
<p>Computers don't execute JavaScript directly.
Instead,
each processor has its own <span class="ix-entry" ix-key="instruction set" markdown="1"><a class="gl-ref" href="../glossary/#instruction_set" markdown="1">instruction set</a></span>,
and a compiler translates high-level languages into those instructions.
Compilers often use an intermediate representation called <span class="ix-entry" ix-key="assembly code" markdown="1"><a class="gl-ref" href="../glossary/#assembly_code" markdown="1">assembly code</a></span>
that gives instructions human-readable names instead of numbers.
To understand more about how JavaScript actually runs
we will simulate a very simple processor with a little bit of memory.
If you want to dive deeper,
have a look at <span class="ix-entry" ix-key="Nystrom, Bob" markdown="1"><a href="http://journal.stuffwithstuff.com/">Bob Nystrom's</a></span> <em><a href="https://craftinginterpreters.com/">Crafting Interpreters</a></em>.
You may also enjoy <span class="ix-entry" ix-key="Human Resource Machine" markdown="1"><a href="https://tomorrowcorporation.com/humanresourcemachine">Human Resource Machine</a></span>,
which asks you to solve puzzles of increasing difficulty
using a processor almost as simple as ours.</p>
<h2 id="virtual-machine-arch">Section 19.1: What is the architecture of our virtual machine?</h2>
<p>Our <span class="ix-entry" ix-key="virtual machine" markdown="1"><a class="gl-ref" href="../glossary/#virtual_machine" markdown="1">virtual machine</a></span> has three parts,
which are shown in <a class="fig-ref" href="../virtual-machine/#virtual-machine-architecture">Figure 19.1</a>
for a program made up of 110 instructions:</p>
<ol>
<li>
<p>An <span class="ix-entry" ix-key="instruction pointer" markdown="1"><a class="gl-ref" href="../glossary/#instruction_pointer" markdown="1">instruction pointer</a></span> (IP)
    that holds the memory address of the next instruction to execute.
    It is automatically initialized to point at address 0,
    which is where every program must start.
    This rule is part of the <span class="ix-entry" ix-key="Application Binary Interface" markdown="1"><a class="gl-ref" href="../glossary/#abi" markdown="1">Application Binary Interface</a></span> (ABI)
    for our virtual machine.</p>
</li>
<li>
<p>Four <span class="ix-entry" ix-key="register (in computer)" markdown="1"><a class="gl-ref" href="../glossary/#register" markdown="1">registers</a></span> named R0 to R3 that instructions can access directly.
    There are no memory-to-memory operations in our VM:
    everything  happens in or through registers.</p>
</li>
<li>
<p>256 <a class="gl-ref" href="../glossary/#word_memory" markdown="1">words</a> of memory, each of which can store a single value.
    Both the program and its data live in this single block of memory;
    we chose the size 256 so that each address will fit in a single byte.</p>
</li>
</ol>
<figure id="virtual-machine-architecture">
<img alt="Virtual machine architecture" src="./virtual-machine/architecture.svg"/>
<figcaption markdown="1">Figure 19.1: Architecture of the virtual machine.</figcaption>
</figure>
<p>The instructions for our VM are 3 bytes long.
The <span class="ix-entry" ix-key="op code;virtual machine!op code" markdown="1"><a class="gl-ref" href="../glossary/#op_code" markdown="1">op code</a></span> fits into one byte,
and each instruction may optionally include one or two single-byte operands.
Each operand is a register identifier,
a constant,
or an address
(which is just a constant that identifies a location in memory);
since constants have to fit in one byte,
the largest number we can represent directly is 256.
<a class="tbl-ref" href="../virtual-machine/#virtual-machine-op-codes">Table 19.1</a> uses the letters <code>r</code>, <code>c</code>, and <code>a</code>
to indicate instruction format,
where <code>r</code> indicates a register identifier,
<code>c</code> indicates a constant,
and <code>a</code> indicates an address.</p>
<div class="table break-before"><table id="virtual-machine-op-codes"><caption>Table 19.1: Virtual machine op codes.</caption>
<thead>
<tr>
<th>Instruction</th>
<th>Code</th>
<th>Format</th>
<th>Action</th>
<th>Example</th>
<th>Equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hlt</code></td>
<td>1</td>
<td><code>--</code></td>
<td>Halt program</td>
<td><code>hlt</code></td>
<td><code>process.exit(0)</code></td>
</tr>
<tr>
<td><code>ldc</code></td>
<td>2</td>
<td><code>rc</code></td>
<td>Load immediate</td>
<td><code>ldc R0 123</code></td>
<td><code>R0 := 123</code></td>
</tr>
<tr>
<td><code>ldr</code></td>
<td>3</td>
<td><code>rr</code></td>
<td>Load register</td>
<td><code>ldr R0 R1</code></td>
<td><code>R0 := RAM[R1]</code></td>
</tr>
<tr>
<td><code>cpy</code></td>
<td>4</td>
<td><code>rr</code></td>
<td>Copy register</td>
<td><code>cpy R0 R1</code></td>
<td><code>R0 := R1</code></td>
</tr>
<tr>
<td><code>str</code></td>
<td>5</td>
<td><code>rr</code></td>
<td>Store register</td>
<td><code>str R0 R1</code></td>
<td><code>RAM[R1] := R0</code></td>
</tr>
<tr>
<td><code>add</code></td>
<td>6</td>
<td><code>rr</code></td>
<td>Add</td>
<td><code>add R0 R1</code></td>
<td><code>R0 := R0 + R1</code></td>
</tr>
<tr>
<td><code>sub</code></td>
<td>7</td>
<td><code>rr</code></td>
<td>Subtract</td>
<td><code>sub R0 R1</code></td>
<td><code>R0 := R0 - R1</code></td>
</tr>
<tr>
<td><code>beq</code></td>
<td>8</td>
<td><code>ra</code></td>
<td>Branch if equal</td>
<td><code>beq R0 123</code></td>
<td><code>if (R0 === 0) PC := 123</code></td>
</tr>
<tr>
<td><code>bne</code></td>
<td>9</td>
<td><code>ra</code></td>
<td>Branch if not equal</td>
<td><code>bne R0 123</code></td>
<td><code>if (R0 !== 0) PC := 123</code></td>
</tr>
<tr>
<td><code>prr</code></td>
<td>10</td>
<td><code>r-</code></td>
<td>Print register</td>
<td><code>prr R0</code></td>
<td><code>console.log(R0)</code></td>
</tr>
<tr>
<td><code>prm</code></td>
<td>11</td>
<td><code>r-</code></td>
<td>Print memory</td>
<td><code>prm R0</code></td>
<td><code>console.log(RAM[R0])</code></td>
</tr>
</tbody>
</table>
</div>
<p>We put our VM's architectural details in a file
that can be shared by other components:</p>
<div class="code-sample lang-js" title="architecture.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">OPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">hlt</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'--'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Halt program</span><span class="w"></span>
<span class="w">  </span><span class="nx">ldc</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rv'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Load immediate</span><span class="w"></span>
<span class="w">  </span><span class="nx">ldr</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rr'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Load register</span><span class="w"></span>
<span class="w">  </span><span class="nx">cpy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rr'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Copy register</span><span class="w"></span>
<span class="w">  </span><span class="nx">str</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rr'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Store register</span><span class="w"></span>
<span class="w">  </span><span class="nx">add</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rr'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Add</span><span class="w"></span>
<span class="w">  </span><span class="nx">sub</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rr'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Subtract</span><span class="w"></span>
<span class="w">  </span><span class="nx">beq</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rv'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Branch if equal</span><span class="w"></span>
<span class="w">  </span><span class="nx">bne</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w">  </span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'rv'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Branch if not equal</span><span class="w"></span>
<span class="w">  </span><span class="nx">prr</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'r-'</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Print register</span><span class="w"></span>
<span class="w">  </span><span class="nx">prm</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="mf">11</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="o">:</span><span class="w"> </span><span class="s1">'r-'</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// Print memory</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">OP_MASK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="w"> </span><span class="c1">// select a single byte</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">OP_SHIFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="w">   </span><span class="c1">// shift up by one byte</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">OP_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6</span><span class="w">   </span><span class="c1">// op width in characters when printing</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">NUM_REG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="w">    </span><span class="c1">// number of registers</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">RAM_LEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">256</span><span class="w">  </span><span class="c1">// number of words in RAM</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">OPS</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">OP_MASK</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">OP_SHIFT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">OP_WIDTH</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">NUM_REG</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">RAM_LEN</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">While there isn't a name for this design pattern,
putting all the constants that define a system in one file
instead of scattering them across multiple files
makes them easier to find as well as ensuring consistency.</p>
<h2 id="virtual-machine-execute">Section 19.2: How can we execute these instructions?</h2>
<p>As in previous chapters,
we will split a class that would normally be written in one piece into several parts for exposition.
We start by defining a class with an instruction pointer, some registers, and some memory
along with a prompt for output:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">OP_MASK</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">OP_SHIFT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">NUM_REG</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">RAM_LEN</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./architecture.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">COLUMNS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">DIGITS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">NUM_REG</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">RAM_LEN</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">prompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&gt;&gt;'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"></span>
</code></pre></div>
</div>
<p>A program is just an array of numbers representing instructions.
To load one,
we copy those numbers into memory and reset the instruction pointer and registers:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">initialize</span><span class="w"> </span><span class="p">(</span><span class="nx">program</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">program</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Program is too long for memory'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">program</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>In order to handle the next instruction,
the VM gets the value in memory that the instruction pointer currently refers to
and moves the instruction pointer on by one address.
It then uses <span class="ix-entry" ix-key="bitwise operation" markdown="1"><a class="gl-ref" href="../glossary/#bitwise_operation" markdown="1">bitwise operations</a></span>
to extract the op code and operands from the instruction
(<a class="fig-ref" href="../virtual-machine/#virtual-machine-unpacking">Figure 19.2</a>):</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">fetch</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">((</span><span class="mf">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">RAM_LEN</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Program counter </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="si">}</span><span class="sb"> out of range 0..</span><span class="si">${</span><span class="nx">RAM_LEN</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">instruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">OP_MASK</span><span class="w"></span>
<span class="w">    </span><span class="nx">instruction</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="nx">OP_SHIFT</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">arg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">OP_MASK</span><span class="w"></span>
<span class="w">    </span><span class="nx">instruction</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="nx">OP_SHIFT</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">arg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">OP_MASK</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">arg1</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="virtual-machine-unpacking">
<img alt="Unpacking instructions" src="./virtual-machine/unpacking.svg"/>
<figcaption markdown="1">Figure 19.2: Using bitwise operations to unpack instructions.</figcaption>
</figure>
<blockquote class="break-before">
<h3>Semi-realistic</h3>
<p>We always unpack two operands regardless of whether the instructions has them or not,
since this is what a hardware implementation would be.
We have also included assertions in our VM
to simulate the way that real hardware includes logic
to detect illegal instructions and out-of-bound memory addresses.</p>
</blockquote>
<p>The next step is to extend our base class with one that has a <code>run</code> method.
As its name suggests,
this runs the program by fetching instructions and executing them until told to stop:</p>
<div class="code-sample lang-js" title="vm.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">OPS</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./architecture.js'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./vm-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachine</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">arg1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">OPS</span><span class="p">.</span><span class="nx">hlt</span><span class="p">.</span><span class="nx">code</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="nx">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">OPS</span><span class="p">.</span><span class="nx">ldc</span><span class="p">.</span><span class="nx">code</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">arg1</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>


<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="sb">`Unknown op </span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">assertIsRegister</span><span class="w"> </span><span class="p">(</span><span class="nx">reg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">((</span><span class="mf">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">reg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">reg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Invalid register </span><span class="si">${</span><span class="nx">reg</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">assertIsAddress</span><span class="w"> </span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">((</span><span class="mf">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">addr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Invalid register </span><span class="si">${</span><span class="nx">addr</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachine</span><span class="w"></span>
</code></pre></div>
</div>
<p>Some instructions are very similar to others,
so we will only look at three here.
The first stores the value of one register in the address held by another register:</p>
<div class="code-sample lang-js" title="vm.js">
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">OPS</span><span class="p">.</span><span class="nx">str</span><span class="p">.</span><span class="nx">code</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsAddress</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg1</span><span class="p">],</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">ram</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg1</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg0</span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The first three lines check that the operation is legal;
the fourth one uses the value in one register as an address,
which is why it has nested array indexing.</p>
<p>Adding the value in one register to the value in another register is simpler:</p>
<div class="code-sample lang-js" title="vm.js">
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">OPS</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">code</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg1</span><span class="p">]</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">as is jumping to a fixed address if the value in a register is zero:</p>
<div class="code-sample lang-js" title="vm.js">
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">OPS</span><span class="p">.</span><span class="nx">beq</span><span class="p">.</span><span class="nx">code</span><span class="o">:</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsRegister</span><span class="p">(</span><span class="nx">arg0</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">assertIsAddress</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">arg0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">arg1</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="k">break</span><span class="w"></span>
</code></pre></div>
</div>
<h2 id="virtual-machine-assembly">Section 19.3: What do assembly programs look like?</h2>
<p>We could figure out numerical op codes by hand,
and in fact that's what <a href="http://eniacprogrammers.org/">the first programmers</a> did.
However,
it is much easier to use an <span class="ix-entry" ix-key="assembler" markdown="1"><a class="gl-ref" href="../glossary/#assembler" markdown="1">assembler</a></span>,
which is just a small compiler for a language that very closely represents actual machine instructions.</p>
<p>Each command in our assembly languages matches an instruction in the VM.
Here's an assembly language program to print the value stored in R1 and then halt:</p>
<div class="code-sample lang-as" title="print-r1.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Print</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">contents</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">R1</span><span class="p">.</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Its numeric representation is:</p>
<div class="code-sample lang-mx" title="print-r1.mx">
<div class="highlight"><pre><span></span><code>00010a
000001
</code></pre></div>
</div>
<p>One thing the assembly language has that the instruction set doesn't
is <span class="ix-entry" ix-key="label (on address)" markdown="1"><a class="gl-ref" href="../glossary/#label_address" markdown="1">labels on addresses</a></span>.
The label <code>loop</code> doesn't take up any space;
instead,
it tells the assembler to give the address of the next instruction a name
so that we can refer to that address as <code>@loop</code> in jump instructions.
For example,
this program prints the numbers from 0 to 2
(<a class="fig-ref" href="../virtual-machine/#virtual-machine-count-up">Figure 19.3</a>):</p>
<div class="code-sample lang-as" title="count-up.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-mx" title="count-up.mx">
<div class="highlight"><pre><span></span><code>000002
030102
00000a
010202
020006
010204
000207
020209
000001
</code></pre></div>
</div>
<figure id="virtual-machine-count-up">
<img alt="Counting from 0 to 2" src="./virtual-machine/count-up.svg"/>
<figcaption markdown="1">Figure 19.3: Flowchart of assembly language program to count up from 0 to 2.</figcaption>
</figure>
<p>Let's trace this program's execution
(<a class="fig-ref" href="../virtual-machine/#virtual-machine-trace-counter">Figure 19.4</a>):</p>
<ol>
<li>R0 holds the current loop index.</li>
<li>R1 holds the loop's upper bound (in this case 3).</li>
<li>The loop prints the value of R0 (one instruction).</li>
<li>The program adds 1 to R0.
    This takes two instructions because we can only add register-to-register.</li>
<li>It checks to see if we should loop again,
    which takes three instructions.</li>
<li>If the program <em>doesn't</em> jump back, it halts.</li>
</ol>
<figure id="virtual-machine-trace-counter">
<img alt="Trace counting program" src="./virtual-machine/trace-counter.svg"/>
<figcaption markdown="1">Figure 19.4: Tracing registers and memory values for a simple counting program.</figcaption>
</figure>
<p>The implementation of the assembler mirrors the simplicity of assembly language.
The main method gets interesting lines,
finds the addresses of labels,
and turns each remaining line into an instruction:</p>
<div class="code-sample lang-js" title="assembler.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">assemble</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cleanLines</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findLabels</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lines</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLabel</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instructions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">instr</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">instr</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">instructionsToText</span><span class="p">(</span><span class="nx">compiled</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">program</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">cleanLines</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">lines</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isComment</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">isComment</span><span class="w"> </span><span class="p">(</span><span class="nx">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To find labels,
we go through the lines one by one
and either save the label <em>or</em> increment the current address
(because labels don't take up space):</p>
<div class="code-sample lang-js" title="assembler.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">findLabels</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="nx">lines</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isLabel</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">result</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="sb">`Duplicate label </span><span class="si">${</span><span class="nx">label</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">index</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">isLabel</span><span class="w"> </span><span class="p">(</span><span class="nx">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To compile a single instruction we break the line into tokens,
look up the format for the operands,
and pack them into a single value:</p>
<div class="code-sample lang-js" title="assembler.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">compile</span><span class="w"> </span><span class="p">(</span><span class="nx">instruction</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instruction</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">OPS</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Unknown operation "</span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">fmt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">'--'</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">code</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">'r-'</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">          </span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">code</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">'rr'</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">]),</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">          </span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">code</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="w"></span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">'rv'</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="w"> </span><span class="nx">labels</span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"></span>
<span class="w">          </span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">code</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="w"></span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="sb">`Unknown instruction format </span><span class="si">${</span><span class="nx">OPS</span><span class="p">[</span><span class="nx">op</span><span class="p">].</span><span class="nx">fmt</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Combining op codes and operands into a single value
is the reverse of the unpacking done by the virtual machine:</p>
<div class="code-sample lang-js" title="assembler.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">combine</span><span class="w"> </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Cannot combine no arguments'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="nx">OP_SHIFT</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">a</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally, we need few utility functions:</p>
<div class="code-sample lang-js" title="assembler.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">instructionsToText</span><span class="w"> </span><span class="p">(</span><span class="nx">program</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="nx">OP_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="s1">'0'</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">register</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">token</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">'R'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Register "</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">" does not start with 'R'`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">((</span><span class="mf">0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">NUM_REG</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Illegal register </span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">value</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'@'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">labelName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">labelName</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">labels</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Unknown label "</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">labels</span><span class="p">[</span><span class="nx">labelName</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's try assembling a program and display its output,
the registers,
and the interesting contents of memory.
As a test,
this program counts up to three:</p>
<div class="code-sample lang-as" title="count-up.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">prr</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="count-up-out.out">
<div class="highlight"><pre><span></span><code>&gt;&gt; 0
&gt;&gt; 1
&gt;&gt; 2
R0 = 3
R1 = 3
R2 = 0
R3 = 0
0:   00000002  00030102  0000000a  00010202
4:   00020006  00010204  00000207  00020209
8:   00000001  00000000  00000000  00000000
</code></pre></div>
</div>
<h2 id="virtual-machine-data">Section 19.4: How can we store data?</h2>
<p>It is tedious to write interesting programs when each value needs a unique name.
We can do a lot more once we have collections like <span class="ix-entry" ix-key="array!implementation of" markdown="1">arrays</span>,
so let's add those to our assembler.
We don't have to make any changes to the virtual machine,
which doesn't care if we think of a bunch of numbers as individuals or elements of an array,
but we do need a way to create arrays and refer to them.</p>
<p>We will allocate storage for arrays at the end of the program
by using <code>.data</code> on a line of its own to mark the start of the data section
and then <code>label: number</code> to give a region a name and allocate some storage space
(<a class="fig-ref" href="../virtual-machine/#virtual-machine-storage-allocation">Figure 19.5</a>).</p>
<figure id="virtual-machine-storage-allocation">
<img alt="Storage allocation" src="./virtual-machine/storage-allocation.svg"/>
<figcaption markdown="1">Figure 19.5: Allocating storage for arrays in the virtual machine.</figcaption>
</figure>
<p>This enhancement only requires a few changes to the assembler.
First,
we need to split the lines into instructions and data allocations:</p>
<div class="code-sample lang-js" title="allocate-data.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">assemble</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">cleanLines</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">toCompile</span><span class="p">,</span><span class="w"> </span><span class="nx">toAllocate</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">splitAllocations</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findLabels</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">toCompile</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLabel</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseOfData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instructions</span><span class="p">.</span><span class="nx">length</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">addAllocations</span><span class="p">(</span><span class="nx">baseOfData</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">,</span><span class="w"> </span><span class="nx">toAllocate</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">compiled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">instructions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">instr</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">instr</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">instructionsToText</span><span class="p">(</span><span class="nx">compiled</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">program</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="allocate-data.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">splitAllocations</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lines</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">DIVIDER</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">split</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">lines</span><span class="p">,</span><span class="w"> </span><span class="p">[]]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">split</span><span class="p">),</span><span class="w"> </span><span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">split</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Second,
we need to figure out where each allocation lies and create a label accordingly:</p>
<div class="code-sample lang-js" title="allocate-data.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">addAllocations</span><span class="w"> </span><span class="p">(</span><span class="nx">baseOfData</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">,</span><span class="w"> </span><span class="nx">toAllocate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">toAllocate</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">alloc</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">alloc</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Invalid allocation directive "</span><span class="si">${</span><span class="nx">alloc</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">label</span><span class="p">,</span><span class="w"> </span><span class="nx">numWordsText</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fields</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">labels</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Duplicate label "</span><span class="si">${</span><span class="nx">label</span><span class="si">}</span><span class="sb">" in data allocation`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">numWords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">numWordsText</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="nx">baseOfData</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">numWords</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">RAM_LEN</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Allocation "</span><span class="si">${</span><span class="nx">label</span><span class="si">}</span><span class="sb">" requires too much memory`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="nx">labels</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseOfData</span><span class="w"></span>
<span class="w">      </span><span class="nx">baseOfData</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">numWords</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>And that's it:
no other changes are needed to either compilation or execution.
To test it,
let's fill an array with the numbers from 0 to 3:</p>
<div class="code-sample lang-as" title="fill-array.as">
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Count</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R0</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R1</span><span class="o">:</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">limit</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R2</span><span class="o">:</span><span class="w"> </span><span class="nx">array</span><span class="w"> </span><span class="nx">index</span><span class="p">.</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">R3</span><span class="o">:</span><span class="w"> </span><span class="nx">temporary</span><span class="p">.</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R1</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="err">@</span><span class="nx">array</span><span class="w"></span>
<span class="nx">loop</span><span class="o">:</span><span class="w"></span>
<span class="nx">str</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R2</span><span class="w"></span>
<span class="nx">ldc</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R0</span><span class="w"> </span><span class="nx">R3</span><span class="w"></span>
<span class="nx">add</span><span class="w"> </span><span class="nx">R2</span><span class="w"> </span><span class="nx">R3</span><span class="w"></span>
<span class="nx">cpy</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="nx">R1</span><span class="w"></span>
<span class="nx">sub</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="nx">R0</span><span class="w"></span>
<span class="nx">bne</span><span class="w"> </span><span class="nx">R3</span><span class="w"> </span><span class="err">@</span><span class="nx">loop</span><span class="w"></span>
<span class="nx">hlt</span><span class="w"></span>
<span class="p">.</span><span class="nx">data</span><span class="w"></span>
<span class="nx">array</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="fill-array-out.out">
<div class="highlight"><pre><span></span><code>R0 = 3
R1 = 3
R2 = 14
R3 = 0
0:   00000002  00030102  000b0202  00020005
4:   00010302  00030006  00030206  00010304
8:   00000307  00030309  00000001  00000000
c:   00000001  00000002  00000000  00000000
</code></pre></div>
</div>
<blockquote>
<h3>How does it actually work?</h3>
<p>Our VM is just another program.
If you'd like to know what happens when instructions finally meet hardware,
and how electrical circuits are able to do arithmetic,
make decisions,
and talk to the world,
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Patterson2017">Patterson2017</a>]</span> has everything you want to know and more.</p>
</blockquote>
<div class="break-before"></div>
<h2 id="virtual-machine-exercises">Section 19.5: Exercises</h2>
<h3 class="exercise">Swapping values</h3>
<p>Write an assembly language program that swaps the values in R1 and R2
without affecting the values in other registers.</p>
<h3 class="exercise">Reversing an array</h3>
<p>Write an assembly language program that starts with:</p>
<ul>
<li>the base address of an array in one word</li>
<li>the length of the array N in the next word</li>
<li>N values immediately thereafter</li>
</ul>
<p class="continue">and reverses the array in place.</p>
<h3 class="exercise">Increment and decrement</h3>
<ol>
<li>
<p>Add instructions <code>inc</code> and <code>dec</code> that add one to the value of a register
    and subtract one from the value of a register respectively.</p>
</li>
<li>
<p>Rewrite the examples to use these instructions.
    How much shorter do they make the programs?
    How much easier to read?</p>
</li>
</ol>
<h3 class="exercise">Using long addresses</h3>
<ol>
<li>
<p>Modify the virtual machine so that the <code>ldr</code> and <code>str</code> instructions
    contain 16-bit addresses rather than 8-bit addresses
    and increase the virtual machine's memory to 64K words to match.</p>
</li>
<li>
<p>How does this complicate instruction interpretation?</p>
</li>
</ol>
<h3 class="exercise">Operating on strings</h3>
<p>The C programming language stored character strings as non-zero bytes terminated by a byte containing zero.</p>
<ol>
<li>
<p>Write a program that starts with the base address of a string in R1
    and finishes with the length of the string (not including the terminator) in the same register.</p>
</li>
<li>
<p>Write a program that starts with the base address of a string in R1
    and the base address of some other block of memory in R2
    and copies the string to that new location (including the terminator).</p>
</li>
<li>
<p>What happens in each case if the terminator is missing?</p>
</li>
</ol>
<h3 class="exercise">Call and return</h3>
<ol>
<li>
<p>Add another register to the virtual machine called SP (for "stack pointer")
    that is automatically initialized to the <em>last</em> address in memory.</p>
</li>
<li>
<p>Add an instruction <code>psh</code> (short for "push") that copies a value from a register
    to the address stored in SP and then subtracts one from SP.</p>
</li>
<li>
<p>Add an instruction <code>pop</code> (short for "pop") that adds one to SP
    and then copies a value from that address into a register.</p>
</li>
<li>
<p>Using these instructions,
    write a subroutine that evaluates <code>2x+1</code> for every value in an array.</p>
</li>
</ol>
<h3 class="exercise break-before">Disassembling instructions</h3>
<p>A <a class="gl-ref" href="../glossary/#disassembler" markdown="1">disassembler</a> turns machine instructions into assembly code.
Write a disassembler for the instruction set used by our virtual machine.
(Since the labels for addresses are not stored in machine instructions,
disassemblers typically generate labels like <code>@L001</code> and <code>@L002</code>.)</p>
<h3 class="exercise">Linking multiple files</h3>
<ol>
<li>
<p>Modify the assembler to handle <code>.include filename</code> directives.</p>
</li>
<li>
<p>What does your modified assembler do about duplicate label names?
    How does it prevent infinite includes
    (i.e., <code>A.as</code> includes <code>B.as</code> which includes <code>A.as</code> again)?</p>
</li>
</ol>
<h3 class="exercise">Providing system calls</h3>
<p>Modify the virtual machine so that developers can add "system calls" to it.</p>
<ol>
<li>
<p>On startup,
    the virtual machine loads an array of functions defined in a file called <code>syscalls.js</code>.</p>
</li>
<li>
<p>The <code>sys</code> instruction takes a one-byte constant argument.
    It looks up the corresponding function and calls it with the values of R0-R3 as parameters
    and places the result in R0.</p>
</li>
</ol>
<h3 class="exercise">Unit testing</h3>
<ol>
<li>
<p>Write unit tests for the assembler.</p>
</li>
<li>
<p>Once they are working,
    write unit tests for the virtual machine.</p>
</li>
</ol>
</section>
<section class="new-chapter"><h1 id="debugger">Chapter: Chapter 20: Debugger</h1>

<p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#breakpoint" markdown="1">breakpoint</a>, <a class="gl-ref" href="../glossary/#source_map" markdown="1">source map</a>, <a class="gl-ref" href="../glossary/#tab_completion" markdown="1">tab completion</a>, <a class="gl-ref" href="../glossary/#watchpoint" markdown="1">watchpoint</a>
</p>
<p>We have finally come to one of the topics that sparked this book:
how does a <span class="ix-entry" ix-key="debugger" markdown="1">debugger</span> work?
(The other was layout engines, discussed in <a class="x-ref" href="#layout-engine">Chapter 11</a>.)
Debuggers are as much a part of good programmers' lives as version control
but are taught far less often
(in part, we believe, because it's harder to create homework questions for them).
In this chapter we will build a simple single-stepping debugger;
in doing so,
we will show one way to test interactive applications (<a class="x-ref" href="#unit-test">Chapter 4</a>).</p>
<h2 id="debugger-start">Section 20.1: What is our starting point?</h2>
<p>We would like to debug a higher-level language than the <span class="ix-entry" ix-key="assembly code" markdown="1">assembly code</span> of <a class="x-ref" href="#virtual-machine">Chapter 19</a>,
but we don't want to have to write a parser
or wrestle with the <span class="ix-entry" ix-key="abstract syntax tree" markdown="1">ASTs</span> of <a class="x-ref" href="#style-checker">Chapter 14</a>.
As a compromise,
we will represent programs as JSON data structures
whose element have the form <code>[command ...args]</code>:</p>
<div class="code-sample lang-json" title="filter-base.json">
<div class="highlight"><pre><span></span><code><span class="c1">// const a = [-3, -5, -1, 0, -2, 1, 3, 1]</span><span class="w"></span>
<span class="c1">// const b = Array()</span><span class="w"></span>
<span class="c1">// let largest = a[0]</span><span class="w"></span>
<span class="c1">// let i = 0</span><span class="w"></span>
<span class="c1">// while (i &lt; length(a)) {</span><span class="w"></span>
<span class="c1">//   if (a[i] &gt; largest) {</span><span class="w"></span>
<span class="c1">//     b.push(a[i])</span><span class="w"></span>
<span class="c1">//   }</span><span class="w"></span>
<span class="c1">//   i += 1</span><span class="w"></span>
<span class="c1">// }</span><span class="w"></span>
<span class="c1">// i = 0</span><span class="w"></span>
<span class="c1">// while (i &lt; length(b)) {</span><span class="w"></span>
<span class="c1">//   console.log(b[i])</span><span class="w"></span>
<span class="c1">//   i += 1</span><span class="w"></span>
<span class="c1">// }</span><span class="w"></span>

<span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"defA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"data"</span><span class="p">,</span><span class="w"> </span><span class="mi">-3</span><span class="p">,</span><span class="w"> </span><span class="mi">-5</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"defA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"data"</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"append"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"loop"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"lt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"len"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"gt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]],</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]]],</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s2">"append"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]]</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="s2">"loop"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"lt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"len"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s2">"print"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
<p>Our <span class="ix-entry" ix-key="virtual machine" markdown="1">virtual machine</span> is structured like the one in <a class="x-ref" href="#virtual-machine">Chapter 19</a>.
A real system would parse a program to create JSON,
then translate JSON into assembly code,
then assemble that to create machine instructions.
Again,
to keep things simple we will execute a program by
removing comments and blank lines
and then running commands by looking up the command name's and calling that method:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">program</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">program</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&gt;&gt;'</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">compile</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lines</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'//'</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">runAll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">runAll</span><span class="w"> </span><span class="p">(</span><span class="nx">commands</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">commands</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">command</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">command</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">exec</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">command</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Unknown op "</span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">op</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Remember, functions and methods are just another kind of data,
so if an object has a method called <code>"meth"</code>,
the expression <code>this["meth"]</code> looks it up
and <code>this["meth"](args)</code> calls it.
If <code>"meth"</code> is stored in a variable called <code>name</code>,
then <code>this[name](args)</code> will do exactly the same thing.</p>
<p>The method in our VM that defines a new variable with an initial value looks like this:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">defV</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkOp</span><span class="p">(</span><span class="s1">'defV'</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">args</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while the one that adds two values looks like this:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">add</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkOp</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">right</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Running a <code>while</code> loop is:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">loop</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkBody</span><span class="p">(</span><span class="s1">'loop'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">runAll</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and checking that a variable name refers to an array is:</p>
<div class="code-sample lang-js" title="vm-base.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">checkArray</span><span class="w"> </span><span class="p">(</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkName</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">array</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Variable "</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">" used in "</span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">" is not array`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>The other operations are similar to these.</p>
<h2 id="debugger-tracing">Section 20.2: How can we make a tracing debugger?</h2>
<p>The next thing we need in our debugger is
a <span class="ix-entry" ix-key="source map;debugger!source map" markdown="1"><a class="gl-ref" href="../glossary/#source_map" markdown="1">source map</a></span> that keeps track of
where in the source file each instruction came from.
Since JSON is a subset of JavaScript,
we could get line numbers by parsing our programs with <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span>.
However,
we would then have to scrape the information we want for this example out of the AST.
Since this chapter is supposed to be about debugging,
not parsing,
we will instead cheat and add a line number to each interesting statement by hand
so that our program looks like this:</p>
<div class="code-sample lang-json" title="filter-source-map.json">
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">"defA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"data"</span><span class="p">,</span><span class="w"> </span><span class="mi">-3</span><span class="p">,</span><span class="w"> </span><span class="mi">-5</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"defA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"data"</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s2">"append"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s2">"loop"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"lt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"len"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">]],</span><span class="w"></span>
<span class="w">   </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"gt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]],</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="s2">"append"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"largest"</span><span class="p">]]</span><span class="w"></span>
<span class="w">   </span><span class="p">],</span><span class="w"></span>
<span class="w">   </span><span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s2">"loop"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"lt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"len"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">]],</span><span class="w"></span>
<span class="w">   </span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s2">"print"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"b"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]]],</span><span class="w"></span>
<span class="w">   </span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
<p>Building the source map from that is simple;
for now,
we just modify <code>exec</code> to ignore the line number:</p>
<div class="code-sample lang-js" title="vm-source-map.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./vm-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineSourceMap</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VirtualMachineBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">compile</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">super</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sourceMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">original</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">command</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">command</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">transform</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">first</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">rest</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">'number'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">first</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">rest</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">arg</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">arg</span><span class="p">))]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rest</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sourceMap</span><span class="p">[</span><span class="nx">first</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">first</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">arg</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">arg</span><span class="p">))]</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">sourceMap</span><span class="p">[</span><span class="nx">first</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">exec</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">command</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Unknown op "</span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">op</span><span class="p">](</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineSourceMap</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>It's not really cheating</h3>
<p>We said that adding line numbers by hand was cheating,
but it isn't.
What we're actually doing is deferring a problem until we're sure we need to solve it.
If our approach is clumsy or fails outright because of some aspect of design we didn't foresee,
there will have been no point handling line numbers the "right" way.
A good rule for <span class="ix-entry" ix-key="software design!deferring problems" markdown="1">software design</span>
is to tackle the thing you're least sure about first,
using temporary code in place of what you think you'll eventually need.</p>
</blockquote>
<p>The next step is to modify the VM's <code>exec</code> method
so that it executes a callback function for each significant operation
(where "significant" means "we bothered to record its line number").
Since we're not sure what our debugger is going to need,
we give this callback the environment holding the current set of variables,
the line number,
and the operation being performed:</p>
<div class="code-sample lang-js" title="vm-callback.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">VirtualMachineSourceMap</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./vm-source-map.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineCallback</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VirtualMachineSourceMap</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">dbg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">program</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dbg</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbg</span><span class="p">.</span><span class="nx">setVM</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">exec</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">command</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbg</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Unknown op "</span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">op</span><span class="p">](</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">message</span><span class="w"> </span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbg</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">prefix</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">val</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineCallback</span><span class="w"></span>
</code></pre></div>
</div>
<p>We also modify the VM's constructor to record the debugger and give it a reference to the virtual machine
(<a class="fig-ref" href="../debugger/#debugger-initialization">Figure 20.1</a>).
We have to <span class="ix-entry" ix-key="mutual references" markdown="1">connect the two objects explicitly</span>
because each one needs a reference to the other,
but one of them has to be created first.
"A gets B then B tells A about itself" is a common pattern;
we will look at other ways to manage it in the exercises.</p>
<figure id="debugger-initialization">
<img alt="Initializing mutually-depending objects" src="./debugger/initialization.svg"/>
<figcaption markdown="1">Figure 20.1: Two-step initialization of mutually-dependent objects.</figcaption>
</figure>
<p>To run the program,
we create a debugger object and pass it to the VM's constructor:</p>
<div class="code-sample lang-js" title="run-debugger.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">readSource</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./read-source.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s1">'Usage: run-debugger.js ./vm ./debugger input|-'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">VM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">Debugger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">3</span><span class="p">])</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">inFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">4</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readSource</span><span class="p">(</span><span class="nx">inFile</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Debugger</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">VM</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span><span class="w"> </span><span class="nx">dbg</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">vm</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p>A simple debugger just traces interesting statements as they run:</p>
<div class="code-sample lang-js" title="debugger-trace.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">DebuggerBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./debugger-base.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DebuggerTrace</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">DebuggerBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">handle</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">lineNum</span><span class="si">}</span><span class="sb"> / </span><span class="si">${</span><span class="nx">op</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">env</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DebuggerTrace</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's try it on a program that adds the numbers in an array:</p>
<div class="code-sample lang-json" title="sum-source-map.json">
<div class="highlight"><pre><span></span><code><span class="c1">// const a = [-5, 1, 3]</span><span class="w"></span>
<span class="c1">// const total = 0</span><span class="w"></span>
<span class="c1">// let i = 0</span><span class="w"></span>
<span class="c1">// while (i &lt; length(a)) {</span><span class="w"></span>
<span class="c1">//   total += a[i]</span><span class="w"></span>
<span class="c1">//   i += 1</span><span class="w"></span>
<span class="c1">// }</span><span class="w"></span>
<span class="c1">// console.log(total)</span><span class="w"></span>

<span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s2">"defA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"data"</span><span class="p">,</span><span class="w"> </span><span class="mi">-5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"total"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s2">"defV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s2">"loop"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"lt"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"len"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">]],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"total"</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"total"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"getA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">]]]</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s2">"setV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"i"</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="s2">"num"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s2">"print"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"getV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"total"</span><span class="p">]]</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="sum-source-map-trace.out">
<div class="highlight"><pre><span></span><code>1 / defA: {}
2 / defV: {"a":[-5,1,3]}
3 / defV: {"a":[-5,1,3],"total":0}
4 / loop: {"a":[-5,1,3],"total":0,"i":0}
5 / setV: {"a":[-5,1,3],"total":0,"i":0}
8 / setV: {"a":[-5,1,3],"total":-5,"i":0}
5 / setV: {"a":[-5,1,3],"total":-5,"i":1}
8 / setV: {"a":[-5,1,3],"total":-4,"i":1}
5 / setV: {"a":[-5,1,3],"total":-4,"i":2}
8 / setV: {"a":[-5,1,3],"total":-1,"i":2}
10 / print: {"a":[-5,1,3],"total":-1,"i":3}
&gt;&gt; -1
</code></pre></div>
</div>
<h2 id="debugger-interactive">Section 20.3: How can we make the debugger interactive?</h2>
<p>What we have built so far is an always-on <code>print</code> statement.
To turn it into an interactive debugger,
we will use the <a href="https://www.npmjs.com/package/prompt-sync"><code>prompt-sync</code></a> module to manage user input
with the following set of commands:</p>
<ul>
<li>
<p><code>?</code> or <code>help</code> to list commands.</p>
</li>
<li>
<p><code>clear #</code> to clear a <a class="gl-ref" href="../glossary/#breakpoint" markdown="1">breakpoint</a> at a numbered line.</p>
</li>
<li>
<p><code>list</code> to list lines and breakpoints.</p>
</li>
<li>
<p><code>next</code> to go forward one line.</p>
</li>
<li>
<p><code>print name</code> to show a variable while at a breakpoint.</p>
</li>
<li>
<p><code>run</code> to run to the next breakpoint.</p>
</li>
<li>
<p><code>stop #</code> to break at a numbered line.</p>
</li>
<li>
<p><code>variables</code> to list all variable names.</p>
</li>
<li>
<p><code>exit</code> to exit immediately.</p>
</li>
</ul>
<p>When the virtual machine calls the debugger,
the debugger first checks whether or not it is on a numbered line.
If it isn't,
it hands control back to the VM.
Otherwise,
its action depends on our current state.
If we are single-stepping or if this line is a breakpoint,
Otherwise, it does nothing.</p>
<p>The overall structure of the interactive debugger is:</p>
<div class="code-sample lang-js" title="debugger-interactive.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">prompt</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'prompt-sync'</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">DebuggerBase</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./debugger-base.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">PROMPT_OPTIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sigint</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DebuggerInteractive</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">DebuggerBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">singleStep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">breakpoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s1">'?'</span><span class="o">:</span><span class="w"> </span><span class="s1">'help'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="s1">'clear'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">l</span><span class="o">:</span><span class="w"> </span><span class="s1">'list'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="o">:</span><span class="w"> </span><span class="s1">'next'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">p</span><span class="o">:</span><span class="w"> </span><span class="s1">'print'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="s1">'run'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">s</span><span class="o">:</span><span class="w"> </span><span class="s1">'stop'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">v</span><span class="o">:</span><span class="w"> </span><span class="s1">'variables'</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="s1">'exit'</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">handle</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">singleStep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">singleStep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">interact</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">breakpoints</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">lineNum</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">interact</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DebuggerInteractive</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">It interacts with users by lookup up a command and invoking the corresponding method,
just as the VM does:</p>
<div class="code-sample lang-js" title="debugger-interactive.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">interact</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">interacting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">interacting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCommand</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">continue</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">cmd</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">args</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">command</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cmd</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">interacting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">cmd</span><span class="p">](</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cmd</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">lookup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">interacting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">lookup</span><span class="p">[</span><span class="nx">cmd</span><span class="p">]](</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="sb">`unknown command </span><span class="si">${</span><span class="nx">command</span><span class="si">}</span><span class="sb"> (use '?' for help)`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">getCommand</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lookup</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`[</span><span class="si">${</span><span class="nx">lineNum</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">options</span><span class="si">}</span><span class="sb">] `</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">input</span><span class="w"> </span><span class="p">(</span><span class="nx">display</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">prompt</span><span class="p">(</span><span class="nx">PROMPT_OPTIONS</span><span class="p">)(</span><span class="nx">display</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<blockquote>
<h3>Learning as we go</h3>
<p>We didn't originally put the input and output in methods that could be overridden,
but realized later we needed to do this to make the debugger testable.
Rather than coming back and rewriting this,
we have done it here.</p>
</blockquote>
<p>With this structure in place,
the command handlers are pretty straightforward.
For example,
this method moves us to the next line:</p>
<div class="code-sample lang-js" title="debugger-interactive.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">next</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">singleStep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">while this one prints the value of a variable:</p>
<div class="code-sample lang-js" title="debugger-interactive.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">print</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">'p[rint] requires one variable name'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">env</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="sb">`unknown variable name "</span><span class="si">${</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">env</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]]))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>After using this for a few moments,
though
we realized that we needed to change the signature of the <code>loop</code> method.
We want to stop the loop each time it runs,
and need to know where we are.
We didn't allow for this in the base class,
and we don't want to have to change every method,
so we take advantage of the fact that JavaScript ignores any extra arguments passed to a method:</p>
<div class="code-sample lang-js" title="vm-interactive.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">VirtualMachineCallback</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./vm-callback.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineInteractive</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VirtualMachineCallback</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">loop</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkBody</span><span class="p">(</span><span class="s1">'loop'</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">dbg</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="s1">'loop'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">runAll</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineInteractive</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">This is sloppy, but it works;
we will tidy it up in the exercises.</p>
<h2 id="debugger-test">Section 20.4: How can we test an interactive application?</h2>
<p>How can we <span class="ix-entry" ix-key="unit test!interactive application" markdown="1">test</span> an interactive application like a debugger?
The answer is, "By making it non-interactive."
Like many tools over the past thirty years,
our approach is based on a program called <span class="ix-entry" ix-key="Expect" markdown="1"><a href="https://en.wikipedia.org/wiki/Expect">Expect</a></span>.
Our library replaces the input and output functions of the application being tested with callbacks,
then provides input when asked and checks output when it is given
(<a class="fig-ref" href="../debugger/#debugger-test-interact">Figure 20.2</a>).</p>
<figure id="debugger-test-interact">
<img alt="Testing interactive application" src="./debugger/test-interact.svg"/>
<figcaption markdown="1">Figure 20.2: Replacing input and output to test interactive applications.</figcaption>
</figure>
<p class="continue">The results look like this:</p>
<div class="code-sample lang-js" title="test-expect.js">
<div class="highlight"><pre><span></span><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'interactive debugger'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'runs and prints'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">setup</span><span class="p">(</span><span class="s1">'print-0.json'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'[1 ?clnprsvx] '</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'r'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'&gt;&gt; 0'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">done</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">'breaks and resumes'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">setup</span><span class="p">(</span><span class="s1">'print-3.json'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'[1 ?clnprsvx] '</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'s 3'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'[1 ?clnprsvx] '</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'r'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'&gt;&gt; 0'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'&gt;&gt; 1'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'[3 ?clnprsvx] '</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">done</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">})</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</div>
<p>Our <code>Expect</code> class may be short,
but it is hard to understand because it is so abstract:</p>
<div class="code-sample lang-js" title="expect.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'assert'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Expect</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">start</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="nx">subject</span><span class="p">.</span><span class="nx">setTester</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">send</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">'toSystem'</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="o">:</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">get</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">'fromSystem'</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="o">:</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Extra steps at end of test'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">toSystem</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s1">'toSystem'</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">fromSystem</span><span class="w"> </span><span class="p">(</span><span class="nx">actual</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s1">'fromSystem'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">,</span><span class="w"> </span><span class="nx">actual</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Expected "</span><span class="si">${</span><span class="nx">expected</span><span class="si">}</span><span class="sb">" got "</span><span class="si">${</span><span class="nx">actual</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">next</span><span class="w"> </span><span class="p">(</span><span class="nx">kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'Unexpected end of steps'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">kind</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Expected </span><span class="si">${</span><span class="nx">kind</span><span class="si">}</span><span class="sb">, got "</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">op</span><span class="si">}</span><span class="sb">"`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">arg</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Expect</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Piece by piece:</p>
<ul>
<li><code>subject</code> is the thing being tested.</li>
<li><code>start</code> is a callback to start the system running.
    It gives control to the subject,
    which then calls back into the test framework for input and output.</li>
<li><code>get</code> and <code>send</code> store things to be given to the subject
    and to be checked against its output.
    Both methods return <code>this</code> so that we can chain calls together.</li>
<li><code>run</code> starts the system
    and checks that all expected interactions have been used up when testing is done.</li>
<li><code>toSystem</code> and <code>fromSystem</code> use <code>next</code> to get the next test record,
    check its type,
    and return the string.</li>
</ul>
<p>Let's modify the debugger to use the tester,
keeping in mind that the prompt counts as an output
(and yes, we forgot this in the first version):</p>
<div class="code-sample lang-js" title="debugger-test.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">DebuggerInteractive</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./debugger-interactive.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DebuggerTest</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">DebuggerInteractive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">setTester</span><span class="w"> </span><span class="p">(</span><span class="nx">tester</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tester</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">input</span><span class="w"> </span><span class="p">(</span><span class="nx">display</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tester</span><span class="p">.</span><span class="nx">fromSystem</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tester</span><span class="p">.</span><span class="nx">toSystem</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">message</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tester</span><span class="p">.</span><span class="nx">fromSystem</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DebuggerTest</span><span class="w"></span>
</code></pre></div>
</div>
<p>Again,
we can't pass the tester as a constructor parameter because of initialization order,
so we write a <code>setup</code> function to make sure everything is connected the right way:</p>
<div class="code-sample lang-js" title="test-expect.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Expect</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../expect.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">VM</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../vm-interactive.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">Debugger</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../debugger-test.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">readSource</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'../read-source.js'</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">setup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readSource</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'debugger/test'</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Debugger</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">VM</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span><span class="w"> </span><span class="nx">dbg</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Expect</span><span class="p">(</span><span class="nx">dbg</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">vm</span><span class="p">.</span><span class="nx">run</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let's try running our tests:</p>
<div class="code-sample lang-sh" title="test-expect.sh">
<div class="highlight"><pre><span></span><code>npm run <span class="nb">test</span> -- -g <span class="s1">'interactive debugger'</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-expect.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "interactive debugger"



  interactive debugger
    ✓ runs and prints
</code></pre></div>
</div>
<p>That works---or does it?
Why is only one test shown,
and doesn't the summary appear?
After a bit of digging,
we realize that the debugger's <code>exit</code> command calls <code>process.exit</code> when the simulated program ends,
so the whole program including the VM, debugger, and test framework stops immediately
<em>before</em> the promises that contain the tests have run.</p>
<p>We could fix this by modifying the debugger callback
to return an indication of whether or not execution should continue,
then modify the VM to pay attention to that flag.
However,
this approach becomes very complicated when we have deeply-nested calls to <code>exec</code>,
which will happen with loops and conditionals.</p>
<p>A better alternative is to use an <span class="ix-entry" ix-key="exception!for control flow" markdown="1">exception for control flow</span>.
We can define our own kind of exception as an empty class:
it doesn't need any data
because we are only using it to get a typed object:</p>
<div class="code-sample lang-js" title="halt-exception.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">HaltException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">HaltException</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">Next,
we modify the debugger to throw this exception when asked to exit:</p>
<div class="code-sample lang-js" title="debugger-exit.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">HaltException</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./halt-exception.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">DebuggerTest</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./debugger-test.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DebuggerExit</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">DebuggerTest</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">exit</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">,</span><span class="w"> </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">op</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">HaltException</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DebuggerExit</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">And finally
we modify the VM to finish cleanly if this exception is thrown,
but re-throw any other kind of exception:</p>
<div class="code-sample lang-js" title="vm-exit.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">HaltException</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./halt-exception.js'</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">VirtualMachineInteractive</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./vm-interactive.js'</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachineExit</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VirtualMachineInteractive</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">runAll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">exc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">exc</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">HaltException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">exc</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VirtualMachineExit</span><span class="w"></span>
</code></pre></div>
</div>
<p>With these changes in place,
we are finally able to test our interactive debugger:</p>
<div class="code-sample lang-sh" title="test-exit.sh">
<div class="highlight"><pre><span></span><code>npm run <span class="nb">test</span> -- -g <span class="s1">'exitable debugger'</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-exit.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js "-g" "exitable debugger"



  exitable debugger
    ✓ runs and prints
    ✓ breaks and resumes


  2 passing (7ms)
</code></pre></div>
</div>
<div class="break-before"></div>
<h2 id="debugger-exercises">Section 20.5: Exercises</h2>
<h3 class="exercise">Implementing tab completion</h3>
<p>Read the documentation for <a href="https://www.npmjs.com/package/prompt-sync"><code>prompt-sync</code></a>
and then implement <a class="gl-ref" href="../glossary/#tab_completion" markdown="1">tab completion</a>
for the debugger.</p>
<h3 class="exercise">Modifying variables while running</h3>
<p>Add a <code>set</code> command that sets the value of a variable to a new value in a running program.
How do you handle setting array elements?</p>
<h3 class="exercise">Making output more readable</h3>
<p>Modify the tracing debugger so that
the statements inside loops and conditionals are indented for easier reading.</p>
<h3 class="exercise">Better loops</h3>
<p>Our solution for handling loops is sloppy; fix it.</p>
<h3 class="exercise">Using a flag to continue execution</h3>
<p>Modify the debugger and virtual machine to use a "continue executing" flag
rather than throwing an exception when execution should end.
Which approach is easier to understand?
Which will be easier to extend in future?</p>
<h3 class="exercise">Numbering lines</h3>
<p>Write a tool that takes a JSON program representation <em>without</em> statement numbers
and produces one that numbers all of the interesting statements for debugging purposes.
Use whatever definition of "interesting" you think would be most useful.</p>
<h3 class="exercise">Looping around again</h3>
<p>Implement a "next loop iteration" command that runs the program
until it reaches the current point in the next iteration of the current loop.</p>
<h3 class="exercise">Looking up objects</h3>
<p>Rather than having some objects call <code>setXYZ</code> methods in other objects,
it is common practice to use a lookup table for mutual dependencies:</p>
<ol>
<li>
<p>Every object initializes calls <code>table.set(name, this)</code> in its constructor.</p>
</li>
<li>
<p>Whenever object A needs the instance of object B,
    it calls <code>table.lookup('B')</code>.
    It does <em>not</em> store the result in a member variable.</p>
</li>
</ol>
<p>Modify the virtual machine and debugger to use this pattern.</p>
<h3 class="exercise">Watching for variable changes</h3>
<p>Modify the debugger and virtual machine to implement <a class="gl-ref" href="../glossary/#watchpoint" markdown="1">watchpoints</a>
that halt the program whenever the value of a variable changes.</p>
<h3 class="exercise break-before">Translating JSON to assembler</h3>
<p>Write a tool that translates the JSON program representation
into the assembly code of <a class="x-ref" href="#virtual-machine">Chapter 19</a>.
To simplify things,
increase the number of registers so that
there is always storage for intermediate results
when doing arithmetic.</p>
</section>
<section class="new-chapter"><h1 id="conclusion">Chapter: Chapter 21: Conclusion</h1>

<p>We have come a long way since we listed the contents of a directory in <a class="x-ref" href="#systems-programming">Chapter 2</a>.
Saving files in version control,
making sure code meets style rules,
debugging it and bundling it (hopefully in that order)---programmers do these things every day,
and we hope that understanding how they work will help you do them better.</p>
<p>We also hope that your journey won't stop here.
If you would like to add a chapter to this book
or translate it into another programming language,
human language,
or both,
your help would be very welcome:
please see the introduction in <a class="x-ref" href="#introduction">Chapter 1</a>
and the contributors' guide in <a class="x-ref" href="#contributing">Appendix C</a> for more information.</p>
<blockquote>
<p>We shape our tools, and thereafter our tools shape us.</p>
<p>--- Marshall McLuhan</p>
</blockquote>
</section><section class="new-chapter"><h1 id="license">Appendix: Appendix A: License</h1>

<p>All of the written material on this site is made available under the Creative
Commons - Attribution - NonCommercial 4.0 International license (CC-BY-NC-4.0),
while the software is made available under the Hippocratic License.</p>
<h2>Writing</h2>
<p><em>This is a human-readable summary of (and not a substitute for) the license.
For the full legal text of this license, please see
<a href="https://creativecommons.org/licenses/by-nc/4.0/legalcode">https://creativecommons.org/licenses/by-nc/4.0/legalcode</a>.</em></p>
<p>All of this site is made available under the terms of the Creative Commons
Attribution - NonCommercial 4.0 license. You are free to:</p>
<ul>
<li>
<p><strong>Share</strong> — copy and redistribute the material in any medium or format</p>
</li>
<li>
<p><strong>Adapt</strong> — remix, transform, and build upon the material</p>
</li>
<li>
<p>The licensor cannot revoke these freedoms as long as you follow the license
    terms.</p>
</li>
</ul>
<p>Under the following terms:</p>
<ul>
<li>
<p><strong>Attribution</strong> — You must give appropriate credit, provide a link to the
    license, and indicate if changes were made. You may do so in any reasonable
    manner, but not in any way that suggests the licensor endorses you or your
    use.</p>
</li>
<li>
<p><strong>NonCommercial</strong> — You may not use the material for commercial purposes.</p>
</li>
<li>
<p>No additional restrictions — You may not apply legal terms or technological
    measures that legally restrict others from doing anything the license
    permits.</p>
</li>
</ul>
<p>Notices:</p>
<p>You do not have to comply with the license for elements of the material in the
public domain or where your use is permitted by an applicable exception or
limitation.</p>
<p>No warranties are given. The license may not give you all of the permissions
necessary for your intended use. For example, other rights such as publicity,
privacy, or moral rights may limit how you use the material.</p>
<h2>Software</h2>
<p>Licensor hereby grants permission by this license ("License"), free of charge,
to any person or entity (the "Licensee") obtaining a copy of this software and
associated documentation files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use, copy, modify,
merge, publish, distribute, sublicense, and/or sell copies of the Software, and
to permit persons to whom the Software is furnished to do so, subject to the
following conditions:</p>
<ul>
<li>
<p>The above copyright notice and this License or a subsequent version published
    on the <a href="https://firstdonoharm.dev/">Hippocratic License Website</a> shall be
    included in all copies or substantial portions of the Software. Licensee has
    the option of following the terms and conditions either of the above
    numbered version of this License or of any subsequent version published on
    the Hippocratic License Website.</p>
</li>
<li>
<p>Compliance with Human Rights Laws and Human Rights Principles:</p>
<ol>
<li>
<p>Human Rights Laws. The Software shall not be used by any person or
    entity for any systems, activities, or other uses that violate any
    applicable laws, regulations, or rules that protect human, civil, labor,
    privacy, political, environmental, security, economic, due process, or
    similar rights (the "Human Rights Laws"). Where the Human Rights Laws of
    more than one jurisdiction are applicable to the use of the Software,
    the Human Rights Laws that are most protective of the individuals or
    groups harmed shall apply.</p>
</li>
<li>
<p>Human Rights Principles. Licensee is advised to consult the articles of
    the <a href="https://www.un.org/en/universal-declaration-human-rights/">United Nations Universal Declaration of Human
    Rights</a> and
    the <a href="https://www.unglobalcompact.org/what-is-gc/mission/principles">United Nations Global
    Compact</a>
    that define recognized principles of international human rights (the
    "Human Rights Principles"). It is Licensor's express intent that all use
    of the Software be consistent with Human Rights Principles. If Licensor
    receives notification or otherwise learns of an alleged violation of any
    Human Rights Principles relating to Licensee's use of the Software,
    Licensor may in its discretion and without obligation (i) (a) notify
    Licensee of such allegation and (b) allow Licensee 90 days from
    notification under (i)(a) to investigate and respond to Licensor
    regarding the allegation and (ii) (a) after the earlier of 90 days from
    notification under (i)(a), or Licensee's response under (i)(b), notify
    Licensee of License termination and (b) allow Licensee an additional 90
    days from notification under (ii)(a) to cease use of the Software.</p>
</li>
<li>
<p>Indemnity. Licensee shall hold harmless and indemnify Licensor against
    all losses, damages, liabilities, deficiencies, claims, actions,
    judgments, settlements, interest, awards, penalties, fines, costs, or
    expenses of whatever kind, including Licensor's reasonable attorneys'
    fees, arising out of or relating to Licensee's non-compliance with this
    License or use of the Software in violation of Human Rights Laws or
    Human Rights Principles.</p>
</li>
</ol>
</li>
<li>
<p>Enforceability: If any portion or provision of this License is determined to
     be invalid, illegal, or unenforceable by a court of competent jurisdiction,
     then such invalidity, illegality, or unenforceability shall not affect any
     other term or provision of this License or invalidate or render
     unenforceable such term or provision in any other jurisdiction. Upon a
     determination that any term or provision is invalid, illegal, or
     unenforceable, to the extent permitted by applicable law, the court may
     modify this License to affect the original intent of the parties as closely
     as possible. The section headings are for convenience only and are not
     intended to affect the construction or interpretation of this License. Any
     rule of construction to the effect that ambiguities are to be resolved
     against the drafting party shall not apply in interpreting this
     License. The language in this License shall be interpreted as to its fair
     meaning and not strictly for or against any party.</p>
</li>
</ul>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<p><em>The Hippocratic License is an <a href="https://ethicalsource.dev">Ethical Source license</a>.</em></p>
</section>
<section class="new-chapter"><h1 id="conduct">Appendix: Appendix B: Code of Conduct</h1>

<p>In the interest of fostering an open and welcoming environment, we as
contributors and maintainers pledge to making participation in our project and
our community a harassment-free experience for everyone, regardless of age, body
size, disability, ethnicity, gender identity and expression, level of
experience, education, socioeconomic status, nationality, personal appearance,
race, religion, or sexual identity and orientation.</p>
<h2>Our Standards</h2>
<p>Examples of behavior that contributes to creating a positive environment
include:</p>
<ul>
<li>using welcoming and inclusive language,</li>
<li>being respectful of differing viewpoints and experiences,</li>
<li>gracefully accepting constructive criticism,</li>
<li>focusing on what is best for the community, and</li>
<li>showing empathy towards other community members.</li>
</ul>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li>the use of sexualized language or imagery and unwelcome sexual
  attention or advances,</li>
<li>trolling, insulting/derogatory comments, and personal or political
  attacks,</li>
<li>public or private harassment,</li>
<li>publishing others' private information, such as a physical or
  electronic address, without explicit permission, and</li>
<li>other conduct which could reasonably be considered inappropriate in
  a professional setting</li>
</ul>
<h2>Our Responsibilities</h2>
<p>Project maintainers are responsible for clarifying the standards of acceptable
behavior and are expected to take appropriate and fair corrective action in
response to any instances of unacceptable behavior.</p>
<p>Project maintainers have the right and responsibility to remove, edit, or reject
comments, commits, code, wiki edits, issues, and other contributions that are
not aligned to this Code of Conduct, or to ban temporarily or permanently any
contributor for other behaviors that they deem inappropriate, threatening,
offensive, or harmful.</p>
<h2>Scope</h2>
<p>This Code of Conduct applies both within project spaces and in public spaces
when an individual is representing the project or its community. Examples of
representing a project or community include using an official project email
address, posting via an official social media account, or acting as an appointed
representative at an online or offline event. Representation of a project may be
further defined and clarified by project maintainers.</p>
<h2>Enforcement</h2>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be
reported by emailing the project team. All complaints will be reviewed
and investigated and will result in a response that is deemed necessary and
appropriate to the circumstances. The project team is obligated to maintain
confidentiality with regard to the reporter of an incident.  Further details of
specific enforcement policies may be posted separately.</p>
<p>Project maintainers who do not follow or enforce the Code of Conduct in good
faith may face temporary or permanent repercussions as determined by other
members of the project's leadership.</p>
<h2>Attribution</h2>
<p>This Code of Conduct is adapted from the <a href="https://www.contributor-covenant.org/">Contributor Covenant</a> version 1.4.</p>
</section>
<section class="new-chapter"><h1 id="contributing">Appendix: Appendix C: Contributing</h1>

<p>Contributions are very welcome;
please contact us by email or by filing an issue on this site.
All contributors must abide by our Code of Conduct.</p>
<h2>Making Decisions</h2>
<p>This project uses <a href="https://journals.sagepub.com/doi/10.1177/088610998600100206">Martha's Rules</a> for consensus decision making:</p>
<ol>
<li>
<p>Before each meeting, anyone who wishes may sponsor a proposal by filing an
    issue in the GitHub repository tagged "proposal".  People must file proposals
    at least 24 hours before a meeting in order for them to be considered at that
    meeting, and must include:</p>
<ul>
<li>a one-line summary (the subject line of the issue)</li>
<li>the full text of the proposal</li>
<li>any required background information</li>
<li>pros and cons</li>
<li>possible alternatives</li>
</ul>
</li>
<li>
<p>A quorum is established in a meeting if half or more of voting members are
    present.</p>
</li>
<li>
<p>Once a person has sponsored a proposal, they are responsible for it.  The
    group may not discuss or vote on the issue unless the sponsor or their
    delegate is present.  The sponsor is also responsible for presenting the
    item to the group.</p>
</li>
<li>
<p>After the sponsor presents the proposal, a "sense" vote is cast for the
    proposal before any discussion:</p>
<ul>
<li>Who likes the proposal?</li>
<li>Who can live with the proposal?</li>
<li>Who is uncomfortable with the proposal?</li>
</ul>
</li>
<li>
<p>If everyone likes or can live with the proposal, it passes immediately.</p>
</li>
<li>
<p>If most of the group is uncomfortable with the proposal, it is postponed for
    further rework by the sponsor.</p>
</li>
<li>
<p>Otherwise, members who are uncomfortable can briefly state their objections.
    A timer is then set for a brief discussion moderated by the facilitator.
    After 10 minutes or when no one has anything further to add (whichever comes
    first), the facilitator calls for a yes-or-no vote on the question: "Should
    we implement this decision over the stated objections?"  If a majority votes
    "yes" the proposal is implemented.  Otherwise, the proposal is returned to
    the sponsor for further work.</p>
</li>
</ol>
<h2>Formatting</h2>
<p>This material uses <a href="https://www.dmulholl.com/docs/ivy/dev/">Ivy</a> with some custom extensions.
Run <code>make</code> in the root directory to get a list of available commands.
Some of these rely on scripts in the <code>./bin/</code> directory.</p>
<h3>Chapters and Appendices</h3>
<ol>
<li>
<p>Each chapter or appendix has a unique slug such as <code>topic</code>.
    Its text lives in <code>./src/<em>topic</em>/index.md</code>,
    and there is an entry for it in the <code>chapters</code> or <code>appendices</code> list in <code>./config.py</code>
    (which control ordering).</p>
</li>
<li>
<p>Each <code>index.md</code> file starts with a YAML header in triple dashes.
    This header must include the key <code>title:</code> with the page's title.</p>
</li>
<li>
<p>Each section within a page must use a heading like this:</p>
<div class="highlight"><pre><span></span><code><span class="gu">## Some Title {: #topic-sometitle}</span>
</code></pre></div>
<p>This creates an <code>h2</code>-level heading with the HTML ID <code>topic-sometitle</code>.
Use the page's slug instead of <code>topic</code> and a single unhyphenated work
in place of <code>sometitle</code>.</p>
</li>
<li>
<p>To create a cross-reference to a chapter or appendix write:</p>
<div class="highlight"><pre><span></span><code>[% x topic %]
</code></pre></div>
<p>where <code>topic</code> is the slug of the chapter being referred to.
This shortcode is converted to <code>Chapter N</code> or <code>Appendix N</code> as appropriate.
Please only refer to chapters or appendices, not to sections.</p>
</li>
</ol>
<h3>External Links</h3>
<ol>
<li>
<p>The table of external links lives in <code>./info/links.yml</code>.
    Please add entries as needed.</p>
</li>
<li>
<p>To refer to an external link write:</p>
<div class="highlight"><pre><span></span><code>[<span class="nt">body text</span>][<span class="nl">link_key</span>]
</code></pre></div>
</li>
</ol>
<p>Please do <em>not</em> add links directly with <code>[text](http://some.url)</code>:
keeping the links in <code>./info/links.yml</code> ensures consistency
and makes it easier to create a table of external links.</p>
<h3>Code Inclusions</h3>
<ol>
<li>
<p>To include an entire file as a code sample write:</p>
<div class="highlight"><pre><span></span><code>[% inc file="some_name.py" %]
</code></pre></div>
<p>The file must be in or below the directory containing the Markdown file.</p>
</li>
<li>
<p>To include only part of a file write:</p>
<div class="highlight"><pre><span></span><code>[% inc file="some_name.py" keep="some_key" %]
</code></pre></div>
<p>and put matching tags in the file like this:</p>
<div class="highlight"><pre><span></span><code><span class="gh"># [some_key]</span>
…lines of code…
<span class="gh"># [/some_key]</span>
</code></pre></div>
</li>
<li>
<p>To include several files (such as a program and its output) write:</p>
<div class="highlight"><pre><span></span><code>[% inc pat="some_stem.*" fill="py out" %]
</code></pre></div>
<p>This includes <code>some_stem.py</code> and <code>some_stem.out</code> in that order.</p>
</li>
</ol>
<h3>Figures</h3>
<ol>
<li>
<p>Put the image file in the same directory as the chapter or appendix
    and use this to include it:</p>
<div class="highlight"><pre><span></span><code>[% figure
   slug="topic-someword"
   img="filename.svg"
   caption="Short sentence-case caption."
   alt="Long text describing the figure for the benefit of visually impaired readers."
%]
</code></pre></div>
</li>
<li>
<p>To refer to a figure write:</p>
<div class="highlight"><pre><span></span><code>[% f topic-someword %]
</code></pre></div>
<p>This is converted to <code>Figure N.K</code>.</p>
</li>
<li>
<p>Use <a href="https://www.diagrams.net/">diagrams.net</a> to create SVG diagrams
    using the "sketch" style and a 12-point Comic Sans font.</p>
</li>
<li>
<p>Avoid screenshots if at all possible:
    making them display correctly in print is difficult.</p>
</li>
</ol>
<h3>Tables</h3>
<p>The Markdown processor used by <a href="https://www.dmulholl.com/docs/ivy/dev/">Ivy</a> doesn't support attributes on tables,
so we must do something a bit clumsy.</p>
<ol>
<li>
<p>To create a table write:</p>
<div class="highlight"><pre><span></span><code>&lt;div class="table" id="topic-someword" caption="Short sentence-case caption." markdown="1"&gt;
| Left | Middle | Right |
| ---- | ------ | ----- |
| blue | orange | green |
| mars | saturn | venus |
&lt;/div&gt;
</code></pre></div>
</li>
<li>
<p>To refer to a table write:</p>
<div class="highlight"><pre><span></span><code>[% t topic-someword %]
</code></pre></div>
<p>This is converted to <code>Table N.K</code>.</p>
</li>
</ol>
<h3>Bibliography</h3>
<ol>
<li>
<p>The BibTeX bibliography lives in <code>./info/bibliography.bib</code>.
    Please add entries as needed;
    you may find <a href="https://doi2bib.org">https://doi2bib.org</a> useful for creating entries.
    Please format keys as <code>Author1234</code>,
    where <code>Author</code> is the first author's family name
    and <code>1234</code> is the year of publication.
    (Use <code>Author1234a</code>, <code>Author1234b</code>, etc. to resolve conflicts.)</p>
</li>
<li>
<p>To cite bibliography entries write:</p>
<div class="highlight"><pre><span></span><code>[% b key1 key2 key3 %]
</code></pre></div>
</li>
</ol>
<h3>Glossary</h3>
<p>Please do not worry about adding entries for now;
we will fill in the glossary during the final editing pass.</p>
<ol>
<li>
<p>The glossary lives in <code>./info/glossary.yml</code> and uses <a href="https://github.com/carpentries/glosario">Glosario</a> format.</p>
</li>
<li>
<p>To cite glossary entries write:</p>
<div class="highlight"><pre><span></span><code>[% g some_key "text for document" %]
</code></pre></div>
</li>
</ol>
<h3>Index</h3>
<p>Please do not worry about adding entries for now;
we will fill in the index during the final editing pass.</p>
<ol>
<li>
<p>To create a simple index entry write:</p>
<div class="highlight"><pre><span></span><code>[% i "index text" %]body text[% /i %]
</code></pre></div>
</li>
<li>
<p>Separate multiple index entries with semi-colons:</p>
<div class="highlight"><pre><span></span><code>[% i "first; second; third" %]body text[% /i %]
</code></pre></div>
</li>
<li>
<p>Create sub-entries using <code>!</code>:</p>
<div class="highlight"><pre><span></span><code>[% i "major!minor" %]body text[% /i %]
</code></pre></div>
</li>
</ol>
<h3>Minor Formatting</h3>
<ol>
<li>
<p>To continue a paragraph after a code sample write:</p>
<div class="highlight"><pre><span></span><code>text of paragraph
which can span multiple lines
{: .continue}
</code></pre></div>
<p>This has no effect on the appearance of the HTML,
but prevents an unwanted paragraph indent in the PDF version.</p>
</li>
<li>
<p>To create a callout box, use:</p>
<div class="highlight"><pre><span></span><code>&lt;div class="callout" markdown="1"&gt;

### Title of callout

text of callout

&lt;/div&gt;
</code></pre></div>
<p>Use "Sentence case" for the callout's title,
and please put blank lines before and after the opening and closing <code>&lt;div&gt;</code> markers.
You <em>must</em> include <code>markdown="1"</code> in the opening <code>&lt;div&gt;</code> tag
to ensure that Markdown inside the callout is processed.</p>
<p>Note: earlier versions of this template used <code>blockquote</code> rather than <code>div</code> callouts.
Please only use the former for actual quotations.</p>
</li>
</ol>
<h2>Building the PDF</h2>
<p>We use LaTeX to build the PDF version of this book.
Please don't worry about this for now,
but if you want to see what the print version will look like
you will need to install this packages:</p>
<ul>
<li><code>babel-english</code></li>
<li><code>babel-greek</code></li>
<li><code>cbfonts</code></li>
<li><code>enumitem</code></li>
<li><code>greek-fontenc</code></li>
<li><code>keystroke</code></li>
<li><code>listings</code></li>
<li><code>textgreek</code></li>
<li><code>tocbibind</code></li>
</ul>
</section>
<section class="new-chapter"><h1 id="bibliography">Appendix: Appendix D: Bibliography</h1>

<dl class="bib-list">
<dt id="Binkley2012">Binkley2012</dt>
<dd>Dave Binkley, Marcia Davis, Dawn Lawrie, Jonathan I. Maletic, Christopher Morrell, and Bonita Sharif.
The impact of identifier style on effort and comprehension.
<em>ESE</em>, 2012.
<a href="https://doi.org/10.1007/s10664-012-9201-4">doi:10.1007/s10664-012-9201-4</a>.</dd>
<dt id="Brand1995">Brand1995</dt>
<dd>Stewart Brand.
<em>How Buildings Learn: What Happens After They're Built</em>.
Penguin USA, 1995.
ISBN 978-0140139969.</dd>
<dt id="Brown2011">Brown2011</dt>
<dd>Amy Brown and Greg Wilson, editors.
<em>The Architecture of Open Source Applications: Elegance, Evolution, and a Few Fearless Hacks</em>.
Lulu, 2011.
ISBN 978-1257638017.</dd>
<dt id="Brown2012">Brown2012</dt>
<dd>Amy Brown and Greg Wilson, editors.
<em>The Architecture of Open Source Applications: Structure, Scale, and a Few More Fearless Hacks</em>.
Lulu, 2012.
ISBN 978-0201103427.</dd>
<dt id="Brown2016">Brown2016</dt>
<dd>Amy Brown and Michael DiBernardo, editors.
<em>500 Lines or Less: Experienced Programmers Solve Interesting Problems</em>.
Lulu, 2016.
ISBN 978-1329871274.</dd>
<dt id="Casciaro2020">Casciaro2020</dt>
<dd>Mario Casciaro and Luciano Mammino.
<em>Node.js Design Patterns</em>.
Packt, 2020.
ISBN 978-1839214110.</dd>
<dt id="Conery2021">Conery2021</dt>
<dd>Rob Conery.
<em>The Imposter's Handbook: A CS Primer for Self-Taught Developers</em>.
Independently published, 2021.
ISBN 978-8708185266.</dd>
<dt id="Davis2018">Davis2018</dt>
<dd>Ashley Davis.
<em>Data Wrangling with JavaScript</em>.
Manning, 2018.
ISBN 978-1617294846.</dd>
<dt id="Feathers2004">Feathers2004</dt>
<dd>Michael C. Feathers.
<em>Working Effectively with Legacy Code</em>.
Prentice-Hall, 2004.
ISBN 978-0131177055.</dd>
<dt id="Fucci2016">Fucci2016</dt>
<dd>Davide Fucci, Giuseppe Scanniello, Simone Romano, Martin Shepperd, Boyce Sigweni, Fernando Uyaguari, Burak Turhan, Natalia Juristo, and Markku Oivo.
An external replication on the effects of test-driven development using a multi-site blind analysis approach.
In <em>Proc. ESEM'16</em>. ACM Press, 2016.
<a href="https://doi.org/10.1145/2961111.2962592">doi:10.1145/2961111.2962592</a>.</dd>
<dt id="Fucci2017">Fucci2017</dt>
<dd>Davide Fucci, Hakan Erdogmus, Burak Turhan, Markku Oivo, and Natalia Juristo.
A dissection of the test-driven development process: does it really matter to test-first or to test-last?
<em>TSE</em>, 7 2017.
<a href="https://doi.org/10.1109/tse.2016.2616877">doi:10.1109/tse.2016.2616877</a>.</dd>
<dt id="Gregg2020">Gregg2020</dt>
<dd>Brendan Gregg.
<em>Systems Performance: Enterprise and the Cloud</em>.
Pearson, 2020.
ISBN 978-0136820154.</dd>
<dt id="Johnson2019">Johnson2019</dt>
<dd>John Johnson, Sergio Lubo, Nishitha Yedla, Jairo Aponte, and Bonita Sharif.
An empirical study assessing source code readability in comprehension.
In <em>Proc. ICSME'19</em>. 2019.
<a href="https://doi.org/10.1109/ICSME.2019.00085">doi:10.1109/ICSME.2019.00085</a>.</dd>
<dt id="Kernighan1979">Kernighan1979</dt>
<dd>Brian W. Kernighan and P. J. Plauger.
<em>The Elements of Programming Style</em>.
McGraw-Hill, 1979.
ISBN 978-0070342071.</dd>
<dt id="Kernighan1981">Kernighan1981</dt>
<dd>Brian W. Kernighan and P. J. Plauger.
<em>Software Tools in Pascal</em>.
Addison-Wesley Professional, 1981.
ISBN 978-0201103427.</dd>
<dt id="Kernighan1983">Kernighan1983</dt>
<dd>Brian W. Kernighan and Rob Pike.
<em>The Unix Programming Environment</em>.
Prentice-Hall, 1983.
ISBN 978-0139376818.</dd>
<dt id="Kernighan1988">Kernighan1988</dt>
<dd>Brian W. Kernighan and Dennis M. Ritchie.
<em>The C Programming Language</em>.
Prentice-Hall, 1988.
ISBN 978-0131103627.</dd>
<dt id="Kohavi2020">Kohavi2020</dt>
<dd>Ron Kohavi, Diane Tang, and Ya Xu.
<em>Trustworthy Online Controlled Experiments: A Practical Guide to A/B Testing</em>.
Cambridge University Press, 2020.
ISBN 978-1108724265.</dd>
<dt id="Meszaros2007">Meszaros2007</dt>
<dd>Gerard Meszaros.
<em>xUnit Test Patterns: Refactoring Test Code</em>.
Addison-Wesley, 2007.
ISBN 978-0131495050.</dd>
<dt id="Oram2007">Oram2007</dt>
<dd>Andy Oram and Greg Wilson, editors.
<em>Beautiful Code: Leading Programmers Explain How They Think</em>.
O'Reilly, 2007.
ISBN 978-0596510046.</dd>
<dt id="Osmani2017">Osmani2017</dt>
<dd>Addy Osmani.
Learning javascript design patterns.
2017.
URL: <a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/">https://addyosmani.com/resources/essentialjsdesignpatterns/book/</a>.</dd>
<dt id="Patterson2017">Patterson2017</dt>
<dd>David A. Patterson and John L. Hennessy.
<em>Computer Organization and Design: The Hardware/Software Interface</em>.
Morgan Kaufmann, 2017.
ISBN 978-0128122754.</dd>
<dt id="Petre2016">Petre2016</dt>
<dd>Marian Petre and André van der Hoek.
<em>Software Design Decoded: 66 Ways Experts Think</em>.
MIT Press, 2016.
ISBN 978-0262035187.</dd>
<dt id="Petzold2008">Petzold2008</dt>
<dd>Charles Petzold.
<em>The Annotated Turing</em>.
Wiley, 2008.
ISBN 978-0470229057.</dd>
<dt id="Schon1984">Schon1984</dt>
<dd>Donald A. Schon.
<em>The Reflective Practitioner: How Professionals Think in Action</em>.
Basic Books, 1984.
ISBN 978-0465068784.</dd>
<dt id="Smith2011">Smith2011</dt>
<dd>Peter Smith.
<em>Software Build Systems: Principles and Experience</em>.
Addison-Wesley Professional, 2011.
ISBN 978-0134185965.</dd>
<dt id="Taschuk2017">Taschuk2017</dt>
<dd>Morgan Taschuk and Greg Wilson.
Ten simple rules for making research software more robust.
<em>PLoS Comp Bio</em>, 4 2017.
<a href="https://doi.org/10.1371/journal.pcbi.1005412">doi:10.1371/journal.pcbi.1005412</a>.</dd>
<dt id="Tudose2020">Tudose2020</dt>
<dd>Cătălin Tudose.
<em>JUnit in Action</em>.
Manning, 2020.
ISBN 978-1617297045.</dd>
</dl>
</section>
<section class="new-chapter"><h1 id="glossary">Appendix: Appendix E: Glossary</h1>

<div class="glossary">
<dl>
<dt><span class="gl-key" id="absolute_error">absolute error</span></dt>
<dd>The absolute value of the difference between the observed and the correct value. Absolute error is usually less useful than <a href="#relative_error">relative error</a>.</dd>
<dt><span class="gl-key" id="absolute_path">absolute path</span></dt>
<dd>A path that points to the same location in the <a href="#filesystem">filesystem</a> regardless of where it is evaluated. An absolute path is the equivalent of latitude and longitude in geography.</dd>
<dt><span class="gl-key" id="abstract_method">abstract method</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#method">method</a> that is defined but not implemented. Programmers will define an abstract method in a <a href="#parent_class">parent class</a> to specify operations that <a href="#child_class">child classes</a> must provide.</dd>
<dt><span class="gl-key" id="abstract_syntax_tree">abstract syntax tree</span> (AST)</dt>
<dd>A deeply nested data structure, or <a href="#tree">tree</a>, that represents the structure of a program. For example, the AST might have a <a href="#node">node</a> representing a <code>while</code> loop with one <a href="#child_tree">child</a> representing the loop condition and another representing the <a href="#loop_body">loop body</a>.</dd>
<dt><span class="gl-key" id="accidental_complexity">accidental complexity</span></dt>
<dd>The extra (avoidable) complexity introduced by poor design choices. The term is used in contrast with <a href="#intrinsic_complexity">intrinsic complexity</a>.</dd>
<dt><span class="gl-key" id="accumulator">accumulator</span></dt>
<dd>A variable that collects and/or combines many values.  For example, if a program sums the values in an array by adding them all to a variable called <code>result</code>, then <code>result</code> is the accumulator.</dd>
<dt><span class="gl-key" id="actual_result">actual result (of test)</span></dt>
<dd>The value generated by running code in a test. If this matches the <a href="#expected_result">expected result</a>, the test <a href="#pass_test">passes</a>; if the two are different, the test <a href="#fail_test">fails</a>.</dd>
<dt><span class="gl-key" id="adapter_pattern">Adapter pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> that rearranges parameters, provides extra values, or does other work so that one function can be called by another.</dd>
<dt><span class="gl-key" id="alias">alias</span></dt>
<dd>A second or subsequent reference to the same object. Aliases are useful, but increase the <a href="#cognitive_load">cognitive load</a> on readers who have to remember that all these names refer to the same thing.</dd>
<dt><span class="gl-key" id="anonymous_function">anonymous function</span></dt>
<dd>A function that has not been assigned a name. Anonymous functions are usually quite short, and are usually defined where they are used, e.g., as callbacks. In Python, these are called lambda functions and are created through use of the lambda reserved word.</dd>
<dt><span class="gl-key" id="abi">Application Binary Interface</span> (ABI)</dt>
<dd>The low-level layout that a piece of software must have to work on a particular kind of machine.</dd>
<dt><span class="gl-key" id="api">Application Programming Interface</span> (API)</dt>
<dd>A set of functions provided by a software library or web service that other software can call.</dd>
<dt><span class="gl-key" id="argument">argument</span></dt>
<dd>A value passed to a function when it is called.</dd>
<dt><span class="gl-key" id="ascii">ASCII</span></dt>
<dd>A standard way to represent the characters commonly used in the Western European languages as 7- or 8-bit integers, now largely superceded by <a href="#unicode">Unicode</a>.</dd>
<dt><span class="gl-key" id="assembler">assembler</span></dt>
<dd>A <a href="#compiler">compiler</a> that translates software written in <a href="#assembly_code">assembly code</a> into machine instructions.</dd>
<dt><span class="gl-key" id="assembly_code">assembly code</span></dt>
<dd>A low-level programming language whose statements correspond closely to the actual <a href="#instruction_set">instruction set</a> of a particular kind of processor.</dd>
<dt><span class="gl-key" id="assertion">assertion</span></dt>
<dd>A <a href="#boolean">Boolean</a> expression that must be true at a certain point in a program. Assertions may be built into the language (e.g., Python's <code>assert</code> statement) or provided as functions (as with Node's <code>assert</code> library).</dd>
<dt><span class="gl-key" id="associative_array">associative array</span></dt>
<dd>See <a href="#dictionary">dictionary</a>.</dd>
<dt><span class="gl-key" id="asynchronous">asynchronous</span></dt>
<dd>Not happening at the same time. In programming, an asynchronous operation is one that runs independently of another, or that starts at one time and ends at another.</dd>
<dt><span class="gl-key" id="attribute">attribute</span></dt>
<dd>A name-value pair associated with an object, used to store metadata about the object such as an array's dimensions.</dd>
<dt><span class="gl-key" id="automatic_variable">automatic variable</span></dt>
<dd>A variable that is automatically given a value in a <a href="#build_rule">build rule</a>. For example, Make automatically assigns the name of a rule's <a href="#build_target">target</a> to the automatic variable <code>$@</code>. Automatic variables are frequently used when writing <a href="#pattern_rule">pattern rules</a>.</dd>
<dt><span class="gl-key" id="backward_compatible">backward-compatible</span></dt>
<dd>A property of a system that enables interoperability with an older legacy system, or with input designed for such a system.</dd>
<dt><span class="gl-key" id="bare_object">bare object</span></dt>
<dd>An object that isn't an instance of any particular class.</dd>
<dt><span class="gl-key" id="base_class">base class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#class">class</a> from which other classes are derived.</dd>
<dt><span class="gl-key" id="binary">binary</span></dt>
<dd>A system which can have one of two possible states, often represented as 0 and 1 or true and false.</dd>
<dt><span class="gl-key" id="bit">bit</span></dt>
<dd>A single binary digit (0 or 1).</dd>
<dt><span class="gl-key" id="bitwise_operation">bitwise operation</span></dt>
<dd>An operation that manipulates individual bits in memory. Common bitwise operations include <code>and</code>, <code>or</code>, <code>not</code>, and <code>xor</code>.</dd>
<dt><span class="gl-key" id="block_comment">block comment</span></dt>
<dd>A <a href="#comment">comment</a> that spans multiple lines. Block comments may be marked with special start and end symbols, like <code>/*</code> and <code>*/</code> in C and its descendents, or each line may be prefixed with a marker like <code>#</code>.</dd>
<dt><span class="gl-key" id="boolean">Boolean</span></dt>
<dd>Relating to a variable or data type that can have either a logical value of true or false. Named for George Boole, a 19th century mathematician.</dd>
<dt><span class="gl-key" id="breadth_first">breadth first</span></dt>
<dd>To go through a nested data structure such as a <a href="#tree">tree</a> by exploring all of one level, then going on to the next level and so on, or to explore a problem by examining the first step of each possible solution, and then trying the next step for each.</dd>
<dt><span class="gl-key" id="breakpoint">breakpoint</span></dt>
<dd>An instruction to a debugger telling it to suspend execution whenever a specific point in the program (such as a particular line) is reached.</dd>
<dt><span class="gl-key" id="bug">bug</span></dt>
<dd>A missing or undesirable <a href="#feature_software">feature</a> of a piece of software.</dd>
<dt><span class="gl-key" id="build_manager">build manager</span></dt>
<dd>A program that keeps track of how files depend on one another and runs commands to update any files that are out-of-date. Build managers were invented to <a href="#compile">compile</a> only those parts of programs that had changed, but are now often used to implement workflows in which plots depend on results files, which in turn depend on raw data files or configuration files.</dd>
<dt><span class="gl-key" id="build_recipe">build recipe</span></dt>
<dd>The part of a <a href="#build_rule">build rule</a> that describes how to update something that has fallen out-of-date.</dd>
<dt><span class="gl-key" id="build_rule">build rule</span></dt>
<dd>A specification for a <a href="#build_manager">build manager</a> that describes how some files depend on others and what to do if those files are out-of-date.</dd>
<dt><span class="gl-key" id="build_target">build target</span></dt>
<dd>The file(s) that a <a href="#build_rule">build rule</a> will update if they are out-of-date compared to their <a href="#dependency">dependencies</a>.</dd>
<dt><span class="gl-key" id="byte_code">byte code</span></dt>
<dd>A set of instructions designed to be executed efficiently by an <a href="#interpreter">interpreter</a>.</dd>
<dt><span class="gl-key" id="cache">cache</span></dt>
<dd>Something that stores copies of data so that future requests for it can be satisfied more quickly. The CPU in a computer uses a hardware cache to hold recently-accessed values; many programs rely on a software cache to reduce network traffic and latency. Figuring out when something in a cache is out-of-date and should be replaced is one of the <a href="#two_hard_problems">two hard problems in computer science</a>.</dd>
<dt><span class="gl-key" id="caching">caching</span></dt>
<dd>To save a copy of some data in a local <a href="#cache">cache</a> to make future access faster.</dd>
<dt><span class="gl-key" id="call_stack">call stack</span></dt>
<dd>A data structure that stores information about the active subroutines executed.</dd>
<dt><span class="gl-key" id="callback">callback function</span></dt>
<dd>A function A that is passed to another function B so that B can call it at some later point. Callbacks can be used <a href="#synchronous">synchronously</a>, as in generic functions like <code>map</code> that invoke a callback function once for each element in a collection, or <a href="#asynchronous">asynchronously</a>, as in a <a href="#client">client</a> that runs a callback when a <a href="#http_response">response</a> is received in answer to a <a href="#http_request">request</a>.</dd>
<dt><span class="gl-key" id="css">Cascading Style Sheets</span> (CSS)</dt>
<dd>A way to control the appearance of HTML. CSS is typically used to specify fonts, colors, and layout.</dd>
<dt><span class="gl-key" id="catch_exception">catch (an exception)</span></dt>
<dd>To handle an error or other unexpected event represented by an <a href="#exception">exception</a>.</dd>
<dt><span class="gl-key" id="chain_of_responsibility_pattern">Chain of Responsibility pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which each <a href="#object">object</a> either handles a request or passes it on to another object.</dd>
<dt><span class="gl-key" id="character_encoding">character encoding</span></dt>
<dd>A specification of how characters are stored as bytes. The most commonly-used encoding today is <a href="#utf_8">UTF-8</a>.</dd>
<dt><span class="gl-key" id="child_tree">child (in a tree)</span></dt>
<dd>A <a href="#node">node</a> in a <a href="#node">tree</a> that is below another node (call the <a href="#parent_tree">parent</a>).</dd>
<dt><span class="gl-key" id="child_class">child class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a <a href="#class">class</a> derived from another class (called the <a href="#parent_class">parent class</a>).</dd>
<dt><span class="gl-key" id="circular_dependency">circular dependency</span></dt>
<dd>A situation in which X depends on Y and Y depends on X, either directly or indirectly. If there is a circular dependency, then the <a href="#dependency_graph">dependency graph</a> is not <a href="#dag">acyclic</a>.</dd>
<dt><span class="gl-key" id="class">class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a structure that combines data and operations (called <a href="#method">methods</a>). The program then uses a <a href="#constructor">constructor</a> to create an <a href="#object">object</a> with those properties and methods. Programmers generally put generic or reusable behavior in <a href="#parent_class">parent classes</a>, and more detailed or specific behavior in <a href="#child_class">child classes</a>.</dd>
<dt><span class="gl-key" id="client">client</span></dt>
<dd>A program such as a web browser that gets data from a <a href="#server">server</a> and displays it to, or interacts with, users. The term is used more generally to refer to any program A that makes requests of another program B. A single program can be both a client and a server.</dd>
<dt><span class="gl-key" id="closure">closure</span></dt>
<dd>A set of variables defined in the same <a href="#scope">scope</a> whose existence has been preserved after that scope has ended.</dd>
<dt><span class="gl-key" id="code_coverage">code coverage (in testing)</span></dt>
<dd>How much of a <a href="#library">library</a> or program is executed when tests run. This is normally reported as a percentage of lines of code.</dd>
<dt><span class="gl-key" id="cognitive_load">cognitive load</span></dt>
<dd>The amount of working memory needed to accomplish a set of simultaneous tasks.</dd>
<dt><span class="gl-key" id="collision">collision</span></dt>
<dd>A situation in which a program tries to store two items in the same location in memory. For example, a collision occurs when a <a href="#hash_function">hash function</a> generates the same <a href="#hash_code">hash code</a> for two different items.</dd>
<dt><span class="gl-key" id="column_major">column-major storage</span></dt>
<dd>Storing each column of a two-dimensional array as one block of memory so that elements in the same row are far apart.</dd>
<dt><span class="gl-key" id="combinatorial_explosion">combinatorial explosion</span></dt>
<dd>The exponential growth in the size of a problem or the time required to solve it that arises when all possible combinations of a set of items must be searched.</dd>
<dt><span class="gl-key" id="csv">comma-separated values</span> (CSV)</dt>
<dd>A text format for tabular data in which each <a href="#record">record</a> is one row and <a href="#field">fields</a> are separated by commas. There are many minor variations, particularly around quoting of <a href="#string">strings</a>.</dd>
<dt><span class="gl-key" id="command_line_argument">command-line argument</span></dt>
<dd>A filename or control flag given to a command-line program when it is run.</dd>
<dt><span class="gl-key" id="cli">command-line interface</span> (CLI)</dt>
<dd>A user interface that relies solely on text for commands and output, typically running in a <a href="#shell">shell</a>.</dd>
<dt><span class="gl-key" id="comment">comment</span></dt>
<dd>Text written in a script that is not treated as code to be run, but rather as text that describes what the code is doing. These are usually short notes, often beginning with a <code>#</code> (in many programming languages).</dd>
<dt><span class="gl-key" id="compile">compile</span></dt>
<dd>To translate textual source into another form. Programs in <a href="#compiled_language">compiled languages</a> are translated into machine instructions for a computer to run, and <a href="#markdown">Markdown</a> is usually translated into <a href="#html">HTML</a> for display.</dd>
<dt><span class="gl-key" id="compiled_language">compiled language</span></dt>
<dd>Originally, a language such as C or Fortran that is translated into machine instructions for execution. Languages such as Java are also compiled before execution, but into <a href="#byte_code">byte code</a> instead of machine instructions, while <a href="#interpreted_language">interpreted languages</a> like JavaScript are compiled to byte code on the fly.</dd>
<dt><span class="gl-key" id="compiler">compiler</span></dt>
<dd>An application that translates programs written in some languages into machine instructions or <a href="#byte_code">byte code</a>.</dd>
<dt><span class="gl-key" id="confirmation_bias">confirmation bias</span></dt>
<dd>The tendency for someone to look for evidence that they are right rather than searching for reasons why they might be wrong.</dd>
<dt><span class="gl-key" id="console">console</span></dt>
<dd>A computer terminal where a user may enter commands, or a program, such as a shell that simulates such a device.</dd>
<dt><span class="gl-key" id="constructor">constructor</span></dt>
<dd>A function that creates an <a href="#object">object</a> of a particular <a href="#class">class</a>.</dd>
<dt><span class="gl-key" id="utc">Coordinated Universal Time</span> (UTC)</dt>
<dd>The standard time against which all others are defined. UTC is the time at longitude 0°, and is not adjusted for daylight savings. <a href="#timestamp">Timestamps</a> are often reported in UTC so that they will be the same no matter what timezone the computer is in.</dd>
<dt><span class="gl-key" id="corner_case">corner case</span></dt>
<dd>Another name for an <a href="#edge_case">edge case</a>.</dd>
<dt><span class="gl-key" id="coupling">coupling</span></dt>
<dd>The degree of interaction between two <a href="#class">classes</a>, <a href="#module">modules</a>, or other software components. If a system's components are <a href="#loosely_coupled">loosely coupled</a>, changes to one are unlikely to affect others.  If they are <a href="#tightly_coupled">tightly coupled</a>, then any change requires other changes elsewhere, which complicates maintenance and evolution.</dd>
<dt><span class="gl-key" id="cryptographic_hash_function">cryptographic hash function</span></dt>
<dd>A <a href="#hash_function">hash function</a> that produces an apparently-random value for any input.</dd>
<dt><span class="gl-key" id="current_working_directory">current working directory</span></dt>
<dd>The <a href="#folder">folder</a> or <a href="#directory">directory</a> location in which the program operates. Any action taken by the program occurs relative to this directory.</dd>
<dt><span class="gl-key" id="cycle">cycle (in a graph)</span></dt>
<dd>A set of links in a graph that leads from a node back to itself.</dd>
<dt><span class="gl-key" id="data_frame">data frame</span></dt>
<dd>A two-dimensional data structure for storing tabular data in memory. Rows represent <a href="#record">records</a> and columns represent <a href="#field">fields</a>.</dd>
<dt><span class="gl-key" id="data_migration">data migration</span></dt>
<dd>Moving data from one location or format to another. The term refers to translating data from an old format to a newer one.</dd>
<dt><span class="gl-key" id="decorator_pattern">Decorator pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which a function adds additional features to another function or a <a href="#class">class</a> after its initial definition. Decorators are a feature of Python and can be implemented in most other languages as well.</dd>
<dt><span class="gl-key" id="defensive_programming">defensive programming</span></dt>
<dd>A set of programming practices that assumes mistakes will happen and either reports or corrects them, such as inserting <a href="#assertion">assertions</a> to report situations that are not ever supposed to occur.</dd>
<dt><span class="gl-key" id="dependency">dependency</span></dt>
<dd>See <a href="#prerequisite">prerequisite</a>.</dd>
<dt><span class="gl-key" id="dependency_graph">dependency graph</span></dt>
<dd>A <a href="#directed_graph">directed graph</a> showing how things depend on one another, such as the files to be updated by a <a href="#build_manager">build manager</a>. If the dependency graph is not <a href="#dag">acyclic</a>, the dependencies cannot be resolved.</dd>
<dt><span class="gl-key" id="deprecation">deprecation</span></dt>
<dd>To indicate that while a function, method, or class exists, its use is no longer recommended (for example, because it is going to be phased out in a future release).</dd>
<dt><span class="gl-key" id="depth_first">depth-first</span></dt>
<dd>A search algorithm that explores one possibility all the way to its conclusion before moving on to the next.</dd>
<dt><span class="gl-key" id="derived_class">derived class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a class that is a direct or indirect extension of a <a href="#base_class">base class</a>.</dd>
<dt><span class="gl-key" id="design_by_contract">design by contract</span></dt>
<dd>A style of designing software in which functions specify the <a href="#pre_condition">pre-conditions</a> that must be true in order for them to run and the <a href="#post_condition">post-conditions</a> they guarantee will be true when they return. A function can then be replaced by one with weaker pre-conditions (i.e., it accepts a wider set of input) and/or stronger post-conditions (i.e., it produces a smaller range of output) without breaking anything else.</dd>
<dt><span class="gl-key" id="design_pattern">design pattern</span></dt>
<dd>A recurring pattern in software design that is specific enough to be worth naming, but not so specific that a single best implementation can be provided by a <a href="#library">library</a>.</dd>
<dt><span class="gl-key" id="destructuring_assignment">destructuring assignment</span></dt>
<dd>Unpacking values from data structures and assigning them to multiple variables in a single statement.</dd>
<dt><span class="gl-key" id="dictionary">dictionary</span></dt>
<dd>A data structure that allows items to be looked up by value, sometimes called an <a href="#associative_array">associative array</a>. Dictionaries are often implemented using <a href="#hash_table">hash tables</a>.</dd>
<dt><span class="gl-key" id="dag">directed acyclic graph</span> (DAG)</dt>
<dd>A <a href="#directed_graph">directed graph</a> which does not contain any loops (i.e., it is not possible to reach a <a href="#node">node</a> from itself by following edges).</dd>
<dt><span class="gl-key" id="directed_graph">directed graph</span></dt>
<dd>A <a href="#graph">graph</a> whose <a href="#edge">edges</a> have directions.</dd>
<dt><span class="gl-key" id="directory">directory</span></dt>
<dd>A structure in a <a href="#filesystem">filesystem</a> that contains references to other structures, such as files and other directories.</dd>
<dt><span class="gl-key" id="disassembler">disassembler</span></dt>
<dd>A program that translates machine instructions into <a href="#assembly_code">assembly code</a> or some other higher-level language.</dd>
<dt><span class="gl-key" id="doc_comment">doc comment</span></dt>
<dd>A documentation comment ("doc comment" for short) is a specially-formatted comment containing documentation about a piece of code that is embedded in the code itself.</dd>
<dt><span class="gl-key" id="dom">Document Object Model</span> (DOM)</dt>
<dd>A standard, in-memory representation of <a href="#html">HTML</a> and <a href="#xml">XML</a>. Each <a href="#element">element</a> is stored as a <a href="#node">node</a> in a <a href="#tree">tree</a> with a set of named <a href="#attribute">attributes</a>; contained elements are <a href="#child_tree">child nodes</a>.</dd>
<dt><span class="gl-key" id="driver">driver</span></dt>
<dd>A program that runs other programs, or a function that drives all of the other functions in a program.</dd>
<dt><span class="gl-key" id="dynamic_loading">dynamic loading</span></dt>
<dd>To <a href="#import">import</a> a <a href="#module">module</a> into the memory of a program while it is already running. Most <a href="#interpreted_language">interpreted languages</a> use dynamic loading, and provide tools so that programs can find and load modules dynamically to configure themselves.</dd>
<dt><span class="gl-key" id="dynamic_lookup">dynamic lookup</span></dt>
<dd>To find a function or a property of an <a href="#object">object</a> by name while a program is running. For example, instead of getting a specific property of an object using <code>obj.name</code>, a program might use <code>obj[someVariable]</code>, where <code>someVariable</code> could hold <code>"name"</code> or some other property name.</dd>
<dt><span class="gl-key" id="dynamic_scoping">dynamic scoping</span></dt>
<dd>To find the value of a variable by looking at what is on the <a href="#call_stack">call stack</a> at the moment the lookup is done. Almost all programming languages use <a href="#lexical_scoping">lexical-scoping</a> instead, since it is more predictable.</dd>
<dt><span class="gl-key" id="eager_matching">eager matching</span></dt>
<dd>Matching as much as possible, as early as possible.</dd>
<dt><span class="gl-key" id="easy_mode">easy mode</span></dt>
<dd>A term borrowed from gaming meaning to do something with obstacles or difficulties simplified or removed, often for practice purposes.</dd>
<dt><span class="gl-key" id="edge">edge</span></dt>
<dd>A connection between two <a href="#node">nodes</a> in a <a href="#graph">graph</a>. An edge may have data associated with it, such as a name or distance.</dd>
<dt><span class="gl-key" id="edge_case">edge case</span></dt>
<dd>A problem that only comes up under unusual circumstances or when a system is pushed to its limits; also sometimes called a <a href="#corner_case">corner case</a>. Programs intended for widespread use have to handle edge cases, but doing so can make them much more complicated.</dd>
<dt><span class="gl-key" id="element">element</span></dt>
<dd>A named component in an <a href="#html">HTML</a> or <a href="#xml">XML</a> document. Elements are usually written <code>&lt;name&gt;</code>…<code>&lt;/name&gt;</code>, where "…" represents the content of the element. Elements often have <a href="#attribute">attributes</a>.</dd>
<dt><span class="gl-key" id="encapsulate">encapsulate</span></dt>
<dd>To store data inside some kind of structure so that it is only accessible through that structure.</dd>
<dt><span class="gl-key" id="entry_point">entry point</span></dt>
<dd>Where a program begins executing.</dd>
<dt><span class="gl-key" id="environment">environment</span></dt>
<dd>A structure that stores a set of variable names and the values they refer to.</dd>
<dt><span class="gl-key" id="error_test">error (in a test)</span></dt>
<dd>Signalled when something goes wrong in a <a href="#unit_test">unit test</a> itself rather than in the system being tested. In this case, we do not know anything about the correctness of the system.</dd>
<dt><span class="gl-key" id="error_handling">error handling</span></dt>
<dd>What a program does to detect and correct for errors. Examples include printing a message and using a default configuration if the user-specified configuration cannot be found.</dd>
<dt><span class="gl-key" id="event_loop">event loop</span></dt>
<dd>A mechanism for managing concurrent activities in a program. Tasks are represented as items in a queue; the event loop repeatedly takes an item from the front of the queue and runs it, adding any other tasks it generates to the back of the queue to run later.</dd>
<dt><span class="gl-key" id="exception">exception</span></dt>
<dd>An object that stores information about an error or other unusual event in a program. One part of a program will create and <a href="#raise_exception">raise an exception</a> to signal that something unexpected has happened; another part will <a href="#catch_exception">catch</a> it.</dd>
<dt><span class="gl-key" id="exception_handler">exception handler</span></dt>
<dd>A piece of code that deals with an <a href="#exception">exception</a> after it is <a href="#catch_exception">caught</a>, e.g., by recording a message, retrying the operation that failed, or performing an alternate operation.</dd>
<dt><span class="gl-key" id="expected_result">expected result (of test)</span></dt>
<dd>The value that a piece of software is supposed to produce when tested in a certain way, or the state in which it is supposed to leave the system.</dd>
<dt><span class="gl-key" id="exploratory_programming">exploratory programming</span></dt>
<dd>A software development methodology in which requirements emerge or change as the software is being written, often in response to results from early runs.</dd>
<dt><span class="gl-key" id="export">export</span></dt>
<dd>To make something visible outside a <a href="#module">module</a> so that other parts of a program can <a href="#import">import</a> it. In most languages a module must export things explicitly in an attempt to avoid <a href="#name_collision">name collision</a>.</dd>
<dt><span class="gl-key" id="fail_test">fail (a test)</span></dt>
<dd>A test fails if the <a href="#actual_result">actual result</a> does not match the <a href="#expected_result">expected result</a>.</dd>
<dt><span class="gl-key" id="feature_software">feature (in software)</span></dt>
<dd>Some aspect of software that was deliberately designed or built. A <a href="#bug">bug</a> is an undesired feature.</dd>
<dt><span class="gl-key" id="field">field</span></dt>
<dd>A component of a <a href="#record">record</a> containing a single value. Every record in a database <a href="#table">table</a> has the same fields.</dd>
<dt><span class="gl-key" id="filename_extension">filename extension</span></dt>
<dd>The last part of a filename, usually following the '.' symbol. Filename extensions are commonly used to indicate the type of content in the file, though there is no guarantee that this is correct.</dd>
<dt><span class="gl-key" id="filesystem">filesystem</span></dt>
<dd>The part of the <a href="#operating_system">operating system</a> that manages how files are stored and retrieved. Also used to refer to all of those files and <a href="#directory">directories</a> or the specific way they are stored (as in "the Unix filesystem").</dd>
<dt><span class="gl-key" id="filter">filter</span></dt>
<dd>As a verb, to choose a set of <a href="#record">records</a> (i.e., rows of a table) based on the values they contain. As a noun, a command-line program that reads lines of text from files or <a href="#stdin">standard input</a>, performs some operation on them (such as filtering), and writes to a file or <a href="#stdout">stdout</a>.</dd>
<dt><span class="gl-key" id="fsm">finite state machine</span> (FSM)</dt>
<dd>A theoretical model of computing consisting of a directed graph whose nodes represent the states of the computation and whose arcs show how to move from one state to another. Every <a href="#regular_expression">regular expression</a> corresponds to a finite state machine.</dd>
<dt><span class="gl-key" id="fixed_width_string">fixed-width (of strings)</span></dt>
<dd>A set of character strings that have the same length. Databases often used fixed-width strings to make storage and access more efficient; short strings are <a href="#pad_string">padded</a> up to the required length and long strings are truncated.</dd>
<dt><span class="gl-key" id="fixture">fixture</span></dt>
<dd>The thing on which a test is run, such as the <a href="#parameter">parameters</a> to the function being tested or the file being processed.</dd>
<dt><span class="gl-key" id="fluent_interface">fluent interface</span></dt>
<dd>A style of object-oriented programming in which methods return objects so that other methods can immediately be called.</dd>
<dt><span class="gl-key" id="folder">folder</span></dt>
<dd>Another term for a <a href="#directory">directory</a>.</dd>
<dt><span class="gl-key" id="garbage_collection">garbage collection</span></dt>
<dd>The process of identifying memory that has been allocated but is no longer in use and reclaiming it to be re-used.</dd>
<dt><span class="gl-key" id="generator_function">generator function</span></dt>
<dd>A function whose state is automatically saved when it returns a value so that execution can be restarted from that point the next time it is called. One example of generator functions use is to produce streams of values that can be processed by <code>for</code> loops.</dd>
<dt><span class="gl-key" id="generic_function">generic function</span></dt>
<dd>A collection of functions with similar purpose, each operating on a different class of data.</dd>
<dt><span class="gl-key" id="global_variable">global variable</span></dt>
<dd>A variable defined outside any particular function or <a href="#package">package</a> namespace, which is therefore visible to all functions.</dd>
<dt><span class="gl-key" id="globbing">globbing</span></dt>
<dd>To specify a set of filenames using a simplified form of <a href="#regular_expression">regular expressions</a>, such as <code>*.dat</code> to mean "all files whose names end in <code>.dat</code>". The name is derived from "global".</dd>
<dt><span class="gl-key" id="graph">graph</span></dt>
<dd>A plot or a chart that displays data, or a data structure in which <a href="#node">nodes</a> are connected to one another by <a href="#edge">edges</a>.</dd>
<dt><span class="gl-key" id="greedy_algorithm">greedy algorithm</span></dt>
<dd>An algorithm that consumes as much input as possible, as early as possible.</dd>
<dt><span class="gl-key" id="handler">handler</span></dt>
<dd>A <a href="#callback">callback function</a> responsible for handling some particular event, such as the user clicking on a button or new data being receiving from a file.</dd>
<dt><span class="gl-key" id="hash_code">hash code</span></dt>
<dd>A value generated by a <a href="#hash_function">hash function</a>. Good hash codes have the same properties as random numbers in order to reduce the frequency of <a href="#collision">collisions</a>.</dd>
<dt><span class="gl-key" id="hash_function">hash function</span></dt>
<dd>A function that turns arbitrary data into a bit array, or a <a href="#key">key</a>, of a fixed size. Hash functions are used to determine where data should be stored in a <a href="#hash_table">hash table</a>.</dd>
<dt><span class="gl-key" id="hash_table">hash table</span></dt>
<dd>A data structure that calculates a pseudo-random key (location) for each value passed to it and stores the value in that location. Hash tables enable fast lookup for arbitrary data. This occurs at the cost of extra memory because hash tables must always be larger than the amount of information they need to store, to avoid the possibility of data collisions, when the hash function returns the same key for two different values.</dd>
<dt><span class="gl-key" id="header_file">header file</span></dt>
<dd>In C and C++, a file that defines constants and function <a href="#signature">signatures</a> but does not contain runnable code. Header files tell the including file what is defined in other files so that the compiler can generate correct code.</dd>
<dt><span class="gl-key" id="heterogeneous">heterogeneous</span></dt>
<dd>Containing mixed data types. For example, an array in Javascript can contain a mix of numbers, character strings, and values of other types.</dd>
<dt><span class="gl-key" id="heuristic">heuristic</span></dt>
<dd>A rule or guideline that isn't guaranteed to produce the desired result, but usually does.</dd>
<dt><span class="gl-key" id="homogeneous">homogeneous</span></dt>
<dd>Containing a single data type. For example, a <a href="#vector">vector</a> must be homogeneous: its values must all be numeric, logical, etc.</dd>
<dt><span class="gl-key" id="http_request">HTTP request</span></dt>
<dd>A message sent from a <a href="#client">client</a> to a <a href="#server">server</a> using the <a href="#http">HTTP</a> <a href="#protocol">protocol</a> asking for data. A request usually asks for a web page, image, or other data.</dd>
<dt><span class="gl-key" id="http_response">HTTP response</span></dt>
<dd>A reply sent from a <a href="#server">server</a> to a <a href="#client">client</a> using the <a href="#http">HTTP</a> <a href="#protocol">protocol</a> in response to a <a href="#http_request">request</a>. The response usually contains a web page, image, or data.</dd>
<dt><span class="gl-key" id="html">HyperText Markup Language</span> (HTML)</dt>
<dd>The standard <a href="#markup_language">markup language</a> used for web pages. HTML is represented in memory using <a href="#dom">DOM</a> (Digital Object Model).</dd>
<dt><span class="gl-key" id="http">HyperText Transfer Protocol</span> (HTTP)</dt>
<dd>The standard <a href="#protocol">protocol</a> for data transfer on the World-Wide Web. HTTP defines the format of <a href="#http_request">requests</a> and <a href="#http_response">responses</a>, the meanings of standard error codes, and other features.</dd>
<dt><span class="gl-key" id="idiomatic">idiomatic</span></dt>
<dd>To use a language in the same way as a fluent or native speaker. Programs are called idiomatic if they use the language the way that proficient programmers use it.</dd>
<dt><span class="gl-key" id="iife">immediately-invoked function expression</span> (IIFE)</dt>
<dd>A function that is invoked once at the point where it is defined.  IIFEs are typically used to create a <a href="#scope">scope</a> to hide some function or variable definitions.</dd>
<dt><span class="gl-key" id="immutable">immutable</span></dt>
<dd>Data that cannot be changed after being created. Immutable data is easier to think about, particularly if data structures are shared between several tasks, but may result in higher memory requirements.</dd>
<dt><span class="gl-key" id="import">import</span></dt>
<dd>To bring things from a <a href="#module">module</a> into a program for use. In most languages a program can only import things that the module explicitly <a href="#export">exports</a>.</dd>
<dt><span class="gl-key" id="index_database">index (in a database)</span></dt>
<dd>An auxiliary data structure in a database used to speed up search for some entries. An index increases memory and disk requirements but reduces search time.</dd>
<dt><span class="gl-key" id="inner_function">inner function</span></dt>
<dd>A function defined inside another (outer) function.  Creating and returning inner functions is a way to create <a href="#closure">closures</a>.</dd>
<dt><span class="gl-key" id="instance">instance</span></dt>
<dd>An <a href="#object">object</a> of a particular <a href="#class">class</a>.</dd>
<dt><span class="gl-key" id="instruction_pointer">instruction pointer</span></dt>
<dd>A special <a href="#register">register</a> in a processor that stores the address of the next instruction to execute.</dd>
<dt><span class="gl-key" id="instruction_set">instruction set</span></dt>
<dd>The basic operations that a particular processor can execute directly.</dd>
<dt><span class="gl-key" id="interpreted_language">interpreted language</span></dt>
<dd>A high-level language that is not executed directly by the computer, but instead is run by an <a href="#interpreter">interpreter</a> that translates program instructions into machine commands on the fly.</dd>
<dt><span class="gl-key" id="interpreter">interpreter</span></dt>
<dd>A program whose job it is to run programs written in a high-level <a href="#interpreted_language">interpreted language</a>. Interpreters can run interactively, but may also execute commands saved in a file.</dd>
<dt><span class="gl-key" id="intrinsic_complexity">intrinsic complexity</span></dt>
<dd>The unavoidable complexity inherent in a problem that any solution must deal with. The term is used in contrast with <a href="#accidental_complexity">accidental complexity</a>.</dd>
<dt><span class="gl-key" id="introspection">introspection</span></dt>
<dd>Having a program examine itself as it is running; common examples are to determine the specific class of a generic object or to get the fields of an object when they are not known in advance.</dd>
<dt><span class="gl-key" id="iso_date_format">ISO date format</span></dt>
<dd>An international for formatting dates. While the full standard is complex, the most common form is <code>YYYY-MM-DD</code>, i.e., a four-digit year, a two-digit month, and a two-digit day, separated by hyphens.</dd>
<dt><span class="gl-key" id="iterator_pattern">Iterator pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which a temporary <a href="#object">object</a> or <a href="#generator_function">generator function</a> produces each value from a collection in turn for processing. This pattern hides the differences between different kinds of data structures so that everything can be processed using loops.</dd>
<dt><span class="gl-key" id="json">JavaScript Object Notation</span> (JSON)</dt>
<dd>A way to represent data by combining basic values like numbers and character strings in <a href="#list">lists</a> and <a href="#dictionary">key/value</a> structures. The acronym stands for "JavaScript Object Notation"; unlike better-defined standards like <a href="#xml">XML</a>, it is unencumbered by a syntax for comments or ways to define a <a href="#schema">schema</a>.</dd>
<dt><span class="gl-key" id="join">join</span></dt>
<dd>An operation that combines two <a href="#table">tables</a>, typically by matching <a href="#key">keys</a> from one with keys from another.</dd>
<dt><span class="gl-key" id="key">key</span></dt>
<dd>A <a href="#field">field</a> or combination of fields whose value(s) uniquely identify a <a href="#record">record</a> within a <a href="#table">table</a> or dataset. Keys are often used to select specific records and in <a href="#join">joins</a>.</dd>
<dt><span class="gl-key" id="label_address">label (address in memory)</span></dt>
<dd>A human-readable name given to a particular location in memory when writing programs in <a href="#assembly_code">assembly code</a>.</dd>
<dt><span class="gl-key" id="layout_engine">layout engine</span></dt>
<dd>A piece of software that decides where to place text, images, and other elements on a page.</dd>
<dt><span class="gl-key" id="lazy_matching">lazy matching</span></dt>
<dd>Matching as little as possible while still finding a valid match.</dd>
<dt><span class="gl-key" id="lru_cache">Least Recently Used cache</span> (LRU cache)</dt>
<dd>A <a href="#cache">cache</a> that discards items that have not been used recently in order to limit memory requirements.</dd>
<dt><span class="gl-key" id="lexical_scoping">lexical scoping</span></dt>
<dd>To look up the value associated with a name according to the textual structure of a program. Most programming languages use lexical scoping instead of <a href="#dynamic_scoping">dynamic scoping</a> because the latter is less predictable.</dd>
<dt><span class="gl-key" id="library">library</span></dt>
<dd>An installable collection of software, also often called a <a href="#module">module</a> or <a href="#package">package</a>.</dd>
<dt><span class="gl-key" id="lifecycle">lifecycle</span></dt>
<dd>The steps that something is allowed or required to go through. The lifecycle of an <a href="#object">object</a> runs from its <a href="#constructor">construction</a> through the operations it can or must perform before it is destroyed.</dd>
<dt><span class="gl-key" id="line_comment">line comment</span></dt>
<dd>A <a href="#comment">comment</a> in a program that spans part of a single line, as opposed to a <a href="#block_comment">block comment</a> that may span multiple lines.</dd>
<dt><span class="gl-key" id="link">link (a program)</span></dt>
<dd>To combine separately <a href="#compile">compiled</a> modules into a single runnable program.</dd>
<dt><span class="gl-key" id="linter">linter</span></dt>
<dd>A program that checks for common problems in software, such as violations of indentation rules or variable naming conventions. The name comes from the first tool of its kind, called <code>lint</code>.</dd>
<dt><span class="gl-key" id="liskov_substitution_principle">Liskov Substitution Principle</span></dt>
<dd>A design rule stating that it should be possible to replace objects in a program with objects of derived classes without breaking the program. <a href="#design_by_contract">Design by contract</a> is intended to enforce this rule.</dd>
<dt><span class="gl-key" id="list">list</span></dt>
<dd>A <a href="#vector">vector</a> that can contain values of many different (<a href="#heterogeneous">heterogeneous</a>) types.</dd>
<dt><span class="gl-key" id="literal">literal</span></dt>
<dd>A representation of a fixed value in a program, such as the digits <code>123</code> for the number 123 or the characters <code>"abc"</code> for the string containing those three letters.</dd>
<dt><span class="gl-key" id="literate_programming">literate programming</span></dt>
<dd>A programming paradigm that mixes prose and code so that explanations and instructions are side by side.</dd>
<dt><span class="gl-key" id="loader">loader</span></dt>
<dd>A function whose job is to read files containing runnable code into memory and make that code available to the calling program.</dd>
<dt><span class="gl-key" id="local_variable">local variable</span></dt>
<dd>A variable defined inside a function which is only visible within that function.</dd>
<dt><span class="gl-key" id="log_message">log message</span></dt>
<dd>A status report or error message written to a file as a program runs.</dd>
<dt><span class="gl-key" id="loop_body">loop body</span></dt>
<dd>The statement or statements executed by a loop.</dd>
<dt><span class="gl-key" id="loosely_coupled">loosely coupled</span></dt>
<dd>Components in a software system are said to be loosely coupled if they are relatively independent of one another, i.e., if any one of them can be changed or replaced without others having to be altered as well.</dd>
<dt><span class="gl-key" id="macro">macro</span></dt>
<dd>Originally short for "macro-instruction", an instruction to translate some of the text into a program into other text before using it.</dd>
<dt><span class="gl-key" id="makefile">Makefile</span></dt>
<dd>A configuration file for the original <a href="#build_manager">build manager</a>.</dd>
<dt><span class="gl-key" id="manifest">manifest</span></dt>
<dd>A list that specifies the precise versions of a complete set of libraries or other software components.</dd>
<dt><span class="gl-key" id="markdown">Markdown</span></dt>
<dd>A <a href="#markup_language">markup language</a> with a simple syntax intended as a replacement for <a href="#html">HTML</a>.</dd>
<dt><span class="gl-key" id="markup_language">markup language</span></dt>
<dd>A set of rules for annotating text to define its meaning or how it should be displayed. The markup is usually not displayed, but instead controls how the underlying text is interpreted or shown. <a href="#markdown">Markdown</a> and <a href="#html">HTML</a> are widely-used markup languages for web pages.</dd>
<dt><span class="gl-key" id="method">method</span></dt>
<dd>An implementation of a <a href="#generic_function">generic function</a> that handles objects of a specific class.</dd>
<dt><span class="gl-key" id="method_chaining">method chaining</span></dt>
<dd>A style of object-oriented programming in which an object's methods return that object as their result so that another method can immediately be called, as in <code>obj.a().b().c()</code>.</dd>
<dt><span class="gl-key" id="mock_object">mock object</span></dt>
<dd>A simplified replacement for part of a program whose behavior is easy to control and predict. Mock objects are used in <a href="#unit_test">unit tests</a> to simulate databases, web services, and other complex systems.</dd>
<dt><span class="gl-key" id="module">module</span></dt>
<dd>A reusable software <a href="#package">package</a>, also often called a <a href="#library">library</a>.</dd>
<dt><span class="gl-key" id="module_bundler">module bundler</span></dt>
<dd>A program that finds all the dependencies of a set of source files and combines them into a single loadable file.</dd>
<dt><span class="gl-key" id="multi_threaded">multi-threaded</span></dt>
<dd>Capable of performing several operations simultaneously. Multi-threaded programs are usually more efficient than <a href="#single_threaded">single-threaded</a> ones, but also harder to understand and debug.</dd>
<dt><span class="gl-key" id="name_collision">name collision</span></dt>
<dd>The ambiguity that arises when two or more things in a program that have the same name are active at the same time. Most languages use <a href="#namespace">namespaces</a> to prevent such collisions.</dd>
<dt><span class="gl-key" id="namespace">namespace</span></dt>
<dd>A collection of names in a program that exists in isolation from other namespaces. Each function, <a href="#object">object</a>, <a href="#class">class</a>, or <a href="#module">module</a> in a program typically has its own namespace so that references to "X" in one part of a program do not accidentally refer to something called "X" in another part of the program. Scope is a distinct, but related, concept.</dd>
<dt><span class="gl-key" id="nested_function">nested function</span></dt>
<dd>A function that is defined inside another function.</dd>
<dt><span class="gl-key" id="node">node</span></dt>
<dd>An element of a <a href="#graph">graph</a> that is connected to other nodes by <a href="#edge">edges</a>. Nodes typically have data associated with them, such as names or weights.</dd>
<dt><span class="gl-key" id="non_blocking_execution">non-blocking execution</span></dt>
<dd>To allow a program to continue running while an operation is in progress. For example, many systems support non-blocking execution for file I/O so that the program can continue doing work while it waits for data to be read from or written to the <a href="#filesystem">filesystem</a> (which is typically much slower than the CPU).</dd>
<dt><span class="gl-key" id="object">object</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, a structure that contains the data for a specific instance of a <a href="#class">class</a>. The operations the object is capable of are defined by the class's <a href="#method">methods</a>.</dd>
<dt><span class="gl-key" id="oop">object-oriented programming</span> (OOP)</dt>
<dd>A style of programming in which functions and data are bound together in <a href="#object">objects</a> that only interact with each other through well-defined interfaces.</dd>
<dt><span class="gl-key" id="off_by_one_error">off-by-one error</span></dt>
<dd>A common error in programming in which the program refers to element <code>i</code> of a structure when it should refer to element <code>i-1</code> or <code>i+1</code>, or processes <code>N</code> elements when it should process <code>N-1</code> or <code>N+1</code>.</dd>
<dt><span class="gl-key" id="op_code">op code</span></dt>
<dd>The numerical code for a particular instruction that a processor can execute.</dd>
<dt><span class="gl-key" id="open_closed_principle">Open-Closed Principle</span></dt>
<dd>A design rule stating that software should be open for extension but closed for modification, i.e., it should be possible to extend functionality without having to rewrite existing code.</dd>
<dt><span class="gl-key" id="operating_system">operating system</span></dt>
<dd>A program that provides a standard interface to whatever hardware it is running on. Theoretically, any program that only interacts with the operating system should run on any computer that operating system runs on.</dd>
<dt><span class="gl-key" id="package">package</span></dt>
<dd>A collection of code, data, and documentation that can be distributed and re-used. Also referred to in some languages as a <a href="#library">library</a> or <a href="#module">module</a>.</dd>
<dt><span class="gl-key" id="pad_string">pad (a string)</span></dt>
<dd>To add extra characters to a string to make it a required length.</dd>
<dt><span class="gl-key" id="parameter">parameter</span></dt>
<dd>A variable specified in a function definition that is assigned a value when the function is called.</dd>
<dt><span class="gl-key" id="parent_tree">parent (in a tree)</span></dt>
<dd>A <a href="#node">node</a> in a <a href="#node">tree</a> that is above another node (called a <a href="#child_tree">child</a>). Every node in a tree except the <a href="#root_tree">root node</a> has a single parent.</dd>
<dt><span class="gl-key" id="parent_class">parent class</span></dt>
<dd>In <a href="#oop">object-oriented programming</a>, the <a href="#class">class</a> from which a sub class (called the <a href="#child_class">child class</a>) is derived.</dd>
<dt><span class="gl-key" id="parser">parser</span></dt>
<dd>A piece of software that translates a textual representation of something into a data structure. For example, a <a href="#yaml">YAML</a> parser reads indented text and produces nested lists and objects.</dd>
<dt><span class="gl-key" id="pass_test">pass (a test)</span></dt>
<dd>A test passes if the <a href="#actual_result">actual result</a> matches the <a href="#expected_result">expected result</a>.</dd>
<dt><span class="gl-key" id="patch">patch</span></dt>
<dd>A single file containing a set of changes to a set of files, separated by markers that indicate where each individual change should be applied.</dd>
<dt><span class="gl-key" id="path">path (in filesystem)</span></dt>
<dd>A <a href="#string">string</a> that specifies a location in a <a href="#filesystem">filesystem</a>. In Unix, the <a href="#directory">directories</a> in a path are joined using <code>/</code>.</dd>
<dt><span class="gl-key" id="pattern_rule">pattern rule</span></dt>
<dd>A generic <a href="#build_rule">build rule</a> that describes how to update any file whose name matches a pattern. Pattern rules often use <a href="#automatic_variable">automatic variables</a> to represent the actual filenames.</dd>
<dt><span class="gl-key" id="pipe">pipe</span></dt>
<dd>To use the output of one computation as the input for the next, or the connection between the two computations responsible for the data transfer. Pipes were popularized by the <a href="#shell">Unix shell</a>, and are now used in many different programming languages and systems.</dd>
<dt><span class="gl-key" id="pipe_shell">pipe (in the Unix shell)</span></dt>
<dd>The <code>|</code> used to make the output of one command the input of the next.</dd>
<dt><span class="gl-key" id="plugin_architecture">plugin architecture</span></dt>
<dd>A style of application design in which the main program loads and runs small independent modules that do the bulk of the work.</dd>
<dt><span class="gl-key" id="polymorphism">polymorphism</span></dt>
<dd>Having many different implementations of the same interface. If a set of functions or objects are polymorphic, they can be called interchangeably.</dd>
<dt><span class="gl-key" id="post_condition">post-condition</span></dt>
<dd>Something that is guaranteed to be true after a function runs successfully. Post-conditions are often expressed as <a href="#assertion">assertions</a> that are guaranteed to be be true of a function's results.</dd>
<dt><span class="gl-key" id="pre_condition">pre-condition</span></dt>
<dd>Something that must be true before a function runs in order for it to work correctly. Pre-conditions are often expressed as as <a href="#assertion">assertions</a> that must be true of a function's inputs in order for it to run successfully.</dd>
<dt><span class="gl-key" id="precedence">precedence</span></dt>
<dd>The priority of an operation. For example, multiplication has a higher precedence than addition, so <code>a+b*c</code> is read as "the sum of <code>a</code> with the product of <code>b</code> and <code>c</code>".</dd>
<dt><span class="gl-key" id="prerequisite">prerequisite</span></dt>
<dd>Something that a <a href="#build_target">build target</a> depends on.</dd>
<dt><span class="gl-key" id="process">process</span></dt>
<dd>An <a href="#operating_system">operating system</a>'s representation of a running program. A process typically has some memory, the identity of the user who is running it, and a set of connections to open files.</dd>
<dt><span class="gl-key" id="promise">promise</span></dt>
<dd>A way to represent the result of a delayed or <a href="#asynchronous">asynchronous</a> computation. A promise is a placeholder for a value that will eventually be computed; any attempt to read the value before it is available blocks, while any such attempt after the computation finishes acts like a normal read.</dd>
<dt><span class="gl-key" id="promisification">promisification</span></dt>
<dd>In JavaScript, the act of wrapping a callback function in a <a href="#promise">promise</a> for uniform asynchronous execution.</dd>
<dt><span class="gl-key" id="protocol">protocol</span></dt>
<dd>Any standard specifying how two pieces of software interact. A network protocol such as <a href="#http">HTTP</a> defines the messages that <a href="#client">clients</a> and <a href="#server">servers</a> exchange on the World-Wide Web; <a href="#oop">object-oriented</a> programs often define protocols for interactions between <a href="#object">objects</a> of different <a href="#class">classes</a>.</dd>
<dt><span class="gl-key" id="prune">prune</span></dt>
<dd>To remove branches and nodes from a tree, or to rule out partially-complete solutions when searching for an overall solution in order to reduce work.</dd>
<dt><span class="gl-key" id="pseudo_random_number">pseudo-random number</span></dt>
<dd>A value generated in a repeatable way that resembles the true randomness of the universe well enough to fool observers.</dd>
<dt><span class="gl-key" id="prng">pseudo-random number generator</span> (PRNG)</dt>
<dd>A function that can generate <a href="#pseudo_random_number">pseudo-random numbers</a>.</dd>
<dt><span class="gl-key" id="query_selector">query selector</span></dt>
<dd>A pattern that specifies a set of <a href="#dom">DOM</a> nodes.  Query selectors are used in <a href="#css">CSS</a> to specify the elements that rules apply to, or by JavaScript programs to manipulate web pages.</dd>
<dt><span class="gl-key" id="query_string">query string</span></dt>
<dd>The portion of a <a href="#url">URL</a> after the question mark <code>?</code> that specifies extra parameters for the <a href="#http_request">HTTP request</a> as name-value pairs.</dd>
<dt><span class="gl-key" id="race_condition">race condition</span></dt>
<dd>A situation in which a result depends on the order in which two or more concurrent operations are carried out.</dd>
<dt><span class="gl-key" id="raise_exception">raise (an exception)</span></dt>
<dd>To signal that something unexpected or unusual has happened in a program by creating an <a href="#exception">exception</a> and handing it to the <a href="#error_handling">error-handling</a> system, which then tries to find a point in the program that will <a href="#catch_exception">catch</a> it.</dd>
<dt><span class="gl-key" id="repl">read-eval-print loop</span> (REPL)</dt>
<dd>An interactive program that reads a command typed in by a user, executes it, prints the result, and then waits patiently for the next command. REPLs are often used to explore new ideas, or for debugging.</dd>
<dt><span class="gl-key" id="record">record</span></dt>
<dd>A group of related values that are stored together. A record may be represented as a <a href="#tuple">tuple</a> or as a row in a <a href="#table">table</a>; in the latter case, every record in the table has the same <a href="#field">fields</a>.</dd>
<dt><span class="gl-key" id="register">register</span></dt>
<dd>A small piece of memory (typically one <a href="#word_memory">word</a> long) built into a processor that operations can refer to directly.</dd>
<dt><span class="gl-key" id="regular_expression">regular expression</span></dt>
<dd>A pattern for matching text, written as text itself. Regular expressions are sometimes called "regexp", "regex", or "RE", and are powerful tools for working with text.</dd>
<dt><span class="gl-key" id="relational_database">relational database</span></dt>
<dd>A database that organizes information into <a href="#table">tables</a>, each of which has a fixed set of named <a href="#field">fields</a> (shown as columns) and a variable number of <a href="#record">records</a> (shown as rows).</dd>
<dt><span class="gl-key" id="relative_error">relative error</span></dt>
<dd>The absolute value of the difference between the actual and correct value divided by the correct value. For example, if the actual value is 9 and the correct value is 10, the relative error is 0.1. Relative error is usually more useful than <a href="#absolute_error">absolute error</a>.</dd>
<dt><span class="gl-key" id="relative_path">relative path</span></dt>
<dd>A path that is interpreted relative to some other location, such as the <a href="#current_working_directory">current working directory</a>. A relative path is the equivalent of giving directions using terms like "straight" and "left".</dd>
<dt><span class="gl-key" id="root_tree">root (in a tree)</span></dt>
<dd>The <a href="#node">node</a> in a <a href="#tree">tree</a> of which all other nodes are direct or indirect <a href="#child_tree">children</a>, or equivalently the only node in the tree that has no <a href="#parent_tree">parent</a>.</dd>
<dt><span class="gl-key" id="row_major">row-major storage</span></dt>
<dd>Storing each row of a two-dimensional array as one block of memory so that elements in the same column are far apart.</dd>
<dt><span class="gl-key" id="runnable_documentation">runnable documentation</span></dt>
<dd>Statements about code that can be executed to check their correctness, such as <a href="#assertion">assertions</a> or <a href="#type_declaration">type declarations</a>.</dd>
<dt><span class="gl-key" id="sandbox">sandbox</span></dt>
<dd>A testing environment that is separate from the production system, or an environment that is only allowed to perform a restricted set of operations for security reasons.</dd>
<dt><span class="gl-key" id="sat_solver">SAT solver</span></dt>
<dd>A library or application that determines whether there is an assignment of true and false to a set of <a href="#boolean">Boolean</a> variables that makes an expression true (i.e., that satisfies the expression).</dd>
<dt><span class="gl-key" id="schema">schema</span></dt>
<dd>A specification of the format of a dataset, including the name, format, and content of each <a href="#table">table</a>.</dd>
<dt><span class="gl-key" id="scope">scope</span></dt>
<dd>The portion of a program within which a definition can be seen and used.</dd>
<dt><span class="gl-key" id="scope_creep">scope creep</span></dt>
<dd>Slow but steady increase in a project's goals after the project starts.</dd>
<dt><span class="gl-key" id="scoring_function">scoring function</span></dt>
<dd>A function that measures or estimates how good a solution to a problem is.</dd>
<dt><span class="gl-key" id="search_path">search path</span></dt>
<dd>The list of directories that a program searches to find something. For example, the Unix <a href="#shell">shell</a> uses the search path stored in the <code>PATH</code> variable when trying to find a program whose name it has been given.</dd>
<dt><span class="gl-key" id="seed">seed</span></dt>
<dd>A value used to initialize a <a href="#prng">pseudo-random number generator</a>.</dd>
<dt><span class="gl-key" id="semantic_versioning">semantic versioning</span></dt>
<dd>A standard for identifying software releases. In the version identifier <code>major.minor.patch</code>, <code>major</code> changes when a new version of software is incompatible with old versions, <code>minor</code> changes when new features are added to an existing version, and <code>patch</code> changes when small <a href="#bug">bugs</a> are fixed.</dd>
<dt><span class="gl-key" id="server">server</span></dt>
<dd>Typically, a program such as a database manager or web server that provides data to a <a href="#client">client</a> upon request.</dd>
<dt><span class="gl-key" id="sha_1">SHA-1 hash</span></dt>
<dd>A <a href="#cryptographic_hash_function">cryptographic hash function</a> that produces a 160-bit output.</dd>
<dt><span class="gl-key" id="shell">shell</span></dt>
<dd>A <a href="#cli">command-line interface</a> that allows a user to interact with the <a href="#operating_system">operating system</a>, such as Bash (for Unix and MacOS) or PowerShell (for Windows).</dd>
<dt><span class="gl-key" id="shell_variable">shell variable</span></dt>
<dd>A variable set and used in the <a href="#shell">Unix shell</a>. Commonly-used shell variables include <code>HOME</code> (the user's home directory) and <code>PATH</code> (their <a href="#search_path">search path</a>).</dd>
<dt><span class="gl-key" id="side_effect">side effect</span></dt>
<dd>A change made by a function while it runs that is visible after the function finishes, such as modifying a <a href="#global_variable">global variable</a> or writing to a file. Side effects make programs harder for people to understand, since the effects are not necessarily clear at the point in the program where the function is called.</dd>
<dt><span class="gl-key" id="signature">signature</span></dt>
<dd>The set of parameters (with types or meaning) that characterize the calling interface of a function or set of functions. Two functions with the same signature can be called interchangeably.</dd>
<dt><span class="gl-key" id="single_threaded">single-threaded</span></dt>
<dd>A model of program execution in which only one thing can happen at a time. Single-threaded execution is easier for people to understand, but less efficient than <a href="#multi_threaded">multi-threaded</a> execution.</dd>
<dt><span class="gl-key" id="singleton">singleton</span></dt>
<dd>A set with only one element, or a <a href="#class">class</a> with only one <a href="#instance">instance</a>.</dd>
<dt><span class="gl-key" id="singleton_pattern">Singleton pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> that creates a <a href="#singleton">singleton</a> <a href="#object">object</a> to manage some resource or service, such as a database or <a href="#cache">cache</a>. In <a href="#oop">object-oriented programming</a>, the pattern is usually implemented by hiding the <a href="#constructor">constructor</a> of the <a href="#class">class</a> in some way so that it can only be called once.</dd>
<dt><span class="gl-key" id="slug">slug</span></dt>
<dd>An abbreviated portion of a page's URL that uniquely identifies it. In the example <code>https://www.mysite.com/category/post-name</code>, the slug is <code>post-name</code>.</dd>
<dt><span class="gl-key" id="source_map">source map</span></dt>
<dd>A table used to translate a piece of code back to the lines in the original source.</dd>
<dt><span class="gl-key" id="sparse_matrix">sparse matrix</span></dt>
<dd>A matrix in which most of the values are zero (or some other value). Rather than storing many copies of the same values, programs will often use a special data structure that only stores the "interesting" values.</dd>
<dt><span class="gl-key" id="sql">SQL</span></dt>
<dd>The language used for writing queries for a <a href="#relational_database">relational database</a>. The term was originally an acronym for Structured Query Language.</dd>
<dt><span class="gl-key" id="stack_frame">stack frame</span></dt>
<dd>A section of the <a href="#call_stack">call stack</a> that records details of a single call to a specific function.</dd>
<dt><span class="gl-key" id="build_stale">stale (in build)</span></dt>
<dd>To be out-of-date compared to a <a href="#prerequisite">prerequisite</a>. A <a href="#build_manager">build manager</a>'s job is to find and update things that are stale.</dd>
<dt><span class="gl-key" id="stderr">standard error</span></dt>
<dd>A predefined communication channel for a <a href="#process">process</a> typically used to report errors.</dd>
<dt><span class="gl-key" id="stdin">standard input</span></dt>
<dd>A predefined communication channel for a <a href="#process">process</a>, typically used to read input from the keyboard or from the previous process in a <a href="#pipe_shell">pipe</a>.</dd>
<dt><span class="gl-key" id="stdout">standard output</span></dt>
<dd>A predefined communication channel for a <a href="#process">process</a>, typically used to send output to the screen or to the next process in a <a href="#pipe_shell">pipe</a>.</dd>
<dt><span class="gl-key" id="static_site_generator">static site generator</span></dt>
<dd>A software tool that creates HTML pages from templates and content.</dd>
<dt><span class="gl-key" id="stream">stream</span></dt>
<dd>A sequential flow of data, such as the <a href="#bit">bits</a> arriving across a network connection or the bytes read from a file.</dd>
<dt><span class="gl-key" id="streaming_api">streaming API</span></dt>
<dd>An <a href="#api">API</a> that processes data in chunks rather than needing to have all of it in memory at once. Streaming APIs usually require <a href="#handler">handlers</a> for events such as "start of data", "next block", and "end of data".</dd>
<dt><span class="gl-key" id="string">string</span></dt>
<dd>A block of text in a program. The term is short for "character string".</dd>
<dt><span class="gl-key" id="string_interpolation">string interpolation</span></dt>
<dd>The process of inserting text corresponding to specified values into a <a href="#string">string</a>, usually to make output human-readable.</dd>
<dt><span class="gl-key" id="synchronous">synchronous</span></dt>
<dd>To happen at the same time. In programming, synchronous operations are ones that have to run simultaneously, or complete at the same time.</dd>
<dt><span class="gl-key" id="tab_completion">tab completion</span></dt>
<dd>A technique implemented by most <a href="#repl">REPLs</a>, <a href="#shell">shells</a>, and programming editors that completes a command, variable name, filename, or other text when the TAB key is pressed.</dd>
<dt><span class="gl-key" id="table">table</span></dt>
<dd>A set of <a href="#record">records</a> in a <a href="#relational_database">relational database</a> or <a href="#data_frame">data frame</a>.</dd>
<dt><span class="gl-key" id="tagged_data">tagged data</span></dt>
<dd>A technique for storing data in a two-part structure, where one part identifies the type and the other part stores the bits making up the value.</dd>
<dt><span class="gl-key" id="template_method_pattern">Template Method pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which a <a href="#parent_class">parent class</a> defines an overall sequence of operations by calling <a href="#abstract_method">abstract methods</a> that <a href="#child_class">child classes</a> must then implement. Each child class then behaves in the same general way, but implements the steps differently.</dd>
<dt><span class="gl-key" id="test_harness">test harness</span></dt>
<dd>A program written to test some other program or set of functions, typically to measure their performance.</dd>
<dt><span class="gl-key" id="test_runner">test runner</span></dt>
<dd>A program that finds and runs software tests and reports their results.</dd>
<dt><span class="gl-key" id="test_subject">test subject</span></dt>
<dd>The thing being tested, sometimes also called the system under test (SUT).</dd>
<dt><span class="gl-key" id="tdd">test-driven development</span> (TDD)</dt>
<dd>A programming practice in which tests are written before a new feature is added or a <a href="#bug">bug</a> is fixed in order to clarify the goal.</dd>
<dt><span class="gl-key" id="throw_exception">throw (exception)</span></dt>
<dd>Another term for <a href="#raise_exception">raising</a> an exception.</dd>
<dt><span class="gl-key" id="tightly_coupled">tightly coupled</span></dt>
<dd>Components in a software system are said to be tightly coupled if they depend on each other's internals, so that if one is altered then others have to be altered as well.</dd>
<dt><span class="gl-key" id="toctou">Time of check/time of use</span> (ToCToU)</dt>
<dd>A <a href="#race_condition">race condition</a> in which a process checks the state of something and then operates on it, but some other process might alter that state between the check and the operation.</dd>
<dt><span class="gl-key" id="timestamp">timestamp</span></dt>
<dd>A digital identifier showing the time at which something was created or accessed. Timestamps should use <a href="#iso_date_format">ISO date format</a> for portability.</dd>
<dt><span class="gl-key" id="token">token</span></dt>
<dd>An indivisible unit of text for a parser, such as a variable name or a number. Exactly what constitutes a token depends on the language.</dd>
<dt><span class="gl-key" id="topological_order">topological order</span></dt>
<dd>Any ordering of the <a href="#node">nodes</a> in a <a href="#graph">graph</a> that respects the direction of its <a href="#edge">edges</a>, i.e., if there is an edge from node A to node B, A comes before B in the ordering. There may be many topological orderings of a particular graph.</dd>
<dt><span class="gl-key" id="transitive_closure">transitive closure</span></dt>
<dd>The set of all <a href="#node">nodes</a> in a <a href="#graph">graph</a> that are reachable from a starting node, either directly or indirectly.</dd>
<dt><span class="gl-key" id="tree">tree</span></dt>
<dd>A <a href="#graph">graph</a> in which every node except the <a href="#root_tree">root</a> has exactly one <a href="#parent_tree">parent</a>.</dd>
<dt><span class="gl-key" id="tuple">tuple</span></dt>
<dd>A value that has a fixed number of parts, such as the three color components of a red-green-blue color specification.</dd>
<dt><span class="gl-key" id="turing_machine">Turing Machine</span></dt>
<dd>A theoretical model of computation that manipulates symbols on an infinite tape according to a fixed table of rules. Any computation that can be expressed as an algorithm can be done by a Turing Machine.</dd>
<dt><span class="gl-key" id="two_hard_problems">two hard problems in computer science</span></dt>
<dd>Refers to a quote by Phil Karlton: "There are only two hard problems in computer science—cache invalidation and naming things." Many variations add a third problem as a joke, such as <a href="#off_by_one_error">off-by-one errors</a>.</dd>
<dt><span class="gl-key" id="type_declaration">type declaration</span></dt>
<dd>A statement in a program that a variable or value has a particular data type. Languages like Java require type declarations for all variables; they are optional in TypeScript and Python, and not allowed in pure JavaScript.</dd>
<dt><span class="gl-key" id="unicode">Unicode</span></dt>
<dd>A standard that defines numeric codes for many thousands of characters and symbols. Unicode does not define how those numbers are stored; that is done by standards like <a href="#utf_8">UTF-8</a>.</dd>
<dt><span class="gl-key" id="url">Uniform Resource Locator</span> (URL)</dt>
<dd>A unique address on the World-Wide Web. URLs originally identified web pages, but may also represent datasets or database queries, particularly if they include a <a href="#query_string">query string</a>.</dd>
<dt><span class="gl-key" id="unit_test">unit test</span></dt>
<dd>A test that exercises one function or feature of a piece of software and produces <a href="#pass_test">pass</a>, <a href="#fail_test">fail</a>, or <a href="#error_test">error</a>.</dd>
<dt><span class="gl-key" id="utf_8">UTF-8</span></dt>
<dd>A way to store the numeric codes representing <a href="#unicode">Unicode</a> characters in memory that is <a href="#backward_compatible">backward-compatible</a> with the older <a href="#ascii">ASCII</a> standard.</dd>
<dt><span class="gl-key" id="vector">vector</span></dt>
<dd>A sequence of values, usually of <a href="#homogeneous">homogeneous</a> type.</dd>
<dt><span class="gl-key" id="version_control_system">version control system</span></dt>
<dd>A system for managing changes made to software during its development.</dd>
<dt><span class="gl-key" id="virtual_machine">virtual machine</span></dt>
<dd>A program that pretends to be a computer. This may seem a bit redundant, but VMs are quick to create and start up, and changes made inside the virtual machine are contained within that VM so we can install new <a href="#package">packages</a> or run a completely different operating system without affecting the underlying computer.</dd>
<dt><span class="gl-key" id="visitor_pattern">Visitor pattern</span></dt>
<dd>A <a href="#design_pattern">design pattern</a> in which the operation to be done is taken to each element of a data structure in turn. It is usually implemented by having a generator "visitor" that knows how to reach the structure's elements, which is given a function or method to call for each in turn, and that carries out the specific operation.</dd>
<dt><span class="gl-key" id="walk_tree">walk (a tree)</span></dt>
<dd>To visit each <a href="#node">node</a> in a <a href="#tree">tree</a> in some order, typically <a href="#depth_first">depth-first</a> or <a href="#breadth_first">breadth-first</a>.</dd>
<dt><span class="gl-key" id="watchpoint">watchpoint</span></dt>
<dd>An instruction for a debugger telling it to suspect execution whenever the value of a variable (or more generally an expression) changes.</dd>
<dt><span class="gl-key" id="well_formed">well formed</span></dt>
<dd>A piece of text that obeys the rules of a formal grammar is said to be well formed.</dd>
<dt><span class="gl-key" id="word_memory">word (of memory)</span></dt>
<dd>The unit of memory that a particular processor most naturally works with. While a byte is a fixed size (8 bits), a word may be 16, 32, or 64 bits long depending on the processor.</dd>
<dt><span class="gl-key" id="xml">XML</span></dt>
<dd>A set of rules for defining <a href="#html">HTML</a>-like tags and using them to format documents (typically data). XML was popular in the early 2000s, but its complexity led many programmers to adopt <a href="#json">JSON</a>, instead.</dd>
<dt><span class="gl-key" id="yaml">YAML</span></dt>
<dd>Short for "YAML Ain't Markup Language", a way to represent nested data using indentation rather than the parentheses and commas of <a href="#json">JSON</a>. YAML is often used in configuration files and to define <a href="#parameter">parameters</a> for various flavors of <a href="#markdown">Markdown</a> documents.</dd>
<dt><span class="gl-key" id="z_buffering">z-buffering</span></dt>
<dd>A drawing method that keeps track of the depth of what lies "under" each pixel so that it displays whatever is nearest to the observer.</dd>
</dl>
</div>
</section>
<section class="new-chapter"><h1 id="links">Appendix: Appendix F: Links</h1>

<ul>
<li>acorn-walk: <a class="link-ref" href="https://www.npmjs.com/package/acorn-walk">https://www.npmjs.com/package/acorn-walk</a></li>
<li>acorn.js: <a class="link-ref" href="https://github.com/acornjs/acorn">https://github.com/acornjs/acorn</a></li>
<li>Amy Brown: <a class="link-ref" href="https://www.amyrhodabrown.com/">https://www.amyrhodabrown.com/</a></li>
<li>Andy Oram: <a class="link-ref" href="http://www.praxagora.com/">http://www.praxagora.com/</a></li>
<li>ANTLR: <a class="link-ref" href="https://www.antlr.org/">https://www.antlr.org/</a></li>
<li>The Architecture of Open Source Applications: <a class="link-ref" href="https://aosabook.org/">https://aosabook.org/</a></li>
<li>Babel: <a class="link-ref" href="https://babeljs.io/">https://babeljs.io/</a></li>
<li>Bajel: <a class="link-ref" href="https://www.npmjs.com/package/bajel">https://www.npmjs.com/package/bajel</a></li>
<li>The Birthday Problem: <a class="link-ref" href="https://en.wikipedia.org/wiki/Birthday_problem#A_simple_exponentiation">https://en.wikipedia.org/wiki/Birthday_problem#A_simple_exponentiation</a></li>
<li>Bob Nystrom: <a class="link-ref" href="http://journal.stuffwithstuff.com/">http://journal.stuffwithstuff.com/</a></li>
<li>Brian Kernighan: <a class="link-ref" href="https://en.wikipedia.org/wiki/Brian_Kernighan">https://en.wikipedia.org/wiki/Brian_Kernighan</a></li>
<li>caller: <a class="link-ref" href="https://www.npmjs.com/package/caller">https://www.npmjs.com/package/caller</a></li>
<li>The Carpentries: <a class="link-ref" href="https://carpentries.org/">https://carpentries.org/</a></li>
<li>CC-BY-NC License: <a class="link-ref" href="https://creativecommons.org/licenses/by-nc/4.0/">https://creativecommons.org/licenses/by-nc/4.0/</a></li>
<li>The Comprehensive TeX Archive Network: <a class="link-ref" href="https://www.ctan.org/">https://www.ctan.org/</a></li>
<li>Crafting Interpreters: <a class="link-ref" href="https://craftinginterpreters.com/">https://craftinginterpreters.com/</a></li>
<li>Data-Forge: <a class="link-ref" href="http://www.data-forge-js.com/">http://www.data-forge-js.com/</a></li>
<li>doctest: <a class="link-ref" href="https://docs.python.org/3/library/doctest.html">https://docs.python.org/3/library/doctest.html</a></li>
<li>Donald Knuth: <a class="link-ref" href="https://www-cs-faculty.stanford.edu/~knuth/">https://www-cs-faculty.stanford.edu/~knuth/</a></li>
<li>Emacs: <a class="link-ref" href="https://www.gnu.org/software/emacs/">https://www.gnu.org/software/emacs/</a></li>
<li>Embedded JavaScript Templating: <a class="link-ref" href="https://ejs.co/">https://ejs.co/</a></li>
<li>The ENIAC Programmers Project: <a class="link-ref" href="http://eniacprogrammers.org/">http://eniacprogrammers.org/</a></li>
<li>Escodegen: <a class="link-ref" href="https://github.com/estools/escodegen/">https://github.com/estools/escodegen/</a></li>
<li>ESDoc: <a class="link-ref" href="https://esdoc.org/">https://esdoc.org/</a></li>
<li>ESLint: <a class="link-ref" href="https://eslint.org/">https://eslint.org/</a></li>
<li>Esprima: <a class="link-ref" href="https://esprima.org/">https://esprima.org/</a></li>
<li>Expect: <a class="link-ref" href="https://en.wikipedia.org/wiki/Expect">https://en.wikipedia.org/wiki/Expect</a></li>
<li>Function.prototype.bind(): <a class="link-ref" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind</a></li>
<li>Git: <a class="link-ref" href="https://git-scm.com/">https://git-scm.com/</a></li>
<li>Git man page generator: <a class="link-ref" href="https://git-man-page-generator.lokaltog.net/">https://git-man-page-generator.lokaltog.net/</a></li>
<li>GitHub Pages: <a class="link-ref" href="https://pages.github.com/">https://pages.github.com/</a></li>
<li>Gitlet: <a class="link-ref" href="http://gitlet.maryrosecook.com/">http://gitlet.maryrosecook.com/</a></li>
<li>Glosario: <a class="link-ref" href="https://github.com/carpentries/glosario">https://github.com/carpentries/glosario</a></li>
<li>GNU Make: <a class="link-ref" href="https://www.gnu.org/software/make/">https://www.gnu.org/software/make/</a></li>
<li>Graphlib: <a class="link-ref" href="https://www.npmjs.com/package/graphlib">https://www.npmjs.com/package/graphlib</a></li>
<li>Greg Wilson: <a class="link-ref" href="https://third-bit.com/">https://third-bit.com/</a></li>
<li>Hippocratic License: <a class="link-ref" href="https://firstdonoharm.dev/">https://firstdonoharm.dev/</a></li>
<li>Human Resource Machine: <a class="link-ref" href="https://tomorrowcorporation.com/humanresourcemachine">https://tomorrowcorporation.com/humanresourcemachine</a></li>
<li>Istanbul: <a class="link-ref" href="https://istanbul.js.org/">https://istanbul.js.org/</a></li>
<li>Jake: <a class="link-ref" href="https://jakejs.com/">https://jakejs.com/</a></li>
<li>Java: <a class="link-ref" href="https://en.wikipedia.org/wiki/Java_(programming_language)">https://en.wikipedia.org/wiki/Java_(programming_language)</a></li>
<li>JavaScript for Data Science: <a class="link-ref" href="https://js4ds.org/">https://js4ds.org/</a></li>
<li>JavaScript Promise combinators: <a class="link-ref" href="https://2ality.com/2019/08/promise-combinators.html">https://2ality.com/2019/08/promise-combinators.html</a></li>
<li>JavaScript Standard Style: <a class="link-ref" href="https://standardjs.com/">https://standardjs.com/</a></li>
<li>Jekyll: <a class="link-ref" href="https://jekyllrb.com/">https://jekyllrb.com/</a></li>
<li>Jest: <a class="link-ref" href="https://jestjs.io/">https://jestjs.io/</a></li>
<li>JSDoc: <a class="link-ref" href="https://jsdoc.app/">https://jsdoc.app/</a></li>
<li>LaTeX: <a class="link-ref" href="https://www.latex-project.org/">https://www.latex-project.org/</a></li>
<li>Learner personas: <a class="link-ref" href="https://teachtogether.tech/en/index.html#s:process-personas">https://teachtogether.tech/en/index.html#s:process-personas</a></li>
<li>Let's build a browser engine!: <a class="link-ref" href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html</a></li>
<li>Let's Dev: A Package Manager: <a class="link-ref" href="https://classic.yarnpkg.com/blog/2017/07/11/lets-dev-a-package-manager/">https://classic.yarnpkg.com/blog/2017/07/11/lets-dev-a-package-manager/</a></li>
<li>Markdown: <a class="link-ref" href="https://en.wikipedia.org/wiki/Markdown">https://en.wikipedia.org/wiki/Markdown</a></li>
<li>markdown-it: <a class="link-ref" href="https://markdown-it.github.io/">https://markdown-it.github.io/</a></li>
<li>markdown-it-anchor: <a class="link-ref" href="https://www.npmjs.com/package/markdown-it-anchor">https://www.npmjs.com/package/markdown-it-anchor</a></li>
<li>Mary Rose Cook: <a class="link-ref" href="https://maryrosecook.com/">https://maryrosecook.com/</a></li>
<li>Matt Brubeck: <a class="link-ref" href="https://limpet.net/mbrubeck/">https://limpet.net/mbrubeck/</a></li>
<li>Maël Nison: <a class="link-ref" href="https://arcanis.github.io/">https://arcanis.github.io/</a></li>
<li>microtime: <a class="link-ref" href="https://www.npmjs.com/package/microtime">https://www.npmjs.com/package/microtime</a></li>
<li>Mike DiBernardo: <a class="link-ref" href="https://mikedebo.com/">https://mikedebo.com/</a></li>
<li>Mike Hoye: <a class="link-ref" href="http://exple.tive.org/blarg/">http://exple.tive.org/blarg/</a></li>
<li>minimist: <a class="link-ref" href="https://www.npmjs.com/package/minimist">https://www.npmjs.com/package/minimist</a></li>
<li>Mocha: <a class="link-ref" href="https://mochajs.org/">https://mochajs.org/</a></li>
<li>Node crypto module: <a class="link-ref" href="https://nodejs.org/api/crypto.html">https://nodejs.org/api/crypto.html</a></li>
<li>Node filesystem status class.: <a class="link-ref" href="https://nodejs.org/api/fs.html#fs_class_fs_stats">https://nodejs.org/api/fs.html#fs_class_fs_stats</a></li>
<li>Node fs package: <a class="link-ref" href="https://nodejs.org/api/fs.html">https://nodejs.org/api/fs.html</a></li>
<li>Node fs-extra package: <a class="link-ref" href="https://www.npmjs.com/package/fs-extra">https://www.npmjs.com/package/fs-extra</a></li>
<li>Node glob: <a class="link-ref" href="https://www.npmjs.com/package/glob">https://www.npmjs.com/package/glob</a></li>
<li>Node mock-fs: <a class="link-ref" href="https://www.npmjs.com/package/mock-fs">https://www.npmjs.com/package/mock-fs</a></li>
<li>Node path: <a class="link-ref" href="https://nodejs.org/api/path.html">https://nodejs.org/api/path.html</a></li>
<li>Node prompt-sync: <a class="link-ref" href="https://www.npmjs.com/package/prompt-sync">https://www.npmjs.com/package/prompt-sync</a></li>
<li>Node semver: <a class="link-ref" href="https://www.npmjs.com/package/semver">https://www.npmjs.com/package/semver</a></li>
<li>Node.js: <a class="link-ref" href="https://nodejs.org/en/">https://nodejs.org/en/</a></li>
<li>NPM: <a class="link-ref" href="https://www.npmjs.com/">https://www.npmjs.com/</a></li>
<li>object-sizeof package: <a class="link-ref" href="https://www.npmjs.com/package/object-sizeof">https://www.npmjs.com/package/object-sizeof</a></li>
<li>Pandas: <a class="link-ref" href="https://pandas.pydata.org/">https://pandas.pydata.org/</a></li>
<li>PHP: <a class="link-ref" href="https://www.php.net/">https://www.php.net/</a></li>
<li>Punching Holes: <a class="link-ref" href="http://exple.tive.org/blarg/2020/11/26/punching-holes/">http://exple.tive.org/blarg/2020/11/26/punching-holes/</a></li>
<li>Python: <a class="link-ref" href="https://www.python.org/">https://www.python.org/</a></li>
<li>Red Door Family Shelter: <a class="link-ref" href="https://www.reddoorshelter.ca/">https://www.reddoorshelter.ca/</a></li>
<li>Research Software Engineering with Python: <a class="link-ref" href="https://merely-useful.tech/py-rse/">https://merely-useful.tech/py-rse/</a></li>
<li>Semantic versioning specification: <a class="link-ref" href="https://semver.org/">https://semver.org/</a></li>
<li>Shunting-yard algorithm: <a class="link-ref" href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">https://en.wikipedia.org/wiki/Shunting-yard_algorithm</a></li>
<li>Software Tools in JavaScript: <a class="link-ref" href="https://stjs.tech/">https://stjs.tech/</a></li>
<li>SVG Screenshot: <a class="link-ref" href="https://chrome.google.com/webstore/detail/svg-screenshot/nfakpcpmhhilkdpphcjgnokknpbpdllg">https://chrome.google.com/webstore/detail/svg-screenshot/nfakpcpmhhilkdpphcjgnokknpbpdllg</a></li>
<li>Tavish Armstrong: <a class="link-ref" href="http://tavisharmstrong.com/">http://tavisharmstrong.com/</a></li>
<li>Teaching Tech Together: <a class="link-ref" href="http://teachtogether.tech/">http://teachtogether.tech/</a></li>
<li>Tidyverse: <a class="link-ref" href="https://www.tidyverse.org/">https://www.tidyverse.org/</a></li>
<li>Trey Huffine: <a class="link-ref" href="https://medium.com/@treyhuffine">https://medium.com/@treyhuffine</a></li>
<li>Understand JavaScript Promises by Building a Simple Promise Example: <a class="link-ref" href="https://levelup.gitconnected.com/understand-javascript-promises-by-building-a-promise-from-scratch-84c0fd855720">https://levelup.gitconnected.com/understand-javascript-promises-by-building-a-promise-from-scratch-84c0fd855720</a></li>
<li>Using data attributes: <a class="link-ref" href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes">https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes</a></li>
<li>WAVE: <a class="link-ref" href="https://wave.webaim.org/">https://wave.webaim.org/</a></li>
<li>Why We Can't Have Nice Things: <a class="link-ref" href="https://third-bit.com/2015/06/11/why-we-cant-have-nice-things/">https://third-bit.com/2015/06/11/why-we-cant-have-nice-things/</a></li>
<li>Wikipedia article on programming tools: <a class="link-ref" href="https://en.wikipedia.org/wiki/Programming_tool">https://en.wikipedia.org/wiki/Programming_tool</a></li>
<li>Wolfram Alpha: <a class="link-ref" href="http://wolframalpha.com">http://wolframalpha.com</a></li>
<li>You can't parse [X]HTML with regex: <a class="link-ref" href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454</a></li>
</ul>
</section>
<section class="new-chapter"><h1 id="contents">Appendix: Appendix G: Index</h1>

<ul class="ix-list">
<li>abstract syntax tree: <a class="ix-ref" href="#style-checker" ix-ref="abstract syntax tree">Style Checker</a>, <a class="ix-ref" href="#code-generator" ix-ref="abstract syntax tree">Code Generator</a>, <a class="ix-ref" href="#doc-generator" ix-ref="abstract syntax tree">Documentation Generator</a>, <a class="ix-ref" href="#debugger" ix-ref="abstract syntax tree">Debugger</a></li>
<li>Accumulator pattern: <a class="ix-ref" href="#doc-generator" ix-ref="Accumulator pattern">Documentation Generator</a></li>
<li>Acorn: <a class="ix-ref" href="#style-checker" ix-ref="Acorn">Style Checker</a>, <a class="ix-ref" href="#code-generator" ix-ref="Acorn">Code Generator</a>, <a class="ix-ref" href="#doc-generator" ix-ref="Acorn">Documentation Generator</a>, <a class="ix-ref" href="#module-bundler" ix-ref="Acorn">Module Bundler</a>, <a class="ix-ref" href="#debugger" ix-ref="Acorn">Debugger</a></li>
<li>actual result (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="actual result (in unit test)">Unit Testing</a></li>
<li>Adapter pattern: <a class="ix-ref" href="#style-checker" ix-ref="Adapter pattern">Style Checker</a></li>
<li>algorithm</li>
<li>…greedy: <a class="ix-ref" href="#pattern-matching" ix-ref="greedy">Pattern Matching</a></li>
<li>alias</li>
<li>…during import: <a class="ix-ref" href="#module-loader" ix-ref="during import">Module Loader</a></li>
<li>anonymous function: <a class="ix-ref" href="#systems-programming" ix-ref="anonymous function">Systems Programming</a></li>
<li>ANTLR: <a class="ix-ref" href="#regex-parser" ix-ref="ANTLR">Parsing Expressions</a></li>
<li>API</li>
<li>…as protocol: <a class="ix-ref" href="#systems-programming" ix-ref="as protocol">Systems Programming</a>, <a class="ix-ref" href="#async-programming" ix-ref="as protocol">Asynchronous Programming</a></li>
<li>Application Binary Interface: <a class="ix-ref" href="#virtual-machine" ix-ref="Application Binary Interface">Virtual Machine</a></li>
<li>Armstrong, Tavish: <a class="ix-ref" href="#introduction" ix-ref="Armstrong, Tavish">Introduction</a></li>
<li>array</li>
<li>…implementation of: <a class="ix-ref" href="#virtual-machine" ix-ref="implementation of">Virtual Machine</a></li>
<li>Array.filter: <a class="ix-ref" href="#systems-programming" ix-ref="Array.filter">Systems Programming</a></li>
<li>Array.forEach: <a class="ix-ref" href="#async-programming" ix-ref="Array.forEach">Asynchronous Programming</a></li>
<li>Array.reduce: <a class="ix-ref" href="#build-manager" ix-ref="Array.reduce">Build Manager</a></li>
<li>ArrayBuffer: <a class="ix-ref" href="#data-table" ix-ref="ArrayBuffer">Data Tables</a></li>
<li>assembler: <a class="ix-ref" href="#virtual-machine" ix-ref="assembler">Virtual Machine</a></li>
<li>assembly code: <a class="ix-ref" href="#virtual-machine" ix-ref="assembly code">Virtual Machine</a>, <a class="ix-ref" href="#debugger" ix-ref="assembly code">Debugger</a></li>
<li>assertion</li>
<li>…as runnable documentation: <a class="ix-ref" href="#build-manager" ix-ref="as runnable documentation">Build Manager</a></li>
<li>assertion</li>
<li>…in unit test: <a class="ix-ref" href="#unit-test" ix-ref="in unit test">Unit Testing</a></li>
<li>assignment</li>
<li>…destructuring: <a class="ix-ref" href="#systems-programming" ix-ref="destructuring">Systems Programming</a></li>
<li>async keyword: <a class="ix-ref" href="#async-programming" ix-ref="async keyword">Asynchronous Programming</a></li>
<li>asynchronous execution: <a class="ix-ref" href="#systems-programming" ix-ref="asynchronous execution">Systems Programming</a></li>
<li>automatic variable (in build): <a class="ix-ref" href="#build-manager" ix-ref="automatic variable (in build)">Build Manager</a></li>
<li>await keyword: <a class="ix-ref" href="#async-programming" ix-ref="await keyword">Asynchronous Programming</a></li>
<li>Babel: <a class="ix-ref" href="#code-generator" ix-ref="Babel">Code Generator</a></li>
<li>backward compatibility: <a class="ix-ref" href="#package-manager" ix-ref="backward compatibility">Package Manager</a></li>
<li>Bajel: <a class="ix-ref" href="#build-manager" ix-ref="Bajel">Build Manager</a></li>
<li>bare object: <a class="ix-ref" href="#page-templates" ix-ref="bare object">Page Templates</a></li>
<li>bind method to object: <a class="ix-ref" href="#async-programming" ix-ref="bind method to object">Asynchronous Programming</a></li>
<li>bitwise operation: <a class="ix-ref" href="#virtual-machine" ix-ref="bitwise operation">Virtual Machine</a></li>
<li>block comment: <a class="ix-ref" href="#doc-generator" ix-ref="block comment">Documentation Generator</a></li>
<li>Brown, Amy: <a class="ix-ref" href="#introduction" ix-ref="Brown, Amy">Introduction</a></li>
<li>Brubeck, Matt: <a class="ix-ref" href="#layout-engine" ix-ref="Brubeck, Matt">Layout Engine</a></li>
<li>build</li>
<li>…automatic variable: <a class="ix-ref" href="#build-manager" ix-ref="automatic variable">Build Manager</a></li>
<li>build</li>
<li>…clock synchronization: <a class="ix-ref" href="#build-manager" ix-ref="clock synchronization">Build Manager</a></li>
<li>build</li>
<li>…dependency: <a class="ix-ref" href="#build-manager" ix-ref="dependency">Build Manager</a></li>
<li>build</li>
<li>…hash code: <a class="ix-ref" href="#build-manager" ix-ref="hash code">Build Manager</a></li>
<li>build</li>
<li>…pattern rule: <a class="ix-ref" href="#build-manager" ix-ref="pattern rule">Build Manager</a></li>
<li>build</li>
<li>…recipe: <a class="ix-ref" href="#build-manager" ix-ref="recipe">Build Manager</a></li>
<li>build</li>
<li>…rule: <a class="ix-ref" href="#build-manager" ix-ref="rule">Build Manager</a></li>
<li>build</li>
<li>…stale: <a class="ix-ref" href="#build-manager" ix-ref="stale">Build Manager</a></li>
<li>build</li>
<li>…timestamp: <a class="ix-ref" href="#build-manager" ix-ref="timestamp">Build Manager</a></li>
<li>build manager: <a class="ix-ref" href="#build-manager" ix-ref="build manager">Build Manager</a></li>
<li>build target: <a class="ix-ref" href="#build-manager" ix-ref="build target">Build Manager</a></li>
<li>C: <a class="ix-ref" href="#build-manager" ix-ref="C">Build Manager</a>, <a class="ix-ref" href="#file-interpolator" ix-ref="C">File Interpolator</a>, <a class="ix-ref" href="#style-checker" ix-ref="C">Style Checker</a></li>
<li>C++: <a class="ix-ref" href="#file-interpolator" ix-ref="C++">File Interpolator</a></li>
<li>cache</li>
<li>…calculated values: <a class="ix-ref" href="#layout-engine" ix-ref="calculated values">Layout Engine</a></li>
<li>cache</li>
<li>…modules: <a class="ix-ref" href="#unit-test" ix-ref="modules">Unit Testing</a></li>
<li>cache</li>
<li>…of loaded files: <a class="ix-ref" href="#file-interpolator" ix-ref="of loaded files">File Interpolator</a>, <a class="ix-ref" href="#module-loader" ix-ref="of loaded files">Module Loader</a></li>
<li>call stack</li>
<li>…environment: <a class="ix-ref" href="#page-templates" ix-ref="environment">Page Templates</a></li>
<li>call stack</li>
<li>…stack frame: <a class="ix-ref" href="#page-templates" ix-ref="stack frame">Page Templates</a></li>
<li>callback function: <a class="ix-ref" href="#systems-programming" ix-ref="callback function">Systems Programming</a></li>
<li>…conventions for: <a class="ix-ref" href="#systems-programming" ix-ref="conventions for">Systems Programming</a></li>
<li>caller module: <a class="ix-ref" href="#unit-test" ix-ref="caller module">Unit Testing</a></li>
<li>chain of inheritance: <a class="ix-ref" href="#style-checker" ix-ref="chain of inheritance">Style Checker</a></li>
<li>Chain of Responsibility pattern: <a class="ix-ref" href="#pattern-matching" ix-ref="Chain of Responsibility pattern">Pattern Matching</a></li>
<li>character encoding: <a class="ix-ref" href="#async-programming" ix-ref="character encoding">Asynchronous Programming</a></li>
<li>…UTF-8: <a class="ix-ref" href="#async-programming" ix-ref="UTF-8">Asynchronous Programming</a></li>
<li>circular dependency: <a class="ix-ref" href="#module-loader" ix-ref="circular dependency">Module Loader</a></li>
<li>clock synchronization (in build): <a class="ix-ref" href="#build-manager" ix-ref="clock synchronization (in build)">Build Manager</a></li>
<li>closure: <a class="ix-ref" href="#module-loader" ix-ref="closure">Module Loader</a></li>
<li>code</li>
<li>…as data: <a class="ix-ref" href="#doc-generator" ix-ref="as data">Documentation Generator</a>, <a class="ix-ref" href="#systems-programming" ix-ref="as data">Systems Programming</a></li>
<li>code coverage: <a class="ix-ref" href="#code-generator" ix-ref="code coverage">Code Generator</a></li>
<li>coding style</li>
<li>…importance of consistency: <a class="ix-ref" href="#style-checker" ix-ref="importance of consistency">Style Checker</a></li>
<li>coding style</li>
<li>…linter: <a class="ix-ref" href="#style-checker" ix-ref="linter">Style Checker</a></li>
<li>cognitive load: <a class="ix-ref" href="#systems-programming" ix-ref="cognitive load">Systems Programming</a>, <a class="ix-ref" href="#page-templates" ix-ref="cognitive load">Page Templates</a></li>
<li>collision (in hashing): <a class="ix-ref" href="#file-backup" ix-ref="collision (in hashing)">File Backup</a></li>
<li>column-major storage order: <a class="ix-ref" href="#data-table" ix-ref="column-major storage order">Data Tables</a></li>
<li>combinatorial explosion: <a class="ix-ref" href="#package-manager" ix-ref="combinatorial explosion">Package Manager</a></li>
<li>command-line argument: <a class="ix-ref" href="#systems-programming" ix-ref="command-line argument">Systems Programming</a></li>
<li>comment</li>
<li>…block: <a class="ix-ref" href="#doc-generator" ix-ref="block">Documentation Generator</a></li>
<li>comment</li>
<li>…doc: <a class="ix-ref" href="#doc-generator" ix-ref="doc">Documentation Generator</a></li>
<li>comment</li>
<li>…line: <a class="ix-ref" href="#doc-generator" ix-ref="line">Documentation Generator</a></li>
<li>compiled language: <a class="ix-ref" href="#build-manager" ix-ref="compiled language">Build Manager</a></li>
<li>…linking: <a class="ix-ref" href="#build-manager" ix-ref="linking">Build Manager</a></li>
<li>Comprehensive TeX Archive Network: <a class="ix-ref" href="#package-manager" ix-ref="Comprehensive TeX Archive Network">Package Manager</a></li>
<li>confirmation bias: <a class="ix-ref" href="#layout-engine" ix-ref="confirmation bias">Layout Engine</a></li>
<li>console.log: <a class="ix-ref" href="#systems-programming" ix-ref="console.log">Systems Programming</a></li>
<li>const declaration</li>
<li>…advantages of: <a class="ix-ref" href="#systems-programming" ix-ref="advantages of">Systems Programming</a></li>
<li>Cook, Mary Rose: <a class="ix-ref" href="#file-backup" ix-ref="Cook, Mary Rose">File Backup</a></li>
<li>coordinate system: <a class="ix-ref" href="#layout-engine" ix-ref="coordinate system">Layout Engine</a></li>
<li>coupling: <a class="ix-ref" href="#pattern-matching" ix-ref="coupling">Pattern Matching</a></li>
<li>cryptographic hash function: <a class="ix-ref" href="#file-backup" ix-ref="cryptographic hash function">File Backup</a></li>
<li>CSS: <a class="ix-ref" href="#layout-engine" ix-ref="CSS">Layout Engine</a>, <a class="ix-ref" href="#doc-generator" ix-ref="CSS">Documentation Generator</a></li>
<li>…struggles with: <a class="ix-ref" href="#layout-engine" ix-ref="struggles with">Layout Engine</a></li>
<li>DAG: <a class="ix-ref" href="#build-manager" ix-ref="DAG">Build Manager</a></li>
<li>data frame: <a class="ix-ref" href="#data-table" ix-ref="data frame">Data Tables</a></li>
<li>DataForge: <a class="ix-ref" href="#data-table" ix-ref="DataForge">Data Tables</a></li>
<li>debugger: <a class="ix-ref" href="#debugger" ix-ref="debugger">Debugger</a></li>
<li>…source map: <a class="ix-ref" href="#debugger" ix-ref="source map">Debugger</a></li>
<li>Decorator pattern: <a class="ix-ref" href="#code-generator" ix-ref="Decorator pattern">Code Generator</a></li>
<li>dependency (in build): <a class="ix-ref" href="#build-manager" ix-ref="dependency (in build)">Build Manager</a></li>
<li>depth-first search: <a class="ix-ref" href="#pattern-matching" ix-ref="depth-first search">Pattern Matching</a></li>
<li>design by contract: <a class="ix-ref" href="#layout-engine" ix-ref="design by contract">Layout Engine</a></li>
<li>design pattern</li>
<li>…Accumulator: <a class="ix-ref" href="#doc-generator" ix-ref="Accumulator">Documentation Generator</a></li>
<li>design pattern</li>
<li>…Adapter: <a class="ix-ref" href="#style-checker" ix-ref="Adapter">Style Checker</a></li>
<li>design pattern</li>
<li>…Chain of Responsibility: <a class="ix-ref" href="#pattern-matching" ix-ref="Chain of Responsibility">Pattern Matching</a></li>
<li>design pattern</li>
<li>…Decorator: <a class="ix-ref" href="#code-generator" ix-ref="Decorator">Code Generator</a></li>
<li>design pattern</li>
<li>…Iterator: <a class="ix-ref" href="#style-checker" ix-ref="Iterator">Style Checker</a></li>
<li>design pattern</li>
<li>…Singleton: <a class="ix-ref" href="#file-interpolator" ix-ref="Singleton">File Interpolator</a>, <a class="ix-ref" href="#unit-test" ix-ref="Singleton">Unit Testing</a></li>
<li>design pattern</li>
<li>…Template Method: <a class="ix-ref" href="#build-manager" ix-ref="Template Method">Build Manager</a></li>
<li>design pattern</li>
<li>…Visitor: <a class="ix-ref" href="#build-manager" ix-ref="Visitor">Build Manager</a>, <a class="ix-ref" href="#style-checker" ix-ref="Visitor">Style Checker</a>, <a class="ix-ref" href="#page-templates" ix-ref="Visitor">Page Templates</a></li>
<li>destructuring assignment: <a class="ix-ref" href="#systems-programming" ix-ref="destructuring assignment">Systems Programming</a></li>
<li>DiBernardo, Mike: <a class="ix-ref" href="#introduction" ix-ref="DiBernardo, Mike">Introduction</a></li>
<li>directed acyclic graph: <a class="ix-ref" href="#module-loader" ix-ref="directed acyclic graph">Module Loader</a></li>
<li>directed acyclic graph (DAG): <a class="ix-ref" href="#build-manager" ix-ref="directed acyclic graph (DAG)">Build Manager</a></li>
<li>directed graph: <a class="ix-ref" href="#module-loader" ix-ref="directed graph">Module Loader</a></li>
<li>doc comment: <a class="ix-ref" href="#doc-generator" ix-ref="doc comment">Documentation Generator</a></li>
<li>Document Object Model: <a class="ix-ref" href="#style-checker" ix-ref="Document Object Model">Style Checker</a>, <a class="ix-ref" href="#pattern-matching" ix-ref="Document Object Model">Pattern Matching</a></li>
<li>DOM: <a class="ix-ref" href="#pattern-matching" ix-ref="DOM">Pattern Matching</a>, <a class="ix-ref" href="#page-templates" ix-ref="DOM">Page Templates</a></li>
<li>dynamic loading: <a class="ix-ref" href="#unit-test" ix-ref="dynamic loading">Unit Testing</a></li>
<li>dynamic lookup: <a class="ix-ref" href="#style-checker" ix-ref="dynamic lookup">Style Checker</a></li>
<li>dynamic scoping: <a class="ix-ref" href="#page-templates" ix-ref="dynamic scoping">Page Templates</a></li>
<li>eager matching: <a class="ix-ref" href="#pattern-matching" ix-ref="eager matching">Pattern Matching</a></li>
<li>EJS: <a class="ix-ref" href="#page-templates" ix-ref="EJS">Page Templates</a></li>
<li>encapsulation: <a class="ix-ref" href="#module-loader" ix-ref="encapsulation">Module Loader</a></li>
<li>entry point (of module): <a class="ix-ref" href="#module-bundler" ix-ref="entry point (of module)">Module Bundler</a></li>
<li>environment (to store variables): <a class="ix-ref" href="#page-templates" ix-ref="environment (to store variables)">Page Templates</a></li>
<li>error (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="error (in unit test)">Unit Testing</a></li>
<li>Escodegen: <a class="ix-ref" href="#code-generator" ix-ref="Escodegen">Code Generator</a></li>
<li>ESDoc: <a class="ix-ref" href="#doc-generator" ix-ref="ESDoc">Documentation Generator</a></li>
<li>ESLint: <a class="ix-ref" href="#file-interpolator" ix-ref="ESLint">File Interpolator</a>, <a class="ix-ref" href="#style-checker" ix-ref="ESLint">Style Checker</a></li>
<li>Esprima format: <a class="ix-ref" href="#style-checker" ix-ref="Esprima format">Style Checker</a></li>
<li>eval</li>
<li>…insecurity of: <a class="ix-ref" href="#file-interpolator" ix-ref="insecurity of">File Interpolator</a></li>
<li>event handler</li>
<li>…streaming API: <a class="ix-ref" href="#file-backup" ix-ref="streaming API">File Backup</a></li>
<li>event loop: <a class="ix-ref" href="#async-programming" ix-ref="event loop">Asynchronous Programming</a></li>
<li>exception</li>
<li>…for control flow: <a class="ix-ref" href="#debugger" ix-ref="for control flow">Debugger</a></li>
<li>exception</li>
<li>…handler: <a class="ix-ref" href="#unit-test" ix-ref="handler">Unit Testing</a></li>
<li>exception</li>
<li>…in promise: <a class="ix-ref" href="#async-programming" ix-ref="in promise">Asynchronous Programming</a></li>
<li>exception</li>
<li>…throw: <a class="ix-ref" href="#unit-test" ix-ref="throw">Unit Testing</a></li>
<li>exception</li>
<li>…with await: <a class="ix-ref" href="#async-programming" ix-ref="with await">Asynchronous Programming</a></li>
<li>execution</li>
<li>…asynchronous: <a class="ix-ref" href="#systems-programming" ix-ref="asynchronous">Systems Programming</a></li>
<li>execution</li>
<li>…event loop: <a class="ix-ref" href="#async-programming" ix-ref="event loop">Asynchronous Programming</a></li>
<li>execution</li>
<li>…non-blocking: <a class="ix-ref" href="#async-programming" ix-ref="non-blocking">Asynchronous Programming</a></li>
<li>execution</li>
<li>…single-threaded: <a class="ix-ref" href="#systems-programming" ix-ref="single-threaded">Systems Programming</a></li>
<li>execution</li>
<li>…streaming: <a class="ix-ref" href="#file-backup" ix-ref="streaming">File Backup</a></li>
<li>Expect: <a class="ix-ref" href="#debugger" ix-ref="Expect">Debugger</a></li>
<li>expected result (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="expected result (in unit test)">Unit Testing</a></li>
<li>experiments: <a class="ix-ref" href="#data-table" ix-ref="experiments">Data Tables</a></li>
<li>…test harness: <a class="ix-ref" href="#data-table" ix-ref="test harness">Data Tables</a></li>
<li>exploratory programming: <a class="ix-ref" href="#unit-test" ix-ref="exploratory programming">Unit Testing</a></li>
<li>fail (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="fail (in unit test)">Unit Testing</a></li>
<li>filesystem operations: <a class="ix-ref" href="#systems-programming" ix-ref="filesystem operations">Systems Programming</a></li>
<li>finite state machine</li>
<li>…correspondence with regular expressions: <a class="ix-ref" href="#regex-parser" ix-ref="correspondence with regular expressions">Parsing Expressions</a></li>
<li>fixture (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="fixture (in unit test)">Unit Testing</a></li>
<li>fluent interface: <a class="ix-ref" href="#async-programming" ix-ref="fluent interface">Asynchronous Programming</a></li>
<li>fs.stat: <a class="ix-ref" href="#systems-programming" ix-ref="fs.stat">Systems Programming</a></li>
<li>function</li>
<li>…anonymous: <a class="ix-ref" href="#systems-programming" ix-ref="anonymous">Systems Programming</a></li>
<li>function</li>
<li>…inner: <a class="ix-ref" href="#module-loader" ix-ref="inner">Module Loader</a></li>
<li>function</li>
<li>…nested: <a class="ix-ref" href="#code-generator" ix-ref="nested">Code Generator</a></li>
<li>function signature: <a class="ix-ref" href="#layout-engine" ix-ref="function signature">Layout Engine</a></li>
<li>generator function: <a class="ix-ref" href="#style-checker" ix-ref="generator function">Style Checker</a></li>
<li>Git: <a class="ix-ref" href="#file-backup" ix-ref="Git">File Backup</a></li>
<li>GitHub Pages: <a class="ix-ref" href="#page-templates" ix-ref="GitHub Pages">Page Templates</a></li>
<li>globbing: <a class="ix-ref" href="#systems-programming" ix-ref="globbing">Systems Programming</a></li>
<li>…filtering results: <a class="ix-ref" href="#systems-programming" ix-ref="filtering results">Systems Programming</a></li>
<li>greedy algorithm: <a class="ix-ref" href="#pattern-matching" ix-ref="greedy algorithm">Pattern Matching</a></li>
<li>hash code: <a class="ix-ref" href="#file-backup" ix-ref="hash code">File Backup</a></li>
<li>…in build: <a class="ix-ref" href="#build-manager" ix-ref="in build">Build Manager</a></li>
<li>…SHA-1: <a class="ix-ref" href="#file-backup" ix-ref="SHA-1">File Backup</a></li>
<li>hash function: <a class="ix-ref" href="#file-backup" ix-ref="hash function">File Backup</a></li>
<li>…collision: <a class="ix-ref" href="#file-backup" ix-ref="collision">File Backup</a></li>
<li>…cryptographic: <a class="ix-ref" href="#file-backup" ix-ref="cryptographic">File Backup</a></li>
<li>header file</li>
<li>…in C and C++: <a class="ix-ref" href="#file-interpolator" ix-ref="in C and C++">File Interpolator</a></li>
<li>header file</li>
<li>…static site generator: <a class="ix-ref" href="#file-interpolator" ix-ref="static site generator">File Interpolator</a></li>
<li>helper function: <a class="ix-ref" href="#code-generator" ix-ref="helper function">Code Generator</a>, <a class="ix-ref" href="#file-backup" ix-ref="helper function">File Backup</a></li>
<li>heterogeneous storage: <a class="ix-ref" href="#data-table" ix-ref="heterogeneous storage">Data Tables</a></li>
<li>homogeneous storage: <a class="ix-ref" href="#data-table" ix-ref="homogeneous storage">Data Tables</a></li>
<li>Hoye, Mike: <a class="ix-ref" href="#layout-engine" ix-ref="Hoye, Mike">Layout Engine</a></li>
<li>HTML5 specification: <a class="ix-ref" href="#page-templates" ix-ref="HTML5 specification">Page Templates</a></li>
<li>Huffine, Trey: <a class="ix-ref" href="#async-programming" ix-ref="Huffine, Trey">Asynchronous Programming</a></li>
<li>Human Resource Machine: <a class="ix-ref" href="#virtual-machine" ix-ref="Human Resource Machine">Virtual Machine</a></li>
<li>immediately-invoked function expression: <a class="ix-ref" href="#module-loader" ix-ref="immediately-invoked function expression">Module Loader</a>, <a class="ix-ref" href="#module-bundler" ix-ref="immediately-invoked function expression">Module Bundler</a></li>
<li>immutable data: <a class="ix-ref" href="#data-table" ix-ref="immutable data">Data Tables</a></li>
<li>import</li>
<li>…alias: <a class="ix-ref" href="#module-loader" ix-ref="alias">Module Loader</a></li>
<li>import module: <a class="ix-ref" href="#systems-programming" ix-ref="import module">Systems Programming</a></li>
<li>import vs. require: <a class="ix-ref" href="#module-bundler" ix-ref="import vs. require">Module Bundler</a>, <a class="ix-ref" href="#systems-programming" ix-ref="import vs. require">Systems Programming</a></li>
<li>inner function: <a class="ix-ref" href="#module-loader" ix-ref="inner function">Module Loader</a></li>
<li>instruction pointer: <a class="ix-ref" href="#virtual-machine" ix-ref="instruction pointer">Virtual Machine</a></li>
<li>instruction set: <a class="ix-ref" href="#virtual-machine" ix-ref="instruction set">Virtual Machine</a></li>
<li>interpreted language: <a class="ix-ref" href="#build-manager" ix-ref="interpreted language">Build Manager</a></li>
<li>intrinsic complexity: <a class="ix-ref" href="#style-checker" ix-ref="intrinsic complexity">Style Checker</a>, <a class="ix-ref" href="#module-bundler" ix-ref="intrinsic complexity">Module Bundler</a></li>
<li>introspection</li>
<li>…in unit testing: <a class="ix-ref" href="#unit-test" ix-ref="in unit testing">Unit Testing</a></li>
<li>introspection</li>
<li>…of methods: <a class="ix-ref" href="#style-checker" ix-ref="of methods">Style Checker</a></li>
<li>Istanbul: <a class="ix-ref" href="#code-generator" ix-ref="Istanbul">Code Generator</a></li>
<li>Iterator pattern: <a class="ix-ref" href="#style-checker" ix-ref="Iterator pattern">Style Checker</a></li>
<li>…generator function: <a class="ix-ref" href="#style-checker" ix-ref="generator function">Style Checker</a></li>
<li>Jake: <a class="ix-ref" href="#build-manager" ix-ref="Jake">Build Manager</a></li>
<li>Java: <a class="ix-ref" href="#build-manager" ix-ref="Java">Build Manager</a>, <a class="ix-ref" href="#code-generator" ix-ref="Java">Code Generator</a>, <a class="ix-ref" href="#systems-programming" ix-ref="Java">Systems Programming</a></li>
<li>JavaScript</li>
<li>…hurried design of: <a class="ix-ref" href="#module-bundler" ix-ref="hurried design of">Module Bundler</a></li>
<li>Jekyll: <a class="ix-ref" href="#page-templates" ix-ref="Jekyll">Page Templates</a></li>
<li>Jest: <a class="ix-ref" href="#unit-test" ix-ref="Jest">Unit Testing</a></li>
<li>JSDoc: <a class="ix-ref" href="#doc-generator" ix-ref="JSDoc">Documentation Generator</a></li>
<li>Kernighan, Brian: <a class="ix-ref" href="#pattern-matching" ix-ref="Kernighan, Brian">Pattern Matching</a></li>
<li>Knuth, Donald: <a class="ix-ref" href="#file-interpolator" ix-ref="Knuth, Donald">File Interpolator</a></li>
<li>label (on address): <a class="ix-ref" href="#virtual-machine" ix-ref="label (on address)">Virtual Machine</a></li>
<li>language</li>
<li>…compiled: <a class="ix-ref" href="#build-manager" ix-ref="compiled">Build Manager</a></li>
<li>language</li>
<li>…interpreted: <a class="ix-ref" href="#build-manager" ix-ref="interpreted">Build Manager</a></li>
<li>layout engine: <a class="ix-ref" href="#layout-engine" ix-ref="layout engine">Layout Engine</a></li>
<li>lexical scoping: <a class="ix-ref" href="#page-templates" ix-ref="lexical scoping">Page Templates</a></li>
<li>lifecycle</li>
<li>…of file interpolation: <a class="ix-ref" href="#file-interpolator" ix-ref="of file interpolation">File Interpolator</a></li>
<li>lifecycle</li>
<li>…of unit test: <a class="ix-ref" href="#unit-test" ix-ref="of unit test">Unit Testing</a></li>
<li>line comment: <a class="ix-ref" href="#doc-generator" ix-ref="line comment">Documentation Generator</a></li>
<li>linking (compiled language): <a class="ix-ref" href="#build-manager" ix-ref="linking (compiled language)">Build Manager</a></li>
<li>linter: <a class="ix-ref" href="#style-checker" ix-ref="linter">Style Checker</a></li>
<li>Liskov Substitution Principle: <a class="ix-ref" href="#layout-engine" ix-ref="Liskov Substitution Principle">Layout Engine</a></li>
<li>literal (in parsing): <a class="ix-ref" href="#regex-parser" ix-ref="literal (in parsing)">Parsing Expressions</a></li>
<li>literate programming: <a class="ix-ref" href="#file-interpolator" ix-ref="literate programming">File Interpolator</a></li>
<li>macro: <a class="ix-ref" href="#code-generator" ix-ref="macro">Code Generator</a></li>
<li>Make: <a class="ix-ref" href="#build-manager" ix-ref="Make">Build Manager</a></li>
<li>manifest (of package): <a class="ix-ref" href="#package-manager" ix-ref="manifest (of package)">Package Manager</a></li>
<li>Markdown: <a class="ix-ref" href="#style-checker" ix-ref="Markdown">Style Checker</a>, <a class="ix-ref" href="#doc-generator" ix-ref="Markdown">Documentation Generator</a></li>
<li>…parser: <a class="ix-ref" href="#doc-generator" ix-ref="parser">Documentation Generator</a></li>
<li>matching</li>
<li>…eager: <a class="ix-ref" href="#pattern-matching" ix-ref="eager">Pattern Matching</a></li>
<li>method chaining: <a class="ix-ref" href="#async-programming" ix-ref="method chaining">Asynchronous Programming</a></li>
<li>Mocha: <a class="ix-ref" href="#layout-engine" ix-ref="Mocha">Layout Engine</a>, <a class="ix-ref" href="#unit-test" ix-ref="Mocha">Unit Testing</a>, <a class="ix-ref" href="#file-backup" ix-ref="Mocha">File Backup</a>, <a class="ix-ref" href="#pattern-matching" ix-ref="Mocha">Pattern Matching</a>, <a class="ix-ref" href="#regex-parser" ix-ref="Mocha">Parsing Expressions</a></li>
<li>…afterEach: <a class="ix-ref" href="#file-backup" ix-ref="afterEach">File Backup</a></li>
<li>…beforeEach: <a class="ix-ref" href="#file-backup" ix-ref="beforeEach">File Backup</a></li>
<li>mock object</li>
<li>…for testing: <a class="ix-ref" href="#file-backup" ix-ref="for testing">File Backup</a></li>
<li>module</li>
<li>…entry point: <a class="ix-ref" href="#module-bundler" ix-ref="entry point">Module Bundler</a></li>
<li>module bundler: <a class="ix-ref" href="#module-bundler" ix-ref="module bundler">Module Bundler</a></li>
<li>module loader: <a class="ix-ref" href="#file-interpolator" ix-ref="module loader">File Interpolator</a></li>
<li>mutual references: <a class="ix-ref" href="#debugger" ix-ref="mutual references">Debugger</a></li>
<li>namespace: <a class="ix-ref" href="#module-loader" ix-ref="namespace">Module Loader</a></li>
<li>nested function: <a class="ix-ref" href="#code-generator" ix-ref="nested function">Code Generator</a></li>
<li>Nison, Maël: <a class="ix-ref" href="#package-manager" ix-ref="Nison, Maël">Package Manager</a></li>
<li>non-blocking execution: <a class="ix-ref" href="#async-programming" ix-ref="non-blocking execution">Asynchronous Programming</a></li>
<li>Nystrom, Bob: <a class="ix-ref" href="#virtual-machine" ix-ref="Nystrom, Bob">Virtual Machine</a></li>
<li>op code: <a class="ix-ref" href="#virtual-machine" ix-ref="op code">Virtual Machine</a></li>
<li>Open-Closed Principle: <a class="ix-ref" href="#pattern-matching" ix-ref="Open-Closed Principle">Pattern Matching</a></li>
<li>operator precedence</li>
<li>…implementing: <a class="ix-ref" href="#regex-parser" ix-ref="implementing">Parsing Expressions</a></li>
<li>Oram, Andy: <a class="ix-ref" href="#introduction" ix-ref="Oram, Andy">Introduction</a></li>
<li>package manifest: <a class="ix-ref" href="#package-manager" ix-ref="package manifest">Package Manager</a></li>
<li>Pandas: <a class="ix-ref" href="#data-table" ix-ref="Pandas">Data Tables</a></li>
<li>parser: <a class="ix-ref" href="#regex-parser" ix-ref="parser">Parsing Expressions</a></li>
<li>…check-and-combine: <a class="ix-ref" href="#regex-parser" ix-ref="check-and-combine">Parsing Expressions</a></li>
<li>…post-hoc compression strategy: <a class="ix-ref" href="#regex-parser" ix-ref="post-hoc compression strategy">Parsing Expressions</a></li>
<li>…reasons not to write: <a class="ix-ref" href="#regex-parser" ix-ref="reasons not to write">Parsing Expressions</a></li>
<li>…shunting-yard algorithm: <a class="ix-ref" href="#regex-parser" ix-ref="shunting-yard algorithm">Parsing Expressions</a></li>
<li>pass (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="pass (in unit test)">Unit Testing</a></li>
<li>patch number: <a class="ix-ref" href="#package-manager" ix-ref="patch number">Package Manager</a></li>
<li>pattern rule (in build): <a class="ix-ref" href="#build-manager" ix-ref="pattern rule (in build)">Build Manager</a></li>
<li>PHP: <a class="ix-ref" href="#page-templates" ix-ref="PHP">Page Templates</a></li>
<li>plugin architecture: <a class="ix-ref" href="#module-loader" ix-ref="plugin architecture">Module Loader</a></li>
<li>polymorphism (in software design): <a class="ix-ref" href="#pattern-matching" ix-ref="polymorphism (in software design)">Pattern Matching</a></li>
<li>process.argv: <a class="ix-ref" href="#systems-programming" ix-ref="process.argv">Systems Programming</a></li>
<li>programming style</li>
<li>…fluent interface: <a class="ix-ref" href="#async-programming" ix-ref="fluent interface">Asynchronous Programming</a></li>
<li>promise</li>
<li>…as alternative to callback: <a class="ix-ref" href="#async-programming" ix-ref="as alternative to callback">Asynchronous Programming</a></li>
<li>promise</li>
<li>…automatic creation of: <a class="ix-ref" href="#async-programming" ix-ref="automatic creation of">Asynchronous Programming</a></li>
<li>promise</li>
<li>…behavior: <a class="ix-ref" href="#async-programming" ix-ref="behavior">Asynchronous Programming</a></li>
<li>promise</li>
<li>…catch: <a class="ix-ref" href="#async-programming" ix-ref="catch">Asynchronous Programming</a></li>
<li>promise</li>
<li>…reject: <a class="ix-ref" href="#async-programming" ix-ref="reject">Asynchronous Programming</a></li>
<li>promise</li>
<li>…resolve: <a class="ix-ref" href="#async-programming" ix-ref="resolve">Asynchronous Programming</a></li>
<li>promise</li>
<li>…then: <a class="ix-ref" href="#async-programming" ix-ref="then">Asynchronous Programming</a></li>
<li>Promise.all: <a class="ix-ref" href="#async-programming" ix-ref="Promise.all">Asynchronous Programming</a></li>
<li>protocol</li>
<li>…API as: <a class="ix-ref" href="#systems-programming" ix-ref="API as">Systems Programming</a>, <a class="ix-ref" href="#async-programming" ix-ref="API as">Asynchronous Programming</a></li>
<li>protocol</li>
<li>…for unit testing: <a class="ix-ref" href="#file-backup" ix-ref="for unit testing">File Backup</a></li>
<li>prune (a search tree): <a class="ix-ref" href="#package-manager" ix-ref="prune (a search tree)">Package Manager</a></li>
<li>Python: <a class="ix-ref" href="#module-loader" ix-ref="Python">Module Loader</a>, <a class="ix-ref" href="#code-generator" ix-ref="Python">Code Generator</a>, <a class="ix-ref" href="#systems-programming" ix-ref="Python">Systems Programming</a>, <a class="ix-ref" href="#data-table" ix-ref="Python">Data Tables</a></li>
<li>query selector: <a class="ix-ref" href="#layout-engine" ix-ref="query selector">Layout Engine</a></li>
<li>query selector (for HTML): <a class="ix-ref" href="#pattern-matching" ix-ref="query selector (for HTML)">Pattern Matching</a></li>
<li>R: <a class="ix-ref" href="#data-table" ix-ref="R">Data Tables</a></li>
<li>race condition: <a class="ix-ref" href="#file-backup" ix-ref="race condition">File Backup</a></li>
<li>…time of check/time of use: <a class="ix-ref" href="#file-backup" ix-ref="time of check/time of use">File Backup</a></li>
<li>recipe (in build): <a class="ix-ref" href="#build-manager" ix-ref="recipe (in build)">Build Manager</a></li>
<li>recycling data: <a class="ix-ref" href="#data-table" ix-ref="recycling data">Data Tables</a></li>
<li>register (in computer): <a class="ix-ref" href="#virtual-machine" ix-ref="register (in computer)">Virtual Machine</a></li>
<li>regular expression: <a class="ix-ref" href="#pattern-matching" ix-ref="regular expression">Pattern Matching</a></li>
<li>reject promise: <a class="ix-ref" href="#async-programming" ix-ref="reject promise">Asynchronous Programming</a></li>
<li>require</li>
<li>…caching modules: <a class="ix-ref" href="#unit-test" ix-ref="caching modules">Unit Testing</a></li>
<li>require vs. import: <a class="ix-ref" href="#module-bundler" ix-ref="require vs. import">Module Bundler</a>, <a class="ix-ref" href="#systems-programming" ix-ref="require vs. import">Systems Programming</a></li>
<li>resolve promise: <a class="ix-ref" href="#async-programming" ix-ref="resolve promise">Asynchronous Programming</a></li>
<li>row-major storage order: <a class="ix-ref" href="#data-table" ix-ref="row-major storage order">Data Tables</a></li>
<li>rule (in build): <a class="ix-ref" href="#build-manager" ix-ref="rule (in build)">Build Manager</a></li>
<li>runnable documentation (assertions as): <a class="ix-ref" href="#build-manager" ix-ref="runnable documentation (assertions as)">Build Manager</a></li>
<li>sandbox (for safe execution): <a class="ix-ref" href="#file-interpolator" ix-ref="sandbox (for safe execution)">File Interpolator</a></li>
<li>SAT solver: <a class="ix-ref" href="#package-manager" ix-ref="SAT solver">Package Manager</a></li>
<li>satisfiability: <a class="ix-ref" href="#package-manager" ix-ref="satisfiability">Package Manager</a></li>
<li>scope</li>
<li>…of variable definitions: <a class="ix-ref" href="#systems-programming" ix-ref="of variable definitions">Systems Programming</a></li>
<li>scope creep</li>
<li>…when writing lessons: <a class="ix-ref" href="#pattern-matching" ix-ref="when writing lessons">Pattern Matching</a></li>
<li>scoping</li>
<li>…dynamic: <a class="ix-ref" href="#page-templates" ix-ref="dynamic">Page Templates</a></li>
<li>scoping</li>
<li>…lexical: <a class="ix-ref" href="#page-templates" ix-ref="lexical">Page Templates</a></li>
<li>search</li>
<li>…depth-first: <a class="ix-ref" href="#pattern-matching" ix-ref="depth-first">Pattern Matching</a></li>
<li>search path: <a class="ix-ref" href="#file-interpolator" ix-ref="search path">File Interpolator</a></li>
<li>…shell variable: <a class="ix-ref" href="#file-interpolator" ix-ref="shell variable">File Interpolator</a></li>
<li>semantic versioning: <a class="ix-ref" href="#package-manager" ix-ref="semantic versioning">Package Manager</a></li>
<li>…patch number: <a class="ix-ref" href="#package-manager" ix-ref="patch number">Package Manager</a></li>
<li>setImmediate: <a class="ix-ref" href="#async-programming" ix-ref="setImmediate">Asynchronous Programming</a></li>
<li>setTimeout: <a class="ix-ref" href="#async-programming" ix-ref="setTimeout">Asynchronous Programming</a></li>
<li>SHA-1 hash code: <a class="ix-ref" href="#file-backup" ix-ref="SHA-1 hash code">File Backup</a></li>
<li>shell variable (for storing search path): <a class="ix-ref" href="#file-interpolator" ix-ref="shell variable (for storing search path)">File Interpolator</a></li>
<li>shunting-yard algorithm: <a class="ix-ref" href="#regex-parser" ix-ref="shunting-yard algorithm">Parsing Expressions</a></li>
<li>side effect</li>
<li>…for module registration: <a class="ix-ref" href="#unit-test" ix-ref="for module registration">Unit Testing</a></li>
<li>signature</li>
<li>…of function: <a class="ix-ref" href="#layout-engine" ix-ref="of function">Layout Engine</a></li>
<li>sin</li>
<li>…using regular expressions to parse HTML: <a class="ix-ref" href="#regex-parser" ix-ref="using regular expressions to parse HTML">Parsing Expressions</a></li>
<li>single-threaded execution: <a class="ix-ref" href="#systems-programming" ix-ref="single-threaded execution">Systems Programming</a></li>
<li>Singleton pattern: <a class="ix-ref" href="#file-interpolator" ix-ref="Singleton pattern">File Interpolator</a>, <a class="ix-ref" href="#unit-test" ix-ref="Singleton pattern">Unit Testing</a></li>
<li>slug (unique identifier): <a class="ix-ref" href="#doc-generator" ix-ref="slug (unique identifier)">Documentation Generator</a></li>
<li>software design</li>
<li>…bare object: <a class="ix-ref" href="#page-templates" ix-ref="bare object">Page Templates</a></li>
<li>software design</li>
<li>…coupling: <a class="ix-ref" href="#pattern-matching" ix-ref="coupling">Pattern Matching</a></li>
<li>software design</li>
<li>…deferring problems: <a class="ix-ref" href="#debugger" ix-ref="deferring problems">Debugger</a></li>
<li>software design</li>
<li>…design by contract: <a class="ix-ref" href="#layout-engine" ix-ref="design by contract">Layout Engine</a></li>
<li>software design</li>
<li>…driver: <a class="ix-ref" href="#build-manager" ix-ref="driver">Build Manager</a></li>
<li>software design</li>
<li>…encapsulation: <a class="ix-ref" href="#module-loader" ix-ref="encapsulation">Module Loader</a></li>
<li>software design</li>
<li>…generic function: <a class="ix-ref" href="#style-checker" ix-ref="generic function">Style Checker</a></li>
<li>software design</li>
<li>…Liskov Substitution Principle: <a class="ix-ref" href="#layout-engine" ix-ref="Liskov Substitution Principle">Layout Engine</a></li>
<li>software design</li>
<li>…Open-Closed Principle: <a class="ix-ref" href="#pattern-matching" ix-ref="Open-Closed Principle">Pattern Matching</a></li>
<li>software design</li>
<li>…plugin architecture: <a class="ix-ref" href="#module-loader" ix-ref="plugin architecture">Module Loader</a></li>
<li>software design</li>
<li>…polymorphism: <a class="ix-ref" href="#pattern-matching" ix-ref="polymorphism">Pattern Matching</a></li>
<li>software design</li>
<li>…testability: <a class="ix-ref" href="#file-backup" ix-ref="testability">File Backup</a></li>
<li>source map: <a class="ix-ref" href="#debugger" ix-ref="source map">Debugger</a></li>
<li>spread</li>
<li>…function arguments: <a class="ix-ref" href="#code-generator" ix-ref="function arguments">Code Generator</a></li>
<li>SQL: <a class="ix-ref" href="#data-table" ix-ref="SQL">Data Tables</a></li>
<li>stack frame: <a class="ix-ref" href="#page-templates" ix-ref="stack frame">Page Templates</a></li>
<li>stale (in build): <a class="ix-ref" href="#build-manager" ix-ref="stale (in build)">Build Manager</a></li>
<li>Standard JS: <a class="ix-ref" href="#style-checker" ix-ref="Standard JS">Style Checker</a></li>
<li>static site generator: <a class="ix-ref" href="#page-templates" ix-ref="static site generator">Page Templates</a></li>
<li>…header file: <a class="ix-ref" href="#file-interpolator" ix-ref="header file">File Interpolator</a></li>
<li>storage</li>
<li>…heterogeneous: <a class="ix-ref" href="#data-table" ix-ref="heterogeneous">Data Tables</a></li>
<li>storage</li>
<li>…homogeneous: <a class="ix-ref" href="#data-table" ix-ref="homogeneous">Data Tables</a></li>
<li>storage order</li>
<li>…column-major: <a class="ix-ref" href="#data-table" ix-ref="column-major">Data Tables</a></li>
<li>storage order</li>
<li>…row-major: <a class="ix-ref" href="#data-table" ix-ref="row-major">Data Tables</a></li>
<li>streaming API: <a class="ix-ref" href="#file-backup" ix-ref="streaming API">File Backup</a></li>
<li>…event handler: <a class="ix-ref" href="#file-backup" ix-ref="event handler">File Backup</a></li>
<li>string interpolation: <a class="ix-ref" href="#systems-programming" ix-ref="string interpolation">Systems Programming</a></li>
<li>tagged data structure: <a class="ix-ref" href="#data-table" ix-ref="tagged data structure">Data Tables</a></li>
<li>target</li>
<li>…build: <a class="ix-ref" href="#build-manager" ix-ref="build">Build Manager</a></li>
<li>TDD: <a class="ix-ref" href="#pattern-matching" ix-ref="TDD">Pattern Matching</a></li>
<li>Template Method pattern: <a class="ix-ref" href="#build-manager" ix-ref="Template Method pattern">Build Manager</a></li>
<li>test harness: <a class="ix-ref" href="#data-table" ix-ref="test harness">Data Tables</a></li>
<li>test runner: <a class="ix-ref" href="#unit-test" ix-ref="test runner">Unit Testing</a></li>
<li>test subject (in unit test): <a class="ix-ref" href="#unit-test" ix-ref="test subject (in unit test)">Unit Testing</a></li>
<li>test-driven development: <a class="ix-ref" href="#pattern-matching" ix-ref="test-driven development">Pattern Matching</a></li>
<li>testability</li>
<li>…as design criterion: <a class="ix-ref" href="#file-backup" ix-ref="as design criterion">File Backup</a></li>
<li>tidyverse: <a class="ix-ref" href="#data-table" ix-ref="tidyverse">Data Tables</a></li>
<li>time of check/time of use: <a class="ix-ref" href="#file-backup" ix-ref="time of check/time of use">File Backup</a></li>
<li>timestamp</li>
<li>…in build: <a class="ix-ref" href="#build-manager" ix-ref="in build">Build Manager</a></li>
<li>token (in parsing): <a class="ix-ref" href="#regex-parser" ix-ref="token (in parsing)">Parsing Expressions</a></li>
<li>topological order: <a class="ix-ref" href="#build-manager" ix-ref="topological order">Build Manager</a></li>
<li>transitive closure: <a class="ix-ref" href="#module-bundler" ix-ref="transitive closure">Module Bundler</a>, <a class="ix-ref" href="#package-manager" ix-ref="transitive closure">Package Manager</a></li>
<li>Turing Machine: <a class="ix-ref" href="#regex-parser" ix-ref="Turing Machine">Parsing Expressions</a></li>
<li>two hard problems in computer science: <a class="ix-ref" href="#code-generator" ix-ref="two hard problems in computer science">Code Generator</a></li>
<li>unit test</li>
<li>…actual result: <a class="ix-ref" href="#unit-test" ix-ref="actual result">Unit Testing</a></li>
<li>unit test</li>
<li>…error: <a class="ix-ref" href="#unit-test" ix-ref="error">Unit Testing</a></li>
<li>unit test</li>
<li>…expected result: <a class="ix-ref" href="#unit-test" ix-ref="expected result">Unit Testing</a></li>
<li>unit test</li>
<li>…fail: <a class="ix-ref" href="#unit-test" ix-ref="fail">Unit Testing</a></li>
<li>unit test</li>
<li>…fixture: <a class="ix-ref" href="#unit-test" ix-ref="fixture">Unit Testing</a></li>
<li>unit test</li>
<li>…interactive application: <a class="ix-ref" href="#debugger" ix-ref="interactive application">Debugger</a></li>
<li>unit test</li>
<li>…lifecycle: <a class="ix-ref" href="#unit-test" ix-ref="lifecycle">Unit Testing</a></li>
<li>unit test</li>
<li>…pass: <a class="ix-ref" href="#unit-test" ix-ref="pass">Unit Testing</a></li>
<li>unit test</li>
<li>…requirements for: <a class="ix-ref" href="#unit-test" ix-ref="requirements for">Unit Testing</a></li>
<li>unit test</li>
<li>…test runner: <a class="ix-ref" href="#unit-test" ix-ref="test runner">Unit Testing</a></li>
<li>unit test</li>
<li>…test subject: <a class="ix-ref" href="#unit-test" ix-ref="test subject">Unit Testing</a></li>
<li>unit test</li>
<li>…using mock object: <a class="ix-ref" href="#file-backup" ix-ref="using mock object">File Backup</a></li>
<li>University of Toronto: <a class="ix-ref" href="#introduction" ix-ref="University of Toronto">Introduction</a></li>
<li>UTF-8: <a class="ix-ref" href="#async-programming" ix-ref="UTF-8">Asynchronous Programming</a></li>
<li>variable definition</li>
<li>…scope: <a class="ix-ref" href="#systems-programming" ix-ref="scope">Systems Programming</a></li>
<li>version control system: <a class="ix-ref" href="#file-backup" ix-ref="version control system">File Backup</a></li>
<li>…Git: <a class="ix-ref" href="#file-backup" ix-ref="Git">File Backup</a></li>
<li>virtual machine: <a class="ix-ref" href="#virtual-machine" ix-ref="virtual machine">Virtual Machine</a>, <a class="ix-ref" href="#debugger" ix-ref="virtual machine">Debugger</a></li>
<li>…op code: <a class="ix-ref" href="#virtual-machine" ix-ref="op code">Virtual Machine</a></li>
<li>Visitor pattern: <a class="ix-ref" href="#build-manager" ix-ref="Visitor pattern">Build Manager</a>, <a class="ix-ref" href="#style-checker" ix-ref="Visitor pattern">Style Checker</a>, <a class="ix-ref" href="#page-templates" ix-ref="Visitor pattern">Page Templates</a></li>
<li>walk a tree: <a class="ix-ref" href="#style-checker" ix-ref="walk a tree">Style Checker</a></li>
<li>Whitehead, Alfred North: <a class="ix-ref" href="#doc-generator" ix-ref="Whitehead, Alfred North">Documentation Generator</a></li>
<li>Wilson, Greg: <a class="ix-ref" href="#introduction" ix-ref="Wilson, Greg">Introduction</a>, <a class="ix-ref" href="#layout-engine" ix-ref="Wilson, Greg">Layout Engine</a></li>
<li>Wolfram Alpha: <a class="ix-ref" href="#file-backup" ix-ref="Wolfram Alpha">File Backup</a></li>
</ul>
</section></body>
</html>

