<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: Style Checker</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  <a href="../">Software Design by Example</a>
<br/><em><a href="https://www.taylorfrancis.com/books/mono/10.1201/9781003317807/software-design-example-greg-wilson" alt="buy the book">buy the book</a></em>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../style-checker/">
      <strong>Style Checker</strong>
    </a>
  </li>
  
  <li>
    <a href="../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><em><a href="../sdxjs-examples.zip" alt="source code archive">download examples</a></em></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 14: Style Checker</h1>


          
            

            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a>, <a class="gl-ref" href="../glossary/#adapter_pattern" markdown="1">Adapter pattern</a>, <a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major storage</a>, <a class="gl-ref" href="../glossary/#dynamic_lookup" markdown="1">dynamic lookup</a>, <a class="gl-ref" href="../glossary/#generator_function" markdown="1">generator function</a>, <a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a>, <a class="gl-ref" href="../glossary/#iterator_pattern" markdown="1">Iterator pattern</a>, <a class="gl-ref" href="../glossary/#linter" markdown="1">linter</a>, <a class="gl-ref" href="../glossary/#markdown" markdown="1">Markdown</a>, <a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major storage</a>, <a class="gl-ref" href="../glossary/#walk_tree" markdown="1">walk (a tree)</a>
</p>


            <div class="page-toc"></div>
            <p>Programmers argue endlessly about the best way to format their programs,
but everyone agrees that the most important thing is to be <span class="ix-entry" ix-key="coding style!importance of consistency" markdown="1">consistent</span>
<span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Binkley2012">Binkley2012</a>, <a class="bib-ref" href="../bibliography/#Johnson2019">Johnson2019</a>]</span>.
Since checking rules by hand is tedious,
most programmers use tools to compare code against various rules and report any violations.
Programs that do this are often called <span class="ix-entry" ix-key="linter;coding style!linter" markdown="1"><a class="gl-ref" href="../glossary/#linter" markdown="1">linters</a></span>
in honor of an early one for <span class="ix-entry" ix-key="C" markdown="1">C</span> named <code>lint</code>
(because it looked for fluff in source code).</p>
<p>In this chapter we will build a simple linter of our own inspired by <span class="ix-entry" ix-key="ESLint" markdown="1"><a href="https://eslint.org/">ESLint</a></span>,
which we use to check the code in this book.
Our tool will parse source code to create a data structure,
then go through that data structure and apply rules for each part of the program.
It will also introduce us to one of the key ideas of this book,
which is that source code is just another kind of data.</p>
<div class="callout">
<h3>Don&rsquo;t define your own style</h3>
<p>Just as the world doesn&rsquo;t need more file format (<a class="x-ref" href="../regex-parser/">Chapter 8</a>)
it also doesn&rsquo;t need more programming styles,
or more arguments among programmers about whether there should be spaces before curly braces or not.
<span class="ix-entry" ix-key="Standard JS" markdown="1"><a href="https://standardjs.com/">Standard JS</a></span> may not do everything exactly the way you want,
but adopting it increases the odds that other programmers will be able to read your code at first glance.</p>
</div>
<h2 id="style-checker-ast">Section 14.2: How can we parse JavaScript to create an AST?</h2>
<p>A parser for a simple language like arithmetic or JSON is relatively easy to write.
A parser for a language as complex as JavaScript is much more work,
so we will use one called <span class="ix-entry" ix-key="Acorn" markdown="1"><a href="https://github.com/acornjs/acorn">Acorn</a></span> instead.
Acorn takes a string containing source code as input
and produces an <span class="ix-entry" ix-key="abstract syntax tree" markdown="1"><a class="gl-ref" href="../glossary/#abstract_syntax_tree" markdown="1">abstract syntax tree</a></span> (AST)
whose nodes store information about what&rsquo;s in the program
(<a class="fig-ref" href="../style-checker/#style-checker-parse-tree">Figure 14.1</a>).
An AST is for a program what the <span class="ix-entry" ix-key="Document Object Model" markdown="1">DOM</span> is for HTML:
an in-memory representation that is easy for software to inspect and manipulate.</p>
<p>ASTs can be quite complex&mdash;for example,
the JSON representation of the AST for a single constant declaration
is 84 lines long:</p>
<div class="code-sample lang-js" title="parse-single-const.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;const x = 0&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="parse-single-const.slice.out">
<div class="highlight"><pre><span></span><code>{
  &quot;type&quot;: &quot;Program&quot;,
  &quot;start&quot;: 0,
  &quot;end&quot;: 11,
  &quot;loc&quot;: {
    &quot;start&quot;: {
      &quot;line&quot;: 1,
      &quot;column&quot;: 0
    },
    &quot;end&quot;: {
...
            &quot;value&quot;: 0,
            &quot;raw&quot;: &quot;0&quot;
          }
        }
      ],
      &quot;kind&quot;: &quot;const&quot;
    }
  ],
  &quot;sourceType&quot;: &quot;script&quot;
}
</code></pre></div>
</div>
<figure id="style-checker-parse-tree" class="figure-here">
  <img src="./parse-tree.svg" alt="A small parse tree"/>
  <figcaption markdown="1">Figure 14.1: The parse tree of a simple program.</figcaption>
</figure>

<p>Acorn&rsquo;s output is in <span class="ix-entry" ix-key="Esprima format" markdown="1"><a href="https://esprima.org/">Esprima</a> format</span>
(so-called because it was originally defined by a tool with that name).
The format&rsquo;s specification is very detailed,
but we can usually figure out most of what we need by inspection.
For example,
here is the output for a 15-line program:</p>
<div class="code-sample lang-js" title="parse-const-func.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const value = 2</span>

<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="parse-const-func.slice.out">
<div class="highlight"><pre><span></span><code>{
  &quot;type&quot;: &quot;Program&quot;,
  &quot;start&quot;: 0,
  &quot;end&quot;: 122,
  &quot;loc&quot;: {
    &quot;start&quot;: {
      &quot;line&quot;: 1,
      &quot;column&quot;: 0
    },
    &quot;end&quot;: {
...
          &quot;line&quot;: 1,
          &quot;column&quot;: 0
        },
        &quot;end&quot;: {
          &quot;line&quot;: 1,
          &quot;column&quot;: 15
        }
      },
      &quot;declarations&quot;: [
...480 more lines...
</code></pre></div>
</div>
<p class="continue">Yes, it really is almost 500 lines longâ€¦</p>
<h2 id="style-checker-search">Section 14.3: How can we find things in an AST?</h2>
<p>If we want to find functions, variables, or anything else in an AST
we need to <span class="ix-entry" ix-key="walk a tree" markdown="1"><a class="gl-ref" href="../glossary/#walk_tree" markdown="1">walk the tree</a></span>,
i.e.,
to visit each node in turn.
The <a href="https://www.npmjs.com/package/acorn-walk"><code>acorn-walk</code></a> library will do this for us
using the <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1">Visitor design pattern</span> we first saw in <a class="x-ref" href="../page-templates/">Chapter 9</a>.
If we provide a function to act on nodes of type <code>Identifier</code>,
<code>acorn-walk</code> will call that function each time it finds an identifier.
We can use other options to say that we want to record the locations of nodes (i.e., their line numbers)
and to collect comments in an array called <code>onComment</code>.
Our function can do whatever we want;
for demonstration purposes we will add nodes to an array called <code>state</code>
and report them all at the end
(<a class="fig-ref" href="../style-checker/#style-checker-walk-tree">Figure 14.2</a>).</p>
<div class="code-sample lang-js" title="walk-ast.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">walk</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn-walk&#39;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`// Constant</span>
<span class="sb">const value = 2</span>

<span class="sb">// Function</span>
<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">// Main body</span>
<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComment</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>

<span class="nx">state</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="sb">`identifier </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> on line </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="p">))</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">comments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">onComment</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="w"></span>
<span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`comments on lines </span><span class="si">${</span><span class="nx">comments</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="walk-ast.out">
<div class="highlight"><pre><span></span><code>identifier x on line 6
identifier y on line 7
identifier double on line 11
identifier value on line 11
identifier console on line 12
identifier result on line 12
comments on lines 1, 4, 10
</code></pre></div>
</div>
<div class="callout">
<h3>There&rsquo;s more than one way to do it</h3>
<p><code>walk.simple</code> takes four arguments:</p>
<ol>
<li>
<p>The root node of the AST, which is used as the starting point.</p>
</li>
<li>
<p>An object containing callback functions for handling various kinds of nodes.</p>
</li>
<li>
<p>Another object that specifies what algorithm to use&mdash;we have set this to <code>null</code>
    to use the default because
    we don&rsquo;t particularly care about the order in which the nodes are processed.</p>
</li>
<li>
<p>Something we want passed in to each of the node handlers,
    which in our case is the <code>state</code> array.
    If our node handling functions don&rsquo;t require any extra data
    from one call to the next
    we can leave this out;
    if we want to accumulate information across calls,
    this argument acts as the Visitor&rsquo;s memory.</p>
</li>
</ol>
<p class="continue">Any general-purpose implementation of the Visitor pattern
is going to need these four things,
but as we will see below,
we can implement them in different ways.</p>
</div>
<figure id="style-checker-walk-tree" class="figure-here">
  <img src="./walk-tree.svg" alt="Walking a tree"/>
  <figcaption markdown="1">Figure 14.2: Walking a tree to perform an operation at each node.</figcaption>
</figure>

<h2 id="style-checker-apply">Section 14.4: How can we apply checks?</h2>
<p>We don&rsquo;t just want to collect nodes:
we want to check their properties against a set of rules.
One way to do this would be to call <code>walk.simple</code> once for each rule,
passing it a function that checks just that rule.
Another way&mdash;the one we&rsquo;ll use&mdash;is to write a <span class="ix-entry" ix-key="software design!generic function" markdown="1">generic function</span>
that checks a rule and records any nodes that don&rsquo;t satisfy it,
and then call that function once for each rule inside our <code>Identifier</code> handler.
This may seem like extra work,
but it ensures that all of our rule-checkers store their results in the same way,
which in turn means that we can write one reporting function
and be sure it will handle everything.</p>
<p>The function  <code>applyCheck</code> takes the current state (where we are accumulating rule violations),
a label that identifies this rule (so that violations of it can be stored together),
the node,
and a logical value telling it whether the node passed the test or not.
If the node failed the test
we make sure that <code>state</code> contains a list with the appropriate label
and then append this node to it.
This &ldquo;create storage space on demand&rdquo; pattern
is widely used but doesn&rsquo;t have a well-known name.</p>
<div class="code-sample lang-js" title="check-name-lengths.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">applyCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">label</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">passes</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">passes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">label</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">state</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">state</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">state</span><span class="p">[</span><span class="nx">label</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now put a call to <code>applyCheck</code> inside the handler for <code>Identifier</code>:</p>
<div class="code-sample lang-js" title="check-name-lengths.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">applyCheck</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name_length&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>

<span class="nx">state</span><span class="p">.</span><span class="nx">name_length</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">node</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb"> at line </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">loc</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We can&rsquo;t just use <code>applyCheck</code> as the handler for <code>Identifier</code>
because <code>walk.simple</code> wouldn&rsquo;t know how to call it.
This is a (very simple) example of the <span class="ix-entry" ix-key="Adapter pattern;design pattern!Adapter" markdown="1"><a class="gl-ref" href="../glossary/#adapter_pattern" markdown="1">Adapter</a></span> design pattern:
we write a function or class to connect the code we want to call
to the already-written code that is going to call it.</p>
<p>The output for the same sample program as before is:</p>
<div class="code-sample lang-out" title="check-name-lengths.out">
<div class="highlight"><pre><span></span><code>x at line 6
y at line 7
</code></pre></div>
</div>
<p class="continue">The exercises will ask why the parameter <code>x</code> doesn&rsquo;t show up
as a violation of our rule
that variables&rsquo; names must be at least four characters long.</p>
<h2 id="style-checker-walker">Section 14.5: How does the AST walker work?</h2>
<p>The AST walker uses the Visitor pattern,
but how does it actually work?
We can build our own by defining a class with methods that walk the tree,
take action depending on the kind of node,
and then go through the children of that node (if any).
The user can then derive a class of their own from this
and override the set of action methods they&rsquo;re interested in.</p>
<p>One key difference between our implementation and <code>acorn-walk</code>&lsquo;s is that
our methods don&rsquo;t need to take <code>state</code> as a parameter
because it&rsquo;s contained in the object that they&rsquo;re part of.
That simplifies the methods&mdash;one less parameter&mdash;but it does mean that
anyone who wants to use our visitor has to derive a class,
which is a bit more complicated than writing a function.
This tradeoff is a sign that managing state is part of the problem&rsquo;s
<span class="ix-entry" ix-key="intrinsic complexity" markdown="1"><a class="gl-ref" href="../glossary/#intrinsic_complexity" markdown="1">intrinsic complexity</a></span>:
we can move it around,
but we can&rsquo;t get rid of it.</p>
<p>The other difference between our visitor and <code>acorn-walk</code> is that
our class uses <span class="ix-entry" ix-key="dynamic lookup" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_lookup" markdown="1">dynamic lookup</a></span>
(a form of <span class="ix-entry" ix-key="introspection!of methods" markdown="1">introspection</span>)
to look up a method
with the same name as the node type in the object.
While we normally refer to a particular method of an object using <code>object.method</code>,
we can also look them up by asking for <code>object[name]</code>
in the same way that we would look up any other property of any other object.
Our completed class looks like this:</p>
<div class="code-sample lang-js" title="walker-class.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Walker</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Construct a new AST tree walker.</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ast</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Walk the tree.</span><span class="w"></span>
<span class="w">  </span><span class="nx">walk</span><span class="w"> </span><span class="p">(</span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">accumulator</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Act on node and then on children.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_walk</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_doNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_doChildren</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Handle a single node by lookup.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_doNode</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Recurse for anything interesting within the node.</span><span class="w"></span>
<span class="w">  </span><span class="nx">_doChildren</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Is the current node a child of some other type of node?</span><span class="w"></span>
<span class="w">  </span><span class="nx">_childOf</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeTypes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">      </span><span class="nx">nodeTypes</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">type</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The code we need to use it is:</p>
<div class="code-sample lang-js" title="walker-class.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>


<span class="c1">// Walk to accumulate variable and parameter definitions.</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="nx">VariableWalker</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Walker</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">Identifier</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_childOf</span><span class="p">([</span><span class="s1">&#39;ArrowFunctionExpression&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39;VariableDeclarator&#39;</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">accumulator</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Test.</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`const value = 2</span>

<span class="sb">const double = (x) =&gt; {</span>
<span class="sb">  const y = 2 * x</span>
<span class="sb">  return y</span>
<span class="sb">}</span>

<span class="sb">const result = double(value)</span>
<span class="sb">console.log(result)</span>
<span class="sb">`</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">walker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">VariableWalker</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">accumulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="nx">walker</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;definitions are&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and its output is:</p>
<div class="code-sample lang-out" title="walker-class.out">
<div class="highlight"><pre><span></span><code>definitions are [ &#39;value&#39;, &#39;double&#39;, &#39;x&#39;, &#39;y&#39;, &#39;result&#39; ]
</code></pre></div>
</div>
<p>We think this approach to implementing the Visitor pattern is easier to understand and extend
than one that relies on callbacks,
but that could just be a reflection of our background and experience.
As with code style,
the most important thing is consistency:
if we implement Visitor using classes in one place,
we should implement it that way everywhere.</p>
<h2 id="style-checker-alternatives">Section 14.6: How else could the AST walker work?</h2>
<p>A third approach to this problem uses
the <span class="ix-entry" ix-key="Iterator pattern;design pattern!Iterator" markdown="1"><a class="gl-ref" href="../glossary/#iterator_pattern" markdown="1">Iterator</a></span> design pattern.
Instead of taking the computation to the nodes,
an iterator returns the elements of a structure for processing
(<a class="fig-ref" href="../style-checker/#style-checker-iterator">Figure 14.3</a>).
One way to think about it is that Visitor encapsulates recursion,
while Iterator turns everything into a loop.</p>
<p>We can implement the Iterator pattern in JavaScript using
<span class="ix-entry" ix-key="generator function;Iterator pattern!generator function" markdown="1"><a class="gl-ref" href="../glossary/#generator_function" markdown="1">generator functions</a></span>.
If we declare a function using <code>function *</code> (with an asterisk) instead of <code>function</code>
then we can use the <code>yield</code> keyword to return a value and suspend processing to be resumed later.
The result of <code>yield</code> is a two-part structure with a value and a flag showing whether or not processing is done:</p>
<div class="code-sample lang-js" title="generator-example.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">threeWords</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">&#39;first&#39;</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">&#39;second&#39;</span><span class="w"></span>
<span class="w">  </span><span class="k">yield</span><span class="w"> </span><span class="s1">&#39;third&#39;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">threeWords</span><span class="p">()</span><span class="w"></span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="generator-example.out">
<div class="highlight"><pre><span></span><code>{ value: &#39;first&#39;, done: false }
{ value: &#39;second&#39;, done: false }
{ value: &#39;third&#39;, done: false }
{ value: undefined, done: true }
</code></pre></div>
</div>
<figure id="style-checker-iterator" class="figure-here">
  <img src="./iterator.svg" alt="The Iterator pattern"/>
  <figcaption markdown="1">Figure 14.3: Finding nodes in the tree using the Iterator pattern.</figcaption>
</figure>

<p>As another example,
this generator takes a string and produces its vowels one by one:</p>
<div class="code-sample lang-js" title="generator-vowels-while.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getVowels</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;AEIOUaeiou&#39;</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="kr">char</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">yield</span><span class="w"> </span><span class="kr">char</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;this is a test&#39;</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getVowels</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">current</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="generator-vowels-while.out">
<div class="highlight"><pre><span></span><code>i
i
a
e
</code></pre></div>
</div>
<p class="continue">A generator function doesn&rsquo;t actually generate anything;
instead,
it creates an object that we can then ask for values repeatedly.
This gives us a way to have several generators in play at the same time.</p>
<p>Instead of a <code>while</code> loop it is much more common to use <code>for...of</code>,
which knows how to work with generators:</p>
<div class="code-sample lang-js" title="generator-vowels-for.js">
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">vowel</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getVowels</span><span class="p">(</span><span class="nx">test</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">vowel</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finally,
just as <code>function *</code> says &ldquo;this function is a generator&rdquo;,
<code>yield *</code> says &ldquo;yield the values from a nested generator one by one&rdquo;.
We can use it to walk irregular structures like nested arrays:</p>
<div class="code-sample lang-js" title="generator-tree.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="w"> </span><span class="p">(</span><span class="nx">here</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">here</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">yield</span><span class="w"> </span><span class="nx">here</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">here</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">here</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`unknown type &quot;</span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">here</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">nested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;third&#39;</span><span class="p">]]</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">nested</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>Let&rsquo;s use generators to count the number of expressions of various types in a program.
The generator function that visits each node is:</p>
<div class="code-sample lang-js" title="generator-count.js">
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">yield</span><span class="w"> </span><span class="nx">node</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">yield</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">and the program that uses it is:</p>
<div class="code-sample lang-js" title="generator-count.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">getNodes</span><span class="p">(</span><span class="nx">ast</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;BinaryExpression&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">result</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;counts are&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</div>
<p>When we run it with our usual test program as input, we get:</p>
<div class="code-sample lang-out" title="generator-count.out">
<div class="highlight"><pre><span></span><code>counts are { &#39;*&#39;: 2, &#39;+&#39;: 1 }
</code></pre></div>
</div>
<p>Generators are a clean solution to many hard problems,
but we find it more difficult to check variable identifiers using generators
than using the class-based Visitor approach
because we want to accumulate violations to report later.
Again,
this could be a reflection of what we&rsquo;re used to rather than anything intrinsic;
as with coding style,
the most important thing is to be consistent.</p>
<h2 id="style-checker-analysis">Section 14.7: What other kinds of analysis can we do?</h2>
<p>As one final example,
consider the problem of keeping track of which methods are defined where
in a deeply nested class hierarchy.
(This problem comes up in some of the later chapters in this book:
we wrote so many classes that incrementally extended their predecessors for pedagogical purposes
that we lost track of what was defined where.)
To create a table of method definitions,
we first need to find the ancestors of the last class in the hierarchy:</p>
<div class="code-sample lang-js" title="find-ancestors.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">acorn</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">walk</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;acorn-walk&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">find</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">traceAncestry</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">traceAncestry</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fullPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">locations</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">sourceType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acorn</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findClassDef</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">accum</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">,</span><span class="w"> </span><span class="nx">classDef</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ancestorName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAncestor</span><span class="p">(</span><span class="nx">classDef</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ancestorName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">accum</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ancestorFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findImport</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorName</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">traceAncestry</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorFile</span><span class="p">,</span><span class="w"> </span><span class="nx">ancestorName</span><span class="p">,</span><span class="w"> </span><span class="nx">accum</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"></span>
</code></pre></div>
</div>
<p>Finding class definitions is a straightforward extension of what we have already done:</p>
<div class="pagebreak"></div>
<div class="code-sample lang-js" title="find-ancestors.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">findClassDef</span><span class="w"> </span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="w">    </span><span class="nx">walk</span><span class="p">.</span><span class="nx">simple</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">ClassDeclaration</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Identifier&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">className</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`No definition for </span><span class="si">${</span><span class="nx">className</span><span class="si">}</span><span class="sb"> in </span><span class="si">${</span><span class="nx">filename</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
</div>
<p>To test this code, we start with the last of these three short files:</p>
<div class="code-sample lang-js" title="upper.js">
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;upper&#39;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">modify</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Upper</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="middle.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./upper.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Upper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;middle&#39;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">modify</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`** </span><span class="si">${</span><span class="k">super</span><span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="si">}</span><span class="sb"> **`</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Middle</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-js" title="lower.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./middle.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">Lower</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Middle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">additional</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">additional</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;lower&#39;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">Lower</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="run-find-ancestors.out">
<div class="highlight"><pre><span></span><code>Lower in lower.js
Middle in ./middle.js
Upper in ./upper.js
</code></pre></div>
</div>
<p>Good: we can recover the <span class="ix-entry" ix-key="chain of inheritance" markdown="1">chain of inheritance</span>.
Finding method definitions is also straightforward:</p>
<div class="code-sample lang-js" title="find-methods.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./find-ancestors.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">FindMethods</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">FindAncestors</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">find</span><span class="w"> </span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">super</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">className</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">classes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">record</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">record</span><span class="p">.</span><span class="nx">methods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findMethods</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">classDef</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">classes</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findMethods</span><span class="w"> </span><span class="p">(</span><span class="nx">classDef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">classDef</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;MethodDefinition&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;constructor&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;constructor&#39;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;method&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">FindMethods</span><span class="w"></span>
</code></pre></div>
</div>
<p>And finally,
we can print a <span class="ix-entry" ix-key="Markdown" markdown="1"><a class="gl-ref" href="../glossary/#markdown" markdown="1">Markdown</a></span>-formatted table
showing which methods are defined in which class:</p>
<div class="code-sample lang-out" title="run-find-methods.raw.out">
<div class="highlight"><pre><span></span><code>| method | Upper | Middle | Lower |
| ---- | ---- | ---- | ---- |
| additional | . | . | X |
| constructor | X | X | . |
| modify | X | X | . |
| report | X | . | X |
</code></pre></div>
</div>
<p class="continue">which renders as:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>Upper</th>
<th>Middle</th>
<th>Lower</th>
</tr>
</thead>
<tbody>
<tr>
<td>additional</td>
<td>.</td>
<td>.</td>
<td>X</td>
</tr>
<tr>
<td>constructor</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>modify</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>report</td>
<td>X</td>
<td>.</td>
<td>X</td>
</tr>
</tbody>
</table>
<p>This may seem rather pointless for our toy example,
but it proves its worth when we are looking at something like
the virtual machine we will build in <a class="x-ref" href="../virtual-machine/">Chapter 19</a>,
which has a more complex method definition table:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>Base</th>
<th>Interactive</th>
<th>Test</th>
<th>Exit</th>
</tr>
</thead>
<tbody>
<tr>
<td>clear</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>constructor</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>exit</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>X</td>
</tr>
<tr>
<td>getCommand</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>handle</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>help</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>input</td>
<td>.</td>
<td>X</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>interact</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>list</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>message</td>
<td>X</td>
<td>.</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>next</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>print</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>run</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>setTester</td>
<td>.</td>
<td>.</td>
<td>X</td>
<td>.</td>
</tr>
<tr>
<td>setVM</td>
<td>X</td>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>stop</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>variables</td>
<td>.</td>
<td>X</td>
<td>.</td>
<td>.</td>
</tr>
</tbody>
</table>
<h2 id="style-checker-exercises">Section 14.8: Exercises</h2>
<h3 class="exercise">Function length</h3>
<p>Derive a class from <code>Walker</code> that reports the length in lines of each function defined in the code being checked.</p>
<h3 class="exercise">Expression depth</h3>
<p>Derive a class from <code>Walker</code> that reports how deep each top-level expression in the source code is.
For example,
the depth of <code>1 + 2 * 3</code> is 2,
while the depth of <code>max(1 + 2 + 3)</code> is 3
(one level for the function call, one for the first addition, and one for the nested addition).</p>
<h3 class="exercise">Downward and upward</h3>
<p>Modify <code>Walker</code> so that users can specify
one action to take at a node on the way down the tree
and a separate action to take on the way up.
(Hint: require users to specify <code>Nodename_downward</code> and/or <code>Nodename_upward</code> methods in their class,
then use string concatenation to construct method names while traversing the tree.)</p>
<h3 class="exercise">Aggregating across files</h3>
<p>Create a command-line program called <code>sniff.js</code>
that checks for style violations in any number of source files.
The first command-line argument to <code>sniff.js</code> must be a JavaScript source file
that exports a class derived from <code>Walker</code> called <code>Check</code>
that implements the checks the user wants.
The other command-line arguments must be the names of JavaScript source files to be checked:</p>
<div class="code-sample lang-sh" title="sniff.sh">
<div class="highlight"><pre><span></span><code>node sniff.js my-check.js source-1.js source-2.js
</code></pre></div>
</div>
<h3 class="exercise">Finding assertions</h3>
<p>Write a program <code>find-assertions.js</code> that finds all calls to <code>assert</code> or <code>assert.something</code>
and prints the assertion message (if any).</p>
<h3 class="exercise">Finding a missing parameter</h3>
<ol>
<li>
<p>Why doesn&rsquo;t the parameter <code>x</code> show up as a rule violation
    in the example where we check name lengths?</p>
</li>
<li>
<p>Modify the example so that it does.</p>
</li>
</ol>
<h3 class="exercise">Finding nested indexes</h3>
<p>Write a tool that finds places where nested indexing is used,
i.e.,
where the program contains expressions like <code>arr[table[i]]</code>.</p>
<h3 class="exercise">Dynamic lookup</h3>
<ol>
<li>
<p>Write a function <code>dynamicExecution</code> that takes an object,
    the name of a method,
    and zero or more parameters as arguments
    and calls that method on that object:</p>
<div class="highlight"><pre><span></span><code><span class="nx">dynamicExecution</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;meth&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="w"></span>
<span class="c1">// same as obj.meth(1, &#39;a&#39;)</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>What <em>doesn&rsquo;t</em> this work for?</p>
</li>
</ol>
<h3 class="exercise">Generators and arrays</h3>
<ol>
<li>
<p>Write a generator that takes a two-dimensional table represented as an array of arrays
    and returns the values in <a class="gl-ref" href="../glossary/#column_major" markdown="1">column-major</a> order.</p>
</li>
<li>
<p>Write another generator that takes a similar table
    and returns the values in <a class="gl-ref" href="../glossary/#row_major" markdown="1">row-major</a> order.</p>
</li>
</ol>
<h3 class="exercise">Generators and identifiers</h3>
<p>Rewrite the tool to check identifier lengths using a generator.</p>
          
        </main>
      </div>
    </div>
  </body>
</html>
