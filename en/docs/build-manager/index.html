<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <title>Software Design by Example: Build Manager</title>
</head>

  <body>
    <div class="row">
      <div class="column">
        <p>
  <img src="../logo.svg" alt="site logo" style="width: 10%" />
  <a href="../">Software Design by Example</a>
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../build-manager/">
      <strong>Build Manager</strong>
    </a>
  </li>
  
  <li>
    <a href="../layout-engine/">
      Layout Engine
    </a>
  </li>
  
  <li>
    <a href="../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div id="printable" class="column bordered">
        <main>
	  
  <h1>Chapter 10: Build Manager</h1>


          

	  
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variable</a>, <a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a>, <a class="gl-ref" href="../glossary/#build_recipe" markdown="1">build recipe</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rule</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">build target</a>, <a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled language</a>, <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycle (in a graph)</a>, <a class="gl-ref" href="../glossary/#dependency" markdown="1">dependency</a>, <a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a>, <a class="gl-ref" href="../glossary/#driver" markdown="1">driver</a>, <a class="gl-ref" href="../glossary/#interpreted_language" markdown="1">interpreted language</a>, <a class="gl-ref" href="../glossary/#link" markdown="1">link (a program)</a>, <a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rule</a>, <a class="gl-ref" href="../glossary/#runnable_documentation" markdown="1">runnable documentation</a>, <a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale (in build)</a>, <a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method pattern</a>, <a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological order</a>
</p>


          <p>Suppose we are using a page templating system to create a website (<a class="x-ref" href="../page-templates/">Chapter 9</a>).
If we change a single page our tool should translate it,
but shouldn&rsquo;t waste time translating others.
If we change a template,
on the other hand,
the tool should realize that every page in the site is potentially affected
and automatically re-translate all of them.</p>
<p>Choosing what actions to take based on how files depend on one another is a common pattern.
For example,
programs in <span class="ix-entry" ix-key="compiled language;language!compiled" markdown="1"><a class="gl-ref" href="../glossary/#compiled_language" markdown="1">compiled languages</a></span>
like <span class="ix-entry" ix-key="C" markdown="1">C</span> and <span class="ix-entry" ix-key="Java" markdown="1">Java</span>
have to be translated into lower-level forms before they can run.
In fact,
there are usually two stages to the translation:
compiling each source file into some intermediate form,
and then <span class="ix-entry" ix-key="linking (compiled language);compiled language!linking" markdown="1"><a class="gl-ref" href="../glossary/#link" markdown="1">linking</a></span> the compiled modules
to each other and to libraries
to create a runnable program
(<a class="fig-ref" href="../build-manager/#build-manager-compiling">Figure 10.1</a>).
If a source file hasn&rsquo;t changed,
there&rsquo;s no need to recompile it before linking.</p>
<figure id="build-manager-compiling">
  <img src="./compiling.svg" alt="Compiling and linking"/>
  <figcaption markdown="1">Figure 10.1: Compiling source files and linking the resulting modules.</figcaption>
</figure>

<p>A <span class="ix-entry" ix-key="build manager" markdown="1"><a class="gl-ref" href="../glossary/#build_manager" markdown="1">build manager</a></span> takes a description of what depends on what,
figures out which files are out of date,
determines an order in which to rebuild things,
and then executes any necessary steps.
Originally created to manage compilation,
they are also useful for programs written in <span class="ix-entry" ix-key="language!interpreted;interpreted language" markdown="1"><a class="gl-ref" href="../glossary/#interpreted_language" markdown="1">interpreted languages</a></span>
like JavaScript
when we want to bundle multiple modules into a single loadable file (<a class="x-ref" href="../module-bundler/">Chapter 17</a>)
or re-create documentation from source code (<a class="x-ref" href="../doc-generator/">Chapter 16</a>).
In this chapter we will create a simple build manager
based on <span class="ix-entry" ix-key="Make" markdown="1"><a href="https://www.gnu.org/software/make/">Make</a></span>, <span class="ix-entry" ix-key="Bajel" markdown="1"><a href="https://www.npmjs.com/package/bajel">Bajel</a></span>, <span class="ix-entry" ix-key="Jake" markdown="1"><a href="https://jakejs.com/">Jake</a></span>,
and other systems discussed in <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Smith2011">Smith2011</a>]</span>.</p>
<h2 id="build-manager-contents">Section 10.1: What&rsquo;s in a build manager?</h2>
<p>The input to a build manager is a set of rules,
each of which has:</p>
<ul>
<li>
<p>a <span class="ix-entry" ix-key="build target;target!build" markdown="1"><a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a></span>, which is the file to be updated;</p>
</li>
<li>
<p>some <span class="ix-entry" ix-key="dependency (in build);build!dependency" markdown="1"><a class="gl-ref" href="../glossary/#dependency" markdown="1">dependencies</a></span>, which are the things that file depends on;
    and</p>
</li>
<li>
<p>a <span class="ix-entry" ix-key="recipe (in build);build!recipe" markdown="1"><a class="gl-ref" href="../glossary/#build_recipe" markdown="1">recipe</a></span> that specifies how to update the target
    if it is out of date compared to its dependencies.</p>
</li>
</ul>
<p class="continue">The target of one rule can be a dependency of another rule,
so the relationships between the files form a <span class="ix-entry" ix-key="directed acyclic graph (DAG);DAG" markdown="1"><a class="gl-ref" href="../glossary/#dag" markdown="1">directed acyclic graph</a></span> or DAG
(<a class="fig-ref" href="../build-manager/#build-manager-dependencies">Figure 10.2</a>).
The graph is directed because &ldquo;A depends on B&rdquo; is a one-way relationship;
it cannot contain cycles (or loops) because
if something depends on itself we can never finish updating it.
We say that a target is <span class="ix-entry" ix-key="stale (in build);build!stale" markdown="1"><a class="gl-ref" href="../glossary/#build_stale" markdown="1">stale</a></span> if it is older than any of its dependencies.
When this happens,
we use the recipes to bring it up to date.</p>
<figure id="build-manager-dependencies">
  <img src="./dependencies.svg" alt="Respecting dependencies"/>
  <figcaption markdown="1">Figure 10.2: How a build manager finds and respects dependencies.</figcaption>
</figure>

<p>Our build manager must:</p>
<ol>
<li>
<p>Read a file containing rules.</p>
</li>
<li>
<p>Construct the dependency graph.</p>
</li>
<li>
<p>Figure out which targets are stale.</p>
</li>
<li>
<p>Build those targets,
    making sure to build things <em>before</em> anything that depends on them is built.</p>
</li>
</ol>
<div class="callout">
<h3>Topological order</h3>
<p>A <span class="ix-entry" ix-key="topological order" markdown="1"><a class="gl-ref" href="../glossary/#topological_order" markdown="1">topological ordering</a></span> of a graph
arranges the nodes so that every node comes after everything it depends on.
For example,
if A depends on both B and C,
then (B, C, A) and (C, B, A) are both valid topological orders of the graph.</p>
</div>
<h2 id="build-manager-start">Section 10.2: Where should we start?</h2>
<p>We will store our rules in YAML files like this:</p>
<div class="code-sample lang-yml" title="three-simple-rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  - C
  recipes:
  - &quot;update A from B and C&quot;
- target: B
  depends:
  - C
  recipes:
  - &quot;update B from C&quot;
- target: C
  depends: []
  recipes: []
</code></pre></div>
</div>
<p class="continue">We could equally well have used JSON,
but it wouldn&rsquo;t have made sense to use CSV:
rules have a nested structure,
and CSV doesn&rsquo;t represent nesting particularly gracefully.</p>
<p>We are going to create our build manager in stages,
so we start by writing a simple <span class="ix-entry" ix-key="software design!driver" markdown="1"><a class="gl-ref" href="../glossary/#driver" markdown="1">driver</a></span> that loads a JavaScript source file,
creates an object of whatever class that file exports,
and runs the <code>.build</code> method of that object with the rest of the command-line parameters:</p>
<div class="code-sample lang-js" title="driver.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">BuilderClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mf">2</span><span class="p">])).</span><span class="k">default</span><span class="w"></span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BuilderClass</span><span class="p">(...</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">3</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">builder</span><span class="p">.</span><span class="nx">build</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Build failed:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">main</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">We use the <code>import</code> function to dynamically load files in <a class="x-ref" href="../unit-test/">Chapter 4</a> as well.
It only saves us a few lines of code in this case,
but we will use this idea of a general-purpose driver for larger programs in future chapters.</p>
<p>To work with our driver,
each version of our build manager must be a class that satisfies two requirements:</p>
<ol>
<li>
<p>Its constructor must take a configuration file as an argument.</p>
</li>
<li>
<p>It must provide a <code>build</code> method that needs no arguments.</p>
</li>
</ol>
<p class="continue">The <code>build</code> method must create a graph from the configuration file,
check that it does not contain any <a class="gl-ref" href="../glossary/#cycle" markdown="1">cycles</a>,
and then run whatever commands are needed to update stale targets.
Just as we built a generic <span class="ix-entry" ix-key="Visitor pattern;design pattern!Visitor" markdown="1"><code>Visitor</code></span> class in <a class="x-ref" href="../page-templates/">Chapter 9</a>,
we can build a generic base class for our build manager that does these steps in this order
without actually implementing any of them:</p>
<div class="code-sample lang-js" title="skeleton-builder.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">configFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">configFile</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">build</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loadConfig</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkCycles</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">loadConfig</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;not implemented&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;not implemented&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">checkCycles</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;not implemented&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;run method not implemented&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"></span>
</code></pre></div>
</div>
<p>This is an example of
the <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1"><a class="gl-ref" href="../glossary/#template_method_pattern" markdown="1">Template Method</a></span> design pattern:
the parent class defines the order of the steps
and child classes fill them in
(<a class="fig-ref" href="../build-manager/#build-manager-template-method">Figure 10.3</a>).
This design pattern ensures that every child does the same things in the same order,
even if the details of <em>how</em> vary from case to case.</p>
<figure id="build-manager-template-method">
  <img src="./template-method.svg" alt="Template Method pattern"/>
  <figcaption markdown="1">Figure 10.3: The Template Method pattern in action.</figcaption>
</figure>

<p>We would normally implement all of the methods required by the <code>build</code> method at the same time;
here, we will write them them one-by-one to make the evolving code easier to follow.
The <code>loadConfig</code> method loads the configuration file
as the builder object is being constructed:</p>
<div class="code-sample lang-js" title="config-loader.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;js-yaml&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./skeleton-builder.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">SkeletonBuilder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">loadConfig</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39;Configuration must be array&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">&#39;target&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb"> does not string as &#39;target&#39;`</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">&#39;depends&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">dep</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Bad &#39;depends&#39; for rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="s1">&#39;recipes&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">recipe</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">recipe</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="sb">`Bad &#39;recipes&#39; for rule </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"></span>
</code></pre></div>
</div>
<p class="continue">The first line does the loading;
the rest of the method checks that the rules are at least superficially plausible.
We need these checks because YAML is a generic file format
that doesn&rsquo;t know anything about the extra requirements of our rules.
And as we first saw in <a class="x-ref" href="../async-programming/">Chapter 3</a>,
we have to specify that the character encoding of our file is UTF-8
so that JavaScript knows how to convert bytes into text.</p>
<p>The next step is to turn the configuration into a graph in memory.
We use the <a href="https://www.npmjs.com/package/graphlib"><code>graphlib</code></a> module to manage nodes and links
rather than writing our own classes for graphs,
and store the recipe to rebuild a node in that node.
Two features of <code>graphlib</code> that took us a while to figure out are that:</p>
<ol>
<li>
<p>links go <em>from</em> the dependency <em>to</em> the target,
    and</p>
</li>
<li>
<p><code>setEdge</code> automatically adds nodes if they aren&rsquo;t already present.</p>
</li>
</ol>
<p class="continue"><code>graphlib</code> provides implementations of some common graph algorithms,
including one to check for cycles,
so we might as well write that method at this point as follows:</p>
<div class="code-sample lang-js" title="graph-creator.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@dagrejs/graphlib&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./config-loader.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">ConfigLoader</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">Graph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">checkCycles</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cycles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">findCycles</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">cycles</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Dependency graph contains cycles </span><span class="si">${</span><span class="nx">cycles</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"></span>
</code></pre></div>
</div>
<p>We can now create something that displays our configuration when it runs
but does nothing else:</p>
<div class="code-sample lang-js" title="display-only.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@dagrejs/graphlib&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./graph-creator.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">DisplayOnly</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Graph&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sorted&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">topsort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">DisplayOnly</span><span class="w"></span>
</code></pre></div>
</div>
<p>If we run this with our three simple rules as input,
it shows the graph with <code>v</code> and <code>w</code> keys to represent the ends of the links:</p>
<div class="code-sample lang-sh" title="display-only.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./display-only.js three-simple-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="display-only.out">
<div class="highlight"><pre><span></span><code>Graph
{
  options: { directed: true, multigraph: false, compound: false },
  nodes: [
    { v: &#39;A&#39;, value: [Object] },
    { v: &#39;B&#39;, value: [Object] },
    { v: &#39;C&#39;, value: [Object] }
  ],
  edges: [ { v: &#39;B&#39;, w: &#39;A&#39; }, { v: &#39;C&#39;, w: &#39;A&#39; }, { v: &#39;C&#39;, w: &#39;B&#39; } ]
}
Sorted
[ &#39;C&#39;, &#39;B&#39;, &#39;A&#39; ]
</code></pre></div>
</div>
<p>Let&rsquo;s write a quick test to make sure the cycle detector works as intended:</p>
<div class="code-sample lang-yml" title="circular-rules.yml">
<div class="highlight"><pre><span></span><code>- target: A
  depends:
  - B
  recipes:
  - &quot;update A from B&quot;
- target: B
  depends:
  - A
  recipes:
  - &quot;update B from A&quot;
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="check-cycles.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./display-only.js circular-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="check-cycles.out">
<div class="highlight"><pre><span></span><code>Build failed: AssertionError [ERR_ASSERTION]: Dependency graph contains \
 cycles B,A
    at DisplayOnly.checkCycles \
     (/u/stjs/build-manager/graph-creator.js:19:12)
    at DisplayOnly.build \
     (/u/stjs/build-manager/skeleton-builder.js:11:10)
    at main (/u/stjs/build-manager/driver.js:5:13) {
  generatedMessage: false,
  code: &#39;ERR_ASSERTION&#39;,
  actual: 1,
  expected: 0,
  operator: &#39;strictEqual&#39;
}
</code></pre></div>
</div>
<h2 id="build-manager-timestamp">Section 10.3: How can we specify that a file is out-of-date?</h2>
<p>The next step is to figure out which files are out-of-date.
Make does this by comparing the <span class="ix-entry" ix-key="timestamp!in build;build!timestamp" markdown="1">timestamps</span> of the files in question,
but this isn&rsquo;t always reliable:
<span class="ix-entry" ix-key="clock synchronization (in build);build!clock synchronization" markdown="1">computers&rsquo; clocks may be slightly out of sync</span>,
which can produce a wrong answer on a networked filesystem,
and the operating system may only report file update times to the nearest millisecond
(which seemed very short in 1970 but seems very long today).</p>
<p>More modern build systems store a <span class="ix-entry" ix-key="hash code!in build;build!hash code" markdown="1">hash</span> of each file&rsquo;s contents
and compare the current hash to the stored one to see if the file has changed.
Since we already looked at hashing in <a class="x-ref" href="../file-backup/">Chapter 5</a>,
we will use the timestamp approach here.
And instead of using a mock filesystem as we did in <a class="x-ref" href="../file-backup/">Chapter 5</a>,
we will simply load another configuration file that specifies fake timestamps for files:</p>
<div class="code-sample lang-yml" title="add-stamps.yml">
<div class="highlight"><pre><span></span><code>A: 2
B: 5
C: 8
</code></pre></div>
</div>
<p>Since we want to associate those timestamps with files,
we add a step to <code>buildGraph</code> to read the timestamp file and add information to the graph&rsquo;s nodes:</p>
<div class="code-sample lang-js" title="add-stamps.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;js-yaml&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./graph-creator.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">GraphCreator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="nx">timesFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">timesFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timesFile</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">addTimestamps</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">addTimestamps</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timesFile</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">times</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">hasNode</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span><span class="w"></span>
<span class="w">             </span><span class="sb">`Graph does not have node </span><span class="si">${</span><span class="nx">node</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">times</span><span class="p">[</span><span class="nx">node</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">missing</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="sb">`Timestamp missing for node(s) </span><span class="si">${</span><span class="nx">missing</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"></span>
</code></pre></div>
</div>
<div class="callout">
<h3>Not quite what we were expecting</h3>
<p>The steps defined in <code>SkeletonBuilder.build</code> don&rsquo;t change when we do this,
so people reading the code don&rsquo;t have to change their mental model of what it does overall.
However,
if we had realized in advance that we were going to want to add timestamps from a file,
we would probably have added a step for that in the template method.
And if someone ever wants to inject a new step between building the graph and adding timestamps,
they will have to override <code>addTimestamps</code> and put their step at the top before calling <code>super.addTimestamps</code>,
which will make the code a lot harder to understand.</p>
</div>
<p>Before we move on,
let&rsquo;s make sure that adding timestamps works as we want:</p>
<div class="code-sample lang-sh" title="add-stamps.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./add-stamps.js three-simple-rules.yml add-stamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="add-stamps.out">
<div class="highlight"><pre><span></span><code>[
  &#39;A: {&quot;recipes&quot;:[&quot;update A from B and C&quot;],&quot;timestamp&quot;:2}&#39;,
  &#39;B: {&quot;recipes&quot;:[&quot;update B from C&quot;],&quot;timestamp&quot;:5}&#39;,
  &#39;C: {&quot;recipes&quot;:[],&quot;timestamp&quot;:8}&#39;
]
</code></pre></div>
</div>
<h2 id="build-manager-update">Section 10.4: How can we update out-of-date files?</h2>
<p>To figure out which recipes to execute and in which order,
we set the pretended current time to the latest time of any file,
then look at each file in topological order.
If a file is older than any of its dependencies,
we update the file <em>and</em> its pretended timestamp
to trigger an update of anything that depends on it.</p>
<p>We can pretend that updating a file always takes one unit of time,
so we advance our fictional clock by one for each build.
Using <code>graphlib.alg.topsort</code> to create the topological order,
we get this:</p>
<div class="code-sample lang-js" title="update-stamps.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@dagrejs/graphlib&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./add-stamps.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AddTimestamps</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">alg</span><span class="p">.</span><span class="nx">topsort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">timestamp</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">startTime</span><span class="si">}</span><span class="sb">: START`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sorted</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">currTime</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isStale</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">currTime</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">node</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="nx">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`    </span><span class="si">${</span><span class="nx">a</span><span class="si">}</span><span class="sb">`</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currTime</span><span class="w"></span>
<span class="w">        </span><span class="nx">currTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">currTime</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">startTime</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">endTime</span><span class="si">}</span><span class="sb">: END`</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">isStale</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">some</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="nx">other</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">other</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"></span>
</code></pre></div>
</div>
<p>The <code>run</code> method:</p>
<ol>
<li>
<p>gets a sorted list of nodes;</p>
</li>
<li>
<p>sets the starting time to be one unit past the largest file time;
    and then</p>
</li>
<li>
<p>uses <span class="ix-entry" ix-key="Array.reduce" markdown="1"><code>Array.reduce</code></span> to operate on each node (i.e., each file) in order.
    If that file is stale,
    we print the steps we would run and then update the file&rsquo;s timestamp.
    We only advance the notional current time when we do an update.</p>
</li>
</ol>
<p class="continue">To check if a file is stale,
we see if any of its dependencies currently have timestamps greater than or equal to its own.
When we run this,
it seems to do the right thing:</p>
<div class="code-sample lang-sh" title="update-stamps.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./update-stamps.js three-simple-rules.yml add-stamps.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="update-stamps.out">
<div class="highlight"><pre><span></span><code>9: START
9: B
    update B from C
10: A
    update A from B and C
11: END
</code></pre></div>
</div>
<h2 id="build-manager-generic">Section 10.5: How can we add generic build rules?</h2>
<p>If our website has a hundred blog posts
or a hundred pages of documentation about particular JavaScript files,
we don&rsquo;t want to have to write a hundred nearly-identical recipes.
Instead,
we want to be able to write generic <span class="ix-entry" ix-key="build!rule;rule (in build)" markdown="1"><a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a></span> that say,
&ldquo;Build all things of this kind the same way.&rdquo;
These generic rules need to:</p>
<ul>
<li>
<p>a way to define a set of files;</p>
</li>
<li>
<p>a way to specify a generic rule;
    and</p>
</li>
<li>
<p>a way to fill in parts of that rule.</p>
</li>
</ul>
<p class="continue">We will achieve this by overriding <code>buildGraph</code> to replace variables in recipes with values.
Once again,
object-oriented programming helps us change only what we need to change,
provided we divided our problem into sensible chunks in the first place.</p>
<p>Make provides <span class="ix-entry" ix-key="automatic variable (in build);build!automatic variable" markdown="1"><a class="gl-ref" href="../glossary/#automatic_variable" markdown="1">automatic variables</a></span>
with names like <code>$&lt;</code> and <code>$@</code>
to represent the parts of a rule.
Ours will be more readable:
we will use <code>@TARGET</code> for the target,
<code>@DEPENDENCIES</code> for the dependencies (in order),
and <code>@DEP[1]</code>, <code>@DEP[2]</code>, and so on for specific dependencies
(<a class="fig-ref" href="../build-manager/#build-manager-pattern-rules">Figure 10.4</a>).
Our variable expander looks like this:</p>
<div class="code-sample lang-js" title="variable-expander.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./update-stamps.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">UpdateOnTimestamps</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandVariables</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">recipes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">act</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">act</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">act</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;@TARGET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;@DEPENDENCIES&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">act</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">act</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`@DEP[</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">]`</span><span class="p">,</span><span class="w"> </span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"></span>
<span class="w">          </span><span class="p">})</span><span class="w"></span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">act</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Cannot find </span><span class="si">${</span><span class="nx">target</span><span class="si">}</span><span class="sb"> in graph`</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"></span>
</code></pre></div>
</div>
<figure id="build-manager-pattern-rules">
  <img src="./pattern-rules.svg" alt="Pattern rules"/>
  <figcaption markdown="1">Figure 10.4: Turning patterns rules into runnable commands.</figcaption>
</figure>

<p>The first thing we do is test that it works when there <em>aren&rsquo;t</em> any variables to expand
by running it on the same example we used previously:</p>
<div class="code-sample lang-out" title="variable-expander.out">
<div class="highlight"><pre><span></span><code>9: START
9: B
    update B from C
10: A
    update A from B C
11: END
</code></pre></div>
</div>
<p class="continue">This is perhaps the most important reason to create tests:
they tell us right away if something we have added or changed
has broken something that used to work.
That gives us a firm base to build on as we debug the new code.</p>
<div class="pagebreak"></div>
<p>Now we need to add <span class="ix-entry" ix-key="pattern rule (in build);build!pattern rule" markdown="1"><a class="gl-ref" href="../glossary/#pattern_rule" markdown="1">pattern rules</a></span>.
Our first attempt at a rules file looks like this:</p>
<div class="code-sample lang-yml" title="pattern-rules.yml">
<div class="highlight"><pre><span></span><code>- target: left.out
  depends: []
  recipes: []
  timestamp: 1
- target: left.in
  depends: []
  recipes: []
  timestamp: 2
- target: right.out
  depends: []
  recipes: []
  timestamp: 1
- target: right.in
  depends: []
  recipes: []
  timestamp: 3
- target: &quot;%.out&quot;
  depends:
  - &quot;%.in&quot;
  recipes:
  - &quot;update @TARGET from @DEPENDENCIES&quot;
</code></pre></div>
</div>
<p class="continue">and our first attempt at reading it extracts rules before expanding variables:</p>
<div class="code-sample lang-js" title="pattern-user-attempt.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./variable-expander.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserAttempt</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">extractRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">extractRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">recipes</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">removeNode</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserAttempt</span><span class="w"></span>
</code></pre></div>
</div>
<p>However,
that doesn&rsquo;t work:</p>
<div class="code-sample lang-out" title="pattern-user-attempt.out">
<div class="highlight"><pre><span></span><code>Build failed: AssertionError [ERR_ASSERTION]: Graph does not have node A
    at PatternUserAttempt.addTimestamps \
    (/u/stjs/build-manager/add-stamps.js:21:7)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/add-stamps.js:15:10)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/variable-expander.js:5:11)
    at PatternUserAttempt.buildGraph \
    (/u/stjs/build-manager/pattern-user-attempt.js:5:11)
    at PatternUserAttempt.build \
    (/u/stjs/build-manager/skeleton-builder.js:10:10)
    at main (/u/stjs/build-manager/driver.js:5:13) {
  generatedMessage: false,
  code: &#39;ERR_ASSERTION&#39;,
  actual: false,
  expected: true,
  operator: &#39;==&#39;
}
</code></pre></div>
</div>
<p class="continue">The problem is that our simple graph loader creates nodes for dependencies even if they aren&rsquo;t targets.
As a result,
we wind up tripping over the lack of a node for <code>%.in</code> before we get to extracting rules.</p>
<div class="callout">
<h3>Errors become assertions</h3>
<p>When we first wrote <code>add-stamps.js</code>,
it didn&rsquo;t contain the assertion
that printed the error message shown above.
Once we tracked down our bug,
though,
we added the assertion to ensure we didn&rsquo;t make the same mistake again,
and as <span class="ix-entry" ix-key="runnable documentation (assertions as);assertion!as runnable documentation" markdown="1"><a class="gl-ref" href="../glossary/#runnable_documentation" markdown="1">runnable documentation</a></span>
to tell the next programmer more about the code.
Regular code tells the computer what to do;
assertions with meaningful error messages tell the reader why.</p>
</div>
<p>We can fix our problem by rewriting the rule loader
to separate pattern rules from simple rules;
we can tell the two apart by checking if the rule&rsquo;s dependencies include <code>%</code>.
While we&rsquo;re here,
we will enable timestamps as an optional field in the rules for testing purposes
rather than having them in a separate file:</p>
<div class="code-sample lang-js" title="pattern-user-read.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@dagrejs/graphlib&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./variable-expander.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">VariableExpander</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraphAndRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">buildGraphAndRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">Graph</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">depends</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="nx">dep</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="s1">&#39;Cannot have &quot;%&quot; in a non-pattern rule&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"></span>
</code></pre></div>
</div>
<p>Before we try to run this,
let&rsquo;s add methods to show the state of our two internal data structures:</p>
<div class="code-sample lang-js" title="pattern-user-show.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">graphlib</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@dagrejs/graphlib&#39;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./pattern-user-read.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserShow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">run</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">toJSON</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">graph</span><span class="o">:</span><span class="w"> </span><span class="nx">graphlib</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">keys</span><span class="p">()).</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">k</span><span class="o">:</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserShow</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-sh" title="pattern-user-show.sh">
<div class="highlight"><pre><span></span><code>node driver.js ./pattern-user-show.js pattern-rules.yml
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern-user-show.out">
<div class="highlight"><pre><span></span><code>{
  &quot;graph&quot;: {
    &quot;options&quot;: {
      &quot;directed&quot;: true,
      &quot;multigraph&quot;: false,
      &quot;compound&quot;: false
    },
    &quot;nodes&quot;: [
      {
        &quot;v&quot;: &quot;left.out&quot;,
        &quot;value&quot;: {
          &quot;recipes&quot;: [],
          &quot;timestamp&quot;: 1
        }
      },
      {
        &quot;v&quot;: &quot;left.in&quot;,
        &quot;value&quot;: {
          &quot;recipes&quot;: [],
          &quot;timestamp&quot;: 2
        }
      },
      {
        &quot;v&quot;: &quot;right.out&quot;,
        &quot;value&quot;: {
          &quot;recipes&quot;: [],
          &quot;timestamp&quot;: 1
        }
      },
      {
        &quot;v&quot;: &quot;right.in&quot;,
        &quot;value&quot;: {
          &quot;recipes&quot;: [],
          &quot;timestamp&quot;: 3
        }
      }
    ],
    &quot;edges&quot;: []
  },
  &quot;rules&quot;: [
    {
      &quot;k&quot;: &quot;%.out&quot;,
      &quot;v&quot;: {
        &quot;recipes&quot;: [
          &quot;update @TARGET from @DEPENDENCIES&quot;
        ],
        &quot;depends&quot;: [
          &quot;%.in&quot;
        ]
      }
    }
  ]
}
</code></pre></div>
</div>
<p>The output seems to be right,
so let&rsquo;s try expanding rules <em>after</em> building the graph and rules
but <em>before</em> expanding variables:</p>
<div class="code-sample lang-js" title="pattern-user-run.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./pattern-user-read.js&#39;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PatternUserRun</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PatternUserRead</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">buildGraph</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">buildGraphAndRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandAllRules</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">expandVariables</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandAllRules</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">nodes</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">predecessors</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">findRule</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">expandRule</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">findRule</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`%.</span><span class="si">${</span><span class="nx">target</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">expandRule</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">rule</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nx">rule</span><span class="p">.</span><span class="nx">depends</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">dep</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">stem</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dep</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setEdge</span><span class="p">(</span><span class="nx">dep</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recipes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">recipes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">act</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">act</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">stem</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">node</span><span class="p">(</span><span class="nx">target</span><span class="p">).</span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">graph</span><span class="p">.</span><span class="nx">setNode</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">recipes</span><span class="o">:</span><span class="w"> </span><span class="nx">recipes</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">PatternUserRun</span><span class="w"></span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="pattern-user-run.out">
<div class="highlight"><pre><span></span><code>4: START
4: left.out
    update left.out from left.in
5: right.out
    update right.out from right.in
6: END
</code></pre></div>
</div>
<h2 id="build-manager-next">Section 10.6: What should we do next?</h2>
<p>We have added a lot of steps to our original template method,
which makes it a bit of a stretch to claim that the overall operation hasn&rsquo;t changed.
Knowing what we know now,
we could go back and modify the original <code>SkeletonBuilder.build</code> method
to include those extra steps and provide do-nothing implementations.</p>
<p>The root of the problem is that we didn&rsquo;t anticipate all the steps that would be involved
when we wrote our template method.
It typically takes a few child classes for this to settle down;
if it never does,
then <span class="ix-entry" ix-key="Template Method pattern;design pattern!Template Method" markdown="1">Template Method</span> is probably the wrong pattern for our situation.
This isn&rsquo;t a failure in initial design:
we always learn about our problem as we try to capture it in code,
and if we know enough to anticipate 100% of the issues that are going to come up,
it&rsquo;s time to put what we&rsquo;ve learned in a library for future use.</p>
<h2 id="build-manager-exercises">Section 10.7: Exercises</h2>
<h3 class="exercise">Handle failure</h3>
<ol>
<li>
<p>Modify the build manager to accommodate build steps that fail.</p>
</li>
<li>
<p>Write Mocha tests to check that this change works correctly.</p>
</li>
</ol>
<h3 class="exercise">Dry run</h3>
<p>Add an option to the build manager to show what commands would be executed and why
if a build were actually run.
For example,
the output should display things like, &ldquo;&lsquo;update A&rsquo; because A older than B&rdquo;.</p>
<h3 class="exercise">Change directories</h3>
<p>Modify the build manager so that:</p>
<div class="highlight"><pre><span></span><code>node build.js -C some/sub/directory rules.yml timestamps.yml
</code></pre></div>
<p class="continue">runs the build in the specified directory rather than the current directory.</p>
<h3 class="exercise">Merge files</h3>
<p>Modify the build manager so that it can read multiple configuration files
and execute their combined rules.</p>
<h3 class="exercise">Show recipes</h3>
<p>Add a method to build manager to display all unique recipes,
i.e.,
all of the commands it might execute if asked to rebuild everything.</p>
<h3 class="exercise">Conditional execution</h3>
<p>Modify the build manager so that:</p>
<ol>
<li>
<p>The user can pass <code>variable=true</code> and <code>variable=false</code> arguments on the command-line
    to define variables.</p>
</li>
<li>
<p>Rules can contain an <code>if: variable</code> field.</p>
</li>
<li>
<p>Those rules are only executed if the variable is defined and true.</p>
</li>
<li>
<p>Write Mocha tests to check that this works correctly.</p>
</li>
</ol>
<h3 class="exercise">Define filesets</h3>
<p>Modify the build manager so that users can define sets of files:</p>
<div class="highlight"><pre><span></span><code>fileset:
  name: everything
  contains:
    - X
    - Y
    - Z
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @everything
</code></pre></div>
<h3 class="exercise">Globbing</h3>
<p>Modify the build manager so that it can dynamically construct a set of files:</p>
<div class="highlight"><pre><span></span><code>glob:
  name: allAvailableInputs
  pattern: &quot;./*.in&quot;
</code></pre></div>
<p class="continue">and then refer to them later:</p>
<div class="highlight"><pre><span></span><code>- target: P
  depends:
  - @allAvailableInputs
</code></pre></div>
<h3 class="exercise">Use hashes</h3>
<ol>
<li>
<p>Write a program called <code>build-init.js</code> that calculates a hash
    for every file mentioned in the build configuration
    and stores the hash along with the file&rsquo;s name in <code>build-hash.json</code>.</p>
</li>
<li>
<p>Modify the build manager to compare the current hashes of files
    with those stored in <code>build-hash.json</code>
    in order to determine what is out of date,
    and to update <code>build-hash.json</code> each time it runs.</p>
</li>
</ol>
<h3 class="exercise">Auxiliary functions</h3>
<ol>
<li>
<p>Modify the builder manager so that it takes an extra argument <code>auxiliaries</code>
    containing zero or more named functions:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExtensibleBuilder</span><span class="p">(</span><span class="nx">configFile</span><span class="p">,</span><span class="w"> </span><span class="nx">timesFile</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">slice</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">simplify</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Modify the <code>run</code> method to call these functions
    before executing the rules for a node,
    and to only execute the rules if all of them return <code>true</code>.</p>
</li>
<li>
<p>Write Mocha tests to check that this works correctly.</p>
</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
